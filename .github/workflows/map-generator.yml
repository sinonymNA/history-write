name: Generate Code Map

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'HTML filename (in repo root) to map'
        required: true
        default: 'historywrite.html'
        type: string

permissions:
  contents: read

jobs:
  generate-map:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate filename
        run: |
          set -e
          FILENAME="${{ inputs.filename }}"

          if [[ ! "$FILENAME" =~ ^[a-zA-Z0-9_.-]+\.html$ ]]; then
            echo "::error::Invalid filename format: $FILENAME (must be a .html file in repo root)"
            exit 1
          fi

          if [ ! -f "$FILENAME" ]; then
            echo "::error::File not found: $FILENAME"
            echo "Available HTML files:"
            ls -la *.html 2>/dev/null || echo "  (none)"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s "$FILENAME")
          echo "File validated: $FILENAME ($FILE_SIZE bytes)"

      - name: Generate map with Haiku
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          set -eo pipefail

          MAP_FILE="map-${INPUT_FILENAME%.html}.json"
          echo "Generating map: $INPUT_FILENAME -> $MAP_FILE"

          node scripts/generate-map.js "$INPUT_FILENAME" > "$MAP_FILE"

          # Validate it's valid JSON
          jq empty "$MAP_FILE" || { echo "::error::Map output is not valid JSON"; exit 1; }

          SECTIONS=$(jq '.sections | length' "$MAP_FILE")
          TOTAL=$(jq '.totalLines' "$MAP_FILE")
          echo "Map generated: $SECTIONS sections, $TOTAL lines"

      - name: Validate map structure
        env:
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          set -eo pipefail
          MAP_FILE="map-${INPUT_FILENAME%.html}.json"

          jq -e '
            if (.sections | type) != "array" then
              "sections must be an array" | error
            elif (.sections | length) == 0 then
              "no sections found" | error
            elif (.totalLines | type) != "number" then
              "totalLines must be a number" | error
            else
              {
                status: "valid",
                sections: (.sections | length),
                totalLines: .totalLines,
                sectionNames: (.sections | map(.name))
              }
            end
          ' "$MAP_FILE" || { echo "::error::Map structure validation failed"; exit 1; }

      - name: Upload map as artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: code-map
          path: map-*.json
          retention-days: 30

      - name: Create summary
        if: always()
        env:
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          MAP_FILE="map-${INPUT_FILENAME%.html}.json"

          if [ -f "$MAP_FILE" ] && jq empty "$MAP_FILE" 2>/dev/null; then
            SECTIONS=$(jq '.sections | length' "$MAP_FILE")
            TOTAL_LINES=$(jq '.totalLines' "$MAP_FILE")

            echo "## Code Map Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**File**: \`${INPUT_FILENAME}\` | **Lines**: $TOTAL_LINES | **Sections**: $SECTIONS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Sections" >> $GITHUB_STEP_SUMMARY
            jq -r '.sections[] | "- **\(.name)** (L\(.startLine)â€“\(.endLine)): \(.description)"' "$MAP_FILE" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Map Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
