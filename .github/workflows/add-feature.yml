name: Add Feature to HTML

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'HTML filename (in repo root) to modify'
        required: true
        default: 'historywrite.html'
        type: string
      feature_description:
        description: 'Plain English description of the feature to add'
        required: true
        type: string
      target_sections:
        description: 'Comma-separated section names (leave blank for auto-select via Haiku)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  add-feature:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate inputs
        run: |
          set -e
          FILENAME="${{ inputs.filename }}"
          FEATURE="${{ inputs.feature_description }}"

          if [[ ! "$FILENAME" =~ ^[a-zA-Z0-9_.-]+\.html$ ]]; then
            echo "::error::Invalid filename: $FILENAME (must be a .html file in repo root)"
            exit 1
          fi

          if [ ! -f "$FILENAME" ]; then
            echo "::error::File not found: $FILENAME"
            ls -la *.html 2>/dev/null || echo "  (no HTML files found)"
            exit 1
          fi

          if [ ${#FEATURE} -lt 10 ]; then
            echo "::error::Feature description too short (min 10 chars). Got: ${#FEATURE}"
            exit 1
          fi

          echo "Inputs validated:"
          echo "  File: $FILENAME ($(stat -c%s "$FILENAME") bytes)"
          echo "  Feature: ${FEATURE:0:80}..."

      - name: Stage 1 — Generate code map with Haiku
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          set -eo pipefail
          BASENAME="${INPUT_FILENAME%.html}"
          MAP_FILE="map-${BASENAME}.json"

          echo "Stage 1: Mapping $INPUT_FILENAME with Haiku..."
          node scripts/generate-map.js "$INPUT_FILENAME" > "$MAP_FILE"

          jq empty "$MAP_FILE" || { echo "::error::Map generation produced invalid JSON"; exit 1; }

          SECTIONS=$(jq '.sections | length' "$MAP_FILE")
          echo "Map complete: $SECTIONS sections identified"

      - name: Stage 2 — Implement feature with Sonnet
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          INPUT_FILENAME: ${{ inputs.filename }}
          INPUT_FEATURE: ${{ inputs.feature_description }}
          INPUT_SECTIONS: ${{ inputs.target_sections }}
        run: |
          set -eo pipefail
          BASENAME="${INPUT_FILENAME%.html}"
          MAP_FILE="map-${BASENAME}.json"

          echo "Stage 2: Implementing feature with Sonnet..."
          node scripts/add-feature.js

          MODIFIED="${BASENAME}.modified.html"
          if [ ! -f "$MODIFIED" ]; then
            echo "::error::Modified file not created: $MODIFIED"
            exit 1
          fi

          echo "Feature implemented: $MODIFIED ($(stat -c%s "$MODIFIED") bytes)"

      - name: Stage 3 — Validate modified HTML
        env:
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          set -eo pipefail
          BASENAME="${INPUT_FILENAME%.html}"
          MODIFIED="${BASENAME}.modified.html"

          echo "Stage 3: Validating $MODIFIED..."
          node scripts/validate-html.js "$MODIFIED"

      - name: Compare original vs modified
        env:
          INPUT_FILENAME: ${{ inputs.filename }}
        run: |
          set -e
          BASENAME="${INPUT_FILENAME%.html}"
          ORIGINAL="$INPUT_FILENAME"
          MODIFIED="${BASENAME}.modified.html"

          ORIG_LINES=$(wc -l < "$ORIGINAL" | tr -d ' ')
          MOD_LINES=$(wc -l < "$MODIFIED" | tr -d ' ')
          DIFF_LINES=$((MOD_LINES - ORIG_LINES))

          ORIG_SIZE=$(stat -c%s "$ORIGINAL")
          MOD_SIZE=$(stat -c%s "$MODIFIED")
          DIFF_SIZE=$((MOD_SIZE - ORIG_SIZE))

          echo "## Feature Added" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File**: \`$ORIGINAL\` | **Feature**: ${{ inputs.feature_description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Original | Modified | Delta |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | $ORIG_LINES | $MOD_LINES | ${DIFF_LINES:+$DIFF_LINES} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bytes | $ORIG_SIZE | $MOD_SIZE | ${DIFF_SIZE:+$DIFF_SIZE} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download \`${BASENAME}.modified.html\` from artifacts below." >> $GITHUB_STEP_SUMMARY

      - name: Upload modified file
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: modified-html
          path: |
            *.modified.html
            map-*.json
          retention-days: 7

      - name: Report failure
        if: failure()
        run: |
          echo "## Feature Addition Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File**: \`${{ inputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Feature**: ${{ inputs.feature_description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the step logs above for the specific error." >> $GITHUB_STEP_SUMMARY
