<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HistoryWrite | AP World History Mastery</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{
  ember:{400:'#e8794a',500:'#d4622f',600:'#b34d1e'},
  sage:{400:'#6b9b7a',500:'#4d8060'},
  royal:{400:'#7b8ac4',500:'#5c6db3'},
  gold:{400:'#d4a843',500:'#c49528'}
}}}}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#fefdfb; --card:#fff; --elev:#fdf8f0; --tx:#1e1c17; --mu:#7f7868;
  --fa:#b5b0a3; --bd:#e8e6e1; --bd2:#f3ddb8; --ac:#d4622f; --ac2:#b34d1e;
  --acs:rgba(212,98,47,.08); --sg:#4d8060; --ry:#5c6db3; --gd:#c49528;
  --ease-out-expo:cubic-bezier(.16,1,.3,1);
  --ease-spring:cubic-bezier(.34,1.56,.64,1);
  --ease-smooth:cubic-bezier(.4,0,.2,1);
}
[data-theme="dark"] {
  --bg:#0f0e0b; --card:#1a1814; --elev:#242119; --tx:#e8e6e1; --mu:#9a9385;
  --fa:#655f52; --bd:#332f26; --bd2:#4a4639; --ac:#e8794a; --ac2:#d4622f;
  --acs:rgba(232,121,74,.1); --sg:#6b9b7a; --ry:#7b8ac4; --gd:#d4a843;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--tx); margin:0; transition:background .5s var(--ease-out-expo),color .4s; }
::selection { background:rgba(212,98,47,.18); color:var(--tx); }
.fs { font-family:'Crimson Pro',Georgia,serif; }
.fm { font-family:'JetBrains Mono',monospace; }
.csc::-webkit-scrollbar { width:5px; }
.csc::-webkit-scrollbar-track { background:transparent; }
.csc::-webkit-scrollbar-thumb { background:var(--bd); border-radius:10px; }

/* Nav glass */
.navg { background:color-mix(in srgb,var(--card) 85%,transparent); backdrop-filter:blur(20px) saturate(1.3); border-bottom:1px solid var(--bd); transition:box-shadow .3s; }
.navg:has(+ main:hover) { box-shadow:0 1px 12px rgba(0,0,0,.04); }

/* Cards */
.hcard { background:var(--card); border:1px solid var(--bd); border-radius:16px; transition:all .35s var(--ease-out-expo); }
.hcard:hover { border-color:var(--bd2); box-shadow:0 12px 40px rgba(0,0,0,.08); transform:translateY(-3px); }
.hcard:active { transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,.05); }

/* Buttons */
.btnP { background:var(--ac); color:#fff; font-weight:600; border-radius:10px; padding:10px 24px; transition:all .25s var(--ease-out-expo); border:none; cursor:pointer; font-size:14px; font-family:'DM Sans',sans-serif; position:relative; overflow:hidden; }
.btnP::after { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,.15),transparent 60%); opacity:0; transition:opacity .25s; }
.btnP:hover { background:var(--ac2); transform:translateY(-2px); box-shadow:0 6px 24px rgba(212,98,47,.35); }
.btnP:hover::after { opacity:1; }
.btnP:active { transform:translateY(0) scale(.97); box-shadow:0 2px 8px rgba(212,98,47,.2); transition-duration:.1s; }
.btnP:disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
.btnG { background:transparent; color:var(--tx); font-weight:500; border-radius:10px; padding:10px 20px; border:1px solid var(--bd); cursor:pointer; font-size:14px; transition:all .25s var(--ease-out-expo); font-family:'DM Sans',sans-serif; }
.btnG:hover { background:var(--acs); border-color:var(--ac); color:var(--ac); transform:translateY(-1px); }
.btnG:active { transform:translateY(0) scale(.97); transition-duration:.1s; }

/* Inputs */
.hinp { width:100%; padding:10px 16px; background:var(--elev); border:1px solid var(--bd); border-radius:10px; color:var(--tx); font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color .3s,box-shadow .3s,background .3s; }
.hinp:focus { border-color:var(--ac); box-shadow:0 0 0 3px rgba(212,98,47,.1); background:var(--card); }
.hinp::placeholder { color:var(--fa); transition:color .2s; }
.hinp:focus::placeholder { color:var(--bd); }

/* Highlights */
.hl-success { background:rgba(77,128,96,.15); border-bottom:2px solid var(--sg); cursor:help; }
.hl-warning { background:rgba(196,149,40,.15); border-bottom:2px solid var(--gd); cursor:help; }
.hl-error { background:rgba(212,98,47,.15); border-bottom:2px solid var(--ac); cursor:help; }

/* Inline annotation markers */
.hl-inline { position:relative; cursor:pointer; transition:filter .2s; }
.hl-inline:hover { filter:brightness(1.15); z-index:1; }
.hl-num { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:50%; font-size:10px; font-weight:700; color:#fff; margin-right:3px; vertical-align:middle; font-family:'DM Sans',sans-serif; line-height:1; }
.hl-success .hl-num { background:var(--sg); }
.hl-warning .hl-num { background:var(--gd); }
.hl-error .hl-num { background:var(--ac); }

/* Annotation cards */
.ann-card { padding:14px; border-radius:14px; background:var(--elev); border:1px solid var(--bd); transition:all .25s; cursor:pointer; }
.ann-card:hover { border-color:var(--bd2); transform:translateX(-2px); }
.ann-card-success { border-left:3px solid var(--sg); }
.ann-card-warning { border-left:3px solid var(--gd); }
.ann-card-error { border-left:3px solid var(--ac); }
@keyframes annFlash { 0%,30% { box-shadow:0 0 0 3px var(--ac); } 100% { box-shadow:none; } }
.ann-flash { animation:annFlash .8s ease-out; }

/* Encouragement banner */
.enc-banner { background:linear-gradient(135deg,rgba(212,98,47,.08),rgba(196,149,40,.08)); border:1px solid var(--bd2); border-radius:14px; padding:16px 20px; }

/* Improvement tip boxes */
.tip-box { background:rgba(196,149,40,.08); border:1px solid rgba(196,149,40,.2); border-radius:10px; padding:8px 12px; margin-top:8px; }
.tip-box-error { background:rgba(212,98,47,.08); border:1px solid rgba(212,98,47,.2); }

/* Highlight legend */
.hl-legend { display:flex; flex-wrap:wrap; gap:16px; }
.hl-legend-item { display:flex; align-items:center; gap:6px; font-size:11px; }
.hl-legend-swatch { width:12px; height:12px; border-radius:3px; }

/* Skill nodes */
.skill-node { transition:all .3s cubic-bezier(.4,0,.2,1); cursor:pointer; }
.skill-node:hover { transform:scale(1.08) translateY(-4px); }
.skill-gold { box-shadow:0 0 0 3px var(--gd),0 0 20px rgba(196,149,40,.4); animation:glowG 2.5s ease-in-out infinite; }
.skill-grow { border-color:var(--sg); background:rgba(77,128,96,.1); }
.skill-seed { border-color:var(--bd); background:var(--elev); }
@keyframes glowG {
  0%,100% { box-shadow:0 0 0 3px var(--gd),0 0 15px rgba(196,149,40,.3); }
  50% { box-shadow:0 0 0 3px var(--gd),0 0 25px rgba(196,149,40,.6); }
}

/* Garden enhancements */
.garden-plot { position:relative; background:var(--elev); border:1px solid var(--bd); border-radius:20px; padding:16px; transition:all .3s; }
.garden-plot:hover { border-color:var(--bd2); box-shadow:0 6px 24px rgba(0,0,0,.06); }
.garden-type-header { display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid var(--bd); }
.progress-ring { transform:rotate(-90deg); }
.progress-ring-bg { fill:none; stroke:var(--bd); }
.progress-ring-fill { fill:none; stroke-linecap:round; transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1); }
.plant-cell { display:flex; flex-direction:column; align-items:center; gap:6px; padding:10px 6px; border-radius:14px; cursor:pointer; transition:all .3s; position:relative; }
.plant-cell:hover { background:var(--acs); }
.plant-pot { width:52px; height:52px; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:26px; border:2px solid var(--bd); transition:all .3s; position:relative; overflow:hidden; }
.plant-pot::after { content:''; position:absolute; bottom:0; left:0; right:0; height:0%; background:linear-gradient(to top,rgba(77,128,96,.15),transparent); transition:height .6s; border-radius:0 0 14px 14px; }
.plant-cell[data-pct="low"] .plant-pot::after { height:25%; }
.plant-cell[data-pct="mid"] .plant-pot::after { height:55%; }
.plant-cell[data-pct="high"] .plant-pot::after { height:85%; background:linear-gradient(to top,rgba(196,149,40,.2),transparent); }
@keyframes sway { 0%,100% { transform:rotate(-2deg); } 50% { transform:rotate(2deg); } }
.plant-sway { animation:sway 3s ease-in-out infinite; }
.streak-badge { position:absolute; top:-4px; right:-4px; width:20px; height:20px; border-radius:50%; background:var(--ac); color:#fff; font-size:9px; font-weight:700; display:flex; align-items:center; justify-content:center; }
.garden-summary { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px; }
.garden-stat { text-align:center; padding:10px; border-radius:12px; background:var(--card); border:1px solid var(--bd); }
.drill-scenario { background:var(--elev); border:1px solid var(--bd); border-radius:14px; padding:16px; margin-bottom:12px; }
.drill-hint { background:rgba(196,149,40,.08); border:1px solid rgba(196,149,40,.15); border-radius:10px; padding:10px 14px; margin-top:8px; font-size:12px; }
.drill-checklist { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.drill-check { font-size:11px; padding:4px 10px; border-radius:6px; background:var(--elev); border:1px solid var(--bd); transition:all .2s; }
.drill-check.met { background:rgba(77,128,96,.12); border-color:var(--sg); color:var(--sg); font-weight:600; }
.drill-feedback { padding:14px; border-radius:14px; margin-top:12px; }
.drill-feedback-great { background:rgba(77,128,96,.1); border:1px solid rgba(77,128,96,.25); }
.drill-feedback-good { background:rgba(196,149,40,.1); border:1px solid rgba(196,149,40,.25); }
.drill-feedback-try { background:rgba(212,98,47,.08); border:1px solid rgba(212,98,47,.2); }

/* Arcade */
.arcP { background:#13120f; border-radius:16px; overflow:hidden; }
[data-theme="dark"] .arcP { background:#0a0908; }
.arcTab { font-size:12px; padding:10px 16px; border:none; border-bottom:2px solid transparent; color:#7f7868; cursor:pointer; background:none; font-family:'DM Sans',sans-serif; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s; }
.arcTab.on { color:#e8e6e1; border-bottom-color:var(--ac); }

/* Animations */
@keyframes toastIn { from { opacity:0; transform:translateX(30px) scale(.9); } to { opacity:1; transform:translateX(0) scale(1); } }
@keyframes toastOut { to { opacity:0; transform:translateX(30px) scale(.9); } }
.toastAnim { animation:toastIn .4s var(--ease-spring); }

@keyframes slideUp { from { opacity:0; transform:translateY(24px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes scaleIn { from { opacity:0; transform:scale(.92); } to { opacity:1; transform:scale(1); } }
@keyframes slideInRight { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }
@keyframes slideInLeft { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }

.pageEnter { animation:slideUp .5s var(--ease-out-expo); }
.fadeIn { animation:fadeIn .4s var(--ease-out-expo); }
.scaleIn { animation:scaleIn .4s var(--ease-spring); }
.slideRight { animation:slideInRight .5s var(--ease-out-expo); }
.slideLeft { animation:slideInLeft .5s var(--ease-out-expo); }

/* Staggered children */
.stagger > * { opacity:0; animation:slideUp .5s var(--ease-out-expo) forwards; }
.stagger > *:nth-child(1) { animation-delay:.04s; }
.stagger > *:nth-child(2) { animation-delay:.08s; }
.stagger > *:nth-child(3) { animation-delay:.12s; }
.stagger > *:nth-child(4) { animation-delay:.16s; }
.stagger > *:nth-child(5) { animation-delay:.2s; }
.stagger > *:nth-child(6) { animation-delay:.24s; }
.stagger > *:nth-child(7) { animation-delay:.28s; }
.stagger > *:nth-child(8) { animation-delay:.32s; }
.stagger > *:nth-child(9) { animation-delay:.36s; }
.stagger > *:nth-child(10) { animation-delay:.4s; }

/* Hero landing choreography */
.hero-title { opacity:0; animation:slideUp .7s var(--ease-out-expo) .1s forwards; }
.hero-sub { opacity:0; animation:slideUp .7s var(--ease-out-expo) .2s forwards; }
.hero-btns { opacity:0; animation:slideUp .6s var(--ease-out-expo) .35s forwards; }
.hero-features { opacity:0; animation:slideUp .6s var(--ease-out-expo) .5s forwards; }

.heroBg { background-image:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(212,98,47,.15),transparent),radial-gradient(circle at 80% 80%,rgba(92,109,179,.1),transparent); }
@keyframes floatAnim { 0%,100% { transform:translateY(0) rotate(0); } 50% { transform:translateY(-15px) rotate(2deg); } }
.float1 { animation:floatAnim 6s ease-in-out infinite; }
.float2 { animation:floatAnim 8s ease-in-out infinite 1s; }
.float3 { animation:floatAnim 7s ease-in-out infinite 2s; }

/* Score reveal */
@keyframes scoreReveal { from { opacity:0; transform:scale(.6) rotate(-10deg); } to { opacity:1; transform:scale(1) rotate(0); } }
.score-reveal { animation:scoreReveal .6s var(--ease-spring); }

/* Pulse glow for CTAs */
@keyframes pulseGlow { 0%,100% { box-shadow:0 0 0 0 rgba(212,98,47,.3); } 50% { box-shadow:0 0 0 8px rgba(212,98,47,0); } }
.pulse-cta { animation:pulseGlow 2s ease-in-out infinite; }

/* Modals */
@keyframes modalBgIn { from { opacity:0; } to { opacity:1; } }
@keyframes modalBoxIn { from { opacity:0; transform:scale(.9) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }
.modalBg { position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); z-index:50; display:flex; align-items:center; justify-content:center; padding:16px; animation:modalBgIn .25s ease-out; }
.modalBox { background:var(--card); border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,.15); width:100%; max-width:480px; padding:32px; animation:modalBoxIn .35s var(--ease-spring); }
.modalLg { max-width:720px; max-height:90vh; overflow-y:auto; }

/* XP bar */
.xpBar { height:6px; background:var(--bd); border-radius:3px; overflow:hidden; }
.xpFill { height:100%; background:linear-gradient(90deg,var(--ac),var(--gd)); border-radius:3px; transition:width .8s var(--ease-out-expo); position:relative; }
@keyframes xpShimmer { from { transform:translateX(-100%); } to { transform:translateX(200%); } }
.xpFill::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent); animation:xpShimmer 2.5s ease-in-out infinite; }

/* Tabs */
.tabBtn { padding:8px 20px; font-size:13px; font-weight:600; border-radius:8px 8px 0 0; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; background:transparent; color:var(--mu); border-bottom:2px solid transparent; transition:all .2s; }
.tabBtn.on { color:var(--ac); border-bottom-color:var(--ac); background:var(--acs); }

/* Assignment builder */
.builder-wrap { display:flex; height:calc(100vh - 56px); }
.builder-form { width:50%; overflow-y:auto; padding:24px 32px; border-right:1px solid var(--bd); }
.builder-preview { width:50%; overflow-y:auto; background:var(--elev); position:relative; }
.builder-preview-label { position:sticky; top:0; z-index:5; background:var(--elev); border-bottom:1px solid var(--bd); padding:10px 20px; display:flex; align-items:center; gap:8px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--mu); }
.builder-preview-label i { color:var(--ac); }
.builder-preview-inner { padding:24px 32px; }
.builder-section { margin-bottom:20px; }
.builder-section label { display:block; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--mu); margin-bottom:6px; }
.doc-card { background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:12px; margin-bottom:8px; position:relative; }
.doc-card-remove { position:absolute; top:8px; right:8px; width:22px; height:22px; border-radius:6px; border:1px solid var(--bd); background:var(--card); cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--fa); font-size:12px; transition:all .15s; }
.doc-card-remove:hover { border-color:var(--ac); color:var(--ac); background:var(--acs); }
.doc-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:2px 8px; border-radius:5px; text-transform:uppercase; }
.doc-badge-text { background:rgba(92,109,179,.1); color:var(--ry); }
.doc-badge-image { background:rgba(77,128,96,.1); color:var(--sg); }
.doc-badge-chart { background:rgba(196,149,40,.1); color:var(--gd); }
.doc-badge-map { background:rgba(212,98,47,.1); color:var(--ac); }
.doc-img-preview { max-width:100%; border-radius:8px; margin-top:8px; border:1px solid var(--bd); }
.doc-img-error { padding:20px; text-align:center; border-radius:8px; margin-top:8px; border:2px dashed var(--bd); font-size:12px; color:var(--fa); }
.preview-prompt { background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:16px; font-family:'Crimson Pro',Georgia,serif; font-size:14px; line-height:1.7; white-space:pre-wrap; }
.preview-empty { text-align:center; padding:40px 20px; color:var(--fa); }
.preview-doc { background:var(--card); border:1px solid var(--bd); border-radius:10px; padding:12px; margin-bottom:8px; }
@media (max-width:768px) {
  .builder-wrap { flex-direction:column; height:auto; min-height:calc(100vh - 56px); }
  .builder-form { width:100%; border-right:none; border-bottom:1px solid var(--bd); }
  .builder-preview { width:100%; min-height:50vh; }
}
/* Teacher submission list */
.sub-row { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:10px; cursor:pointer; transition:all .15s; }
.sub-row:hover { background:var(--acs); }
.sub-score { min-width:48px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; }
.sub-score-high { background:rgba(77,128,96,.12); color:var(--sg); }
.sub-score-mid { background:rgba(196,149,40,.12); color:var(--gd); }
.sub-score-low { background:rgba(212,98,47,.12); color:var(--ac); }

/* Chrono flash */
@keyframes flashGreen { 0% { background:rgba(77,128,96,.3); box-shadow:inset 0 0 30px rgba(77,128,96,.15); } 100% { background:transparent; box-shadow:none; } }
.chronoCorrect { animation:flashGreen .5s var(--ease-out-expo); }
@keyframes flashRed { 0% { background:rgba(212,98,47,.3); box-shadow:inset 0 0 30px rgba(212,98,47,.15); } 100% { background:transparent; box-shadow:none; } }
.chronoWrong { animation:flashRed .6s var(--ease-out-expo); }

/* Annotation cards enhanced */
.ann-card { transition:all .3s var(--ease-out-expo); }
.ann-card:hover { transform:translateX(-3px) translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.06); }

/* Skill nodes enhanced */
.skill-node { transition:all .35s var(--ease-spring); }
.skill-node:hover { transform:scale(1.1) translateY(-5px); box-shadow:0 8px 24px rgba(0,0,0,.1); }

/* Focus-visible accessibility */
:focus-visible { outline:2px solid var(--ac); outline-offset:2px; border-radius:6px; }
button:focus-visible, .btnP:focus-visible, .btnG:focus-visible { outline:2px solid var(--ac); outline-offset:2px; }

/* Smooth scrollbar */
.csc { scroll-behavior:smooth; }
main { scroll-behavior:smooth; }

/* Garden plot enhanced */
.garden-plot { transition:all .35s var(--ease-out-expo); }
.garden-plot:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(0,0,0,.07); }

/* Plant cell enhanced */
.plant-cell { transition:all .3s var(--ease-spring); }
.plant-cell:hover { transform:translateY(-3px); }
.plant-pot { transition:all .35s var(--ease-spring); }

/* Tab transition */
.tabBtn { transition:all .25s var(--ease-out-expo); }
.tabBtn:hover { background:var(--acs); }

/* Sub-row enhanced */
.sub-row { transition:all .2s var(--ease-out-expo); }
.sub-row:hover { transform:translateX(4px); }

/* Loading skeleton shimmer */
@keyframes shimmer { 0% { background-position:-200% 0; } 100% { background-position:200% 0; } }
.skeleton { background:linear-gradient(90deg,var(--bd) 25%,var(--elev) 50%,var(--bd) 75%); background-size:200% 100%; animation:shimmer 1.5s ease-in-out infinite; border-radius:8px; }

/* Smooth number counter */
@keyframes countUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
.count-up { animation:countUp .4s var(--ease-out-expo); }

/* Doc card enhanced */
.doc-card { transition:all .25s var(--ease-out-expo); }
.doc-card:hover { border-color:var(--bd2); transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.04); }

/* Builder preview enhanced */
.builder-preview { transition:background .3s; }
.preview-prompt { transition:all .3s var(--ease-out-expo); }

/* Arcade tab enhanced */
.arcTab { transition:all .2s var(--ease-out-expo); }
.arcTab:hover { color:#c4b8a8; }
.arcTab.on { color:#e8e6e1; border-bottom-color:var(--ac); }

/* Spinner */
@keyframes spin { to { transform:rotate(360deg); } }

/* Smooth link hover */
a, [onclick] { transition:opacity .2s, color .2s; }

/* Encouragement banner animated */
.enc-banner { transition:all .3s var(--ease-out-expo); }
.enc-banner:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,0,0,.04); }

/* ═══ ESSAY BLOCKS ═══ */
.eb-wrap { max-width:680px; margin:0 auto; padding:24px 16px; }
.eb-progress { display:flex; gap:4px; margin-bottom:24px; }
.eb-pip { flex:1; height:6px; border-radius:3px; background:var(--bd); transition:all .4s var(--ease-out-expo); }
.eb-pip.done { background:var(--sg); }
.eb-pip.active { background:var(--ac); box-shadow:0 0 8px rgba(212,98,47,.3); }
@keyframes blockIn { from { opacity:0; transform:translateY(30px) scale(.96); } to { opacity:1; transform:translateY(0) scale(1); } }
.eb-block { animation:blockIn .5s var(--ease-spring); }
.eb-card { background:var(--card); border:1px solid var(--bd); border-radius:20px; padding:28px; box-shadow:0 4px 24px rgba(0,0,0,.04); }
.eb-emoji { font-size:40px; margin-bottom:12px; display:block; animation:floatAnim 4s ease-in-out infinite; }
.eb-hint { background:rgba(196,149,40,.08); border:1px solid rgba(196,149,40,.15); border-radius:12px; padding:12px 16px; margin-top:12px; font-size:13px; color:var(--mu); }
.eb-hint-btn { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--gd); font-weight:600; cursor:pointer; padding:6px 12px; border-radius:8px; border:1px solid rgba(196,149,40,.2); background:rgba(196,149,40,.05); transition:all .2s; }
.eb-hint-btn:hover { background:rgba(196,149,40,.12); }
.eb-textarea { width:100%; min-height:120px; padding:16px; background:var(--elev); border:2px solid var(--bd); border-radius:14px; color:var(--tx); font-size:15px; font-family:'Crimson Pro',Georgia,serif; line-height:1.7; resize:none; outline:none; transition:border-color .3s,box-shadow .3s; }
.eb-textarea:focus { border-color:var(--ac); box-shadow:0 0 0 3px rgba(212,98,47,.1); }
.eb-nav { display:flex; gap:12px; margin-top:20px; }
@keyframes consolidate { from { opacity:0; transform:scale(.9); } to { opacity:1; transform:scale(1); } }
.eb-consolidated { animation:consolidate .6s var(--ease-spring); }
.eb-final { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:24px; font-family:'Crimson Pro',Georgia,serif; font-size:15px; line-height:1.8; white-space:pre-wrap; }
.eb-block-label { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:2px 8px; border-radius:5px; text-transform:uppercase; background:var(--acs); color:var(--ac); margin-bottom:4px; }

/* Multiplayer lobby */
.eb-lobby { max-width:600px; margin:0 auto; text-align:center; }
.eb-player { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; background:var(--elev); border:1px solid var(--bd); transition:all .3s; }
.eb-player.ready { border-color:var(--sg); background:rgba(77,128,96,.06); }
.eb-player .dot { width:10px; height:10px; border-radius:50%; background:var(--bd); transition:all .3s; }
.eb-player.ready .dot { background:var(--sg); box-shadow:0 0 6px rgba(77,128,96,.4); }
@keyframes timerPulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.08); } }
.eb-timer { font-size:48px; font-weight:800; font-family:'JetBrains Mono',monospace; color:var(--ac); }
.eb-timer.urgent { animation:timerPulse .5s ease-in-out infinite; color:#b34d1e; }
.eb-timer-board { font-size:96px; text-shadow:0 0 60px rgba(212,98,47,.25); letter-spacing:.05em; }
@media(max-width:640px){ .eb-timer-board { font-size:56px; } }
.eb-thesis-bar { background:rgba(212,98,47,.06); border:1px solid rgba(212,98,47,.2); border-radius:16px; padding:16px 20px; font-family:'Crimson Pro',Georgia,serif; font-size:15px; line-height:1.6; color:var(--tx); }
.eb-doc-inline { background:var(--elev); border-left:3px solid var(--ac); border-radius:0 12px 12px 0; padding:14px 16px; margin-bottom:12px; font-family:'Crimson Pro',Georgia,serif; font-size:14px; line-height:1.7; color:var(--tx); }
.eb-doc-inline .eb-doc-attr { font-size:11px; font-style:italic; color:var(--mu); margin-bottom:6px; display:block; }
.eb-progress-card { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:20px 16px; text-align:center; transition:all .3s; }
@keyframes fillUp { from { stroke-dashoffset:157; } }
.eb-progress-ring { position:relative; width:72px; height:72px; margin:0 auto 8px; }
.eb-progress-ring svg { transform:rotate(-90deg); }
.eb-progress-ring .ring-bg { fill:none; stroke:var(--bd); stroke-width:6; }
.eb-progress-ring .ring-fill { fill:none; stroke:var(--ac); stroke-width:6; stroke-linecap:round; transition:stroke-dashoffset .6s var(--ease-out-expo); }
.eb-progress-ring .ring-text { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:800; color:var(--ac); font-family:'JetBrains Mono',monospace; }
.eb-group-card { background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:20px; transition:all .3s var(--ease-out-expo); }
.eb-group-card:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.06); }
.eb-vote-btn { padding:8px 16px; border-radius:10px; border:2px solid var(--bd); background:var(--card); cursor:pointer; font-size:13px; font-weight:600; transition:all .2s; font-family:'DM Sans',sans-serif; }
.eb-vote-btn:hover { border-color:var(--ac); color:var(--ac); }
.eb-vote-btn.voted { border-color:var(--ac); background:var(--acs); color:var(--ac); }

/* ═══ LESSON LAB ═══ */
@keyframes labSparkle { 0%,100% { transform:scale(1) rotate(0deg); } 50% { transform:scale(1.15) rotate(5deg); } }
.lab-icon { animation:labSparkle 3s ease-in-out infinite; display:inline-block; }
.lab-template-card { border:2px solid var(--bd); border-radius:20px; padding:20px 16px; text-align:center; cursor:pointer; transition:all .25s var(--ease-out-expo); background:var(--card); user-select:none; }
.lab-template-card:hover { border-color:var(--ac); transform:translateY(-2px); box-shadow:0 8px 24px rgba(212,98,47,.1); }
.lab-template-card.selected { border-color:var(--ac); background:var(--acs); box-shadow:0 0 0 3px rgba(212,98,47,.12); }
.lab-template-card .lab-t-icon { font-size:32px; margin-bottom:8px; display:block; transition:transform .3s; }
.lab-template-card.selected .lab-t-icon { transform:scale(1.2); }
.lab-generate-btn { width:100%; padding:14px; border-radius:14px; background:linear-gradient(135deg,var(--ac),var(--gd)); color:#fff; font-weight:700; font-size:16px; border:none; cursor:pointer; transition:all .3s; font-family:'DM Sans',sans-serif; display:flex; align-items:center; justify-content:center; gap:8px; }
.lab-generate-btn:hover { filter:brightness(1.08); transform:translateY(-1px); box-shadow:0 8px 24px rgba(212,98,47,.3); }
.lab-generate-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
@keyframes labPulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }
.lab-generating { animation:labPulse 1.5s ease-in-out infinite; }
.lab-chapter-card { background:var(--card); border:1px solid var(--bd); border-radius:20px; overflow:hidden; transition:all .3s; }
.lab-chapter-header { padding:16px 20px; display:flex; align-items:center; gap:12px; cursor:pointer; border-bottom:1px solid var(--bd); }
.lab-chapter-body { padding:20px; }
.lab-gradient-swatch { width:36px; height:36px; border-radius:10px; cursor:pointer; border:3px solid transparent; transition:all .2s; flex-shrink:0; }
.lab-gradient-swatch.selected { border-color:#fff; box-shadow:0 0 0 2px var(--ac),0 4px 12px rgba(0,0,0,.2); transform:scale(1.1); }
.lab-img-preview { width:100%; height:140px; object-fit:cover; border-radius:12px; margin-top:8px; display:none; }
.lab-img-preview.visible { display:block; }
.lab-q-option { display:flex; align-items:flex-start; gap:10px; padding:12px 14px; border-radius:12px; border:1.5px solid var(--bd); cursor:pointer; transition:all .2s; margin-bottom:8px; background:var(--card); }
.lab-q-option:hover { border-color:var(--ac); background:var(--acs); }
.lab-q-option input[type=radio] { margin-top:2px; accent-color:var(--ac); flex-shrink:0; }
.lab-q-option.checked { border-color:var(--ac); background:var(--acs); }
.lab-saved-banner { background:linear-gradient(135deg,rgba(77,128,96,.1),rgba(77,128,96,.05)); border:1px solid rgba(77,128,96,.25); border-radius:14px; padding:16px 20px; display:flex; align-items:center; gap:12px; }

/* ═══ TEACHER TOUR ═══ */
.tour-step { opacity:0; transform:translateY(20px); transition:opacity .5s var(--ease-out-expo),transform .5s var(--ease-out-expo); }
.tour-step.visible { opacity:1; transform:translateY(0); }
.tour-nav { display:flex; gap:6px; justify-content:center; margin:20px 0; }
.tour-dot { width:10px; height:10px; border-radius:50%; background:var(--bd); cursor:pointer; transition:background .2s,transform .2s; }
.tour-dot.active { background:var(--ac); transform:scale(1.3); }
.tour-mock { border-radius:16px; overflow:hidden; border:1px solid var(--bd); background:var(--card); }
.tour-mock-header { padding:8px 12px; background:var(--elev); border-bottom:1px solid var(--bd); display:flex; align-items:center; gap:6px; }
.tour-mock-dot { width:8px; height:8px; border-radius:50%; }
.tour-mock-body { padding:16px; }
@keyframes tourType { from { width:0; } to { width:100%; } }
@keyframes tourFadeSlide { from { opacity:0; transform:translateX(8px); } to { opacity:1; transform:translateX(0); } }
@keyframes tourCursor { 0%,50% { border-color:var(--ac); } 51%,100% { border-color:transparent; } }
.tour-typing { display:inline-block; overflow:hidden; white-space:nowrap; border-right:2px solid var(--ac); animation:tourType 2s steps(30) forwards, tourCursor .7s step-end 3; max-width:100%; }
.tour-pop { animation:tourFadeSlide .4s var(--ease-out-expo) forwards; opacity:0; }
.tour-pop-d1 { animation-delay:.3s; }
.tour-pop-d2 { animation-delay:.6s; }
.tour-pop-d3 { animation-delay:.9s; }
.tour-pop-d4 { animation-delay:1.2s; }
.tour-pop-d5 { animation-delay:1.5s; }

/* ═══ BLOCK BLAST ═══ */
.bb-board { display:grid; grid-template-columns:repeat(8,1fr); gap:3px; width:100%; max-width:380px; margin:0 auto; }
.bb-cell { aspect-ratio:1; border-radius:5px; transition:background .12s,transform .2s,opacity .2s; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.04); cursor:pointer; }
.bb-cell.filled { border-color:rgba(255,255,255,.18); }
.bb-cell.ghost { opacity:.4; }
.bb-cell.clearing { animation:bbClear .35s var(--ease-out-expo) forwards; }
@keyframes bbClear { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.15)} 100%{transform:scale(0);opacity:0} }
.bb-tray { display:flex; justify-content:center; align-items:flex-start; gap:16px; padding:12px 8px 16px; min-height:90px; }
.bb-piece { display:inline-grid; gap:2px; padding:8px; border-radius:10px; cursor:pointer; transition:transform .15s,box-shadow .15s,border-color .15s; border:2px solid transparent; background:rgba(255,255,255,.03); }
.bb-piece:hover { transform:scale(1.08); }
.bb-piece.selected { border-color:var(--ac); box-shadow:0 0 20px rgba(212,98,47,.3); transform:scale(1.1); }
.bb-piece.used { opacity:.12; pointer-events:none; }
.bb-piece-cell { width:18px; height:18px; border-radius:3px; }
.bb-piece-cell.empty { background:transparent; }
.bb-modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(4px); }
.bb-qcard { max-width:360px; width:90%; padding:20px; border-radius:16px; background:#2a2620; border:1px solid #3d382f; }
.bb-choice { display:block; width:100%; text-align:left; padding:10px 14px; margin-top:6px; border-radius:10px; font-size:12px; background:rgba(255,255,255,.05); color:#e8e6e1; border:1px solid rgba(255,255,255,.08); cursor:pointer; transition:background .15s,border-color .15s; }
.bb-choice:hover { background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.15); }
.bb-choice.correct { background:rgba(77,128,96,.3)!important; border-color:var(--sg)!important; color:var(--sg)!important; }
.bb-choice.wrong { background:rgba(212,98,47,.2)!important; border-color:var(--ac)!important; color:var(--ac)!important; }

/* ═══ STORY LESSON ═══ */
.story-scene { position:relative; overflow:hidden; border-radius:20px; padding:48px 24px 36px; text-align:center; min-height:240px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.story-scene::after { content:''; position:absolute; inset:0; background:linear-gradient(transparent 40%,rgba(0,0,0,.5)); pointer-events:none; }
.story-scene > * { position:relative; z-index:1; }
.story-icon { font-size:56px; margin-bottom:12px; filter:drop-shadow(0 4px 16px rgba(0,0,0,.4)); animation:float 4s ease-in-out infinite; }
.story-chnum { font-size:10px; text-transform:uppercase; letter-spacing:.2em; color:rgba(255,255,255,.5); font-family:'DM Sans',sans-serif; font-weight:700; }
.story-chtitle { font-size:24px; font-weight:700; color:#fff; text-shadow:0 2px 16px rgba(0,0,0,.5); font-family:'Crimson Pro',serif; margin-top:2px; }
.story-date { font-size:11px; color:rgba(255,255,255,.45); margin-top:6px; font-family:'JetBrains Mono',monospace; }
.story-body { font-family:'Crimson Pro',Georgia,serif; font-size:17px; line-height:1.85; color:var(--tx); max-width:640px; margin:0 auto; }
.story-body p { margin-bottom:18px; text-indent:1.5em; }
.story-body p:first-child { text-indent:0; }
.story-body p:first-child::first-letter { font-size:2.8em; float:left; line-height:.85; margin-right:6px; margin-top:4px; font-weight:700; color:var(--ac); }
.story-term { font-weight:600; color:var(--ac); border-bottom:1px dotted rgba(212,98,47,.4); }
.story-quote { border-left:3px solid var(--ac); padding:12px 16px; margin:20px 0; background:var(--acs); border-radius:0 12px 12px 0; font-style:italic; }
.story-quote cite { display:block; font-size:12px; font-style:normal; color:var(--mu); margin-top:6px; font-family:'DM Sans',sans-serif; }
.story-check { max-width:560px; margin:32px auto 0; padding:24px; border-radius:16px; background:var(--elev); border:1px solid var(--bd); }
.story-progress { display:flex; gap:4px; margin-bottom:20px; }
.story-pip { flex:1; height:5px; border-radius:3px; background:var(--bd); transition:background .4s var(--ease-out-expo); }
.story-pip.done { background:var(--sg); }
.story-pip.current { background:var(--ac); box-shadow:0 0 8px rgba(212,98,47,.4); }
.story-narrator { display:flex; gap:12px; align-items:flex-start; margin-bottom:16px; }
.story-narrator-avi { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; background:linear-gradient(135deg,var(--ac),var(--gd)); }
.story-narrator-bubble { background:var(--card); border:1px solid var(--bd); border-radius:4px 14px 14px 14px; padding:12px 16px; font-size:14px; line-height:1.6; }
.story-unlock { animation:storyUnlock .6s var(--ease-spring); }
@keyframes storyUnlock { 0%{transform:scale(.9);opacity:0} 100%{transform:scale(1);opacity:1} }
.story-lib-card { position:relative; overflow:hidden; border-radius:16px; border:1px solid var(--bd); transition:all .35s var(--ease-out-expo); }
.story-lib-card:hover { border-color:var(--bd2); box-shadow:0 12px 40px rgba(0,0,0,.08); transform:translateY(-3px); }
.story-lib-card .story-lib-cover { height:140px; display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; }
.story-lib-card .story-lib-cover::after { content:''; position:absolute; inset:0; background:linear-gradient(transparent 50%,rgba(0,0,0,.4)); }
.story-lib-card .story-lib-cover > * { position:relative; z-index:1; }

/* Story images */
.story-img { width:100%; max-height:280px; object-fit:cover; border-radius:16px; margin-bottom:20px; border:1px solid var(--bd); }
.story-img-edit { position:absolute; top:8px; right:8px; z-index:2; background:rgba(0,0,0,.6); color:#fff; border:none; border-radius:8px; padding:4px 10px; font-size:11px; cursor:pointer; backdrop-filter:blur(4px); transition:background .2s; }
.story-img-edit:hover { background:rgba(0,0,0,.8); }

/* ═══ LIVE QUIZ (Blooket-style) ═══ */
.qz-wrap { min-height:100vh; background:#0d0b1a; color:#e8e6e1; }
.qz-lobby-code { font-size:48px; font-weight:800; letter-spacing:.15em; color:#fff; text-shadow:0 0 30px rgba(212,98,47,.5); }
.qz-player-grid { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; max-width:600px; margin:0 auto; }
.qz-player-chip { padding:6px 14px; border-radius:10px; font-size:13px; font-weight:600; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.06); animation:storyUnlock .3s var(--ease-spring); }
.qz-timer { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:800; font-family:'JetBrains Mono',monospace; border:4px solid; transition:border-color .3s,color .3s; }
.qz-timer.urgent { border-color:#e74c3c; color:#e74c3c; animation:qzPulse .5s ease-in-out infinite; }
@keyframes qzPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
.qz-choices { display:grid; grid-template-columns:1fr 1fr; gap:10px; max-width:560px; margin:0 auto; }
.qz-choice { padding:16px 14px; border-radius:14px; font-size:14px; font-weight:600; text-align:left; cursor:pointer; border:2px solid transparent; transition:transform .15s,box-shadow .15s,opacity .15s; position:relative; overflow:hidden; }
.qz-choice:hover { transform:scale(1.03); box-shadow:0 6px 20px rgba(0,0,0,.3); }
.qz-choice:active { transform:scale(.97); }
.qz-choice.picked { opacity:.7; pointer-events:none; }
.qz-choice.picked.right { opacity:1; border-color:#fff; box-shadow:0 0 24px rgba(46,204,113,.4); }
.qz-choice.picked.wrong { opacity:.5; }
.qz-choice:nth-child(1) { background:#c0392b; }
.qz-choice:nth-child(2) { background:#2980b9; }
.qz-choice:nth-child(3) { background:#27ae60; }
.qz-choice:nth-child(4) { background:#d35400; }
.qz-score-pop { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:36px; font-weight:800; color:#2ecc71; text-shadow:0 0 20px rgba(46,204,113,.5); animation:qzScorePop .8s var(--ease-out-expo) forwards; pointer-events:none; z-index:50; }
@keyframes qzScorePop { 0%{opacity:0;transform:translate(-50%,-50%) scale(.5)} 30%{opacity:1;transform:translate(-50%,-50%) scale(1.2)} 100%{opacity:0;transform:translate(-50%,-70%) scale(1)} }
.qz-lb-row { display:flex; align-items:center; gap:12px; padding:10px 16px; border-radius:12px; margin-bottom:6px; transition:all .4s var(--ease-out-expo); }
.qz-lb-row:nth-child(1) { background:linear-gradient(90deg,rgba(255,215,0,.15),transparent); }
.qz-lb-row:nth-child(2) { background:linear-gradient(90deg,rgba(192,192,192,.1),transparent); }
.qz-lb-row:nth-child(3) { background:linear-gradient(90deg,rgba(205,127,50,.1),transparent); }
.qz-podium { display:flex; align-items:flex-end; justify-content:center; gap:12px; margin:30px 0; }
.qz-pod { text-align:center; border-radius:14px 14px 0 0; padding:16px 20px 12px; min-width:100px; }
.qz-pod-1 { background:linear-gradient(180deg,rgba(255,215,0,.2),rgba(255,215,0,.05)); min-height:160px; }
.qz-pod-2 { background:linear-gradient(180deg,rgba(192,192,192,.15),rgba(192,192,192,.03)); min-height:120px; }
.qz-pod-3 { background:linear-gradient(180deg,rgba(205,127,50,.12),rgba(205,127,50,.03)); min-height:90px; }

/* ═══ ILLUSTRATIONS ═══ */
.illus { opacity:.12; transition:opacity .4s; }
.illus:hover { opacity:.2; }
.illus-hero { position:absolute; pointer-events:none; }
@keyframes float { 0%,100% { transform:translateY(0) rotate(0); } 50% { transform:translateY(-8px) rotate(1deg); } }
@keyframes orbitSlow { 0% { transform:rotate(0deg) translateX(40px) rotate(0deg); } 100% { transform:rotate(360deg) translateX(40px) rotate(-360deg); } }
.orbit { animation:orbitSlow 20s linear infinite; }
.orbit-dot { width:6px; height:6px; border-radius:50%; background:var(--ac); opacity:.25; }

/* ═══ LANDING SHOWCASES ═══ */
.showcase-wrap { position:relative; overflow:hidden; border-radius:20px; background:var(--card); border:1px solid var(--bd); box-shadow:0 12px 40px rgba(0,0,0,.06); }
.showcase-inner { padding:20px; min-height:320px; position:relative; }
.showcase-label { position:absolute; top:12px; left:12px; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; padding:3px 10px; border-radius:6px; background:var(--acs); color:var(--ac); z-index:2; }

/* Fake browser chrome */
.showcase-chrome { display:flex; align-items:center; gap:6px; padding:10px 14px; background:var(--elev); border-bottom:1px solid var(--bd); border-radius:20px 20px 0 0; }
.showcase-dot { width:8px; height:8px; border-radius:50%; }
.showcase-dot:nth-child(1) { background:#ff5f57; }
.showcase-dot:nth-child(2) { background:#febc2e; }
.showcase-dot:nth-child(3) { background:#28c840; }
.showcase-url { margin-left:8px; font-size:10px; color:var(--fa); font-family:'JetBrains Mono',monospace; }

/* Animated typing cursor */
@keyframes blink { 0%,50% { opacity:1; } 51%,100% { opacity:0; } }
.typing-cursor { display:inline-block; width:2px; height:14px; background:var(--ac); margin-left:2px; vertical-align:text-bottom; animation:blink 1s step-end infinite; }

/* Auto-typing text reveal */
@keyframes typeReveal { from { max-width:0; } to { max-width:100%; } }
.type-line { overflow:hidden; white-space:nowrap; display:inline-block; max-width:0; animation:typeReveal 1.5s var(--ease-out-expo) forwards; }
.type-line:nth-child(1) { animation-delay:0.8s; }
.type-line:nth-child(2) { animation-delay:2.5s; }
.type-line:nth-child(3) { animation-delay:4.2s; }

/* Block pop-in for showcase */
@keyframes blockPop { from { opacity:0; transform:translateY(20px) scale(.9); } to { opacity:1; transform:translateY(0) scale(1); } }
.sc-block { opacity:0; animation:blockPop .5s var(--ease-spring) forwards; }
.sc-block:nth-child(1) { animation-delay:.3s; }
.sc-block:nth-child(2) { animation-delay:1.5s; }
.sc-block:nth-child(3) { animation-delay:2.7s; }

/* Progress fill animation */
@keyframes fillProg { from { width:0%; } to { width:var(--fill); } }
.sc-prog-fill { animation:fillProg 3s var(--ease-out-expo) .5s forwards; width:0%; }

/* Score count up */
@keyframes scoreCount { 0% { opacity:0; transform:scale(.5) rotate(-15deg); } 60% { transform:scale(1.1) rotate(2deg); } 100% { opacity:1; transform:scale(1) rotate(0); } }
.sc-score { opacity:0; animation:scoreCount .6s var(--ease-spring) 4s forwards; }

/* Multiplayer dots */
@keyframes dotPulse { 0%,100% { transform:scale(1); opacity:.6; } 50% { transform:scale(1.3); opacity:1; } }
.sc-dot { animation:dotPulse 1.5s ease-in-out infinite; }
.sc-dot:nth-child(2) { animation-delay:.3s; }
.sc-dot:nth-child(3) { animation-delay:.6s; }
.sc-dot:nth-child(4) { animation-delay:.9s; }

/* Showcase hover lift */
.showcase-wrap { transition:all .4s var(--ease-out-expo); }
.showcase-wrap:hover { transform:translateY(-4px); box-shadow:0 16px 50px rgba(0,0,0,.1); }
</style>
</head>
<body class="antialiased h-screen flex flex-col overflow-hidden" data-theme="light">

<!-- NAVBAR -->
<nav class="navg sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div class="flex justify-between h-14">
      <div class="flex items-center cursor-pointer gap-3" onclick="window.app.router.go('home')">
        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:var(--ac)">
          <i data-lucide="feather" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="text-base font-bold" style="letter-spacing:-.02em">HistoryWrite</h1>
          <p class="text-[10px] fm uppercase tracking-widest" style="color:var(--fa)">AP World Modern</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div id="nav-out" class="flex items-center gap-2">
          <button onclick="window.app.router.go('login')" class="btnG text-sm py-2 px-4">Log In</button>
          <button onclick="window.app.router.go('signup')" class="btnP text-sm py-2 px-5">Get Started</button>
        </div>
        <div id="nav-in" class="hidden flex items-center gap-2">
          <button onclick="window.app.ui.toggleSettings()" class="flex items-center gap-2 px-3 py-1.5 rounded-xl transition" style="border:1px solid var(--bd)">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center text-xs font-bold" style="background:var(--acs);color:var(--ac)">
              <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>
            <span id="nav-name" class="hidden md:block text-xs font-semibold">User</span>
          </button>
          <button onclick="window.app.auth.logout()" class="p-2 rounded-lg transition" style="color:var(--fa)" title="Log Out">
            <i data-lucide="log-out" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main id="app-root" class="flex-1 overflow-y-auto relative bg-canvas"></main>

<!-- TOASTS -->
<div id="toast-container" class="fixed top-16 right-4 z-[60] flex flex-col gap-2 pointer-events-none"></div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="hidden">
  <div class="modalBg" onclick="event.target===this&&window.app.ui.toggleSettings()">
    <div class="modalBox">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">Settings</h3>
        <button onclick="window.app.ui.toggleSettings()" style="color:var(--mu)"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="space-y-5">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wider" style="color:var(--mu)">Name</label>
          <input type="text" id="profile-name-input" class="hinp mt-2">
        </div>
        <div id="settings-student-id-wrap">
          <label class="text-xs font-semibold uppercase tracking-wider" style="color:var(--mu)">School Student ID</label>
          <input type="text" id="student-id-input" placeholder="e.g. 123456" class="hinp mt-2">
          <p class="text-[11px] mt-1" style="color:var(--fa)">Your permanent school ID. Used by teachers to export grades into Synergy.</p>
        </div>
        <div id="settings-api-key-wrap">
          <label class="text-xs font-semibold uppercase tracking-wider" style="color:var(--mu)">Claude API Key</label>
          <input type="password" id="api-key-input" placeholder="sk-ant-..." class="hinp mt-2">
          <div id="api-key-status" class="text-[11px] mt-1" style="color:var(--fa)"></div>
          <button type="button" id="set-global-key-btn" onclick="window.app.ui.setGlobalKey()" class="text-[11px] font-semibold mt-2 px-3 py-1.5 rounded-lg transition" style="background:var(--acs);color:var(--ac);border:1px solid var(--bd);cursor:pointer">Set as universal key for all users</button>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wider mb-3 block" style="color:var(--mu)">Theme</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="light" class="peer sr-only">
              <div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)">
                <i data-lucide="sun" class="w-5 h-5 mx-auto" style="color:var(--ac)"></i>
                <span class="text-xs font-semibold mt-1 block">Light</span>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="dark" class="peer sr-only">
              <div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)">
                <i data-lucide="moon" class="w-5 h-5 mx-auto" style="color:var(--ac)"></i>
                <span class="text-xs font-semibold mt-1 block">Dark</span>
              </div>
            </label>
          </div>
        </div>
      </div>
      <button onclick="window.app.ui.saveSettings()" class="btnP w-full mt-6">Save Changes</button>
    </div>
  </div>
</div>

<!-- PRACTICE MODAL -->
<div id="practice-modal" class="hidden">
  <div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('practice-modal')">
    <div class="modalBox modalLg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" id="practice-title">Practice Drill</h3>
        <button onclick="window.app.ui.closeModal('practice-modal')" style="color:var(--mu)"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="practice-prompt" class="mb-4 p-4 rounded-xl text-sm fs leading-relaxed" style="background:var(--elev);border:1px solid var(--bd)"></div>
      <textarea id="practice-response" class="hinp fs" rows="6" placeholder="Write your response..."></textarea>
      <div class="flex justify-end mt-4">
        <button id="submit-practice-btn" onclick="window.app.game.submitPractice()" class="btnP">Submit Response</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, setDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyD2K9kbT3FKq0lHvl8eetv43I8xVkOFvaI",
  authDomain: "history-f02c6.firebaseapp.com",
  projectId: "history-f02c6",
  storageBucket: "history-f02c6.firebasestorage.app",
  messagingSenderId: "676682825829",
  appId: "1:676682825829:web:911e167cb59469c58ec68c"
});
const auth = getAuth(app);
const db = getFirestore(app);

const appState = {
  user: null,
  userData: null,
  apiKey: localStorage.getItem('anthropic_key') || '',
  activeAssignment: null,
  practiceContext: null,
  demoMode: false
};

const DEMO_ASSIGNMENT = {
  id: 'demo',
  title: 'Columbian Exchange LEQ (Demo)',
  type: 'leq',
  prompt: 'Evaluate the extent to which the Columbian Exchange transformed global economies between 1450 and 1750.',
  maxAttempts: 99,
  structure: { kind: 'leq', focusSkills: ['thesis', 'context', 'evidence', 'reasoning'] },
  demo: true
};

const DEMO_ESSAY = `The Columbian Exchange fundamentally transformed global economies between 1450 and 1750 because it introduced new crops, established trade networks, and created systems of forced labor that reshaped production across continents.

Before the Columbian Exchange, the economies of the Eastern and Western hemispheres operated largely in isolation from one another. European economies were based primarily on feudal agriculture, while the Americas had developed their own agricultural systems centered around crops like maize and potatoes.

The introduction of New World crops to the Old World significantly boosted population growth and economic output. Potatoes became a staple food across northern Europe, particularly in Ireland and parts of Germany, allowing populations to grow rapidly between the 16th and 18th centuries. Similarly, the introduction of maize to Africa provided new food sources that sustained growing populations.

Silver from the mines of Potosi in modern-day Bolivia became the backbone of global trade. Spanish colonizers used the mita labor system to force indigenous workers to extract massive quantities of silver, which then flowed to Europe and Asia through established trade networks. By the late 1500s, Spanish silver accounted for a large portion of global currency, connecting economies from Manila to Seville.

The Atlantic slave trade emerged as a direct consequence of the Columbian Exchange. European demand for sugar, tobacco, and cotton in the Americas led to the forced migration of millions of Africans. This system of exploitation generated enormous wealth for European colonial powers while devastating African societies and economies.

Overall, the Columbian Exchange had a big impact on the world economy and changed many things for different groups of people across the globe.`;

const LIBRARY_TEMPLATES = [
  { title: "Dar al-Islam SAQ", type: "saq", prompt: "Identify and explain ONE way Islamic states maintained political authority 1200–1450.", maxAttempts: 3 },
  { title: "Silver Trade DBQ", type: "dbq", prompt: "Evaluate the extent to which silver affected global economies 1550–1800.", sources: [{ title: "Document 1", type: "text", content: "Spanish silver from Potosí mines..." }], maxAttempts: 2 },
  { title: "Industrial Rev LEQ", type: "leq", prompt: "Evaluate the extent to which geographic factors caused industrialization differences 1750–1900.", maxAttempts: 3 },
  { title: "Mongol Empire SAQ", type: "saq", prompt: "Identify ONE way the Mongol Empire facilitated cultural exchange across Eurasia 1200–1350.", maxAttempts: 3 },
  { title: "Atlantic Revolutions LEQ", type: "leq", prompt: "Evaluate the extent to which Enlightenment ideas influenced political revolutions 1750–1900.", maxAttempts: 3 },
  { title: "Imperialism DBQ", type: "dbq", prompt: "Evaluate the extent to which state imperialism was driven by economic motives 1750–1900.", sources: [], maxAttempts: 2 }
];

const CHRONO_EVENTS = [
  { event: "Fall of Rome", date: 476, era: "Post-Classical" },
  { event: "Rise of Islam", date: 622, era: "Post-Classical" },
  { event: "Tang Dynasty begins", date: 618, era: "Post-Classical" },
  { event: "Battle of Hastings", date: 1066, era: "Post-Classical" },
  { event: "First Crusade", date: 1096, era: "Post-Classical" },
  { event: "Magna Carta", date: 1215, era: "Post-Classical" },
  { event: "Mongols take Baghdad", date: 1258, era: "Post-Classical" },
  { event: "Black Death reaches Europe", date: 1347, era: "Post-Classical" },
  { event: "Ming Dynasty founded", date: 1368, era: "Post-Classical" },
  { event: "Fall of Constantinople", date: 1453, era: "Early Modern" },
  { event: "Columbus reaches Americas", date: 1492, era: "Early Modern" },
  { event: "Luther's 95 Theses", date: 1517, era: "Early Modern" },
  { event: "Spanish Armada defeated", date: 1588, era: "Early Modern" },
  { event: "Jamestown founded", date: 1607, era: "Early Modern" },
  { event: "Thirty Years' War begins", date: 1618, era: "Early Modern" },
  { event: "Qing Dynasty established", date: 1644, era: "Early Modern" },
  { event: "Glorious Revolution", date: 1688, era: "Early Modern" },
  { event: "American Independence", date: 1776, era: "Modern" },
  { event: "French Revolution begins", date: 1789, era: "Modern" },
  { event: "Haitian Revolution", date: 1791, era: "Modern" },
  { event: "Congress of Vienna", date: 1815, era: "Modern" },
  { event: "Communist Manifesto", date: 1848, era: "Modern" },
  { event: "Meiji Restoration", date: 1868, era: "Modern" },
  { event: "Berlin Conference", date: 1884, era: "Modern" },
  { event: "Boxer Rebellion", date: 1900, era: "Modern" },
  { event: "Justinian's Code compiled", date: 529, era: "Post-Classical" },
  { event: "Sui Dynasty reunifies China", date: 589, era: "Post-Classical" },
  { event: "Battle of Tours", date: 732, era: "Post-Classical" },
  { event: "Charlemagne crowned Emperor", date: 800, era: "Post-Classical" },
  { event: "Song Dynasty begins", date: 960, era: "Post-Classical" },
  { event: "Great Schism (East-West)", date: 1054, era: "Post-Classical" },
  { event: "Mansa Musa's hajj", date: 1324, era: "Post-Classical" },
  { event: "Aztec Empire founded", date: 1428, era: "Post-Classical" },
  { event: "Gutenberg printing press", date: 1440, era: "Early Modern" },
  { event: "Vasco da Gama reaches India", date: 1498, era: "Early Modern" },
  { event: "Cortés conquers Aztecs", date: 1521, era: "Early Modern" },
  { event: "Council of Trent begins", date: 1545, era: "Early Modern" },
  { event: "Akbar rules Mughal Empire", date: 1556, era: "Early Modern" },
  { event: "Dutch East India Co. founded", date: 1602, era: "Early Modern" },
  { event: "Tokugawa Shogunate begins", date: 1603, era: "Early Modern" },
  { event: "English Civil War begins", date: 1642, era: "Early Modern" },
  { event: "Treaty of Westphalia", date: 1648, era: "Early Modern" },
  { event: "Peter the Great modernizes Russia", date: 1700, era: "Early Modern" },
  { event: "Seven Years' War begins", date: 1756, era: "Modern" },
  { event: "Watt's steam engine improved", date: 1769, era: "Modern" },
  { event: "Latin American revolutions begin", date: 1810, era: "Modern" },
  { event: "Opium War begins", date: 1839, era: "Modern" },
  { event: "Sepoy Rebellion in India", date: 1857, era: "Modern" },
  { event: "Suez Canal opens", date: 1869, era: "Modern" },
  { event: "Scramble for Africa begins", date: 1881, era: "Modern" },
  { event: "Russo-Japanese War", date: 1905, era: "Modern" },
  { event: "Chinese Revolution (Qing falls)", date: 1911, era: "Modern" },
  { event: "World War I begins", date: 1914, era: "Modern" },
  { event: "Russian Revolution", date: 1917, era: "Modern" },
  { event: "Treaty of Versailles", date: 1919, era: "Modern" }
];

const PRACTICE_BANK = {
  thesis: [
    { scenario:"The spread of Buddhism along the Silk Road transformed East and Southeast Asian societies between 200 BCE and 1000 CE.", hint:"A strong thesis makes a defensible claim and previews your line of reasoning (what + why/how).", checks:["defensible claim","line of reasoning","addresses the prompt","specific time/place"], keywords:["because","due to","led to","as a result","although","primarily","fundamentally","transformed","significant"] },
    { scenario:"Evaluate the extent to which the Atlantic slave trade reshaped African societies between 1500 and 1800.", hint:"Use 'Evaluate the extent' to show nuance — was the change total, partial, or limited?", checks:["defensible claim","line of reasoning","addresses the prompt","shows extent/degree"], keywords:["because","due to","although","while","extent","significantly","largely","transformed","reshaped"] },
    { scenario:"Evaluate the extent to which the printing press changed European society between 1450 and 1648.", hint:"Think about multiple categories of change: political, social, religious, intellectual.", checks:["defensible claim","line of reasoning","addresses the prompt","specific categories"], keywords:["because","due to","although","enabled","facilitated","challenged","undermined","religious","political"] },
    { scenario:"Evaluate the extent to which the Mongol Empire facilitated cultural exchange across Eurasia between 1200 and 1400.", hint:"Consider the Pax Mongolica — what flowed along those trade routes?", checks:["defensible claim","line of reasoning","addresses the prompt","specific time/place"], keywords:["because","due to","Pax Mongolica","facilitated","exchange","connected","silk road","trade"] }
  ],
  contextualization: [
    { scenario:"You are writing an essay about the causes of the French Revolution (1789). Write 2-3 sentences of historical context that sets the stage.", hint:"Contextualization means BROADER context — trends or events BEFORE or AROUND the topic, not the topic itself.", checks:["broader trend","before/around the topic","specific details","connects to prompt"], keywords:["Enlightenment","ancien régime","estates","inequality","American Revolution","monarchy","debt","famine","1780s","Voltaire","Rousseau","Louis"] },
    { scenario:"You are writing about the effects of the Industrial Revolution on European cities (1750-1900). Provide contextualization.", hint:"What was happening in Europe BEFORE industrialization that set the stage?", checks:["broader trend","before/around the topic","specific details","connects to prompt"], keywords:["agricultural revolution","enclosure","population","rural","mercantilism","cottage industry","steam","coal","urbanization","1700s"] },
    { scenario:"You are writing about the decline of the Ottoman Empire in the 19th century. Provide contextualization.", hint:"What broader global forces were pressuring empires during this period?", checks:["broader trend","before/around the topic","specific details","connects to prompt"], keywords:["nationalism","industrialization","European","imperialism","tanzimat","reform","military","Napoleonic","decline","19th century","Balkans"] }
  ],
  evidence: [
    { scenario:"The prompt asks: 'Evaluate the extent to which trade networks facilitated cultural exchange 1200-1450.' Provide TWO specific pieces of historical evidence.", hint:"Good evidence = specific names, dates, places, events. Not vague generalizations.", checks:["two distinct examples","specific names/dates","relevant to prompt","different regions/aspects"], keywords:["Silk Road","Ibn Battuta","Marco Polo","Mongol","Mali","Mansa Musa","Indian Ocean","Song","Yuan","Swahili","1200","1300","1400","gold","Islam","Buddhism"] },
    { scenario:"The prompt asks: 'Evaluate the effects of European maritime exploration 1450-1750.' Provide TWO specific pieces of evidence.", hint:"Think about Columbian Exchange, colonization, trade — pick two different effects.", checks:["two distinct examples","specific names/dates","relevant to prompt","different effects"], keywords:["Columbus","1492","Cortés","Aztec","Potosí","silver","Manila","smallpox","potato","sugar","plantation","encomienda","1500","1600"] },
    { scenario:"The prompt asks: 'Evaluate the causes of World War I.' Provide TWO specific pieces of evidence.", hint:"Think about alliances, militarism, imperialism, nationalism — pick specific examples.", checks:["two distinct examples","specific names/dates","relevant to prompt","explains significance"], keywords:["Bismarck","alliance","Triple","Balkans","assassination","Archduke","1914","arms race","dreadnought","Morocco","Bosnia","nationalism","imperialism"] }
  ],
  sourcing: [
    { scenario:"Document: 'I, a Jesuit missionary in China, write to Rome that Confucian values are compatible with Christianity, and Chinese converts should be allowed to honor their ancestors.' — Matteo Ricci, letter to Vatican, 1603.\n\nAnalyze this source's POV, purpose, audience, or historical situation.", hint:"HAPP = Historical situation, Audience, Purpose, Point of View. Pick at least one and explain HOW it affects the document.", checks:["identifies HAPP element","explains HOW it affects content","specific to this document","uses evidence from doc"], keywords:["Jesuit","missionary","purpose","convince","Rome","Vatican","audience","POV","convert","accommodate","Chinese Rites","situation","Counter-Reformation"] },
    { scenario:"Document: 'The factory system has brought prosperity to our nation. Workers earn wages and can purchase goods their grandparents never imagined.' — British Parliament member, speech to House of Commons, 1833.\n\nAnalyze this source.", hint:"Who is speaking, to whom, and why? What would they gain or lose from this position?", checks:["identifies HAPP element","explains HOW it affects content","specific to this document","considers bias/motivation"], keywords:["Parliament","political","purpose","defend","factory","industrialist","audience","Commons","POV","wealthy","bias","interest","reform","child labor","1833"] }
  ],
  reasoning: [
    { scenario:"You've argued that the Columbian Exchange transformed the Americas. You have evidence about crop exchange and disease. Write 2-3 sentences of REASONING that connects this evidence to your thesis.", hint:"Reasoning = explaining HOW/WHY your evidence proves your point. Use comparison, causation, or CCOT.", checks:["connects evidence to thesis","explains HOW/WHY","uses historical thinking","goes beyond description"], keywords:["because","therefore","this demonstrates","as a result","caused","led to","transformed","which meant","consequently","this shows that","comparison","causation"] },
    { scenario:"You've argued that gunpowder empires (Ottoman, Safavid, Mughal) maintained power through military technology 1450-1750. Write reasoning connecting military evidence to your thesis.", hint:"Don't just describe — explain the MECHANISM. How did the military → political power → empire stability?", checks:["connects evidence to thesis","explains mechanism","uses historical thinking","goes beyond description"], keywords:["because","enabled","maintained","consolidated","centralized","therefore","this meant","power","authority","legitimacy","control","which allowed"] }
  ],
  complexity: [
    { scenario:"Your essay argues the Columbian Exchange was transformative. Write 2-3 sentences that demonstrate COMPLEX understanding.", hint:"Complexity = nuance. Try: counterargument, different perspectives, cross-period connection, or qualifying your argument.", checks:["goes beyond basic argument","shows nuance","addresses counter/alternative","connects across time/place"], keywords:["although","however","while","conversely","on the other hand","not all","varied","uneven","both","complex","nuanced","across","similar to","unlike","long-term","short-term"] },
    { scenario:"Your essay argues nationalism caused political change 1750-1900. Add complexity.", hint:"Think about who benefited vs. who was harmed, or how the same force had different effects in different places.", checks:["goes beyond basic argument","shows nuance","multiple perspectives","connects across regions"], keywords:["although","however","while","different","varied","Europe","Latin America","Asia","both","unify","divide","elite","popular","uneven","paradox"] }
  ],
  identify: [
    { scenario:"Identify ONE way in which the expansion of Islamic trade networks affected sub-Saharan Africa between 1200 and 1450.", hint:"'Identify' means name the thing clearly — no need to explain at length, just be specific.", checks:["names one specific development","relevant to prompt","within time period","historically accurate"], keywords:["Islam","Swahili","gold","salt","Mansa Musa","Mali","Timbuktu","mosque","merchant","conversion","Arabic","trade","1200","1300","1400","trans-Saharan"] },
    { scenario:"Identify ONE technological innovation that facilitated maritime exploration between 1400 and 1600.", hint:"Be specific — name the technology and briefly note its significance.", checks:["names one specific technology","relevant to exploration","within time period","historically accurate"], keywords:["compass","astrolabe","caravel","lateen","sail","cartography","map","navigation","stern","rudder","Portuguese","Chinese","1400","1500"] }
  ],
  describe: [
    { scenario:"Describe the encomienda system in Spanish colonies in the Americas during the 1500s.", hint:"'Describe' = explain WHAT it was and HOW it worked in 2-3 clear sentences.", checks:["explains what it was","explains how it worked","specific details","within time period"], keywords:["encomienda","Spanish","indigenous","labor","land","grant","conquistador","tribute","forced","colonial","1500","Americas","native","convert"] },
    { scenario:"Describe the role of the Indian Ocean trade network between 1200 and 1450.", hint:"Think about WHO traded, WHAT was traded, and HOW the network operated.", checks:["explains what it was","explains how it worked","specific goods/routes","within time period"], keywords:["Indian Ocean","monsoon","dhow","Swahili","spice","silk","porcelain","Gujarat","Malacca","Chinese","Arab","merchant","network","1200","1300"] }
  ],
  explain: [
    { scenario:"Explain ONE cause of the decline of the Byzantine Empire by 1453.", hint:"'Explain' = give the cause AND explain WHY/HOW it led to decline. Connect cause → effect.", checks:["identifies a cause","explains WHY it caused decline","cause-effect connection","specific details"], keywords:["Ottoman","Seljuk","crusade","1204","Constantinople","military","trade","Venice","plague","territory","siege","1453","Mehmed","because","led to","weakened"] },
    { scenario:"Explain how the development of joint-stock companies affected European exploration and colonization between 1500 and 1700.", hint:"Name the mechanism — HOW did joint-stock companies change what was possible?", checks:["identifies mechanism","explains HOW it affected","cause-effect connection","specific details"], keywords:["joint-stock","Dutch East India","British East India","VOC","investor","risk","capital","profit","colony","trade","monopoly","charter","1600","because","enabled","allowed"] }
  ]
};

const THESIS_PROMPTS = [
  "Evaluate the extent to which the Columbian Exchange transformed global economies 1450–1750.",
  "Evaluate the extent to which the Mongol Empire affected interregional trade 1200–1350.",
  "Evaluate the extent to which industrialization changed social hierarchies 1750–1900.",
  "Evaluate the extent to which maritime exploration changed global trade patterns 1450–1750.",
  "Evaluate the extent to which the Atlantic slave trade affected societies in Africa and the Americas 1500–1800.",
  "Evaluate the extent to which nationalism influenced political movements 1750–1900.",
  "Evaluate the extent to which the spread of Islam facilitated cultural exchange 600–1450.",
  "Evaluate the extent to which environmental factors shaped civilizations 1200–1450."
];

const SOURCE_CASES = [
  { excerpt: "I, a Spanish official at the silver mines of Potosí, write to Your Majesty: revenues increase, though Indian workers grow restless under the mita labor system…", attribution: "Spanish colonial administrator to Philip II, 1580", pov: "Spanish imperial official", audience: "The Spanish monarch", purpose: "Justify colonial policies and request support", context: "Spanish silver extraction using coerced indigenous labor" },
  { excerpt: "As a Chinese scholar-official, I lament the corruption as foreign silver floods our markets, encouraging greed among those who should uphold Confucian values…", attribution: "Memorial to the Ming Emperor, 1590", pov: "Chinese scholar-official", audience: "The Emperor and imperial court", purpose: "Criticize moral decline and advocate reform", context: "Ming China experiencing massive silver inflows" },
  { excerpt: "We have witnessed destruction of our temples by foreign missionaries. Yet trade with the Portuguese brings iron tools our village greatly needs…", attribution: "Kongolese elder, recorded by Jesuit missionary, 1620", pov: "Indigenous African leader", audience: "Community members", purpose: "Express tension between cultural loss and material benefit", context: "European-African contact in Central Africa" },
  { excerpt: "Workers in my mill produce cloth at unimaginable rates. Yet children as young as eight work fourteen-hour days, and the air is thick with cotton dust…", attribution: "British factory owner diary, Manchester, 1832", pov: "British industrial capitalist", audience: "Private diary (self-reflection)", purpose: "Reconcile profit motive with moral concerns about labor", context: "Industrial Revolution transforming labor in Britain" },
  { excerpt: "The natives of this island are remarkably docile and could easily be made to work and sow crops. With fifty men we could subjugate them all and make them do whatever we wish…", attribution: "Christopher Columbus, journal entry, 1492", pov: "European explorer", audience: "Spanish monarchs (Ferdinand & Isabella)", purpose: "Persuade sponsors to fund further expeditions", context: "First European contact with Caribbean peoples" },
  { excerpt: "Our Confucian teachings and examination system have produced virtuous leaders for a thousand years. Why should we abandon this wisdom for Western barbarian methods?", attribution: "Qing Dynasty court advisor to Empress Dowager Cixi, 1898", pov: "Conservative court official", audience: "The Empress and imperial court", purpose: "Resist Western-style reforms and preserve tradition", context: "Debate over modernization in late Qing China" },
  { excerpt: "I have seen the future in this American factory system. If Japan does not industrialize quickly, we will become another China — carved up by Western powers.", attribution: "Japanese Meiji reformer, government report, 1872", pov: "Meiji government reformer", audience: "Japanese government officials", purpose: "Argue for rapid industrialization and Western-style reforms", context: "Japan's Meiji Restoration modernization program" },
  { excerpt: "The civilized nations of Europe have a duty to bring progress to the dark places of the earth. Commerce and Christianity shall uplift the African from his primitive state.", attribution: "King Leopold II of Belgium, public speech, 1876", pov: "European imperialist ruler", audience: "European public and diplomats", purpose: "Justify colonization of Africa using civilizing mission rhetoric", context: "Scramble for Africa and the Berlin Conference era" },
  { excerpt: "We Hindus and Muslims must unite against our common oppressor. Swaraj — self-rule — is the birthright of every Indian, and we shall have it through peaceful resistance.", attribution: "Indian National Congress pamphlet, 1920", pov: "Indian nationalist leader", audience: "Indian public across religions", purpose: "Build a united independence movement against British rule", context: "Growing Indian nationalism after World War I" },
  { excerpt: "The trade in human beings has enriched our kingdom greatly, but I fear we sell our own people too cheaply. The Portuguese demand ever more captives, and our villages grow empty.", attribution: "West African king, letter to Portuguese trading partner, 1526", pov: "African ruler engaged in slave trade", audience: "European trading partner", purpose: "Negotiate better terms while expressing concern about depopulation", context: "Atlantic slave trade's impact on African kingdoms" },
  { excerpt: "These Protestant rebels threaten not only the unity of the Church but the stability of all Christian kingdoms. Their heresy must be stamped out before it spreads further.", attribution: "Pope Leo X, papal decree, 1520", pov: "Catholic Church leader", audience: "Catholic rulers and clergy across Europe", purpose: "Rally opposition to the Protestant Reformation", context: "Early years of the Protestant Reformation" },
  { excerpt: "Our hacienda produces more sugar than ever before, yet the enslaved workers sicken and die so quickly we must constantly purchase more from Africa. This is simply the cost of commerce.", attribution: "Brazilian plantation owner, letter to business partner, 1650", pov: "Colonial plantation owner", audience: "Business associates", purpose: "Report on plantation economics and justify continued slave purchases", context: "Sugar plantation economy in colonial Brazil" }
];

const POV_OPTIONS = ["Spanish imperial official","Chinese scholar-official","Indigenous African leader","British industrial capitalist","European explorer","Conservative court official","Meiji government reformer","European imperialist ruler","Indian nationalist leader","African ruler engaged in slave trade","Catholic Church leader","Colonial plantation owner"];
const AUD_OPTIONS = ["The Spanish monarch","The Emperor and imperial court","Community members","Private diary (self-reflection)","Spanish monarchs (Ferdinand & Isabella)","The Empress and imperial court","Japanese government officials","European public and diplomats","Indian public across religions","European trading partner","Catholic rulers and clergy across Europe","Business associates"];
const PURP_OPTIONS = ["Justify colonial policies and request support","Criticize moral decline and advocate reform","Express tension between cultural loss and material benefit","Reconcile profit motive with moral concerns about labor","Persuade sponsors to fund further expeditions","Resist Western-style reforms and preserve tradition","Argue for rapid industrialization and Western-style reforms","Justify colonization of Africa using civilizing mission rhetoric","Build a united independence movement against British rule","Negotiate better terms while expressing concern about depopulation","Rally opposition to the Protestant Reformation","Report on plantation economics and justify continued slave purchases"];

// ═══ ESSAY BLOCKS — Block Templates ═══
const BLOCK_TEMPLATES = {
  saq: (prompt, parts = 3) => {
    const labels = ['a','b','c','d'];
    const emojis = ['🔍','💡','🔗','🎯'];
    const guides = [
      'Identify the key concept or event described in the prompt.',
      'Explain the significance — why did this matter?',
      'Make a connection to a broader historical pattern or another event.',
      'Analyze the long-term impact or legacy.'
    ];
    return Array.from({length: Math.min(parts, 4)}, (_, i) => ({
      id: `saq-${labels[i]}`,
      label: `Part ${labels[i].toUpperCase()}`,
      emoji: emojis[i],
      question: guides[i],
      hint: `Think about specific historical evidence you can cite. Use names, dates, and places.`,
      minWords: 30
    }));
  },
  leq: (prompt) => [
    { id: 'leq-ctx', label: 'Set the Scene', emoji: '🌍', question: 'What was happening in the world at this time? Set the historical context — describe the big picture before your argument.', hint: 'Think about political, economic, social, or cultural conditions that existed before or during the topic.', minWords: 40 },
    { id: 'leq-thesis', label: 'Your Argument', emoji: '⚔️', question: 'What\'s your main argument? State a clear, defensible claim with a line of reasoning.', hint: 'A strong thesis uses "because" and previews 2-3 supporting points. Take a stance!', minWords: 25 },
    { id: 'leq-ev1', label: 'Evidence #1', emoji: '📜', question: 'Give your first piece of specific historical evidence that supports your argument. Explain how it proves your point.', hint: 'Name a specific event, person, policy, or development. Then explain WHY it supports your thesis.', minWords: 50 },
    { id: 'leq-ev2', label: 'Evidence #2', emoji: '📖', question: 'Now give a second piece of evidence. Pick something different from your first — show range!', hint: 'Try a different category: if your first was political, go economic or social. Connect it back to your thesis.', minWords: 50 },
    { id: 'leq-analysis', label: 'So What?', emoji: '🧠', question: 'Analyze HOW your evidence supports your argument. What patterns or comparisons do you see?', hint: 'Use words like "this demonstrates," "as a result," "this pattern shows." Compare, contrast, or show cause/effect.', minWords: 40 },
    { id: 'leq-complex', label: 'Level Up', emoji: '🏆', question: 'Show complexity! Acknowledge a counterargument, different perspective, or connect to another time period.', hint: 'Start with "However," or "While this is true," to show you can think beyond your main argument.', minWords: 30 }
  ],
  dbq: (prompt, sources = []) => {
    const docPicks = sources.slice(0, Math.min(sources.length, 4));
    const happ = [
      (s) => `Read ${s.label} below. What is the author's MAIN ARGUMENT? In 2-3 sentences, explain what they are saying and how it connects to the thesis above.`,
      (s) => `Read ${s.label} below. Analyze the author's POINT OF VIEW. How does who they are (their job, nationality, or social position) shape what they wrote? What does this reveal?`,
      (s) => `Read ${s.label} below. What was the author's PURPOSE for writing this? Who was their AUDIENCE? How does knowing this change how we should read the document?`,
      (s) => `Read ${s.label} below. Identify ONE specific claim or detail from this document. Explain how the HISTORICAL SITUATION at the time helps us understand why this was written.`
    ];
    const hints = [
      'Focus on the key point the author is making. Use a specific detail or quote from the text.',
      'Think: WHY does this person see things this way? Their identity shapes their perspective.',
      'Was this meant to persuade, inform, protest, or report? That changes everything about how we read it.',
      'Connect the document to specific events or conditions happening during this time period.'
    ];
    const emojis = ['🔎','📑','🔍','📋'];
    const blocks = [
      { id: 'dbq-ctx', label: 'Set the Scene', emoji: '🌍', question: 'In 2-3 sentences, describe the historical context. What was happening BEFORE or DURING this time period that helps explain the topic?', hint: 'Don\'t reference any documents — use your outside knowledge. Think big picture: political, economic, or social conditions.', minWords: 25 }
    ];
    docPicks.forEach((s, i) => {
      blocks.push({ id: `dbq-doc${i+1}`, label: `Analyze ${s.label}`, emoji: emojis[i], question: happ[i % happ.length](s), hint: hints[i % hints.length], minWords: 25, docIndex: i });
    });
    blocks.push({ id: 'dbq-finish', label: 'Finish Strong', emoji: '🏆', question: 'Do TWO things: (1) Name ONE specific piece of outside evidence (not from any document) that supports the thesis. (2) In 1-2 sentences, explain why the thesis might be more complicated than it seems — what\'s a counterargument?', hint: 'Be SPECIFIC with outside evidence — name a person, event, or policy with a date. For complexity, start with "However..." or "While this is true..."', minWords: 30 });
    return blocks;
  }
};

const ESSAY_BLOCKS_PROMPTS = [
  { type: 'leq', title: 'Maritime Empires LEQ', prompt: 'Evaluate the extent to which maritime empires in the period 1450–1750 transformed global trade networks.', difficulty: 'Medium' },
  { type: 'leq', title: 'Industrial Revolution LEQ', prompt: 'Evaluate the extent to which the Industrial Revolution (1750–1900) changed social structures in ONE of the following regions: Europe, East Asia, or Latin America.', difficulty: 'Medium' },
  { type: 'saq', title: 'Columbian Exchange SAQ', prompt: 'a) Identify ONE biological exchange that occurred as a result of the Columbian Exchange.\nb) Explain ONE economic effect of the Columbian Exchange on the Americas.\nc) Explain ONE way the Columbian Exchange affected population patterns in Afro-Eurasia.', difficulty: 'Easy', parts: 3 },
  { type: 'saq', title: 'Mongol Empire SAQ', prompt: 'a) Identify ONE way the Mongol Empire facilitated trade across Eurasia.\nb) Explain ONE negative consequence of Mongol expansion.\nc) Explain how the Mongol Empire contributed to cultural exchange between East and West.', difficulty: 'Easy', parts: 3 },
  { type: 'leq', title: 'Imperialism LEQ', prompt: 'Evaluate the extent to which European imperialism in the period 1750–1900 was driven by economic motives versus ideological justifications.', difficulty: 'Hard' },
  { type: 'leq', title: 'Decolonization LEQ', prompt: 'Compare the processes of decolonization in TWO of the following regions: South Asia, Sub-Saharan Africa, or Southeast Asia.', difficulty: 'Hard' },
  {
    type: 'dbq',
    title: 'APWH 6.4 — Global Economy DBQ',
    prompt: 'Evaluate the extent to which industrialization changed global economic relationships in the period 1750–1900.',
    difficulty: 'Hard',
    thesis: 'Industrialization fundamentally transformed global economic relationships between 1750 and 1900 by creating new systems of factory production that enriched industrialized nations while forcing non-industrialized regions into economic dependency as suppliers of raw materials and consumers of manufactured goods.',
    structure: {
      sources: [
        {
          label: 'Document 1',
          attribution: 'Adam Smith, The Wealth of Nations, Book I, 1776',
          type: 'text',
          content: 'The greatest improvement in the productive powers of labor, and the greater part of the skill, dexterity, and judgment with which it is anywhere directed or applied, seem to have been the effects of the division of labor. A man draws the wire, another straightens it, a third cuts it, a fourth points it, a fifth grinds it. Those ten persons could make among them upwards of forty-eight thousand pins in a day. But if they had all wrought separately and independently, they could not each of them have made twenty — perhaps not one pin in a day.'
        },
        {
          label: 'Document 2',
          attribution: 'Imperial Commissioner Lin Zexu, letter to Queen Victoria of Britain, 1839',
          type: 'text',
          content: 'We have heard that in your honorable nation the rules of morality are strictly observed. How is it that you have not forbidden your merchants to deal in opium? Your country lies twenty thousand leagues away, but its subjects dare to sail to China and peddle this poison for profit. The wealth of China is used to profit the barbarians — that is to say, the great profit made by barbarians is all taken from the rightful share of China. By what right do they use this noxious article to injure the Chinese people? I pray you, O sovereign, take back and burn the foreign opium ships and ban the opium trade forever.'
        },
        {
          label: 'Document 3',
          attribution: 'Tokugawa Akitake, official Japanese observer, report on the 1867 Paris Exposition, submitted to the Meiji government',
          type: 'text',
          content: 'We witnessed machinery of extraordinary variety — spinning looms that produce in one hour what a hundred weavers could not complete in a day, steam engines of fearsome power driving whole factories from a single coal-fired furnace. The Western nations have achieved mastery over natural forces. Japan must study these techniques with urgency. If we do not build our own factories and railways, we shall find ourselves purchasing Western goods forever and selling raw silk and lacquerware at the prices they dictate. Our nation must industrialize or remain permanently subordinate in the new world order of commerce.'
        },
        {
          label: 'Document 4',
          attribution: 'Report of the Indian Railways Commission, submitted to the British Parliament, 1854',
          type: 'text',
          content: 'The extension of railways into the interior of India will deliver several great benefits to British commerce. Raw cotton from the Deccan, jute from Bengal, and wheat from the Punjab can be conveyed swiftly to the ports for export to England\'s mills. At the same time, British manufactured textiles, hardware, and tools can penetrate markets previously inaccessible. India\'s vast interior, with its millions of inhabitants, represents a commercial opportunity of incalculable magnitude — one that only a modern railway system can unlock for the mutual benefit of the Empire.'
        },
        {
          label: 'Document 5',
          attribution: 'Report of the Committee on Factory Children\'s Labor, British Parliament, 1832',
          type: 'text',
          content: 'We found children of very tender age — some as young as five or six years — working in the mills for twelve to fourteen hours daily, often in poorly ventilated rooms filled with dust and cotton fibers. Many showed signs of physical deformity from standing at machines for prolonged periods. The parents, themselves earning starvation wages, saw no alternative but to send their children to the factories. The mill owners, however, maintained that without child labor, the price of British cloth would rise and foreign competitors would seize their markets.'
        },
        {
          label: 'Document 6',
          attribution: 'Karl Marx and Friedrich Engels, The Communist Manifesto, 1848',
          type: 'text',
          content: 'The bourgeoisie has through its exploitation of the world market given a cosmopolitan character to production and consumption in every country. All old-established national industries have been destroyed or are daily being destroyed. They are dislodged by new industries, whose introduction becomes a life-and-death question for all civilized nations — industries that no longer work up indigenous raw material, but raw material drawn from the remotest zones. In place of the old wants, satisfied by the production of the country, we find new wants, requiring for their satisfaction the products of distant lands and climes.'
        }
      ]
    }
  },
  {
    type: 'dbq',
    title: 'APWH 6.5 — Economic Imperialism DBQ',
    prompt: 'Evaluate the extent to which economic motives drove European imperialism in Africa and Asia in the period 1750–1900.',
    difficulty: 'Hard',
    thesis: 'European imperialism in Africa and Asia from 1750 to 1900 was primarily driven by economic motives — the need for raw materials, new markets for manufactured goods, and investment opportunities — though these economic goals were often justified through ideological claims of racial and civilizational superiority.',
    structure: {
      sources: [
        {
          label: 'Document 1',
          attribution: 'Cecil Rhodes, British colonial magnate and politician, "Confession of Faith," 1877',
          type: 'text',
          content: 'I contend that we are the finest race in the world and that the more of the world we inhabit the better it is for the human race. I have found in the study of history that commerce has been the first motive of nearly all colonial enterprise. We must find new lands from which we can easily obtain raw materials and at the same time exploit the cheap labor that is available from the natives of those countries. Africa is still lying ready for us — it is our duty to take it. It is our duty to seize every opportunity of acquiring more territory.'
        },
        {
          label: 'Document 2',
          attribution: 'Dadabhai Naoroji, Indian nationalist leader and member of the British Parliament, "Poverty and Un-British Rule in India," 1876',
          type: 'text',
          content: 'The millions of India are now groaning under British economic rule. England takes from India year after year vast amounts of wealth in the form of salaries to English officers, interest on loans, pensions, and the profits of British-owned businesses — wealth that India produces but never sees returned. This "drain of wealth" amounts to tens of millions of pounds annually. India is impoverished, not because her people are lazy, but because the entire structure of British rule is designed to extract resources for Britain\'s benefit. The Indian weaver who once clothed the world has been ruined by cheap Lancashire mill cloth, forced upon us by free-trade policies we had no voice in making.'
        },
        {
          label: 'Document 3',
          attribution: 'King Jaja of Opobo (present-day Nigeria), letter to the British Consul General, 1887',
          type: 'text',
          content: 'I have always welcomed honest trade and I have maintained commerce with English firms for many years. But your consul now demands that I open my rivers to British traders directly, cutting out my position as middleman in the palm oil trade. This is not free trade — it is coercion. I built Opobo on commerce, and I have made it prosperous. The English merchants wish to take the profits of the interior trade for themselves and reduce my people to laborers on our own land. I will not sign any agreement that strips my people of the trade that is rightfully ours.'
        },
        {
          label: 'Document 4',
          attribution: 'Jules Ferry, Prime Minister of France, speech to the French Chamber of Deputies, 1884',
          type: 'text',
          content: 'Gentlemen, we must speak more loudly and more honestly! We must say openly that indeed the higher races have a right over the lower races — they have a duty to civilize the inferior races. But I insist that the great movement of colonial policy is a daughter of the industrial movement. Colonial policy is the daughter of economic policy. Is it not obvious that the great industrial nations have an absolute need for markets? For the export of capital as well as goods? Colonies are for us, from this angle, necessary investments for the future, markets for our surplus goods, and sources of raw materials that our factories require.'
        },
        {
          label: 'Document 5',
          attribution: 'E.D. Morel, British journalist and reformer, "The Black Man\'s Burden: The White Man in Africa," 1903',
          type: 'text',
          content: 'King Leopold\'s Congo Free State has revealed to the world the true face of economic imperialism stripped of its pretenses. Under the guise of bringing civilization and ending Arab slavery, Leopold has created a system of terror without parallel. Every Congolese man, woman, and child has been assigned a rubber quota. Those who fail to deliver are mutilated — their hands cut off as proof that cartridges were not wasted. Villages are burned, hostages taken, and a people who numbered twenty million at the start of Leopold\'s rule have been reduced, by the estimates of missionaries, to perhaps eight or nine million. All of this horror has produced rubber and ivory — profit for a king and his shareholders in Brussels.'
        },
        {
          label: 'Document 6',
          attribution: 'Bishop Samuel Ajayi Crowther, first African Anglican bishop, letter to the Church Missionary Society, Lagos, 1869',
          type: 'text',
          content: 'I confess that the missionaries and the merchants have often arrived together in Africa, and I do not always find it easy to separate their purposes. Where trade follows the cross, the African people gain access to education, medicine, and the word of God — blessings I have myself received. Yet I have also seen how the opening of trade routes and the establishment of trading posts is swiftly followed by demands for territory, for exclusive rights, for agreements signed by chiefs who do not understand their contents. I fear that the commercial motive, though dressed in the language of civilization, will prove stronger than the Christian one, and that Africa will lose not only her goods but her self-governance.'
        }
      ]
    }
  }
];

function generateBlocks(type, prompt, structure) {
  if (type === 'saq') return BLOCK_TEMPLATES.saq(prompt, structure?.parts || 3);
  if (type === 'dbq') return BLOCK_TEMPLATES.dbq(prompt, structure?.sources || structure?.structure?.sources || []);
  return BLOCK_TEMPLATES.leq(prompt);
}

const THESIS_JUDGE_BANK = [
  { text: "The Columbian Exchange fundamentally transformed global economies between 1450 and 1750 because it introduced new crops that boosted population growth, created silver-based trade networks, and established coerced labor systems.", verdict: "strong", why: "Clear claim + 'because' with three specific supporting points + time period. This earns the thesis point." },
  { text: "The Columbian Exchange affected many things in the world.", verdict: "weak", why: "Too vague — no defensible claim, no line of reasoning, no specifics. What things? How? This would NOT earn the point." },
  { text: "This essay will discuss the causes and effects of the Industrial Revolution.", verdict: "not_thesis", why: "This is a topic sentence, not a thesis. It announces what you'll talk about but makes no argument or claim." },
  { text: "Although the Mongol Empire caused widespread destruction, it ultimately facilitated unprecedented cultural and commercial exchange across Eurasia by establishing the Pax Mongolica.", verdict: "strong", why: "Starts with a counterpoint ('although'), makes a clear claim, and previews the reasoning. The qualifier shows complexity." },
  { text: "The Mongols were very important in history and changed a lot of things.", verdict: "weak", why: "No specifics, no argument, no time period. 'Important' and 'changed things' are not defensible claims." },
  { text: "In this paper I will explore how trade networks developed over time.", verdict: "not_thesis", why: "Announces intent ('I will explore') rather than making an argument. A thesis must make a claim, not describe the essay." },
  { text: "Maritime exploration between 1450 and 1750 was primarily driven by economic motives, as European states competed for control of spice routes and silver flows to finance their growing military ambitions.", verdict: "strong", why: "'Primarily' shows extent, 'because/as' provides reasoning, and specific details (spice routes, silver) support the claim." },
  { text: "European exploration happened because of many reasons including religion, economics, and technology.", verdict: "weak", why: "Lists categories but makes no argument about their relative importance. 'Many reasons' is not a defensible claim — which mattered MOST?" },
  { text: "There are many similarities and differences between the Atlantic slave trade and other forms of coerced labor.", verdict: "not_thesis", why: "The 'similarities and differences' formula without specifying WHAT they are is not a thesis. It's a prompt restatement." },
  { text: "The Atlantic slave trade fundamentally reshaped both African and American societies between 1500 and 1800, though its effects varied significantly — devastating West African political structures while simultaneously generating the agricultural wealth that fueled European industrialization.", verdict: "strong", why: "Specific time period, clear argument with extent ('fundamentally'), plus nuance ('though its effects varied'). This shows complex thinking." },
  { text: "Nationalism was both a unifying and divisive force in the 19th century, consolidating states like Germany and Italy while simultaneously fracturing multiethnic empires such as Austria-Hungary and the Ottoman Empire.", verdict: "strong", why: "Makes a paradoxical claim (both unifying AND divisive) with specific examples. This is a sophisticated, defensible thesis." },
  { text: "Nationalism had a big impact on the world during this time period.", verdict: "weak", why: "Which time period? What kind of impact? Where? This is too vague to be defensible. Needs specifics and an argument." },
  { text: "The printing press changed Europe forever.", verdict: "weak", why: "No time period, no explanation of HOW or WHY, no line of reasoning. 'Changed forever' is too broad to be a thesis." },
  { text: "The purpose of this essay is to analyze the extent to which the Enlightenment influenced political revolutions.", verdict: "not_thesis", why: "States the purpose of the essay rather than making an argument. Drop 'the purpose of this essay is to analyze' and make a claim instead." },
  { text: "Although economic factors were significant, the spread of Islam between 600 and 1450 was primarily facilitated by trade networks and Sufi missionaries rather than military conquest, as evidenced by conversion patterns in Southeast Asia and sub-Saharan Africa.", verdict: "strong", why: "Makes a specific, arguable claim ('primarily facilitated by X rather than Y'), provides a qualifier ('although'), and previews evidence regions." }
];

const EVIDENCE_BANK = [
  { claim: "Trade networks facilitated cultural exchange in the period 1200-1450.", evidence: "Merchants traveled along trade routes during this time.", verdict: "weak", why: "Too vague — which merchants? Which routes? When exactly? This lacks the specificity needed for AP credit. Name a person, place, or date." },
  { claim: "Trade networks facilitated cultural exchange in the period 1200-1450.", evidence: "Ibn Battuta traveled over 75,000 miles across the Dar al-Islam between 1325 and 1354, documenting the shared Islamic legal and cultural practices he found from Morocco to China.", verdict: "strong", why: "Specific person (Ibn Battuta), specific dates (1325-1354), specific detail (75,000 miles), and directly supports the claim about cultural exchange." },
  { claim: "The Columbian Exchange transformed global economies.", evidence: "New crops were introduced to different parts of the world.", verdict: "weak", why: "Which crops? Where? When? 'New crops' and 'different parts' are too vague. This is a general statement, not specific evidence." },
  { claim: "The Columbian Exchange transformed global economies.", evidence: "The introduction of the potato from the Americas to Europe led to significant population growth — Ireland's population nearly doubled between 1750 and 1840, largely due to potato cultivation.", verdict: "strong", why: "Specific crop (potato), specific place (Ireland), specific dates and data (doubled, 1750-1840). This is concrete, usable evidence." },
  { claim: "European imperialism was driven by economic motives.", evidence: "King Leopold II's exploitation of the Congo Free State generated enormous rubber and ivory profits while causing the deaths of an estimated 10 million Congolese between 1885 and 1908.", verdict: "strong", why: "Specific ruler, specific colony, specific resources, specific dates and casualty figures. Directly proves economic motive with human cost." },
  { claim: "European imperialism was driven by economic motives.", evidence: "Europeans wanted to get rich from colonies in Africa.", verdict: "weak", why: "Which Europeans? Which colonies? What resources? This restates the claim without providing any specific evidence to support it." },
  { claim: "The Industrial Revolution changed social structures.", evidence: "Many people moved to cities during the Industrial Revolution.", verdict: "weak", why: "How many? Which cities? When? 'Many people' and 'cities' are too vague. Good evidence needs numbers, names, or specific examples." },
  { claim: "The Industrial Revolution changed social structures.", evidence: "Manchester's population exploded from 25,000 in 1772 to over 300,000 by 1850, creating a new urban working class that lived in overcrowded tenements and worked 14-hour days in textile mills.", verdict: "strong", why: "Specific city, specific population numbers and dates, vivid detail about conditions. This makes the social transformation concrete and real." },
  { claim: "Gunpowder empires maintained control through military technology.", evidence: "The Ottoman Empire used large cannons to breach the walls of Constantinople in 1453, ending the Byzantine Empire and establishing Ottoman control over a critical trade crossroads.", verdict: "strong", why: "Specific empire, specific technology (cannons), specific event (fall of Constantinople), specific date (1453), and explains the significance." },
  { claim: "Gunpowder empires maintained control through military technology.", evidence: "Empires used guns and cannons to conquer other places.", verdict: "weak", why: "Which empires? Which places? When? This is a category description, not evidence. AP readers want you to show you know specific history." }
];

// ═══ BLOCK BLAST — AP MCQ BANK ═══
const BB_QUESTIONS = [
  { q:"Which best explains the political success of the Mongol Empire in the 13th century?", c:["Adoption of a single state religion","A meritocratic military structure and psychological warfare","Reliance on naval superiority","Centralized bureaucracy modeled on the Song dynasty"], a:1, cat:"political" },
  { q:"Indian Ocean trade (1200-1450) was most facilitated by:", c:["European joint-stock companies","Collapse of overland Silk Road routes","Monsoon winds and lateen sail technology","Chinese naval dominance after Zheng He"], a:2, cat:"economic" },
  { q:"Mansa Musa's 1324 pilgrimage to Mecca demonstrates:", c:["Mali's isolation from Islamic civilization","Decline of trans-Saharan gold trade","Extraordinary wealth of West African kingdoms integrated into the Islamic world","European economic dominance over Africa"], a:2, cat:"economic" },
  { q:"The caste system in South Asia (1200-1450) primarily functioned to:", c:["Provide social mobility for merchants","Organize society into hereditary occupational groups","Ensure equal political representation","Prevent the spread of Islam"], a:1, cat:"social" },
  { q:"Which best illustrates cultural syncretism along Silk Road routes?", c:["Theravada Buddhism spreading to Japan","Adoption of cuneiform by Persians","Greco-Buddhist artistic styles in Central Asian sculptures","Replacement of Hinduism with Islam in all of Southeast Asia"], a:2, cat:"cultural" },
  { q:"Aztec tribute from conquered city-states most directly served to:", c:["Spread Nahuatl as a universal language","Sustain Tenochtitlan and reinforce hierarchical political structure","Establish a uniform legal code","Promote religious tolerance"], a:1, cat:"political" },
  { q:"Great Zimbabwe's stone enclosures evidence:", c:["Portuguese architectural influence","A prosperous Bantu-speaking state in long-distance trade","Nomadic pastoralist settlements","Egyptian cultural diffusion"], a:1, cat:"cultural" },
  { q:"The Black Death's demographic impact (1347-1400) most directly caused:", c:["Strengthening of feudal obligations","Labor shortage increasing peasant bargaining power","Expansion of Byzantine Empire westward","Decline of Christianity in Europe"], a:1, cat:"social" },
  { q:"The Columbian Exchange most significantly altered demographics through:", c:["Voluntary European migration","Old World diseases devastating indigenous Americans","Maize cultivation in sub-Saharan Africa","Forced relocation of Asian laborers"], a:1, cat:"social" },
  { q:"The encomienda system was most similar to:", c:["European feudal manorialism","Chinese examination system","Ottoman devshirme","Inca mit'a labor system"], a:0, cat:"political" },
  { q:"Atlantic slave trade growth (1500-1750) was best explained by:", c:["African rulers universally resisting traders","European demand for plantation labor plus African slave-trading networks","Enslaved Africans used as European domestic servants","Catholic Church mandating enslaved labor"], a:1, cat:"economic" },
  { q:"The Ottoman devshirme system is best characterized as:", c:["A tax on non-Muslim merchants","Recruiting Christian boys as elite soldiers/administrators","Diplomatic hostage exchange","Land grants to Turkish nobility"], a:1, cat:"political" },
  { q:"Silver flow from Americas to China (1500-1750) primarily resulted in:", c:["Collapse of Chinese economy","China's total isolation from commerce","Integration of Americas into global trade and Spanish inflation","Replacement of silver with paper currency"], a:2, cat:"economic" },
  { q:"The Protestant Reformation most directly challenged Catholic authority by arguing:", c:["Pope should share power with monarchs","Salvation through faith alone without Church intermediaries","All denominations should merge","Science should replace doctrine"], a:1, cat:"cultural" },
  { q:"Akbar's sulh-i-kul (universal peace) primarily aimed to:", c:["Convert all Hindus to Islam","Eliminate jizya and promote tolerance to consolidate diverse subjects","Establish Sikhism as state religion","Forge Mughal-Safavid alliance"], a:1, cat:"cultural" },
  { q:"The Haitian Revolution was historically significant because it:", c:["Was the first European settler revolt","Showed enslaved people could overthrow colonialism and establish independence","Led directly to US abolition","Was driven by French Enlightenment philosophers"], a:1, cat:"political" },
  { q:"The primary cause of the Opium Wars was:", c:["China colonizing British territories","British insistence on opium trade that China tried to suppress","Religious conflict","Competition for Japanese markets"], a:1, cat:"economic" },
  { q:"A direct social consequence of 19th-century British industrialization:", c:["Decline of the nuclear family","Rapid urbanization and factory working class in poor conditions","Population decrease from factory mortality","Immediate elimination of child labor"], a:1, cat:"social" },
  { q:"Bolivar's South American campaigns were most inspired by:", c:["Marxist class struggle theories","Enlightenment ideals of popular sovereignty and natural rights","Meiji Restoration model","Ottoman Tanzimat reforms"], a:1, cat:"political" },
  { q:"The Berlin Conference (1884-1885) established rules for:", c:["Unified European currency","Partition and colonization of Africa","Granting independence to Asian colonies","Regulating the slave trade"], a:1, cat:"political" },
  { q:"The Meiji Restoration (1868) is best characterized as:", c:["A communist revolution","State-directed rapid industrialization and Western-style modernization","A Shinto theocracy revival","A democratic universal suffrage movement"], a:1, cat:"economic" },
  { q:"Social Darwinism was most commonly used to justify:", c:["International labor rights","European imperialism arguing racial superiority","Abolition of slavery","Women's suffrage movements"], a:1, cat:"cultural" },
  { q:"The League of Nations mandate system primarily functioned to:", c:["Grant immediate independence","Place former colonies under Allied administration","Create a Middle East free-trade zone","Establish democracies in Europe"], a:1, cat:"political" },
  { q:"Gandhi's satyagraha was most directly influenced by:", c:["Marxist-Leninist vanguardism","Hindu/Jain ahimsa combined with Thoreau's civil disobedience","Irish Republican Army tactics","Wilson's Fourteen Points"], a:1, cat:"cultural" },
  { q:"The Green Revolution most directly resulted in:", c:["Transition to renewable energy","Increased agricultural yields through high-yield crops and fertilizers","Widespread organic farming in Asia","Global population decline"], a:1, cat:"economic" },
  { q:"The Bandung Conference (1955) was significant because it:", c:["Formalized US-Western Europe alliance","Brought together Asian/African leaders for solidarity and non-alignment","Established the EEC","Ended the Korean War"], a:1, cat:"political" },
  { q:"'Asian Tigers' rapid growth was best explained by:", c:["Abundant natural resources","State-directed export-oriented manufacturing and education","Soviet economic aid","Complete absence of government"], a:1, cat:"economic" },
  { q:"South African apartheid (1948-1994) was a system of:", c:["UN economic sanctions","Institutionalized racial segregation by white-minority government","Voluntary cultural separation","British military rule"], a:1, cat:"social" },
  { q:"Ming China ended Zheng He's voyages because:", c:["Devastating naval defeats","Confucian officials prioritized internal threats and agriculture","Maritime routes were less profitable","A pandemic destroyed shipbuilding"], a:1, cat:"political" },
  { q:"Late 20th-century global feminism was most characterized by:", c:["A single unified movement","Diverse movements addressing inequality through culturally specific approaches","Exclusive focus on Western voting rights","Rejection of all traditional practices"], a:1, cat:"social" }
];
const BB_CAT_COLORS = { political:'#4A90D9', economic:'#D4A843', social:'#5AAF6E', cultural:'#9B6FC3' };

// ═══ STORY LESSONS ═══
const STORY_LESSONS = {
'apwh-6.3': {
  title:'Industrialization Spreads',unit:'6.3',period:'1750–1900',
  desc:'Follow the fire of industry as it leaps from Britain across oceans and continents, forever changing how humans live and work.',
  chapters:[
    { title:'The Forge of Britain', date:'Manchester, England — 1790s',
      bg:'linear-gradient(135deg,#1a1a2e 0%,#2d1b3d 40%,#4a1c1c 100%)',icon:'🏭',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Cottonopolis1.jpg/800px-Cottonopolis1.jpg',
      text:`<p>The air tastes of iron and coal. You stand at the edge of Manchester, a city that barely existed a generation ago, now swelling with tens of thousands of souls drawn by the promise of wages. Through the predawn fog, smokestacks rise like the masts of some great industrial fleet, and from inside the brick mills comes the relentless clatter of <span class="story-term">power looms</span> — machines that do in minutes what a hand-weaver needed days to accomplish.</p>
<p>Britain did not stumble into this revolution by accident. Beneath its green hills lay vast deposits of <span class="story-term">coal and iron ore</span> — the twin fuels of mechanization. Its <span class="story-term">Agricultural Revolution</span> had already pushed surplus laborers off enclosed farms and into cities hungry for factory hands. Centuries of global trade — from Caribbean sugar to Indian cotton — had filled merchant coffers with <span class="story-term">capital</span> ready to invest. And a stable Parliament, friendly to property rights, meant inventors like James Watt could patent a <span class="story-term">steam engine</span> and profit from it.</p>
<p>By 1800, Britain produced more manufactured goods than any nation on Earth. Its rivers were bridged with iron, its fields crossed by canals, and its cities lit — just barely — by gaslight. The world had never seen anything like it. And it was only the beginning.</p>`,
      quote:{text:'England is the workshop of the world.',attr:'— British saying, early 1800s'},
      question:'What specific advantages allowed Britain to industrialize before any other country? Name at least two.',
      keyConcept:'Britain industrialized first due to coal/iron deposits, capital accumulated from global trade, labor freed by the Agricultural Revolution, a stable government protecting property/patents, and geographic advantages like rivers and ports.'
    },
    { title:'Smoke Over the Channel', date:'Continental Europe — 1820s–1860s',
      bg:'linear-gradient(135deg,#1c2841 0%,#2c3e50 50%,#4a6274 100%)',icon:'⚙️',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Krupp_works.JPG/800px-Krupp_works.JPG',
      text:`<p>It was only a matter of time. British entrepreneurs tried desperately to guard their secrets — Parliament even banned the export of textile machinery and the emigration of skilled mechanics. But ideas, like smoke, cannot be contained. A mechanic named Samuel Slater memorized factory designs and sailed to America. Belgian investors lured British engineers across the Channel. The industrial fire had escaped.</p>
<p><span class="story-term">Belgium</span> industrialized first on the continent, blessed with its own coal fields and a government eager to build railroads. <span class="story-term">France</span> followed more cautiously — its revolution had redistributed land to peasants who were reluctant to leave, so French industry grew around luxury goods and smaller workshops. <span class="story-term">Germany</span> was the surprise. Fragmented into dozens of states, it formed the <span class="story-term">Zollverein</span> (customs union) in 1834, erasing trade barriers. When Otto von Bismarck unified Germany in 1871, the nation erupted into an industrial powerhouse, surpassing Britain in steel production by 1900.</p>
<p>Each nation found its own path. But the pattern was unmistakable: governments that invested in <span class="story-term">railroads</span>, <span class="story-term">education</span>, and <span class="story-term">banking systems</span> industrialized faster. The state was not a bystander — it was a catalyst.</p>`,
      quote:{text:'The Zollverein has done more for German unity than fifty years of diplomacy.',attr:'— Contemporary observation, 1840s'},
      question:'How did the paths to industrialization differ between Belgium, France, and Germany? What role did governments play?',
      keyConcept:'Belgium had coal and government railroad investment. France industrialized cautiously due to peasant landholding. Germany used the Zollverein customs union and state-directed investment to rapidly industrialize after unification. Government support for infrastructure, education, and banking was crucial everywhere.'
    },
    { title:'Iron Horse Across America', date:'United States — 1820s–1870s',
      bg:'linear-gradient(135deg,#2c1810 0%,#6b4423 40%,#c4923a 100%)',icon:'🚂',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/East_and_West_Shaking_hands_at_the_laying_of_last_rail_Union_Pacific_Railroad_-_Restoration.jpg/800px-East_and_West_Shaking_hands_at_the_laying_of_last_rail_Union_Pacific_Railroad_-_Restoration.jpg',
      text:`<p>In 1790, America was a nation of farmers. By 1890, it was the world's largest industrial economy. The transformation was staggering. It began in places like <span class="story-term">Lowell, Massachusetts</span>, where young farm women — the "Lowell Mill Girls" — tended power looms in carefully planned factory towns. It accelerated when the <span class="story-term">transcontinental railroad</span> was completed in 1869 at Promontory Summit, Utah, stitching a continent together with iron and steam.</p>
<p>America had advantages Britain could only dream of: seemingly limitless <span class="story-term">natural resources</span> — coal, iron, timber, oil — and wave after wave of <span class="story-term">immigrant labor</span> pouring through Ellis Island, desperate for work. Inventors like Eli Whitney championed <span class="story-term">interchangeable parts</span>, and later Henry Ford would perfect the <span class="story-term">assembly line</span>. The government handed millions of acres to railroad companies, and tariffs shielded infant industries from British competition.</p>
<p>But the human cost was enormous. Workers labored twelve-hour days in dangerous factories. Children as young as eight worked in coal mines. And the railroad was built on the backs of exploited Chinese and Irish immigrants, across land taken from Indigenous peoples. Progress had a price, and not everyone paid equally.</p>`,
      quote:{text:'What hath God wrought!',attr:'— Samuel Morse, first telegraph message, 1844'},
      question:'What factors drove American industrialization, and what were its human costs?',
      keyConcept:'US industrialization was driven by abundant natural resources, immigrant labor, innovations like interchangeable parts and assembly lines, government support through land grants and tariffs, and the transcontinental railroad. Human costs included dangerous working conditions, child labor, exploitation of immigrants, and displacement of Indigenous peoples.'
    },
    { title:'The Meiji Miracle', date:'Japan — 1868–1900',
      bg:'linear-gradient(135deg,#1a0a0a 0%,#6b1a1a 40%,#c24848 80%,#f0a0a0 100%)',icon:'🌸',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Brooklyn_Museum_-_Commodore_Matthew_Perry%27s_%22Black_Ship%22.jpg/800px-Brooklyn_Museum_-_Commodore_Matthew_Perry%27s_%22Black_Ship%22.jpg',
      text:`<p>In 1853, American Commodore Matthew Perry sailed four warships into Edo Bay and demanded Japan open to trade. The shock was existential. For over two centuries, the Tokugawa shogunate had kept Japan isolated. Now, staring at Perry's steam-powered "Black Ships," Japan's leaders saw a terrifying truth: industrialize, or be colonized like China and India.</p>
<p>The response was revolutionary. In 1868, young samurai overthrew the shogun and restored Emperor Meiji to power. The <span class="story-term">Meiji Restoration</span> was not a return to the past — it was a sprint into the future. The new government sent delegations worldwide to study Western technology, law, and military systems. They adopted what worked and adapted it to Japanese culture. A <span class="story-term">national education system</span> was created virtually overnight. The government built <span class="story-term">state-owned factories</span> (model factories), then sold them cheaply to powerful family business groups called <span class="story-term">zaibatsu</span> like Mitsubishi and Mitsui.</p>
<p>By 1895 Japan defeated China in war. By 1905 it stunned the world by defeating <em>Russia</em>. In barely forty years, Japan had transformed from a feudal society into an industrial and military power — the only non-Western nation to do so in this era. The Meiji slogan said it all: <em>"Rich nation, strong army."</em></p>`,
      quote:{text:'Fukoku kyōhei — Rich country, strong military.',attr:'— Meiji government slogan'},
      question:'How did Japan\'s approach to industrialization differ from European nations? Why was it motivated by more than just economic growth?',
      keyConcept:'Japan industrialized through state-directed modernization after Perry\'s forced opening. The Meiji government studied and selectively borrowed Western systems, built model factories, created national education, and sold industries to zaibatsu. Motivation was survival — avoiding colonization — making it a defensive modernization. Japan was the only non-Western nation to fully industrialize in this period.'
    },
    { title:'The Sleeping Giant Stirs', date:'Russia — 1860s–1900s',
      bg:'linear-gradient(135deg,#0d1b2a 0%,#1b2838 40%,#415a77 100%)',icon:'🐻',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Construction_of_the_Transsiberian_Railway.jpg/800px-Construction_of_the_Transsiberian_Railway.jpg',
      text:`<p>Russia was an empire of contradictions. It stretched across eleven time zones and commanded the largest army in Europe, yet in 1860 it was still a land of <span class="story-term">serfs</span> — peasants legally bound to the land, practically enslaved. While Britain built railroads, Russian nobles debated whether their peasants should be allowed to read. The humiliating defeat in the <span class="story-term">Crimean War</span> (1853–1856) against industrialized Britain and France forced a reckoning.</p>
<p>Tsar Alexander II <span class="story-term">emancipated the serfs</span> in 1861, but freedom came with crushing debt payments that kept most peasants poor and tied to their villages. Real industrial push came under Finance Minister <span class="story-term">Sergei Witte</span> in the 1890s. Witte courted foreign investment (especially French capital), raised tariffs, and poured resources into a single spectacular project: the <span class="story-term">Trans-Siberian Railroad</span>, stretching 5,772 miles from Moscow to the Pacific — the longest railroad on Earth.</p>
<p>Factories sprouted in Moscow and St. Petersburg, but Russia's industrialization was uneven and late. By 1900, the vast majority of Russians were still peasant farmers. The cities that did industrialize bred a new class of factory workers living in miserable conditions — workers who would soon have a revolution of their own. Russia had begun to industrialize, but the social tensions it unleashed would reshape the 20th century.</p>`,
      quote:{text:'We must make up in decades what other countries took centuries to achieve.',attr:'— Sergei Witte, Russian Finance Minister'},
      question:'What held Russia back from industrializing earlier, and how did Witte attempt to catch up?',
      keyConcept:'Russia was held back by serfdom, lack of capital, and conservative nobility. After Crimean War defeat exposed weakness, serfs were emancipated (1861) but remained poor. Witte drove industrialization in 1890s through foreign investment, tariffs, and the Trans-Siberian Railroad. Industrialization was late and uneven — cities industrialized while most remained peasant farmers, creating social tensions.'
    }
  ]
},
'apwh-6.4': {
  title:'Trade and the Global Economy',unit:'6.4',period:'1750–1900',
  desc:'Trace the flows of cotton, opium, and silver as industrial nations reshape global trade — creating unprecedented wealth for some and devastating dependency for others.',
  chapters:[
    { title:'Workshop of the World', date:'The British Empire — 1820s–1870s',
      bg:'linear-gradient(135deg,#1a1506 0%,#4a3b10 40%,#c49528 100%)',icon:'🚢',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/East_Indiaman_Surat_Castle_1790.jpg/800px-East_Indiaman_Surat_Castle_1790.jpg',
      text:`<p>By the mid-1800s, the phrase was not a boast — it was a fact. Britain manufactured roughly a third of the world's industrial output. Its ships carried cheap textiles, iron tools, and machinery to every inhabited continent, and returned laden with <span class="story-term">raw materials</span>: cotton from Egypt and India, rubber from Malaya, copper from Chile, wool from Australia. The sheer scale of this exchange was unprecedented in human history.</p>
<p>The key to British dominance was <span class="story-term">comparative advantage</span> backed by military power. British factories could produce cotton cloth so cheaply that Indian hand-weavers — who had supplied Europe with fine textiles for centuries — could not compete. British trade policy, enforced by the Royal Navy, pried open markets worldwide. <span class="story-term">Free trade</span> sounded fair in theory, but in practice it meant industrial nations exported expensive manufactured goods while non-industrial nations were locked into exporting cheap raw materials.</p>
<p>This was the birth of a truly <span class="story-term">global economy</span> — interconnected, efficient, and deeply unequal. The profits flowed overwhelmingly in one direction: toward the industrialized core of Western Europe and, increasingly, the United States.</p>`,
      quote:{text:'Trade follows the flag.',attr:'— Victorian-era British proverb'},
      question:'How did industrialization change the nature of global trade? Why was "free trade" not equally beneficial to all nations?',
      keyConcept:'Industrial nations like Britain exported cheap manufactured goods while importing raw materials from non-industrial regions. Free trade enforced by naval power destroyed local industries (like Indian textiles) and locked colonies into raw material dependency. The global economy became interconnected but deeply unequal, with profits flowing toward industrialized nations.'
    },
    { title:'Rivers of Cotton, Mountains of Ore', date:'Colonial Economies — 1800s',
      bg:'linear-gradient(135deg,#1a120a 0%,#3d2b1a 40%,#8b6b3d 100%)',icon:'🌾',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/Processes_in_the_Manufacture_of_Dacca_Muslins.png/800px-Processes_in_the_Manufacture_of_Dacca_Muslins.png',
      text:`<p>Before the Industrial Revolution, India was the world's leading textile exporter. Bengali weavers produced muslins so fine they were called "woven wind." But the machine changed everything. British-made cotton cloth, produced at a fraction of the cost, flooded Indian markets after the East India Company eliminated tariffs on British imports while taxing Indian textiles. By 1850, <span class="story-term">India had reversed</span> from textile exporter to raw cotton exporter — feeding British mills with fiber and buying back the finished cloth.</p>
<p>This pattern — <span class="story-term">deindustrialization</span> of colonies — repeated worldwide. Egyptian farmers were pushed to grow <span class="story-term">cash crops</span> like cotton instead of food, making them dependent on global prices they could not control. African colonies exported palm oil, rubber, and minerals. Latin American nations shipped guano, nitrates, and coffee. Each region was integrated into the global economy, but on terms dictated by industrialized powers.</p>
<p>The result was a new form of <span class="story-term">economic imperialism</span>. You didn't always need to conquer a country with soldiers — you could control it through trade dependency, debt, and infrastructure built to extract resources rather than develop local economies. Railroads in India, for instance, ran from mines and plantations straight to ports — they connected India to Britain, not to itself.</p>`,
      quote:{text:'The bones of the cotton weavers are bleaching the plains of India.',attr:'— William Bentinck, British Governor-General of India, 1835'},
      question:'How did British industrial trade transform India\'s economy? What is "deindustrialization" and how did it work?',
      keyConcept:'India went from leading textile exporter to raw cotton exporter as cheap British machine-made cloth destroyed Indian handloom industry — this is deindustrialization. Colonial economies were restructured to export cash crops and raw materials while importing manufactured goods. Economic imperialism used trade dependency, debt, and extraction-focused infrastructure to control regions without direct military conquest.'
    },
    { title:'Poison and Profit', date:'China & the Opium Wars — 1839–1860',
      bg:'linear-gradient(135deg,#0a0a1a 0%,#1a1a3a 40%,#3a1a2a 100%)',icon:'💨',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Destroying_Chinese_war_junks%2C_by_E._Duncan_%281843%29.jpg/800px-Destroying_Chinese_war_junks%2C_by_E._Duncan_%281843%29.jpg',
      text:`<p>Britain had a problem. It was addicted to Chinese tea — importing millions of pounds annually — but China wanted almost nothing in return. Silver drained out of Britain at an alarming rate. The solution the British found was as profitable as it was devastating: <span class="story-term">opium</span>.</p>
<p>Grown on plantations in British-controlled India, opium was smuggled into China by private traders with a wink and nod from the East India Company. By the 1830s, an estimated <span class="story-term">twelve million Chinese</span> were addicted. Silver now flowed the other direction — out of China — causing economic chaos. When the Qing emperor sent Commissioner <span class="story-term">Lin Zexu</span> to Canton to destroy 20,000 chests of opium and halt the trade, Britain declared war.</p>
<p>The <span class="story-term">First Opium War</span> (1839–1842) was no contest. British steam-powered gunboats devastated Chinese coastal defenses. The resulting <span class="story-term">Treaty of Nanjing</span> was the first of the <span class="story-term">unequal treaties</span>: China ceded Hong Kong, opened five ports to foreign trade, paid a massive indemnity, and granted <span class="story-term">extraterritoriality</span> — the right of British citizens to be tried under British, not Chinese, law. A second war (1856–1860) forced even harsher terms. China's "Century of Humiliation" had begun — a story still taught in Chinese schools today.</p>`,
      quote:{text:'If we allow this trade to continue, there will be no soldiers to defend our borders and no money to pay them.',attr:'— Lin Zexu, letter to Queen Victoria, 1839'},
      question:'What caused the Opium Wars, and what were the consequences for China? What are "unequal treaties"?',
      keyConcept:'Britain smuggled Indian-grown opium into China to reverse its trade deficit from tea imports. When China tried to stop the trade, Britain used military force. The Treaty of Nanjing forced China to cede Hong Kong, open ports, pay indemnities, and accept extraterritoriality. Unequal treaties imposed terms that benefited Western powers while stripping Chinese sovereignty — beginning China\'s Century of Humiliation.'
    },
    { title:'Cutting Through Continents', date:'Suez Canal & Panama Canal — 1860s–1910s',
      bg:'linear-gradient(135deg,#0c2340 0%,#1a5276 40%,#2ecc71 80%,#d4a843 100%)',icon:'⚓',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Suez_Canal_drawing_1881.jpg/800px-Suez_Canal_drawing_1881.jpg',
      text:`<p>In 1869, a French-designed, Egyptian-built miracle opened for business. The <span class="story-term">Suez Canal</span> cut through 120 miles of Egyptian desert, connecting the Mediterranean to the Red Sea. Suddenly, the voyage from London to Mumbai shrank from four months around Africa to mere weeks. Global trade accelerated overnight.</p>
<p>But the canal came at a price. Egypt's ruler, Khedive Ismail, had borrowed massively from European banks to fund the project and his modernization dreams. When Egypt couldn't repay its debts, <span class="story-term">Britain bought Egypt's shares</span> in the canal in 1875 and effectively took control of the country by 1882 — a textbook case of <span class="story-term">debt imperialism</span>. The canal built to connect Egypt to the world instead connected Egypt to a foreign master.</p>
<p>Forty-five years later, the same story played out in Central America. The <span class="story-term">Panama Canal</span> (completed 1914) slashed the journey between the Atlantic and Pacific. The United States, after engineering Panama's independence from Colombia, built the canal and controlled a ten-mile-wide <span class="story-term">Canal Zone</span> as sovereign American territory. These engineering marvels were monuments to industrial progress — and to the power of industrial nations to reshape the world's geography for their own strategic benefit.</p>`,
      quote:{text:'The canal is the property of the Egyptian government. But its benefits belong to the world — especially to Britain.',attr:'— Paraphrase of British PM Disraeli after buying Suez shares, 1875'},
      question:'How did the Suez and Panama Canals change global trade? How did they become tools of imperialism?',
      keyConcept:'The Suez Canal (1869) dramatically shortened trade routes from Europe to Asia. Egypt went into debt building it, allowing Britain to buy control and effectively colonize Egypt — an example of debt imperialism. The Panama Canal (1914) was built by the US after engineering Panama\'s independence. Both canals show how infrastructure projects could be tools of imperial control, not just trade efficiency.'
    },
    { title:'The Great Divergence', date:'The Global Economy by 1900',
      bg:'linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 30%,#d4622f 70%,#c49528 100%)',icon:'⚖️',
      img:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Kongokonferenz.jpg/800px-Kongokonferenz.jpg',
      text:`<p>Stand at the turn of the twentieth century and look at the world the Industrial Revolution made. A handful of nations — Britain, Germany, France, the United States, Japan — produce the vast majority of the world's manufactured goods. They control most of the world's shipping, banking, and military power. Their citizens enjoy rising living standards, longer lives, and more material comfort than any previous generation.</p>
<p>Now look at the other side. India, once producing 25% of global GDP, has been <span class="story-term">deindustrialized</span> into a raw-material colony. China, humiliated by unequal treaties, has fractured. Africa has been carved up at the <span class="story-term">Berlin Conference</span> of 1884 with no African voice at the table. Latin American nations are technically independent but economically dependent on exporting coffee, bananas, and minerals to the industrialized north. Historians call this gap <span class="story-term">The Great Divergence</span>.</p>
<p>This was not just about technology. It was about power — the power to set the terms of trade, to control shipping lanes, to lend money and foreclose on nations, to draw borders and extract resources. The global economy of 1900 was more connected than ever, but its connections were not between equals. They were between the <span class="story-term">industrial core</span> and the <span class="story-term">dependent periphery</span> — a pattern whose echoes still shape our world today.</p>`,
      quote:{text:'When they arrived, they had the Bible and we had the land. They said, "Let us close our eyes and pray." When we opened our eyes, we had the Bible and they had the land.',attr:'— Attributed to Desmond Tutu'},
      question:'What is "The Great Divergence" and what forces created the gap between industrial and non-industrial nations by 1900?',
      keyConcept:'The Great Divergence describes the growing economic gap between industrialized nations and the rest of the world by 1900. It was caused by deindustrialization of colonies, unequal trade terms, debt imperialism, extraction of raw materials, and political control through unequal treaties and direct colonization. The global economy divided into an industrial core (Europe, US, Japan) and a dependent periphery (Asia, Africa, Latin America).'
    }
  ]
}
};

window.app = {

// ═══ ROUTER ═══
router: {
  go: (view, params = {}) => {
    const root = document.getElementById('app-root');
    root.scrollTop = 0;
    // Cleanup blocks listeners/timers on navigation
    const bl = window.app.blocks;
    if (bl) {
      if (bl._unsub) { bl._unsub(); bl._unsub = null; }
      if (bl._unsub2) { bl._unsub2(); bl._unsub2 = null; }
      if (bl._state?.timerInterval) { clearInterval(bl._state.timerInterval); bl._state.timerInterval = null; }
      if (bl._state) { bl._state.rendered = false; bl._state.docsRendered = false; bl._state.thesisRendered = false; }
    }
    // Cleanup quiz listeners on navigation
    const qz = window.app.quiz;
    if (qz) { clearInterval(qz._timer); if(qz._unsub){qz._unsub();qz._unsub=null;} if(qz._unsub2){qz._unsub2();qz._unsub2=null;} }
    const V = window.app.views;
    const routes = {
      'home': () => { if (appState.user) return window.app.router.go(appState.userData?.role === 'teacher' ? 'teacher-dash' : 'student-dash'); root.innerHTML = V.landing(); },
      'login': () => root.innerHTML = V.login(),
      'signup': () => root.innerHTML = V.signup(),
      'teacher-dash': () => { root.innerHTML = V.teacherDash(); window.app.teacher.init(); },
      'student-dash': () => { root.innerHTML = V.studentDash(); window.app.student.init(); },
      'class-detail': () => { root.innerHTML = V.classDetail(params.classData); window.app.teacher.loadClass(params.classData.id); },
      'assignment-builder': () => { root.innerHTML = V.assignmentBuilder(params.classData); window.app.teacher.initBuilder(); },
      'assignment-detail': () => { window.app.teacher._lastAssignment = params.assignment; root.innerHTML = V.assignmentDetail(params.assignment, params.classData); window.app.teacher.loadSubmissions(params.assignment); },
      'library': () => { root.innerHTML = V.library(); window.app.teacher.initLibrary(); },
      'editor': () => { appState.activeAssignment = params.assignment; root.innerHTML = V.editor(params.assignment); window.app.student.initEditor(); },
      'demo': () => { appState.demoMode = true; const a = DEMO_ASSIGNMENT; appState.activeAssignment = a; localStorage.setItem('draft_demo', DEMO_ESSAY); root.innerHTML = V.editor(a); window.app.student.initEditor(); },
      'results': () => { appState._lastViewedAssignment = params.assignment; root.innerHTML = V.results(params.submission, params.assignment); },
      'teacher-tour': () => { root.innerHTML = V.teacherTour(); window.app.teacher.initTour(); },
      'blocks-solo': () => { root.innerHTML = V.blocksSolo(params.prompt); window.app.blocks.initSolo(params.prompt); },
      'blocks-lobby': () => { root.innerHTML = V.blocksLobby(params.sessionId); window.app.blocks.initLobby(params.sessionId); },
      'blocks-play': () => { root.innerHTML = V.blocksPlay(params.sessionId); window.app.blocks.initMultiPlay(params.sessionId); },
      'blocks-review': () => { root.innerHTML = V.blocksReview(params.sessionId); window.app.blocks.initReview(params.sessionId); },
      'story-lesson': () => { root.innerHTML = V.storyLesson(params.storyId); window.app.story.init(params.storyId, params.assignmentId); },
      'quiz-game': () => { root.innerHTML = V.quizGame(); window.app.quiz.init(params.gameId, params.isHost); },
      'lesson-lab': () => { root.innerHTML = V.lessonLab(); window.app.lab.init(); }
    };
    if (routes[view]) routes[view]();
    lucide.createIcons();
  }
},

// ═══ VIEWS ═══
views: {
  landing: () => `
    <div class="heroBg flex flex-col pageEnter" style="min-height:calc(100vh - 56px)">
      <div class="flex-1 flex items-center justify-center px-4 pt-8 pb-4 relative overflow-hidden">
        <!-- Decorative SVG background illustrations -->
        <svg class="illus-hero" style="top:8%;left:5%;opacity:.07" width="120" height="120" viewBox="0 0 120 120" fill="none"><circle cx="60" cy="60" r="55" stroke="var(--ac)" stroke-width="1.5" stroke-dasharray="8 6"/><path d="M40 75 L60 35 L80 75 Z" stroke="var(--ac)" stroke-width="1.5" fill="none"/><circle cx="60" cy="55" r="8" stroke="var(--gd)" stroke-width="1"/></svg>
        <svg class="illus-hero float2" style="top:15%;right:8%;opacity:.06" width="100" height="100" viewBox="0 0 100 100" fill="none"><rect x="15" y="15" width="70" height="70" rx="8" stroke="var(--ry)" stroke-width="1.5" stroke-dasharray="4 4"/><line x1="30" y1="35" x2="70" y2="35" stroke="var(--ry)" stroke-width="1" opacity=".5"/><line x1="30" y1="50" x2="60" y2="50" stroke="var(--ry)" stroke-width="1" opacity=".5"/><line x1="30" y1="65" x2="55" y2="65" stroke="var(--ry)" stroke-width="1" opacity=".5"/></svg>
        <svg class="illus-hero float3" style="bottom:12%;left:10%;opacity:.06" width="90" height="90" viewBox="0 0 90 90" fill="none"><circle cx="45" cy="45" r="35" stroke="var(--sg)" stroke-width="1.5"/><path d="M30 45 Q45 20 60 45 Q45 70 30 45" stroke="var(--sg)" stroke-width="1" fill="none"/><circle cx="45" cy="45" r="4" fill="var(--sg)" opacity=".2"/></svg>
        <svg class="illus-hero" style="bottom:18%;right:6%;opacity:.05" width="80" height="80" viewBox="0 0 80 80" fill="none"><path d="M10 70 L40 10 L70 70 Z" stroke="var(--gd)" stroke-width="1.5" fill="none" stroke-dasharray="6 4"/><circle cx="40" cy="50" r="12" stroke="var(--gd)" stroke-width="1" opacity=".4"/></svg>
        <div class="max-w-2xl text-center relative z-10">
          <div class="mb-8 flex justify-center gap-4">
            <div class="float1 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--ac)"><i data-lucide="feather" class="w-6 h-6 text-white"></i></div>
            <div class="float2 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--sg)"><i data-lucide="scroll-text" class="w-6 h-6 text-white"></i></div>
            <div class="float3 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--ry)"><i data-lucide="gamepad-2" class="w-6 h-6 text-white"></i></div>
          </div>
          <h1 class="text-4xl md:text-6xl font-bold tracking-tight mb-4 fs hero-title">Write history.<br><span style="color:var(--ac)">Make history.</span></h1>
          <p class="text-lg md:text-xl mb-10 hero-sub" style="color:var(--mu);max-width:480px;margin:0 auto">AI-powered essay grading, skill gardens, and arcade games for AP World History writing mastery.</p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center hero-btns">
            <button onclick="window.app.router.go('signup')" class="btnP text-base py-3 px-8 shadow-lg pulse-cta">Get Started Free</button>
            <button onclick="window.app.router.go('login')" class="btnG text-base py-3 px-8">Log In</button>
          </div>
          <button onclick="window.app.router.go('demo')" class="mt-4 text-sm font-medium underline underline-offset-4 transition hover:opacity-80 hero-btns" style="color:var(--ac)">Try a demo essay with instant AI feedback →</button>
        </div>
      </div>
      <!-- ═══ ANIMATED FEATURE SHOWCASES ═══ -->
      <div class="py-16 px-4" style="background:var(--elev)">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-2xl md:text-3xl font-bold fs text-center mb-3 hero-features">How it works</h2>
          <p class="text-sm text-center mb-10 hero-features" style="color:var(--mu)">Three ways to master AP World History writing</p>

          <!-- SHOWCASE 1: Essay Blocks -->
          <div class="grid md:grid-cols-2 gap-8 items-center mb-16 hero-features">
            <div>
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">🧩</span>
                <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">New</span>
              </div>
              <h3 class="text-xl font-bold fs mb-2">Essay Blocks</h3>
              <p class="text-sm mb-3" style="color:var(--mu)">Write essays without knowing you're writing an essay. Fun guided blocks break the AP rubric into bite-sized questions.</p>
              <ul class="text-xs space-y-2" style="color:var(--mu)">
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Solo practice with AI hints</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Multiplayer: team up, each writes a block blindly</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Blocks consolidate into a full graded essay</li>
              </ul>
            </div>
            <div class="showcase-wrap">
              <div class="showcase-chrome"><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-url">historywrite / essay-blocks</span></div>
              <div class="showcase-inner" style="padding:16px">
                <div class="showcase-label">Live Preview</div>
                <!-- Animated progress bar -->
                <div class="flex gap-3 mb-4 mt-6" style="padding:0 8px">
                  <div class="flex-1 h-[5px] rounded-full" style="background:var(--sg)"></div>
                  <div class="flex-1 h-[5px] rounded-full" style="background:var(--sg)"></div>
                  <div class="flex-1 h-[5px] rounded-full sc-prog-fill" style="background:var(--ac);--fill:100%"></div>
                  <div class="flex-1 h-[5px] rounded-full" style="background:var(--bd)"></div>
                  <div class="flex-1 h-[5px] rounded-full" style="background:var(--bd)"></div>
                  <div class="flex-1 h-[5px] rounded-full" style="background:var(--bd)"></div>
                </div>
                <!-- Animated blocks appearing -->
                <div class="sc-block" style="padding:14px;background:var(--elev);border:1px solid var(--bd);border-radius:14px;margin-bottom:10px">
                  <span style="font-size:28px;display:block;margin-bottom:8px">⚔️</span>
                  <span class="eb-block-label">Your Argument</span>
                  <p class="text-xs mt-2 fs" style="color:var(--mu)">What's your main argument? State a clear, defensible claim.</p>
                  <div style="margin-top:10px;padding:10px 12px;background:var(--card);border:2px solid var(--ac);border-radius:10px;font-family:'Crimson Pro',serif;font-size:12px;color:var(--tx);min-height:48px;position:relative">
                    <span class="type-line" style="display:inline">Maritime empires fundamentally transformed trade because</span><span class="typing-cursor"></span>
                  </div>
                </div>
                <div class="sc-block" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(196,149,40,.06);border:1px solid rgba(196,149,40,.12);border-radius:10px">
                  <span style="font-size:14px">💡</span>
                  <p class="text-[10px]" style="color:var(--gd)">Try adding "because" with 2-3 specific supporting points!</p>
                </div>
              </div>
            </div>
          </div>

          <!-- SHOWCASE 2: AI Grading -->
          <div class="grid md:grid-cols-2 gap-8 items-center mb-16 hero-features" style="direction:rtl">
            <div style="direction:ltr">
              <span class="text-2xl">✨</span>
              <h3 class="text-xl font-bold fs mb-2 mt-1">AI-Powered Grading</h3>
              <p class="text-sm mb-3" style="color:var(--mu)">Submit your essay and get instant rubric-aligned feedback with highlighted annotations, improvement tips, and encouragement.</p>
              <ul class="text-xs space-y-2" style="color:var(--mu)">
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Inline annotations on your actual text</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Color-coded: green (earned), yellow (close), red (improve)</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Specific improvement tips for each rubric point</li>
              </ul>
              <button onclick="window.app.router.go('demo')" class="btnP text-xs py-2 px-5 mt-4">Try the Demo →</button>
            </div>
            <div class="showcase-wrap" style="direction:ltr">
              <div class="showcase-chrome"><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-url">historywrite / grading-report</span></div>
              <div class="showcase-inner" style="padding:16px">
                <div class="showcase-label">Live Preview</div>
                <div class="text-center mt-4 mb-3">
                  <div class="sc-score text-4xl font-bold fs" style="color:var(--ac)">5<span class="text-lg" style="color:var(--fa)">/6</span></div>
                  <div class="text-[10px] font-semibold sc-score" style="color:var(--mu);animation-delay:4.2s">Proficient</div>
                </div>
                <div class="space-y-2 stagger" style="font-size:11px">
                  <div class="sc-block" style="padding:10px 12px;border-radius:10px;border-left:3px solid var(--sg);background:var(--elev)">
                    <div class="flex items-center gap-2 mb-1"><span class="w-4 h-4 rounded-full flex items-center justify-center text-[8px] font-bold text-white" style="background:var(--sg)">1</span><span class="font-bold text-[10px]" style="color:var(--sg)">THESIS</span><span class="text-[9px] px-1.5 py-0.5 rounded-full" style="background:rgba(77,128,96,.1);color:var(--sg)">Point Earned</span></div>
                    <p style="color:var(--mu)">Strong thesis with clear argument and line of reasoning.</p>
                  </div>
                  <div class="sc-block" style="padding:10px 12px;border-radius:10px;border-left:3px solid var(--gd);background:var(--elev)">
                    <div class="flex items-center gap-2 mb-1"><span class="w-4 h-4 rounded-full flex items-center justify-center text-[8px] font-bold text-white" style="background:var(--gd)">2</span><span class="font-bold text-[10px]" style="color:var(--gd)">EVIDENCE</span><span class="text-[9px] px-1.5 py-0.5 rounded-full" style="background:rgba(196,149,40,.1);color:var(--gd)">Almost There</span></div>
                    <p style="color:var(--mu)">Good evidence — add one more specific example.</p>
                    <div style="margin-top:6px;padding:6px 8px;border-radius:6px;background:rgba(196,149,40,.06)"><span class="text-[9px]" style="color:var(--gd)">💡 Name a specific treaty, event, or leader.</span></div>
                  </div>
                  <div class="sc-block" style="padding:10px 12px;border-radius:10px;border-left:3px solid var(--sg);background:var(--elev)">
                    <div class="flex items-center gap-2 mb-1"><span class="w-4 h-4 rounded-full flex items-center justify-center text-[8px] font-bold text-white" style="background:var(--sg)">3</span><span class="font-bold text-[10px]" style="color:var(--sg)">REASONING</span><span class="text-[9px] px-1.5 py-0.5 rounded-full" style="background:rgba(77,128,96,.1);color:var(--sg)">Point Earned</span></div>
                    <p style="color:var(--mu)">Excellent cause-and-effect analysis throughout.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- SHOWCASE 3: Multiplayer Blocks -->
          <div class="grid md:grid-cols-2 gap-8 items-center hero-features">
            <div>
              <span class="text-2xl">🎮</span>
              <h3 class="text-xl font-bold fs mb-2 mt-1">Multiplayer Mode</h3>
              <p class="text-sm mb-3" style="color:var(--mu)">Teachers start a live session. Students join, get randomly grouped, and each person writes one block of an essay — without seeing what anyone else wrote. Pure collaborative chaos!</p>
              <ul class="text-xs space-y-2" style="color:var(--mu)">
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Real-time lobby with ready indicators</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Timed rounds with group competition</li>
                <li class="flex items-start gap-2"><span style="color:var(--sg)">✓</span> Peer voting + AI grading to pick the winner</li>
              </ul>
            </div>
            <div class="showcase-wrap">
              <div class="showcase-chrome"><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-dot"></span><span class="showcase-url">historywrite / multiplayer-lobby</span></div>
              <div class="showcase-inner" style="padding:16px;text-align:center">
                <div class="showcase-label">Live Preview</div>
                <p class="text-[9px] font-bold uppercase tracking-wider mt-5 mb-1" style="color:var(--fa)">Session Code</p>
                <p class="text-xl font-bold fm mb-4" style="color:var(--ac)">X7KM2P</p>
                <div class="space-y-2 mb-4" style="max-width:240px;margin:0 auto;text-align:left">
                  <div class="sc-block flex items-center gap-2 py-2 px-3 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.2)">
                    <div class="w-2 h-2 rounded-full sc-dot" style="background:var(--sg)"></div>
                    <span class="text-xs font-semibold flex-1">Alex M.</span>
                    <span class="text-[9px] fm" style="color:var(--sg)">Ready!</span>
                  </div>
                  <div class="sc-block flex items-center gap-2 py-2 px-3 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.2)">
                    <div class="w-2 h-2 rounded-full sc-dot" style="background:var(--sg)"></div>
                    <span class="text-xs font-semibold flex-1">Jamie K.</span>
                    <span class="text-[9px] fm" style="color:var(--sg)">Ready!</span>
                  </div>
                  <div class="sc-block flex items-center gap-2 py-2 px-3 rounded-lg" style="background:var(--elev);border:1px solid var(--bd)">
                    <div class="w-2 h-2 rounded-full sc-dot" style="background:var(--bd)"></div>
                    <span class="text-xs font-semibold flex-1">Sam T.</span>
                    <span class="text-[9px] fm" style="color:var(--fa)">Waiting...</span>
                  </div>
                  <div class="sc-block flex items-center gap-2 py-2 px-3 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.2)">
                    <div class="w-2 h-2 rounded-full sc-dot" style="background:var(--sg)"></div>
                    <span class="text-xs font-semibold flex-1">Riley P.</span>
                    <span class="text-[9px] fm" style="color:var(--sg)">Ready!</span>
                  </div>
                </div>
                <div class="sc-block" style="animation-delay:3s">
                  <div style="display:inline-block;padding:8px 20px;border-radius:10px;background:var(--ac);color:#fff;font-size:12px;font-weight:600">3/4 Ready — Start Game</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Original feature cards row -->
      <div class="py-12 px-4"><div class="max-w-4xl mx-auto grid md:grid-cols-3 gap-6 hero-features stagger">
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="pen-tool" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">AI Grading</h3><p class="text-xs" style="color:var(--mu)">Instant rubric-aligned feedback on SAQs, LEQs, and DBQs.</p></div>
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="sprout" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">Skill Garden</h3><p class="text-xs" style="color:var(--mu)">Watch AP skills grow from seedlings to golden mastery.</p></div>
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="gamepad-2" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">Arcade Mode</h3><p class="text-xs" style="color:var(--mu)">Timeline races, thesis forging, and source detective games.</p></div>
      </div></div>
      <!-- Footer -->
      <div class="py-8 px-4" style="border-top:1px solid var(--bd)">
        <div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-2">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background:var(--ac)"><i data-lucide="feather" class="w-4 h-4 text-white"></i></div>
            <span class="text-sm font-bold">HistoryWrite</span>
          </div>
          <div class="flex items-center gap-6 text-xs" style="color:var(--fa)">
            <span>Built for AP World History</span>
            <span class="hidden sm:inline">·</span>
            <span class="flex items-center gap-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> Made with love for history teachers and students</span>
          </div>
        </div>
      </div>
    </div>`,

  login: () => `
    <div class="min-h-screen flex items-center justify-center p-4 pageEnter relative overflow-hidden">
      <svg class="illus-hero" style="top:10%;left:8%;opacity:.06" width="160" height="160" viewBox="0 0 160 160" fill="none"><circle cx="80" cy="80" r="70" stroke="var(--ac)" stroke-width="1.5" stroke-dasharray="10 8"/><path d="M50 110 L80 40 L110 110" stroke="var(--gd)" stroke-width="1.5" fill="none"/><circle cx="80" cy="75" r="15" stroke="var(--ry)" stroke-width="1" opacity=".4"/></svg>
      <svg class="illus-hero float2" style="bottom:15%;right:10%;opacity:.05" width="120" height="120" viewBox="0 0 120 120" fill="none"><rect x="10" y="10" width="100" height="100" rx="12" stroke="var(--sg)" stroke-width="1.5" stroke-dasharray="6 4"/><line x1="30" y1="40" x2="90" y2="40" stroke="var(--sg)" stroke-width="1" opacity=".4"/><line x1="30" y1="60" x2="75" y2="60" stroke="var(--sg)" stroke-width="1" opacity=".4"/><line x1="30" y1="80" x2="65" y2="80" stroke="var(--sg)" stroke-width="1" opacity=".4"/></svg>
    <div class="hcard w-full max-w-sm p-8 scaleIn relative z-10">
      <h2 class="text-2xl font-bold fs mb-6">Welcome back</h2>
      <form onsubmit="event.preventDefault();window.app.auth.login(this.email.value,this.password.value)">
        <input name="email" type="email" placeholder="Email" required class="hinp mb-3">
        <input name="password" type="password" placeholder="Password" required class="hinp mb-5">
        <button id="login-btn" class="btnP w-full">Log In</button>
      </form>
      <p class="mt-4 text-center text-xs" style="color:var(--mu)">No account? <button onclick="window.app.router.go('signup')" class="font-bold" style="color:var(--ac)">Sign up</button></p>
    </div></div>`,

  signup: () => `
    <div class="min-h-screen flex items-center justify-center p-4 pageEnter relative overflow-hidden">
      <svg class="illus-hero" style="top:12%;right:8%;opacity:.06" width="140" height="140" viewBox="0 0 140 140" fill="none"><circle cx="70" cy="70" r="60" stroke="var(--sg)" stroke-width="1.5" stroke-dasharray="8 6"/><path d="M50 95 L70 35 L90 95 Z" stroke="var(--ac)" stroke-width="1.5" fill="none"/></svg>
      <svg class="illus-hero float3" style="bottom:10%;left:6%;opacity:.05" width="100" height="100" viewBox="0 0 100 100" fill="none"><rect x="15" y="15" width="70" height="70" rx="10" stroke="var(--ry)" stroke-width="1.5" stroke-dasharray="5 5"/><circle cx="50" cy="50" r="18" stroke="var(--gd)" stroke-width="1" opacity=".4"/></svg>
    <div class="hcard w-full max-w-sm p-8 scaleIn relative z-10">
      <h2 class="text-2xl font-bold fs mb-6">Join HistoryWrite</h2>
      <form onsubmit="event.preventDefault();window.app.auth.signup(this.name.value,this.email.value,this.password.value,this.role.value,this.studentId.value)">
        <input name="name" placeholder="Full Name" required class="hinp mb-3">
        <input name="email" type="email" placeholder="Email" required class="hinp mb-3">
        <input name="password" type="password" placeholder="Password (min 6)" required minlength="6" class="hinp mb-3">
        <input name="studentId" placeholder="School Student ID (optional — for grade export)" class="hinp mb-4">
        <div class="mb-5"><label class="text-xs font-semibold uppercase tracking-wider mb-2 block" style="color:var(--mu)">I am a…</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer"><input type="radio" name="role" value="student" checked class="peer sr-only"><div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)"><i data-lucide="book-open" class="w-6 h-6 mx-auto mb-1" style="color:var(--ac)"></i><span class="font-semibold text-xs">Student</span></div></label>
            <label class="cursor-pointer"><input type="radio" name="role" value="teacher" class="peer sr-only"><div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)"><i data-lucide="graduation-cap" class="w-6 h-6 mx-auto mb-1" style="color:var(--ac)"></i><span class="font-semibold text-xs">Teacher</span></div></label>
          </div>
        </div>
        <button id="signup-btn" class="btnP w-full">Create Account</button>
      </form>
      <p class="mt-4 text-center text-xs" style="color:var(--mu)">Have an account? <button onclick="window.app.router.go('login')" class="font-bold" style="color:var(--ac)">Log in</button></p>
    </div></div>`,

  teacherDash: () => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm" style="background:linear-gradient(135deg,var(--ac),var(--gd))">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          </div>
          <div><h2 class="text-2xl font-bold fs">My Classes</h2><p class="text-sm mt-1" style="color:var(--mu)">Create classes and assign writing tasks.</p></div>
        </div>
        <div class="flex gap-2">
          <button onclick="window.app.quiz.hostGame()" class="btnG text-sm py-2 px-4 flex items-center gap-2" style="border-color:#c0392b;color:#c0392b"><i data-lucide="zap" class="w-4 h-4"></i>Host Quiz</button>
          <button onclick="window.app.router.go('lesson-lab')" class="btnG text-sm py-2 px-4 flex items-center gap-2" style="border-color:var(--gd);color:var(--gd)"><i data-lucide="sparkles" class="w-4 h-4"></i>Lesson Lab</button>
          <button onclick="window.app.router.go('library')" class="btnG text-sm py-2 px-4 flex items-center gap-2"><i data-lucide="library" class="w-4 h-4"></i>Library</button>
          <button onclick="window.app.ui.modal('create-class','open')" class="btnP text-sm py-2 px-4 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i>New Class</button>
        </div>
      </div>
      <div id="classes-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 stagger"></div>
    </div>
    <div id="create-class" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('create-class')"><div class="modalBox">
      <h3 class="text-lg font-bold mb-4">Create Class</h3>
      <input id="class-name" placeholder="e.g. Period 3 — AP World" class="hinp mb-4">
      <div class="flex gap-2"><button onclick="window.app.ui.closeModal('create-class')" class="btnG flex-1">Cancel</button><button onclick="window.app.teacher.createClass()" class="btnP flex-1">Create</button></div>
    </div></div></div>`,

  studentDash: () => {
    const stats = appState.userData?.gamification || window.app.game.getDefaultStats();
    const level = stats.level || 1;
    const nextXp = level * 200;
    const pct = Math.min(100, Math.round((stats.xp / nextXp) * 100));
    return `
    <div class="max-w-5xl mx-auto px-4 py-6 flex flex-col h-[calc(100vh-56px)] pageEnter">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm" style="background:linear-gradient(135deg,var(--ac),var(--gd))">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
          </div>
          <div><h2 class="text-xl md:text-2xl font-bold fs tracking-tight">Welcome back, ${appState.userData?.name || 'Scholar'}</h2><p class="text-xs mt-0.5" style="color:var(--mu)">Sharpen your AP World writing skills.</p></div>
        </div>
        <div class="flex items-center gap-3">
          <div class="hcard flex items-center gap-3 px-4 py-2">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold" style="background:var(--acs);color:var(--ac)">Lv${level}</div>
            <div><div class="text-xs font-semibold">${stats.xp} XP</div><div class="xpBar w-20 mt-1"><div class="xpFill" style="width:${pct}%"></div></div></div>
          </div>
          <button onclick="window.app.ui.modal('join-quiz','open')" class="btnG text-xs py-2 px-3" style="border-color:#c0392b;color:#c0392b"><i data-lucide="zap" class="w-3 h-3 inline mr-1"></i>Join Quiz</button>
          <button onclick="window.app.ui.modal('join-class','open')" class="btnP text-xs py-2 px-4">Join Class</button>
        </div>
      </div>
      <div class="flex gap-1 mb-3" style="border-bottom:1px solid var(--bd)">
        <button id="stab-assign" onclick="window.app.student.switchTab('assign')" class="tabBtn on"><i data-lucide="book-open" class="w-3.5 h-3.5 inline mr-1"></i>Assignments</button>
        <button id="stab-blocks" onclick="window.app.student.switchTab('blocks')" class="tabBtn"><i data-lucide="puzzle" class="w-3.5 h-3.5 inline mr-1"></i>Essay Blocks</button>
        <button id="stab-skills" onclick="window.app.student.switchTab('skills')" class="tabBtn"><i data-lucide="sprout" class="w-3.5 h-3.5 inline mr-1"></i>Skill Garden</button>
        <button id="stab-arcade" onclick="window.app.student.switchTab('arcade')" class="tabBtn"><i data-lucide="gamepad-2" class="w-3.5 h-3.5 inline mr-1"></i>Arcade</button>
      </div>
      <div id="tab-assign" class="flex-1 min-h-0 overflow-y-auto csc"><div id="assignments-list" class="space-y-2 stagger"></div></div>
      <div id="tab-blocks" class="hidden flex-1 min-h-0 overflow-y-auto csc py-2">${window.app.blocks.renderMenu()}</div>
      <div id="tab-skills" class="hidden flex-1 min-h-0 overflow-y-auto csc py-2">${window.app.game.renderSkillGarden(stats)}</div>
      <div id="tab-arcade" class="hidden flex-1 min-h-0">${window.app.game.renderArcade()}</div>
      <div id="join-class" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('join-class')"><div class="modalBox" style="max-width:380px">
        <h3 class="text-lg font-bold mb-4">Join Class</h3>
        <input id="class-code" placeholder="Enter class code" class="hinp mb-4 uppercase fm">
        <div class="flex gap-2"><button onclick="window.app.ui.closeModal('join-class')" class="btnG flex-1">Cancel</button><button onclick="window.app.student.joinClass()" class="btnP flex-1">Join</button></div>
      </div></div></div>
      <div id="join-quiz" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('join-quiz')"><div class="modalBox" style="max-width:380px">
        <h3 class="text-lg font-bold mb-2">Join Live Quiz</h3>
        <p class="text-xs mb-3" style="color:var(--mu)">Enter the game code from your teacher.</p>
        <input id="quiz-code" placeholder="Game code" class="hinp mb-4 uppercase fm" maxlength="6">
        <div class="flex gap-2"><button onclick="window.app.ui.closeModal('join-quiz')" class="btnG flex-1">Cancel</button><button onclick="window.app.quiz.joinGame(document.getElementById('quiz-code').value)" class="btnP flex-1" style="background:#c0392b">Join Game</button></div>
      </div></div></div>
    </div>`;
  },

  classDetail: (cls) => {
    window.app.teacher._classDataCache = cls;
    return `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm" style="background:linear-gradient(135deg,var(--ry),var(--sg))">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div><h1 class="text-2xl font-bold fs">${cls.name}</h1><p class="text-sm mt-1 fm" style="color:var(--mu)">Code: <span style="color:var(--ac)" class="font-bold">${cls.code}</span></p><p class="text-xs mt-1" style="color:var(--fa)">${(cls.students||[]).length} student${(cls.students||[]).length===1?'':'s'} enrolled</p></div>
        </div>
        <div class="flex gap-2">
          <button onclick="window.app.teacher.exportClassGradebook(window.app.teacher._classDataCache)" class="btnG text-sm flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i>Export Gradebook</button>
          <button onclick="window.app.ui.modal('eb-session-modal','open')" class="btnG text-sm flex items-center gap-2" style="border-color:var(--ac);color:var(--ac)"><i data-lucide="puzzle" class="w-4 h-4"></i>Essay Blocks</button>
          <button onclick="window.app.router.go('assignment-builder',{classData:window.app.teacher._classDataCache})" class="btnP text-sm flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i>New Assignment</button>
        </div>
      </div>
      <div id="assignments-list" class="space-y-3 stagger"></div>
      <div id="eb-session-modal" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('eb-session-modal')"><div class="modalBox" style="max-width:560px;max-height:90vh;overflow-y:auto">
        <h3 class="text-lg font-bold mb-1">🧩 Start Essay Blocks Session</h3>
        <p class="text-xs mb-4" style="color:var(--mu)">Students will be grouped randomly, each writing one block of an essay.</p>
        <label class="text-[10px] font-bold uppercase tracking-wider mb-1 block" style="color:var(--fa)">Select a prompt</label>
        <select id="eb-prompt-select" class="hinp mb-3" onchange="window.app.blocks._onPresetChange(this)">
          ${ESSAY_BLOCKS_PROMPTS.map((p, i) => '<option value="'+i+'">['+p.type.toUpperCase()+'] '+p.title+'</option>').join('')}
          <option value="custom">Custom prompt...</option>
        </select>
        <div id="eb-custom-fields" class="hidden mb-3">
          <select id="eb-custom-type" class="hinp mb-2" onchange="document.getElementById('eb-custom-doc-fields').classList.toggle('hidden',this.value!=='dbq')"><option value="saq">SAQ</option><option value="leq">LEQ</option><option value="dbq">DBQ</option></select>
          <input id="eb-custom-title" placeholder="Title" class="hinp mb-2">
          <textarea id="eb-custom-prompt" placeholder="Full prompt..." rows="3" class="hinp mb-2"></textarea>
          <div id="eb-custom-doc-fields" class="hidden">
            <p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:var(--ac)">📄 DBQ Documents (up to 7)</p>
            <div id="eb-custom-docs-list"></div>
            <button onclick="window.app.blocks._addCustomDoc()" class="btnG text-xs mt-2">+ Add Document</button>
          </div>
        </div>
        <div id="eb-doc-panel" class="hidden mb-3">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[10px] font-bold uppercase tracking-wider" style="color:var(--ac)">📄 Primary Source Documents</p>
            <span class="text-[10px]" style="color:var(--mu)">Edit before creating session</span>
          </div>
          <div id="eb-doc-list" class="space-y-2"></div>
        </div>
        <label class="text-[10px] font-bold uppercase tracking-wider mb-1 block" style="color:var(--fa)">Timer (minutes)</label>
        <input id="eb-timer" type="number" value="5" min="2" max="20" class="hinp w-24 mb-4">
        <div class="flex gap-2">
          <button onclick="window.app.ui.closeModal('eb-session-modal')" class="btnG flex-1">Cancel</button>
          <button onclick="window.app.blocks._createFromModal('${cls.id}')" class="btnP flex-1">Create Session</button>
        </div>
      </div></div></div>
    </div>`;
  },

  assignmentBuilder: (cls) => {
    window.app.teacher._classDataCache = cls;
    return `
    <div class="builder-wrap pageEnter">
      <div class="builder-form csc">
        <button onclick="window.app.router.go('class-detail',{classData:window.app.teacher._classDataCache})" class="mb-5 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to ${cls.name}</button>
        <h2 class="text-xl font-bold fs mb-5">Create Assignment</h2>
        <form id="builder-form" onsubmit="event.preventDefault();window.app.teacher.createAssignment('${cls.id}')">
          <div class="builder-section">
            <label>Title</label>
            <input name="title" placeholder="e.g. Unit 4 LEQ — Maritime Empires" required class="hinp" oninput="window.app.teacher.updatePreview()">
          </div>
          <div class="builder-section">
            <label>Type</label>
            <select name="type" class="hinp" onchange="window.app.teacher.onTypeChange(this.value);window.app.teacher.updatePreview()">
              <option value="saq">SAQ — Short Answer</option>
              <option value="leq">LEQ — Long Essay</option>
              <option value="dbq">DBQ — Document Based</option>
            </select>
          </div>
          <div class="builder-section">
            <label>Prompt</label>
            <textarea name="prompt" rows="5" placeholder="Write the full prompt students will see…" required class="hinp" style="resize:vertical" oninput="window.app.teacher.updatePreview()"></textarea>
          </div>
          <div id="saq-structure" class="builder-section">
            <label>Number of Parts</label>
            <input type="number" name="saqParts" min="1" max="4" value="3" class="hinp w-24" oninput="window.app.teacher.updatePreview()">
          </div>
          <div id="leq-structure" class="builder-section hidden">
            <label>Focus Skills</label>
            <div class="grid grid-cols-2 gap-2 text-xs mt-1">
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="leqSkill" value="thesis" checked onchange="window.app.teacher.updatePreview()">Thesis</label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="leqSkill" value="context" onchange="window.app.teacher.updatePreview()">Contextualization</label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="leqSkill" value="evidence" onchange="window.app.teacher.updatePreview()">Evidence</label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="leqSkill" value="reasoning" onchange="window.app.teacher.updatePreview()">Reasoning</label>
            </div>
          </div>
          <div id="dbq-structure" class="builder-section hidden">
            <label>DBQ Documents</label>
            <div class="hcard p-3 mt-1">
              <div class="grid sm:grid-cols-3 gap-2 mb-2">
                <select id="dbq-source-type" class="hinp text-xs">
                  <option value="text">Text Excerpt</option>
                  <option value="image">Image (URL)</option>
                  <option value="chart">Chart / Table</option>
                  <option value="map">Map</option>
                </select>
                <input id="dbq-source-label" placeholder="Label (e.g. Treaty of Tordesillas)" class="hinp text-xs">
                <input id="dbq-source-content" placeholder="Paste text or image URL" class="hinp text-xs">
              </div>
              <div id="dbq-source-image-hint" class="hidden text-[10px] mb-2" style="color:var(--sg)"><i data-lucide="image" class="w-3 h-3 inline"></i> Paste a public image URL (.jpg, .png, .webp, .gif). It will display inline for students.</div>
              <button type="button" onclick="window.app.teacher.addDbqSource()" class="btnP text-xs py-1.5 px-3">Add Document</button>
            </div>
            <div id="dbq-sources-list" class="mt-2 space-y-2"></div>
          </div>
          <div class="builder-section">
            <label>Max Attempts</label>
            <input name="maxAttempts" type="number" value="3" min="1" max="10" class="hinp w-24">
          </div>
          <div class="flex gap-2 mt-4 pt-4" style="border-top:1px solid var(--bd)">
            <button type="button" onclick="window.app.router.go('class-detail',{classData:window.app.teacher._classDataCache})" class="btnG flex-1">Cancel</button>
            <button class="btnP flex-1">Create Assignment</button>
          </div>
        </form>
      </div>
      <div class="builder-preview csc">
        <div class="builder-preview-label"><i data-lucide="eye" class="w-4 h-4"></i>Student Preview</div>
        <div class="builder-preview-inner" id="builder-preview-content">
          <div class="preview-empty"><i data-lucide="pencil-line" class="w-8 h-8 mx-auto mb-3" style="color:var(--bd)"></i><p class="text-sm" style="color:var(--mu)">Start filling in the form to see<br>what students will see.</p></div>
        </div>
      </div>
    </div>`; },

  assignmentDetail: (assignment, cls) => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('class-detail',{classData:window.app.teacher._classDataCache})" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to ${cls.name}</button>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-2">
        <div>
          <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${assignment.type}</span>
          <h1 class="text-2xl font-bold fs mt-2">${assignment.title}</h1>
        </div>
        <button onclick="window.app.teacher.exportAssignmentGrades(window.app.teacher._lastAssignment)" class="btnG text-xs py-2 px-4 flex items-center gap-2"><i data-lucide="download" class="w-3.5 h-3.5"></i>Export Grades (.xlsx)</button>
      </div>
      <div class="mt-3 mb-6 p-4 rounded-xl fs text-sm leading-relaxed" style="background:var(--elev);border:1px solid var(--bd)">${assignment.prompt}</div>
      ${assignment.structure?.sources?.length ? `<div class="mb-6"><h3 class="text-sm font-bold mb-2">Documents</h3>${assignment.structure.sources.map((s,i) => `<div class="preview-doc">${window.app.teacher.renderDocContent(s,i)}</div>`).join('')}</div>` : ''}
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold">Student Submissions</h3>
      </div>
      <div id="submissions-list"><p class="text-sm" style="color:var(--fa)">Loading submissions…</p></div>
    </div>`,

  library: () => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
      <h1 class="text-2xl font-bold fs mb-2">Assignment Library</h1>
      <p class="text-sm mb-6" style="color:var(--mu)">Ready-made AP World assignments. Clone one into your class with a single click.</p>
      <div id="library-classes-bar" class="mb-4 p-3 rounded-xl flex flex-wrap items-center gap-2" style="background:var(--elev);border:1px solid var(--bd)">
        <span class="text-xs font-bold" style="color:var(--mu)">Clone into:</span>
        <span class="text-xs" style="color:var(--fa)">Loading classes…</span>
      </div>
      <h2 class="text-lg font-bold fs mb-3 flex items-center gap-2"><span class="w-7 h-7 rounded-lg flex items-center justify-center" style="background:linear-gradient(135deg,var(--ac),var(--gd))"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></span> Story Lessons <span class="text-[10px] fm font-bold px-2 py-0.5 rounded-full" style="background:rgba(77,128,96,.1);color:var(--sg)">NEW</span></h2>
      <p class="text-xs mb-4" style="color:var(--mu)">AI-driven immersive stories that teach through narrative. Students read, experience history, and prove they understand before moving on.</p>
      <div class="grid sm:grid-cols-2 gap-4 mb-8 stagger">
        ${Object.entries(STORY_LESSONS).map(([id, s]) => `<div class="story-lib-card">
          <div class="story-lib-cover" style="background:${s.chapters[0].bg}">
            <span style="font-size:36px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.4))">${s.chapters[0].icon}</span>
            <p class="text-[10px] font-bold uppercase tracking-widest mt-2" style="color:rgba(255,255,255,.5)">Unit ${s.unit} · ${s.period}</p>
            <h3 class="font-bold text-lg fs" style="color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.4)">${s.title}</h3>
          </div>
          <div class="p-4" style="background:var(--card)">
            <p class="text-xs mb-3" style="color:var(--mu)">${s.desc}</p>
            <p class="text-[10px] mb-3" style="color:var(--fa)">${s.chapters.length} chapters · AI retention checks · ~15 min</p>
            <div class="flex gap-2">
              <button onclick="window.app.teacher.assignStory('${id}')" class="btnP text-xs flex-1">Assign to Class</button>
              <button onclick="window.app.router.go('story-lesson',{storyId:'${id}'})" class="btnG text-xs flex-1">Preview</button>
            </div>
          </div>
        </div>`).join('')}
      </div>
      <h2 class="text-lg font-bold fs mb-3">Essay Assignments</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 stagger">
        ${LIBRARY_TEMPLATES.map((t, idx) => `<div class="hcard p-5 flex flex-col justify-between"><div class="mb-4"><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${t.type}</span><h3 class="font-bold mt-2 text-sm">${t.title}</h3><p class="text-xs mt-1 line-clamp-3" style="color:var(--mu)">${t.prompt}</p>${t.sources?.length ? `<p class="text-[10px] mt-1" style="color:var(--fa)">${t.sources.length} document${t.sources.length > 1 ? 's' : ''} attached</p>` : ''}</div><button onclick="window.app.teacher.cloneTemplate(${idx})" class="btnP text-xs w-full">Clone to Class</button></div>`).join('')}
      </div>
    </div>`,

  editor: (a) => {
    const draft = localStorage.getItem(`draft_${a.id}`) || '';
    const renderSrc = (s, i) => {
      const isUrl = /^https?:\/\//i.test(s.content);
      let body;
      if (s.type === 'image' || s.type === 'map' || (isUrl && s.type === 'chart')) {
        body = `<img src="${s.content}" alt="${s.label||'Document '+(i+1)}" class="doc-img-preview" onerror="this.outerHTML='<div class=\\'doc-img-error\\'>Image could not be loaded. Check the URL.</div>'">`;
      } else {
        body = `<p class="text-xs leading-relaxed mt-1" style="color:var(--mu);white-space:pre-wrap">${s.content}</p>`;
      }
      return `<div class="p-3 rounded-lg mb-2" style="background:var(--elev);border:1px solid var(--bd)"><div class="flex items-center gap-2 mb-1"><span class="doc-badge doc-badge-${s.type}">${s.type}</span><span class="text-xs font-bold" style="color:var(--ac)">Doc ${i + 1}: ${s.label || s.title || ''}</span></div>${body}</div>`;
    };
    const srcHtml = a.structure?.sources?.length ? `<div class="mt-4"><h3 class="text-sm font-bold mb-2">Documents</h3>${a.structure.sources.map((s, i) => renderSrc(s, i)).join('')}</div>` : '';
    return `
    <div class="h-[calc(100vh-56px)] flex pageEnter">
      <div class="w-full md:w-[45%] overflow-y-auto p-6 md:p-8 csc slideLeft" style="background:var(--card);border-right:1px solid var(--bd)">
        <button onclick="window.app.router.go(appState.demoMode && !appState.user ? 'home' : 'student-dash')" class="mb-5 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Exit</button>
        <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${a.type}</span>
        <h2 class="text-xl font-bold fs mt-3">Prompt</h2>
        <div class="mt-3 p-4 rounded-xl fs text-sm leading-relaxed" style="background:var(--elev);border:1px solid var(--bd)">${a.prompt}</div>
        ${srcHtml}
      </div>
      <div class="w-full md:w-[55%] flex flex-col relative slideRight" style="background:var(--card)">
        <div class="absolute top-4 right-4 z-10"><button id="submit-btn" onclick="window.app.student.submitEssay()" class="btnP shadow-lg text-sm py-2 px-6">Submit</button></div>
        <textarea id="essay-input" class="flex-1 p-6 md:p-10 text-base md:text-lg resize-none focus:outline-none fs leading-relaxed" style="background:transparent;color:var(--tx)" placeholder="Start writing your response…" oninput="window.app.student.onEditorInput(this)">${draft}</textarea>
        <div class="px-6 pb-3 flex justify-between text-[11px]" style="color:var(--fa)"><span id="word-count">0 words</span><span>Auto-saved</span></div>
      </div>
    </div>`;
  },

  results: (sub, a) => {
    setTimeout(() => confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 }, colors: ['#d4622f', '#c49528', '#4d8060'] }), 400);
    let html = sub.essayText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const annotations = sub.grading.annotations || [];
    annotations.forEach((ann, idx) => {
      if (ann.quote) {
        const escaped = ann.quote.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const cls = ann.status === 'success' ? 'hl-success' : ann.status === 'warning' ? 'hl-warning' : 'hl-error';
        const num = idx + 1;
        html = html.replace(escaped, `<span class="${cls} hl-inline" data-ann="${num}" onclick="document.getElementById('ann-${num}')?.scrollIntoView({behavior:'smooth',block:'center'});document.getElementById('ann-${num}')?.classList.add('ann-flash');setTimeout(()=>document.getElementById('ann-${num}')?.classList.remove('ann-flash'),800)"><span class="hl-num">${num}</span>${escaped}</span>`);
      }
    });
    const pct = Math.round((sub.grading.score / sub.grading.maxScore) * 100);
    const grade = pct >= 80 ? 'Excellent' : pct >= 60 ? 'Proficient' : pct >= 40 ? 'Developing' : 'Needs Work';
    const encourageMsg = pct >= 80 ? "Outstanding work! You're demonstrating real mastery of AP World History writing skills."
      : pct >= 60 ? "Great progress! Your historical thinking is getting stronger with every essay."
      : pct >= 40 ? "You're building a solid foundation — keep practicing and you'll see big gains!"
      : "Every great historian started somewhere. Keep writing, and watch your skills grow!";
    const encourageIcon = pct >= 80 ? '🏆' : pct >= 60 ? '⭐' : pct >= 40 ? '📈' : '💪';
    return `
    <div class="h-[calc(100vh-56px)] flex pageEnter">
      <div class="flex-1 overflow-y-auto p-6 md:p-10 csc">
        <div class="flex items-center gap-3 mb-5">
          <button onclick="window.app.ui.resultsBack()" class="text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
          ${a.demo ? '<button onclick="window.app.router.go(\'demo\')" class="btnP text-xs py-1.5 px-4">Try Again</button>' : ''}
        </div>
        <div class="flex items-center gap-3 mb-1">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:linear-gradient(135deg,var(--ac),var(--gd))">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="15" x2="15" y2="15"/><line x1="12" y1="18" x2="12" y2="12"/></svg>
          </div>
          <div><h1 class="text-2xl font-bold fs">Grading Report</h1><p class="text-xs" style="color:var(--mu)">${a.title}</p></div>
        </div>
        ${appState._usedMockGrading ? `<div class="mb-4 p-3 rounded-xl text-xs flex items-start gap-2" style="background:rgba(196,149,40,.08);border:1px solid rgba(196,149,40,.2)"><i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5" style="color:var(--gd)"></i><div><span class="font-bold" style="color:var(--gd)">Demo Feedback</span><span style="color:var(--mu)"> — No Claude API key is set, so this is sample feedback. Add your API key in <button onclick="window.app.ui.toggleSettings()" class="font-bold underline" style="color:var(--ac)">Settings</button> for real AI grading.</span></div></div>` : ''}
        <div class="hcard p-6 md:p-8 fs text-base md:text-lg leading-relaxed" style="white-space:pre-wrap">${html}</div>
        <div class="mt-4 p-4 rounded-xl text-xs" style="background:var(--elev);border:1px solid var(--bd);color:var(--mu)">
          <div class="hl-legend">
            <span class="hl-legend-item"><span class="hl-legend-swatch" style="background:rgba(77,128,96,.15);border-bottom:2px solid var(--sg)"></span> Strong — point earned</span>
            <span class="hl-legend-item"><span class="hl-legend-swatch" style="background:rgba(196,149,40,.15);border-bottom:2px solid var(--gd)"></span> Close — almost there</span>
            <span class="hl-legend-item"><span class="hl-legend-swatch" style="background:rgba(212,98,47,.15);border-bottom:2px solid var(--ac)"></span> Needs work — room to grow</span>
          </div>
          <p class="mt-2" style="color:var(--fa)">Click a numbered highlight to jump to its feedback.</p>
        </div>
      </div>
      <div class="w-80 md:w-96 overflow-y-auto p-6 csc" style="background:var(--card);border-left:1px solid var(--bd)">
        <div class="text-center mb-5">
          <div class="text-5xl font-bold fs score-reveal" style="color:var(--ac)">${sub.grading.score}<span class="text-xl" style="color:var(--fa)">/${sub.grading.maxScore}</span></div>
          <div class="text-xs font-semibold mt-1 fadeIn" style="color:var(--mu)">${grade}</div>
          <div class="xpBar w-full mt-3"><div class="xpFill" style="width:${pct}%"></div></div>
        </div>
        <div class="enc-banner mb-5">
          <div class="flex items-start gap-3">
            <span class="text-2xl">${encourageIcon}</span>
            <div>
              <p class="text-sm font-semibold mb-1">${grade}!</p>
              <p class="text-xs" style="color:var(--mu)">${encourageMsg}</p>
            </div>
          </div>
        </div>
        ${sub.grading.generalFeedback ? `<p class="text-sm mb-5 leading-relaxed" style="color:var(--mu)">${sub.grading.generalFeedback}</p>` : ''}
        <h4 class="text-xs font-bold uppercase tracking-wider mb-3" style="color:var(--fa)">Detailed Feedback</h4>
        <div class="space-y-3 stagger">
          ${annotations.map((ann, idx) => {
            const num = idx + 1;
            const dot = ann.status === 'success' ? 'var(--sg)' : ann.status === 'warning' ? 'var(--gd)' : 'var(--ac)';
            const statusCls = 'ann-card-' + ann.status;
            const statusLabel = ann.status === 'success' ? 'Point Earned' : ann.status === 'warning' ? 'Almost There' : 'Needs Work';
            const tipHtml = ann.improvementTip && ann.status !== 'success'
              ? `<div class="tip-box ${ann.status === 'error' ? 'tip-box-error' : ''}" style="margin-top:8px"><p class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color:${dot}">💡 Try this</p><p class="text-xs" style="color:var(--mu)">${ann.improvementTip}</p></div>` : '';
            const encourageHtml = ann.status === 'success' ? '<p class="text-[10px] mt-2 font-medium" style="color:var(--sg)">✓ Great job on this!</p>' : '';
            return `<div id="ann-${num}" class="ann-card ${statusCls}" onclick="var el=document.querySelector('[data-ann=&quot;${num}&quot;]');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});}">
              <div class="flex items-center justify-between mb-1.5">
                <div class="flex items-center gap-2">
                  <span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold text-white" style="background:${dot}">${num}</span>
                  <span class="text-[11px] font-bold uppercase" style="color:${dot}">${ann.category}</span>
                </div>
                <span class="text-[10px] font-semibold px-2 py-0.5 rounded-full" style="background:${ann.status === 'success' ? 'rgba(77,128,96,.12)' : ann.status === 'warning' ? 'rgba(196,149,40,.12)' : 'rgba(212,98,47,.12)'};color:${dot}">${statusLabel}</span>
              </div>
              ${ann.quote ? `<p class="text-[11px] italic mb-1.5 pl-2" style="color:var(--fa);border-left:2px solid var(--bd)">"${ann.quote.length > 80 ? ann.quote.substring(0, 80) + '…' : ann.quote}"</p>` : ''}
              <p class="text-xs" style="color:var(--mu)">${ann.feedback}</p>
              ${encourageHtml}
              ${tipHtml}
            </div>`;
          }).join('')}
        </div>
        ${annotations.some(ann => ann.status !== 'success') ? `
        <div class="mt-6 p-4 rounded-xl" style="background:var(--acs)">
          <h4 class="text-xs font-bold mb-2" style="color:var(--ac)">🎯 Next Steps</h4>
          <ul class="text-xs space-y-1.5" style="color:var(--mu)">
            ${annotations.filter(ann => ann.status !== 'success' && ann.improvementTip).map(ann => `<li class="flex items-start gap-1.5"><span style="color:var(--ac)">→</span> ${ann.improvementTip}</li>`).join('')}
            ${annotations.filter(ann => ann.status !== 'success' && ann.improvementTip).length === 0 ? '<li class="flex items-start gap-1.5"><span style="color:var(--ac)">→</span> Review the highlighted sections and revise for your next attempt.</li>' : ''}
          </ul>
          <p class="text-[10px] mt-3 font-medium" style="color:var(--ac)">Focus on one area at a time — you've got this!</p>
        </div>` : `
        <div class="mt-6 p-4 rounded-xl text-center" style="background:rgba(77,128,96,.08);border:1px solid rgba(77,128,96,.2)">
          <span class="text-2xl">🌟</span>
          <p class="text-xs font-semibold mt-1" style="color:var(--sg)">Amazing work across the board!</p>
          <p class="text-[10px] mt-1" style="color:var(--mu)">Keep this up and you'll ace the AP exam.</p>
        </div>`}
      </div>
    </div>`;
  },

  // ═══ ESSAY BLOCKS VIEWS ═══
  blocksSolo: (prompt) => `
    <div class="max-w-4xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('student-dash')" class="mb-4 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Dashboard</button>
      <div class="eb-wrap">
        <div class="text-center mb-6">
          <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${prompt.type.toUpperCase()} — Essay Blocks</span>
          <h1 class="text-2xl font-bold fs mt-2">${prompt.title}</h1>
          <p class="text-sm mt-2" style="color:var(--mu);max-width:500px;margin:0 auto">${prompt.prompt}</p>
        </div>
        <div class="eb-progress" id="eb-progress"></div>
        <div id="eb-current-block"></div>
        <div id="eb-consolidated" class="hidden"></div>
      </div>
    </div>`,

  blocksLobby: (sessionId) => `
    <div class="max-w-4xl mx-auto px-4 py-8 pageEnter">
      <button onclick="window.app.router.go(appState.userData?.role==='teacher'?'teacher-dash':'student-dash')" class="mb-4 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
      <div class="eb-lobby">
        <div class="mb-4">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" style="margin:0 auto"><circle cx="32" cy="32" r="28" stroke="var(--ac)" stroke-width="2" opacity=".15"/><circle cx="32" cy="32" r="18" stroke="var(--gd)" stroke-width="1.5" opacity=".2"/><circle cx="22" cy="28" r="5" fill="var(--ac)" opacity=".2"/><circle cx="42" cy="28" r="5" fill="var(--sg)" opacity=".2"/><circle cx="32" cy="42" r="5" fill="var(--ry)" opacity=".2"/><line x1="22" y1="28" x2="42" y2="28" stroke="var(--bd2)" stroke-width="1" stroke-dasharray="3 3"/><line x1="22" y1="28" x2="32" y2="42" stroke="var(--bd2)" stroke-width="1" stroke-dasharray="3 3"/><line x1="42" y1="28" x2="32" y2="42" stroke="var(--bd2)" stroke-width="1" stroke-dasharray="3 3"/></svg>
        </div>
        <div class="mb-4">
          <span class="text-[10px] font-bold fm uppercase px-3 py-1.5 rounded-lg" style="background:var(--acs);color:var(--ac)">Multiplayer Essay Blocks</span>
        </div>
        <h1 class="text-3xl font-bold fs mb-2" id="lobby-title">Waiting for players...</h1>
        <p class="text-sm mb-2" style="color:var(--mu)" id="lobby-prompt"></p>
        <div class="hcard p-4 inline-block mb-6">
          <p class="text-[10px] font-bold uppercase mb-1" style="color:var(--fa)">Session Code</p>
          <p class="text-2xl font-bold fm" style="color:var(--ac)" id="lobby-code">${sessionId}</p>
        </div>
        <div id="lobby-players" class="space-y-2 mb-6 stagger"></div>
        <div id="lobby-actions"></div>
      </div>
    </div>`,

  blocksPlay: (sessionId) => `
    <div class="pageEnter" style="min-height:100vh">
      <!-- TEACHER BOARD VIEW -->
      <div id="mp-teacher-view" class="hidden" style="max-width:860px;margin:0 auto;padding:40px 24px">
        <div class="text-center mb-6">
          <span class="text-[10px] font-bold fm uppercase px-3 py-1.5 rounded-lg" style="background:var(--acs);color:var(--ac);letter-spacing:.1em">Live Session</span>
          <h1 class="text-2xl font-bold fs mt-4 mb-2" id="mp-t-title">Essay Blocks</h1>
        </div>
        <div id="mp-t-prompt" class="mb-4 p-4 rounded-2xl text-sm leading-relaxed" style="background:var(--elev);border:1px solid var(--bd);color:var(--mu)"></div>
        <div id="mp-t-thesis" class="hidden eb-thesis-bar mb-6"></div>
        <div class="text-center mb-8">
          <div class="eb-timer eb-timer-board" id="mp-t-timer">--:--</div>
          <p class="text-sm mt-2 fm" style="color:var(--fa)">Time Remaining</p>
        </div>
        <div id="mp-t-progress" class="grid gap-4 mb-8" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))"></div>
        <div class="text-center">
          <button onclick="window.app.blocks.endSession('${sessionId}')" class="btnP py-3 px-10 text-base font-bold" style="font-size:16px">End Game</button>
        </div>
      </div>
      <!-- STUDENT VIEW -->
      <div id="mp-student-view" class="hidden" style="max-width:680px;margin:0 auto;padding:24px 16px">
        <div class="flex justify-between items-center mb-3">
          <button onclick="if(confirm('Leave the game? Your block will be submitted as-is.')){window.app.blocks.submitMultiBlock('${sessionId}');window.app.router.go('student-dash')}" class="text-xs flex items-center gap-1" style="color:var(--fa)"><i data-lucide="arrow-left" class="w-3 h-3"></i>Exit</button>
          <div class="eb-timer text-lg" id="mp-timer" style="font-size:22px">--:--</div>
        </div>
        <div id="mp-prompt-bar" class="mb-3 p-3 rounded-xl text-xs" style="background:var(--elev);border:1px solid var(--bd)">
          <span class="font-bold" style="color:var(--ac)">Prompt:</span> <span id="mp-prompt-text" class="fs" style="color:var(--mu)">Loading...</span>
        </div>
        <div id="mp-thesis-bar" class="hidden eb-thesis-bar mb-4">
          <span class="text-[10px] font-bold uppercase tracking-wider block mb-1" style="color:var(--ac)">Working Thesis</span>
          <span id="mp-thesis-text" class="text-sm"></span>
        </div>
        <div id="mp-block-info" class="mb-4"></div>
        <div id="mp-block-doc" class="hidden"></div>
        <div id="mp-block-area"></div>
      </div>
    </div>`,

  blocksReview: (sessionId) => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <div class="flex justify-between items-center mb-6">
        <div>
          <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">Review Phase</span>
          <h1 class="text-2xl font-bold fs mt-2">Grade the Essays!</h1>
          <p class="text-sm mt-1" style="color:var(--mu)">Read each group's essay and vote for the best one.</p>
        </div>
        <div class="flex gap-2">
          ${appState.userData?.role === 'teacher' ? '<button onclick="window.app.blocks.endSession(\''+sessionId+'\')" class="btnP text-xs py-2 px-4">Finish & Show Results</button>' : ''}
          <button onclick="window.app.router.go('student-dash')" class="btnG text-xs py-2 px-4">Back to Dashboard</button>
        </div>
      </div>
      <div id="review-essays" class="space-y-6 stagger"></div>
      <div id="review-results" class="hidden mt-8"></div>
    </div>`,

  lessonLab: () => `
    <div class="max-w-3xl mx-auto px-4 py-8 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Dashboard</button>
      <!-- Header -->
      <div class="text-center mb-10">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg" style="background:linear-gradient(135deg,var(--gd),var(--ac))">
          <span class="lab-icon text-2xl">✨</span>
        </div>
        <h1 class="text-3xl font-bold fs mb-2">Lesson Lab</h1>
        <p class="text-sm" style="color:var(--mu)">Describe what you want to teach — Claude builds it in seconds. Edit, customize, and save it to your library.</p>
      </div>

      <!-- Phase 1: Template + Input -->
      <div id="lab-phase1">
        <!-- Template selector -->
        <h2 class="text-xs font-bold uppercase tracking-wider mb-3" style="color:var(--fa)">What are you creating?</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
          <div class="lab-template-card selected" id="lab-t-story" onclick="window.app.lab.selectTemplate('story')">
            <span class="lab-t-icon">📖</span>
            <p class="text-sm font-bold fs">Story Lesson</p>
            <p class="text-[10px] mt-1" style="color:var(--mu)">Immersive narrative chapters</p>
          </div>
          <div class="lab-template-card" id="lab-t-dbq" onclick="window.app.lab.selectTemplate('dbq')">
            <span class="lab-t-icon">🧩</span>
            <p class="text-sm font-bold fs">Essay Blocks</p>
            <p class="text-[10px] mt-1" style="color:var(--mu)">DBQ / LEQ / SAQ</p>
          </div>
          <div class="lab-template-card" id="lab-t-quiz" onclick="window.app.lab.selectTemplate('quiz')">
            <span class="lab-t-icon">🎮</span>
            <p class="text-sm font-bold fs">Live Quiz</p>
            <p class="text-[10px] mt-1" style="color:var(--mu)">Blooket-style MCQ game</p>
          </div>
          <div class="lab-template-card" id="lab-t-writing" onclick="window.app.lab.selectTemplate('writing')">
            <span class="lab-t-icon">✍️</span>
            <p class="text-sm font-bold fs">Writing Assignment</p>
            <p class="text-[10px] mt-1" style="color:var(--mu)">Prompt + rubric</p>
          </div>
        </div>

        <!-- Template-specific options -->
        <div id="lab-template-opts" class="mb-4"></div>

        <!-- AI input -->
        <div class="hcard p-6">
          <label class="text-[10px] font-bold uppercase tracking-wider mb-2 block" style="color:var(--fa)">Topic, standard, or instructions</label>
          <textarea id="lab-topic" class="hinp w-full mb-1" rows="3" placeholder="e.g. APWH 6.5 Economic Imperialism — I want students to understand how European powers used economic pressure to control Africa and Asia. Focus on the perspectives of both colonizers and the colonized."></textarea>
          <p class="text-[10px] mb-4" style="color:var(--mu)">Be specific — include the time period, key themes, or any standards you're targeting.</p>
          <button class="lab-generate-btn" onclick="window.app.lab.generate()">
            <i data-lucide="sparkles" class="w-5 h-5"></i> Generate with Claude AI
          </button>
        </div>
      </div>

      <!-- Phase 2: Editor (hidden until generated) -->
      <div id="lab-phase2" class="hidden mt-8">
        <div class="flex items-center justify-between mb-4">
          <button onclick="document.getElementById('lab-phase1').classList.remove('hidden');document.getElementById('lab-phase2').classList.add('hidden')" class="text-xs flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>Start over</button>
          <button id="lab-save-btn" onclick="window.app.lab.save()" class="btnP text-sm py-2 px-6 flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i>Save to Library</button>
        </div>
        <div id="lab-editor-content"></div>
        <div id="lab-save-result" class="hidden mt-4"></div>
      </div>
    </div>`,

  teacherTour: () => `
    <div class="max-w-4xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-4 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Dashboard</button>
      <div class="text-center mb-8">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-sm" style="background:linear-gradient(135deg,var(--ac),var(--gd))">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
        </div>
        <h1 class="text-2xl font-bold fs">Feature Tour</h1>
        <p class="text-sm mt-1" style="color:var(--mu)">See how each feature works with animated walkthroughs</p>
      </div>
      <div class="tour-nav" id="tour-nav"></div>
      <div id="tour-container" style="min-height:400px"></div>
      <div class="flex justify-center gap-3 mt-6">
        <button onclick="window.app.teacher.tourPrev()" class="btnG text-sm py-2 px-5" id="tour-prev">← Previous</button>
        <button onclick="window.app.teacher.tourNext()" class="btnP text-sm py-2 px-5" id="tour-next">Next →</button>
      </div>
    </div>`,

  storyLesson: (storyId) => {
    const story = STORY_LESSONS[storyId];
    if (!story) return `<div class="p-8 text-center"><p>Story not found.</p></div>`;
    return `
    <div class="max-w-3xl mx-auto px-4 py-6 pageEnter" id="story-root" data-story="${storyId}">
      <div class="flex items-center justify-between mb-4">
        <button onclick="window.app.story.exit()" class="text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
        <div class="text-right"><span class="text-[10px] fm font-bold px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">Unit ${story.unit}</span></div>
      </div>
      <div class="story-progress" id="story-progress"></div>
      <div id="story-content"></div>
    </div>`;
  },

  quizGame: () => `
    <div class="qz-wrap flex flex-col items-center justify-center p-6 text-center" id="qz-root">
      <div id="qz-lobby" class="w-full max-w-lg">
        <div class="mb-6">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style="background:linear-gradient(135deg,#c0392b,#d35400)"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <h1 class="text-2xl font-bold fs mb-1">AP History Live Quiz</h1>
          <p class="text-xs" style="color:#9a9385" id="qz-subtitle">Loading...</p>
        </div>
        <div class="mb-6"><p class="text-xs mb-1" style="color:#655f52">Game Code</p><div class="qz-lobby-code fm" id="qz-code">----</div></div>
        <div class="qz-player-grid mb-6" id="qz-players"></div>
        <div id="qz-lobby-actions"></div>
      </div>
      <div id="qz-question" class="hidden w-full max-w-xl">
        <div class="flex justify-between items-center mb-4 px-2">
          <span class="text-xs fm" style="color:#655f52" id="qz-qnum">Q1/10</span>
          <div class="qz-timer" id="qz-timer" style="border-color:var(--ac);color:var(--ac)">20</div>
          <span class="text-xs fm" style="color:#655f52">Score: <span class="text-white font-bold" id="qz-my-score">0</span></span>
        </div>
        <div class="mb-6 p-5 rounded-2xl" style="background:rgba(255,255,255,.05)">
          <p class="text-sm font-semibold" id="qz-q-text" style="line-height:1.6"></p>
        </div>
        <div class="qz-choices" id="qz-choices"></div>
        <div class="mt-4 text-center hidden" id="qz-answer-feedback"></div>
      </div>
      <div id="qz-leaderboard" class="hidden w-full max-w-md">
        <h2 class="text-xl font-bold fs mb-4">Leaderboard</h2>
        <div id="qz-lb-list" class="mb-4"></div>
        <div id="qz-lb-actions"></div>
      </div>
      <div id="qz-podium" class="hidden w-full max-w-lg">
        <h2 class="text-2xl font-bold fs mb-2">Final Results!</h2>
        <div class="qz-podium" id="qz-podium-display"></div>
        <div id="qz-podium-full" class="mb-4"></div>
        <button onclick="window.app.quiz.exit()" class="btnP text-sm px-8 py-3">Back to Dashboard</button>
      </div>
    </div>`
},

// ═══ AUTH ═══
auth: {
  login: async (email, password) => {
    window.app.ui.btnLoading('login-btn', true);
    try { await signInWithEmailAndPassword(auth, email, password); }
    catch (e) { window.app.ui.toast(e.message, 'error'); window.app.ui.btnLoading('login-btn', false); }
  },
  signup: async (name, email, password, role, studentId) => {
    window.app.ui.btnLoading('signup-btn', true);
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const userData = { name, email, role, createdAt: serverTimestamp(), gamification: role === 'student' ? window.app.game.getDefaultStats() : null };
      if (studentId?.trim()) userData.studentId = studentId.trim();
      await setDoc(doc(db, "users", cred.user.uid), userData);
      await updateProfile(cred.user, { displayName: name });
    } catch (e) { window.app.ui.toast(e.message, 'error'); window.app.ui.btnLoading('signup-btn', false); }
  },
  logout: async () => { await signOut(auth); appState.user = null; appState.userData = null; window.app.ui.updateNav(); window.app.router.go('home'); }
},

// ═══ TEACHER ═══
teacher: {
  dbqSources: [],
  _classDataCache: null,
  init: () => {
    const q2 = query(collection(db, "classes"), where("teacherId", "==", appState.user.uid));
    onSnapshot(q2, snap => {
      const el = document.getElementById('classes-list'); if (!el) return;
      if (snap.empty) { el.innerHTML = `<div class="col-span-3 text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><p style="color:var(--mu)" class="text-sm mb-1">No classes yet</p><p class="text-xs" style="color:var(--fa)">Click "New Class" to get started.</p></div>`; return; }
      el.innerHTML = snap.docs.map(d => {
        const data = d.data(); const payload = JSON.stringify({ id: d.id, ...data }).replace(/'/g, "&#39;");
        return `<div class="hcard p-5 cursor-pointer" onclick='window.app.router.go("class-detail",{classData:${payload}})'><h3 class="font-bold">${data.name}</h3><p class="text-xs fm mt-1" style="color:var(--mu)">Code: <span style="color:var(--ac)" class="font-bold">${data.code}</span></p><p class="text-[11px] mt-1" style="color:var(--fa)">${(data.students||[]).length} student${(data.students||[]).length===1?'':'s'}</p></div>`;
      }).join('');
    });
  },
  createClass: async () => {
    const name = document.getElementById('class-name').value.trim(); if (!name) return;
    const code = 'HIST-' + Math.floor(1000 + Math.random() * 9000);
    await addDoc(collection(db, 'classes'), { name, code, teacherId: appState.user.uid, students: [], createdAt: serverTimestamp() });
    window.app.ui.closeModal('create-class'); window.app.ui.toast('Class created!', 'success');
  },
  loadClass: (classId) => {
    const q2 = query(collection(db, "assignments"), where("classId", "==", classId));
    onSnapshot(q2, async snap => {
      const el = document.getElementById('assignments-list'); if (!el) return;
      if (snap.empty) { el.innerHTML = `<div class="text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><i data-lucide="file-text" class="w-8 h-8 mx-auto mb-2" style="color:var(--fa)"></i><p class="text-sm" style="color:var(--mu)">No assignments yet.</p><p class="text-xs" style="color:var(--fa)">Click "New Assignment" to create one.</p></div>`; lucide.createIcons(); return; }
      // Fetch submission counts per assignment
      const assignIds = snap.docs.map(d => d.id);
      let subCounts = {};
      try {
        for (let i = 0; i < assignIds.length; i += 10) {
          const batch = assignIds.slice(i, i + 10);
          const subSnap = await getDocs(query(collection(db, "submissions"), where("assignmentId", "in", batch)));
          subSnap.forEach(s => { const aid = s.data().assignmentId; subCounts[aid] = (subCounts[aid] || 0) + 1; });
        }
      } catch(e) { console.warn('Could not fetch submission counts', e); }
      // Get current class data from URL context
      el.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const count = subCounts[d.id] || 0;
        const aPayload = JSON.stringify({ id: d.id, ...data }).replace(/'/g, "&#39;");
        return `<div class="hcard p-4 cursor-pointer" onclick='window.app.router.go("assignment-detail",{assignment:${aPayload},classData:window.app.teacher._classDataCache})'>
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${data.type}</span>
                <h4 class="font-bold text-sm truncate">${data.title}</h4>
              </div>
              <p class="text-xs truncate" style="color:var(--mu)">${data.prompt}</p>
            </div>
            <div class="flex items-center gap-3 ml-3">
              <div class="text-center"><div class="text-lg font-bold" style="color:var(--ac)">${count}</div><div class="text-[10px]" style="color:var(--fa)">submissions</div></div>
              <i data-lucide="chevron-right" class="w-4 h-4" style="color:var(--fa)"></i>
            </div>
          </div>
        </div>`;
      }).join('');
      lucide.createIcons();
    });
  },
  _selectedClassId: null,
  _teacherClasses: [],
  // ── Library clone ──
  initLibrary: async () => {
    try {
      const snap = await getDocs(query(collection(db, "classes"), where("teacherId", "==", appState.user.uid)));
      window.app.teacher._teacherClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const bar = document.getElementById('library-classes-bar');
      if (!bar) return;
      if (!snap.docs.length) { bar.innerHTML = `<span class="text-xs" style="color:var(--fa)">No classes yet. <button onclick="window.app.router.go('teacher-dash')" class="font-bold" style="color:var(--ac)">Create one first.</button></span>`; return; }
      window.app.teacher._selectedClassId = snap.docs[0].id;
      bar.innerHTML = `<span class="text-xs font-bold" style="color:var(--mu)">Clone into:</span>` +
        snap.docs.map(d => {
          const data = d.data();
          return `<button onclick="window.app.teacher._selectedClassId='${d.id}';document.querySelectorAll('.lib-cls-btn').forEach(b=>b.style.cssText='');this.style.cssText='background:var(--ac);color:#fff;border-color:var(--ac)'" class="lib-cls-btn text-xs px-3 py-1.5 rounded-lg font-semibold transition" style="${d.id === snap.docs[0].id ? 'background:var(--ac);color:#fff;border-color:var(--ac)' : 'border:1px solid var(--bd)'}">${data.name}</button>`;
        }).join('');
    } catch(e) { console.error(e); }
    lucide.createIcons();
  },
  cloneTemplate: async (idx) => {
    const t = LIBRARY_TEMPLATES[idx]; if (!t) return;
    const classId = window.app.teacher._selectedClassId;
    if (!classId) return window.app.ui.toast('Select a class first.', 'error');
    try {
      let structure = null;
      if (t.type === 'saq') structure = { kind: 'saq', parts: 3 };
      else if (t.type === 'leq') structure = { kind: 'leq', focusSkills: ['thesis', 'context', 'evidence', 'reasoning'] };
      else if (t.type === 'dbq') structure = { kind: 'dbq', sources: (t.sources || []).map(s => ({ type: s.type || 'text', label: s.title || s.label || '', content: s.content || '' })) };
      await addDoc(collection(db, 'assignments'), { classId, title: t.title, type: t.type, prompt: t.prompt, maxAttempts: t.maxAttempts || 3, teacherId: appState.user.uid, createdAt: serverTimestamp(), submissionsCount: 0, structure });
      const cls = window.app.teacher._teacherClasses.find(c => c.id === classId);
      window.app.ui.toast(`"${t.title}" added to ${cls?.name || 'class'}!`, 'success');
    } catch(e) { console.error(e); window.app.ui.toast('Clone failed: ' + e.message, 'error'); }
  },
  assignStory: async (storyId) => {
    const story = STORY_LESSONS[storyId]; if (!story) return;
    const classId = window.app.teacher._selectedClassId;
    if (!classId) return window.app.ui.toast('Select a class first.', 'error');
    try {
      await addDoc(collection(db, 'assignments'), {
        classId, title: `📖 ${story.title} (Unit ${story.unit})`, type: 'story', prompt: story.desc,
        storyId, maxAttempts: 99, teacherId: appState.user.uid, createdAt: serverTimestamp(), submissionsCount: 0,
        structure: { kind: 'story', storyId, chapters: story.chapters.length }
      });
      const cls = window.app.teacher._teacherClasses.find(c => c.id === classId);
      window.app.ui.toast(`Story "${story.title}" assigned to ${cls?.name || 'class'}!`, 'success');
    } catch(e) { console.error(e); window.app.ui.toast('Assign failed: ' + e.message, 'error'); }
  },
  // ── Builder functions ──
  initBuilder: () => {
    window.app.teacher.dbqSources = [];
    // Show image hint when image type selected
    const typeSelect = document.getElementById('dbq-source-type');
    if (typeSelect) {
      typeSelect.addEventListener('change', () => {
        const hint = document.getElementById('dbq-source-image-hint');
        if (hint) hint.classList.toggle('hidden', typeSelect.value === 'text');
        const placeholder = document.getElementById('dbq-source-content');
        if (placeholder) placeholder.placeholder = typeSelect.value === 'text' ? 'Paste the text excerpt…' : 'Paste the public image URL…';
      });
    }
    window.app.teacher.updatePreview();
    lucide.createIcons();
  },
  onTypeChange: (type) => {
    ['saq-structure', 'leq-structure', 'dbq-structure'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
    const map = { saq: 'saq-structure', leq: 'leq-structure', dbq: 'dbq-structure' };
    document.getElementById(map[type])?.classList.remove('hidden');
  },
  renderDocContent: (s, i) => {
    const isUrl = /^https?:\/\//i.test(s.content);
    let body;
    if (s.type === 'image' || s.type === 'map' || (isUrl && s.type === 'chart')) {
      body = `<img src="${s.content}" alt="${s.label||'Document '+(i+1)}" class="doc-img-preview" onerror="this.outerHTML='<div class=\\'doc-img-error\\'>Image could not be loaded. Check the URL.</div>'">`;
    } else {
      body = `<p class="text-xs leading-relaxed" style="color:var(--mu);white-space:pre-wrap">${s.content}</p>`;
    }
    return `<div class="flex items-center gap-2 mb-1"><span class="doc-badge doc-badge-${s.type}">${s.type}</span><span class="text-xs font-bold" style="color:var(--ac)">Doc ${i + 1}: ${s.label || ''}</span></div>${body}`;
  },
  addDbqSource: () => {
    const type = document.getElementById('dbq-source-type')?.value || 'text';
    const label = document.getElementById('dbq-source-label')?.value.trim();
    const content = document.getElementById('dbq-source-content')?.value.trim();
    if (!label || !content) return window.app.ui.toast('Need a label and content/URL.', 'error');
    if ((type === 'image' || type === 'map') && !/^https?:\/\//i.test(content)) return window.app.ui.toast('Image/map sources need a full URL starting with http.', 'error');
    window.app.teacher.dbqSources.push({ id: Date.now(), type, label, content });
    document.getElementById('dbq-source-label').value = '';
    document.getElementById('dbq-source-content').value = '';
    window.app.teacher.renderDbqSourcesList();
    window.app.teacher.updatePreview();
    window.app.ui.toast('Document added.', 'success');
  },
  removeDbqSource: (id) => {
    window.app.teacher.dbqSources = window.app.teacher.dbqSources.filter(s => s.id !== id);
    window.app.teacher.renderDbqSourcesList();
    window.app.teacher.updatePreview();
  },
  renderDbqSourcesList: () => {
    const list = document.getElementById('dbq-sources-list');
    if (!list) return;
    if (!window.app.teacher.dbqSources.length) { list.innerHTML = ''; return; }
    list.innerHTML = window.app.teacher.dbqSources.map((s, i) => {
      const isUrl = /^https?:\/\//i.test(s.content);
      const thumb = (s.type === 'image' || s.type === 'map' || (isUrl && s.type === 'chart'))
        ? `<img src="${s.content}" style="width:48px;height:36px;object-fit:cover;border-radius:6px;border:1px solid var(--bd)" onerror="this.style.display='none'">`
        : `<div style="width:48px;height:36px;border-radius:6px;background:var(--elev);border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--fa)">TXT</div>`;
      return `<div class="doc-card">
        <div class="doc-card-remove" onclick="window.app.teacher.removeDbqSource(${s.id})" title="Remove">&times;</div>
        <div class="flex items-center gap-3">
          ${thumb}
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2"><span class="doc-badge doc-badge-${s.type}">${s.type}</span><span class="text-xs font-bold">Doc ${i + 1}</span></div>
            <p class="text-xs truncate mt-0.5" style="color:var(--mu)">${s.label}</p>
          </div>
        </div>
      </div>`;
    }).join('');
  },
  updatePreview: () => {
    const el = document.getElementById('builder-preview-content');
    if (!el) return;
    const form = document.getElementById('builder-form');
    if (!form) return;
    const title = form.title?.value?.trim() || '';
    const type = form.type?.value || 'saq';
    const prompt = form.prompt?.value?.trim() || '';
    const typeLabels = { saq: 'SAQ — Short Answer', leq: 'LEQ — Long Essay', dbq: 'DBQ — Document Based' };
    if (!title && !prompt) {
      el.innerHTML = `<div class="preview-empty"><i data-lucide="pencil-line" class="w-8 h-8 mx-auto mb-3" style="color:var(--bd)"></i><p class="text-sm" style="color:var(--mu)">Start filling in the form to see<br>what students will see.</p></div>`;
      lucide.createIcons(); return;
    }
    // Build structure info
    let structInfo = '';
    if (type === 'saq') {
      const parts = parseInt(form.saqParts?.value) || 3;
      structInfo = `<p class="text-xs mt-2" style="color:var(--fa)">This question has ${parts} part${parts > 1 ? 's' : ''} (a${parts >= 2 ? ', b' : ''}${parts >= 3 ? ', c' : ''}${parts >= 4 ? ', d' : ''})</p>`;
    } else if (type === 'leq') {
      const skills = Array.from(form.querySelectorAll('input[name="leqSkill"]:checked')).map(i => i.value);
      if (skills.length) structInfo = `<div class="flex flex-wrap gap-1 mt-2">${skills.map(s => `<span class="text-[10px] px-2 py-0.5 rounded-full font-semibold" style="background:var(--acs);color:var(--ac)">${s}</span>`).join('')}</div>`;
    }
    // Build docs for DBQ
    let docsHtml = '';
    if (type === 'dbq' && window.app.teacher.dbqSources.length) {
      docsHtml = `<div class="mt-4"><h3 class="text-sm font-bold mb-2">Documents</h3>${window.app.teacher.dbqSources.map((s, i) => `<div class="preview-doc">${window.app.teacher.renderDocContent(s, i)}</div>`).join('')}</div>`;
    }
    el.innerHTML = `
      <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${typeLabels[type] || type}</span>
      <h2 class="text-xl font-bold fs mt-3">${title || '<span style="color:var(--fa)">Untitled Assignment</span>'}</h2>
      ${structInfo}
      <h3 class="text-sm font-bold fs mt-4 mb-2">Prompt</h3>
      <div class="preview-prompt">${prompt || '<span style="color:var(--fa)">No prompt yet…</span>'}</div>
      ${docsHtml}
      <div class="mt-6 p-4 rounded-xl" style="border:2px dashed var(--bd)">
        <p class="text-xs text-center" style="color:var(--fa)"><i data-lucide="pen-tool" class="w-4 h-4 inline mr-1"></i>Student essay textarea will appear here</p>
      </div>`;
    lucide.createIcons();
  },
  createAssignment: async (classId) => {
    const form = document.getElementById('builder-form'); if (!form) return;
    const title = form.title.value.trim(), type = form.type.value, prompt = form.prompt.value.trim(), maxAttempts = parseInt(form.maxAttempts.value) || 3;
    if (!title || !prompt) return window.app.ui.toast('Title and prompt required.', 'error');
    if (type === 'dbq' && !window.app.teacher.dbqSources.length) return window.app.ui.toast('DBQ needs at least one document source.', 'error');
    let structure = null;
    if (type === 'saq') structure = { kind: 'saq', parts: parseInt(form.saqParts?.value) || 3 };
    else if (type === 'leq') {
      const focusSkills = Array.from(form.querySelectorAll('input[name="leqSkill"]:checked')).map(i => i.value);
      if (!focusSkills.length) return window.app.ui.toast('Select at least one focus skill for this LEQ.', 'error');
      structure = { kind: 'leq', focusSkills };
    }
    else if (type === 'dbq') structure = { kind: 'dbq', sources: window.app.teacher.dbqSources.map(s => ({ type: s.type, label: s.label, content: s.content })) };
    try {
      await addDoc(collection(db, 'assignments'), { classId, title, type, prompt, maxAttempts, teacherId: appState.user.uid, createdAt: serverTimestamp(), submissionsCount: 0, structure });
      window.app.ui.toast('Assignment created!', 'success');
      window.app.teacher.dbqSources = [];
      // Navigate back to class detail
      if (window.app.teacher._classDataCache) window.app.router.go('class-detail', { classData: window.app.teacher._classDataCache });
      else window.app.router.go('teacher-dash');
    } catch(e) { console.error(e); window.app.ui.toast('Error creating assignment: ' + e.message, 'error'); }
  },
  // ── Submission viewing ──
  loadSubmissions: async (assignment) => {
    const el = document.getElementById('submissions-list'); if (!el) return;
    try {
      const snap = await getDocs(query(collection(db, "submissions"), where("assignmentId", "==", assignment.id)));
      if (snap.empty) { el.innerHTML = `<div class="text-center py-8" style="border:2px dashed var(--bd);border-radius:12px"><p class="text-sm" style="color:var(--mu)">No submissions yet.</p><p class="text-xs" style="color:var(--fa)">Students will appear here once they submit.</p></div>`; return; }
      const subs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      subs.sort((a, b) => (b.grading?.score || 0) - (a.grading?.score || 0));
      el.innerHTML = `<div class="hcard overflow-hidden">${subs.map(sub => {
        const score = sub.grading?.score ?? '?';
        const max = sub.grading?.maxScore ?? '?';
        const pct = max > 0 ? Math.round((score / max) * 100) : 0;
        const scoreCls = pct >= 70 ? 'sub-score-high' : pct >= 40 ? 'sub-score-mid' : 'sub-score-low';
        const subPayload = JSON.stringify(sub).replace(/'/g, "&#39;");
        const aPayload = JSON.stringify(assignment).replace(/'/g, "&#39;");
        return `<div class="sub-row" onclick='window.app.router.go("results",{submission:${subPayload},assignment:${aPayload}})' style="border-bottom:1px solid var(--bd)">
          <div class="w-7 h-7 rounded-lg flex items-center justify-center text-xs font-bold" style="background:var(--acs);color:var(--ac)">${(sub.studentName||'?')[0].toUpperCase()}</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold truncate">${sub.studentName || 'Unknown'}</p>
            <p class="text-[11px]" style="color:var(--fa)">${sub.submittedAt?.toDate ? sub.submittedAt.toDate().toLocaleDateString() : 'Recently'}</p>
          </div>
          <div class="sub-score ${scoreCls}">${score}/${max}</div>
          <i data-lucide="chevron-right" class="w-4 h-4" style="color:var(--fa)"></i>
        </div>`;
      }).join('')}</div>`;
      lucide.createIcons();
    } catch(e) { console.error(e); el.innerHTML = `<p class="text-sm" style="color:var(--ac)">Error loading submissions.</p>`; }
  },
  // ── Grade Export ──
  exportAssignmentGrades: async (assignment) => {
    try {
      window.app.ui.toast('Generating spreadsheet…', 'info');
      const subSnap = await getDocs(query(collection(db, "submissions"), where("assignmentId", "==", assignment.id)));
      if (subSnap.empty) return window.app.ui.toast('No submissions to export.', 'error');
      // Fetch student user docs to get studentId (school ID)
      const studentUids = [...new Set(subSnap.docs.map(d => d.data().studentId))];
      const studentMap = {};
      for (let i = 0; i < studentUids.length; i += 10) {
        const batch = studentUids.slice(i, i + 10);
        const userSnap = await getDocs(query(collection(db, "users"), where("__name__", "in", batch)));
        userSnap.forEach(u => { studentMap[u.id] = u.data(); });
      }
      // Build rows
      const rows = subSnap.docs.map(d => {
        const sub = d.data();
        const user = studentMap[sub.studentId] || {};
        const score = sub.grading?.score ?? '';
        const max = sub.grading?.maxScore ?? '';
        const pct = max > 0 ? Math.round((score / max) * 100) : '';
        const categories = (sub.grading?.annotations || []).map(a => `${a.category}: ${a.status}`).join('; ');
        return {
          'Student ID': user.studentId || '',
          'Student Name': sub.studentName || user.name || '',
          'Score': score,
          'Max Score': max,
          'Percentage': pct ? pct + '%' : '',
          'Rubric Breakdown': categories,
          'General Feedback': sub.grading?.generalFeedback || '',
          'Submitted': sub.submittedAt?.toDate ? sub.submittedAt.toDate().toLocaleDateString() : ''
        };
      });
      rows.sort((a, b) => (a['Student Name'] || '').localeCompare(b['Student Name'] || ''));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      // Set column widths
      ws['!cols'] = [{ wch: 12 }, { wch: 22 }, { wch: 8 }, { wch: 10 }, { wch: 12 }, { wch: 40 }, { wch: 50 }, { wch: 14 }];
      XLSX.utils.book_append_sheet(wb, ws, assignment.title?.substring(0, 31) || 'Grades');
      const filename = (assignment.title || 'grades').replace(/[^a-zA-Z0-9]/g, '_') + '.xlsx';
      XLSX.writeFile(wb, filename);
      window.app.ui.toast('Exported ' + rows.length + ' submissions!', 'success');
    } catch(e) { console.error(e); window.app.ui.toast('Export error: ' + e.message, 'error'); }
  },
  exportClassGradebook: async (classData) => {
    try {
      window.app.ui.toast('Generating class gradebook…', 'info');
      // Get all assignments for this class
      const aSnap = await getDocs(query(collection(db, "assignments"), where("classId", "==", classData.id)));
      if (aSnap.empty) return window.app.ui.toast('No assignments in this class.', 'error');
      const assignments = aSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      assignments.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      // Get all submissions for these assignments
      const aIds = assignments.map(a => a.id);
      let allSubs = [];
      for (let i = 0; i < aIds.length; i += 10) {
        const batch = aIds.slice(i, i + 10);
        const subSnap = await getDocs(query(collection(db, "submissions"), where("assignmentId", "in", batch)));
        subSnap.forEach(d => allSubs.push(d.data()));
      }
      // Build student-assignment score map
      const studentUids = [...new Set(allSubs.map(s => s.studentId))];
      // Also include students from class roster who haven't submitted
      const rosterUids = [...new Set([...studentUids, ...(classData.students || [])])];
      const studentMap = {};
      for (let i = 0; i < rosterUids.length; i += 10) {
        const batch = rosterUids.slice(i, i + 10);
        try {
          const userSnap = await getDocs(query(collection(db, "users"), where("__name__", "in", batch)));
          userSnap.forEach(u => { studentMap[u.id] = u.data(); });
        } catch(e) { console.warn('Batch user fetch error', e); }
      }
      // Pivot: studentId → { assignmentId → score }
      const scoreMap = {};
      allSubs.forEach(sub => {
        if (!scoreMap[sub.studentId]) scoreMap[sub.studentId] = {};
        scoreMap[sub.studentId][sub.assignmentId] = sub.grading;
      });
      // Build rows — one per student
      const rows = rosterUids.map(uid => {
        const user = studentMap[uid] || {};
        const row = {
          'Student ID': user.studentId || '',
          'Student Name': user.name || uid
        };
        let totalEarned = 0, totalMax = 0;
        assignments.forEach(a => {
          const grading = scoreMap[uid]?.[a.id];
          const header = a.title + ' (' + a.type.toUpperCase() + ')';
          if (grading) {
            row[header] = grading.score + '/' + grading.maxScore;
            totalEarned += grading.score || 0;
            totalMax += grading.maxScore || 0;
          } else {
            row[header] = 'Missing';
          }
        });
        row['Total Points'] = totalEarned + '/' + totalMax;
        row['Overall %'] = totalMax > 0 ? Math.round((totalEarned / totalMax) * 100) + '%' : '';
        return row;
      });
      rows.sort((a, b) => (a['Student Name'] || '').localeCompare(b['Student Name'] || ''));

      // === SYNERGY-COMPATIBLE SHEET ===
      // Second sheet formatted for TeacherVUE import: Student ID column + assignment name columns with raw scores
      const synergyRows = rosterUids.map(uid => {
        const user = studentMap[uid] || {};
        const row = { 'Student ID': user.studentId || '', 'Student Name': user.name || '' };
        assignments.forEach(a => {
          row[a.title] = scoreMap[uid]?.[a.id]?.score ?? '';
        });
        return row;
      }).filter(r => r['Student ID']); // Only include students who have a school ID
      synergyRows.sort((a, b) => (a['Student Name'] || '').localeCompare(b['Student Name'] || ''));

      const wb = XLSX.utils.book_new();
      // Full gradebook sheet
      const ws1 = XLSX.utils.json_to_sheet(rows);
      ws1['!cols'] = [{ wch: 12 }, { wch: 22 }, ...assignments.map(() => ({ wch: 16 })), { wch: 14 }, { wch: 12 }];
      XLSX.utils.book_append_sheet(wb, ws1, 'Full Gradebook');
      // Synergy import sheet
      if (synergyRows.length) {
        const ws2 = XLSX.utils.json_to_sheet(synergyRows);
        ws2['!cols'] = [{ wch: 12 }, { wch: 22 }, ...assignments.map(() => ({ wch: 16 }))];
        XLSX.utils.book_append_sheet(wb, ws2, 'Synergy Import');
      }
      const filename = (classData.name || 'gradebook').replace(/[^a-zA-Z0-9]/g, '_') + '_gradebook.xlsx';
      XLSX.writeFile(wb, filename);
      window.app.ui.toast('Exported gradebook with ' + rows.length + ' students!', 'success');
    } catch(e) { console.error(e); window.app.ui.toast('Export error: ' + e.message, 'error'); }
  },

  // ── TEACHER TOUR ──
  _tourStep: 0,
  _tourSteps: [
    {
      title: '1. Create a Class',
      desc: 'Give your class a name and you get a unique join code. Students enter the code to enroll.',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Create Class</span></div><div class="tour-mock-body">
        <div class="mb-3"><label class="text-[10px] font-bold uppercase" style="color:var(--fa)">Class Name</label><div class="hinp text-sm" style="padding:8px 12px;background:var(--elev)"><span class="tour-typing">Period 3 — AP World History</span></div></div>
        <div class="tour-pop tour-pop-d2 flex items-center gap-3 p-3 rounded-xl" style="background:var(--acs)"><span class="text-2xl">🔑</span><div><p class="text-xs font-bold" style="color:var(--ac)">Class Code Generated</p><p class="text-lg fm font-bold" style="color:var(--ac)">XK7M2P</p><p class="text-[10px]" style="color:var(--mu)">Share this with your students</p></div></div>
      </div></div>`
    },
    {
      title: '2. Create Assignments',
      desc: 'Choose SAQ, LEQ, or DBQ. Write a prompt, attach documents for DBQs, set max attempts. Students see a live preview.',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Assignment Builder</span></div><div class="tour-mock-body">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="mb-2"><span class="text-[10px] font-bold uppercase" style="color:var(--fa)">Type</span><div class="tour-pop tour-pop-d1 flex gap-2 mt-1"><span class="text-[10px] px-2 py-1 rounded" style="background:var(--elev)">SAQ</span><span class="text-[10px] px-2 py-1 rounded font-bold" style="background:var(--acs);color:var(--ac);border:1px solid var(--ac)">LEQ</span><span class="text-[10px] px-2 py-1 rounded" style="background:var(--elev)">DBQ</span></div></div>
            <div class="mb-2"><span class="text-[10px] font-bold uppercase" style="color:var(--fa)">Prompt</span><div class="hinp text-[11px] mt-1" style="padding:8px;background:var(--elev);min-height:60px"><span class="tour-typing" style="animation-duration:3s">Evaluate the extent to which maritime empires transformed global trade...</span></div></div>
          </div>
          <div class="tour-pop tour-pop-d3 rounded-xl p-3" style="background:var(--elev);border:1px solid var(--bd)">
            <p class="text-[9px] font-bold uppercase mb-2" style="color:var(--fa)">Student Preview</p>
            <span class="text-[9px] px-1.5 py-0.5 rounded font-bold" style="background:var(--acs);color:var(--ac)">LEQ</span>
            <p class="text-[10px] font-bold mt-1 fs">Maritime Empires LEQ</p>
            <p class="text-[9px] mt-1" style="color:var(--mu)">Evaluate the extent to which...</p>
          </div>
        </div>
      </div></div>`
    },
    {
      title: '3. Students Write & Get AI Feedback',
      desc: 'Students write essays in a split-pane editor. On submit, Claude AI grades against the AP rubric with color-coded annotations and improvement tips.',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">AI Grading Report</span></div><div class="tour-mock-body">
        <div class="text-center mb-3"><div class="text-3xl font-bold fs tour-pop" style="color:var(--ac)">5<span class="text-lg" style="color:var(--fa)">/6</span></div><p class="text-[10px]" style="color:var(--mu)">Proficient</p></div>
        <div class="space-y-2">
          <div class="tour-pop tour-pop-d1 p-2 rounded-lg" style="border-left:3px solid var(--sg);background:var(--elev)"><div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full text-[7px] text-white flex items-center justify-center font-bold" style="background:var(--sg)">1</span><span class="text-[9px] font-bold" style="color:var(--sg)">THESIS — Point Earned</span></div><p class="text-[9px] mt-1" style="color:var(--mu)">Clear argument with line of reasoning.</p></div>
          <div class="tour-pop tour-pop-d2 p-2 rounded-lg" style="border-left:3px solid var(--gd);background:var(--elev)"><div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full text-[7px] text-white flex items-center justify-center font-bold" style="background:var(--gd)">2</span><span class="text-[9px] font-bold" style="color:var(--gd)">EVIDENCE — Almost There</span></div><p class="text-[9px] mt-1" style="color:var(--mu)">Good evidence — add one more specific example.</p><div class="mt-1 p-1.5 rounded text-[8px]" style="background:rgba(196,149,40,.06);color:var(--gd)">💡 Name a specific treaty or leader.</div></div>
          <div class="tour-pop tour-pop-d3 p-2 rounded-lg" style="border-left:3px solid var(--sg);background:var(--elev)"><div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full text-[7px] text-white flex items-center justify-center font-bold" style="background:var(--sg)">3</span><span class="text-[9px] font-bold" style="color:var(--sg)">REASONING — Point Earned</span></div><p class="text-[9px] mt-1" style="color:var(--mu)">Excellent cause-and-effect analysis.</p></div>
        </div>
      </div></div>`
    },
    {
      title: '4. Start an Essay Blocks Session',
      desc: 'Pick a prompt and timer, then share the session code. Students join the lobby and click Ready. When you start, they\'re grouped randomly.',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Essay Blocks Lobby</span></div><div class="tour-mock-body text-center">
        <p class="text-[9px] font-bold uppercase" style="color:var(--fa)">Session Code</p>
        <p class="text-xl fm font-bold mb-3 tour-pop" style="color:var(--ac)">X7KM2P</p>
        <div class="space-y-1.5 mb-3" style="max-width:200px;margin:0 auto;text-align:left">
          <div class="tour-pop tour-pop-d1 flex items-center gap-2 py-1.5 px-2 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.15)"><div class="w-2 h-2 rounded-full" style="background:var(--sg)"></div><span class="text-[10px] font-semibold flex-1">Alex M.</span><span class="text-[8px] fm" style="color:var(--sg)">Ready!</span></div>
          <div class="tour-pop tour-pop-d2 flex items-center gap-2 py-1.5 px-2 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.15)"><div class="w-2 h-2 rounded-full" style="background:var(--sg)"></div><span class="text-[10px] font-semibold flex-1">Jamie K.</span><span class="text-[8px] fm" style="color:var(--sg)">Ready!</span></div>
          <div class="tour-pop tour-pop-d3 flex items-center gap-2 py-1.5 px-2 rounded-lg" style="background:var(--elev);border:1px solid var(--bd)"><div class="w-2 h-2 rounded-full" style="background:var(--bd)"></div><span class="text-[10px] font-semibold flex-1">Sam T.</span><span class="text-[8px] fm" style="color:var(--fa)">Joining...</span></div>
          <div class="tour-pop tour-pop-d4 flex items-center gap-2 py-1.5 px-2 rounded-lg" style="background:rgba(77,128,96,.06);border:1px solid rgba(77,128,96,.15)"><div class="w-2 h-2 rounded-full" style="background:var(--sg)"></div><span class="text-[10px] font-semibold flex-1">Riley P.</span><span class="text-[8px] fm" style="color:var(--sg)">Ready!</span></div>
        </div>
        <div class="tour-pop tour-pop-d5"><span class="text-[10px] px-4 py-2 rounded-lg font-bold text-white" style="background:var(--ac)">Start Game →</span></div>
      </div></div>`
    },
    {
      title: '5. Multiplayer: Each Student Writes a Block',
      desc: 'Each student sees the prompt and gets assigned one block (thesis, evidence, analysis, etc). They write blindly — teammates are working on other blocks at the same time!',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Student View — Block Play</span></div><div class="tour-mock-body">
        <div class="p-2 rounded-lg mb-2 text-[10px]" style="background:var(--elev);border:1px solid var(--bd)"><span class="font-bold" style="color:var(--ac)">Prompt:</span> <span style="color:var(--mu)">Evaluate the extent to which maritime empires transformed trade 1450-1750.</span></div>
        <div class="text-center mb-2"><span class="text-lg fm font-bold" style="color:var(--ac)">3:42</span><p class="text-[8px]" style="color:var(--fa)">Time remaining</p></div>
        <div class="flex flex-wrap justify-center gap-1 mb-2">
          <span class="text-[8px] px-1.5 py-0.5 rounded" style="background:var(--elev);color:var(--fa)">🌍 Context</span>
          <span class="text-[8px] px-1.5 py-0.5 rounded font-bold" style="background:var(--acs);color:var(--ac);border:1px solid var(--ac)">⚔️ Thesis ← You</span>
          <span class="text-[8px] px-1.5 py-0.5 rounded" style="background:var(--elev);color:var(--fa)">📜 Evidence</span>
          <span class="text-[8px] px-1.5 py-0.5 rounded" style="background:var(--elev);color:var(--fa)">🧠 Analysis</span>
        </div>
        <div class="tour-pop tour-pop-d1 p-3 rounded-xl" style="background:var(--elev);border:1px solid var(--bd)">
          <p class="text-[10px] font-bold fs mb-1">What's your main argument?</p>
          <div class="p-2 rounded-lg text-[10px]" style="background:var(--card);border:2px solid var(--ac)"><span class="tour-typing" style="animation-duration:3s">Maritime empires fundamentally transformed trade because...</span></div>
        </div>
      </div></div>`
    },
    {
      title: '6. Review & Grade Together',
      desc: 'After time is up, all blocks are combined into full essays. Students vote for the best group essay, and AI grades each one. Results show which group won!',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Review Phase</span></div><div class="tour-mock-body">
        <div class="tour-pop p-3 rounded-xl mb-2" style="border:1px solid var(--bd)">
          <div class="flex items-center justify-between mb-2"><span class="text-[10px] font-bold">Group 1's Essay</span><span class="text-[10px] px-2 py-0.5 rounded-full" style="background:rgba(77,128,96,.1);color:var(--sg)">5/6 — Proficient</span></div>
          <div class="space-y-1 text-[9px]" style="color:var(--mu)">
            <div class="tour-pop tour-pop-d1"><span class="font-bold" style="color:var(--ac)">🌍 Context (Alex):</span> Before 1450, trade was primarily regional...</div>
            <div class="tour-pop tour-pop-d2"><span class="font-bold" style="color:var(--ac)">⚔️ Thesis (Jamie):</span> Maritime empires fundamentally transformed...</div>
            <div class="tour-pop tour-pop-d3"><span class="font-bold" style="color:var(--ac)">📜 Evidence (Sam):</span> The Portuguese established trading posts...</div>
          </div>
        </div>
        <div class="tour-pop tour-pop-d4 flex gap-2 justify-center">
          <span class="text-[10px] px-3 py-1.5 rounded-lg font-bold text-white" style="background:var(--sg)">👍 3 votes</span>
          <span class="text-[10px] px-3 py-1.5 rounded-lg font-bold" style="background:var(--elev);color:var(--fa)">Grade with AI</span>
        </div>
      </div></div>`
    },
    {
      title: '7. Export Grades',
      desc: 'Export all scores to Excel with one click. Includes a Synergy-compatible sheet with student IDs for direct import into your gradebook.',
      mock: `<div class="tour-mock"><div class="tour-mock-header"><div class="tour-mock-dot" style="background:#ff5f57"></div><div class="tour-mock-dot" style="background:#febc2e"></div><div class="tour-mock-dot" style="background:#28c840"></div><span class="text-[10px] fm" style="color:var(--fa)">Gradebook Export</span></div><div class="tour-mock-body">
        <div class="tour-pop flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:rgba(77,128,96,.1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--sg)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
          <div><p class="text-xs font-bold fs">Period_3_AP_World_gradebook.xlsx</p><p class="text-[10px]" style="color:var(--mu)">2 sheets · 24 students</p></div>
        </div>
        <div class="rounded-lg overflow-hidden" style="border:1px solid var(--bd)">
          <table class="w-full text-[9px]" style="border-collapse:collapse">
            <tr style="background:var(--elev)"><th class="p-1.5 text-left" style="border-bottom:1px solid var(--bd)">Student</th><th class="p-1.5" style="border-bottom:1px solid var(--bd)">LEQ #1</th><th class="p-1.5" style="border-bottom:1px solid var(--bd)">DBQ #1</th><th class="p-1.5" style="border-bottom:1px solid var(--bd)">SAQ #1</th></tr>
            <tr class="tour-pop tour-pop-d1"><td class="p-1.5" style="border-bottom:1px solid var(--bd)">Alex M.</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--sg)">5/6</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--gd)">4/7</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--sg)">3/3</td></tr>
            <tr class="tour-pop tour-pop-d2"><td class="p-1.5" style="border-bottom:1px solid var(--bd)">Jamie K.</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--sg)">4/6</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--sg)">6/7</td><td class="p-1.5 text-center" style="border-bottom:1px solid var(--bd);color:var(--gd)">2/3</td></tr>
            <tr class="tour-pop tour-pop-d3"><td class="p-1.5">Sam T.</td><td class="p-1.5 text-center" style="color:var(--gd)">3/6</td><td class="p-1.5 text-center" style="color:var(--sg)">5/7</td><td class="p-1.5 text-center" style="color:var(--sg)">3/3</td></tr>
          </table>
        </div>
        <div class="tour-pop tour-pop-d4 mt-2 p-2 rounded-lg text-[9px]" style="background:rgba(77,128,96,.06);color:var(--sg)">✓ Includes Synergy-compatible sheet for direct gradebook import</div>
      </div></div>`
    }
  ],

  initTour: () => {
    window.app.teacher._tourStep = 0;
    window.app.teacher._renderTourStep();
    lucide.createIcons();
  },

  _renderTourStep: () => {
    const steps = window.app.teacher._tourSteps;
    const idx = window.app.teacher._tourStep;
    const step = steps[idx];

    // Render dots
    const nav = document.getElementById('tour-nav');
    if (nav) nav.innerHTML = steps.map((_,i) => `<div class="tour-dot ${i===idx?'active':''}" onclick="window.app.teacher._tourStep=${i};window.app.teacher._renderTourStep()"></div>`).join('');

    // Render step
    const container = document.getElementById('tour-container');
    if (container) {
      container.innerHTML = `<div class="tour-step" id="tour-current">
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold fs">${step.title}</h2>
          <p class="text-sm mt-1" style="color:var(--mu);max-width:500px;margin:0 auto">${step.desc}</p>
        </div>
        <div style="max-width:480px;margin:0 auto">${step.mock}</div>
      </div>`;
      // Trigger animation
      requestAnimationFrame(() => document.getElementById('tour-current')?.classList.add('visible'));
    }

    // Update buttons
    const prev = document.getElementById('tour-prev');
    const next = document.getElementById('tour-next');
    if (prev) prev.style.visibility = idx === 0 ? 'hidden' : 'visible';
    if (next) next.textContent = idx === steps.length - 1 ? 'Back to Dashboard' : 'Next →';
    lucide.createIcons();
  },

  tourNext: () => {
    const steps = window.app.teacher._tourSteps;
    if (window.app.teacher._tourStep >= steps.length - 1) {
      window.app.router.go('teacher-dash');
    } else {
      window.app.teacher._tourStep++;
      window.app.teacher._renderTourStep();
    }
  },

  tourPrev: () => {
    if (window.app.teacher._tourStep > 0) {
      window.app.teacher._tourStep--;
      window.app.teacher._renderTourStep();
    }
  }
},

// ═══ STUDENT ═══
student: {
  init: async () => {
    if (!appState.userData?.gamification) {
      appState.userData = appState.userData || {};
      appState.userData.gamification = window.app.game.getDefaultStats();
      await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification });
    }
    window.app.game.checkLevelUp();
    const classSnap = await getDocs(query(collection(db, "classes"), where("students", "array-contains", appState.user.uid)));
    const classIds = classSnap.docs.map(d => d.id);
    const container = document.getElementById('assignments-list'); if (!container) return;

    if (!classIds.length) {
      container.innerHTML = `<div class="text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><i data-lucide="book-open" class="w-8 h-8 mx-auto mb-2" style="color:var(--fa)"></i><p class="text-sm" style="color:var(--mu)">Join a class to see assignments.</p><p class="text-xs" style="color:var(--fa)">Ask your teacher for the class code.</p></div>`;
    } else {
      const snap = await getDocs(query(collection(db, "assignments"), where("classId", "in", classIds.slice(0, 10))));
      const subSnap = await getDocs(query(collection(db, "submissions"), where("studentId", "==", appState.user.uid)));
      const subsMap = {}; subSnap.forEach(d => subsMap[d.data().assignmentId] = { id: d.id, ...d.data() });

      if (snap.empty) {
        container.innerHTML = `<div class="text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><p class="text-sm" style="color:var(--mu)">No assignments yet. Check back soon.</p></div>`;
      } else {
        container.innerHTML = snap.docs.map(d => {
          const a = d.data(), sub = subsMap[d.id], done = !!sub;
          const subPayload = sub ? JSON.stringify(sub).replace(/'/g, "&#39;") : '';
          const aPayload = JSON.stringify({ id: d.id, ...a }).replace(/'/g, "&#39;");
          if (a.type === 'story') {
            const sid = a.storyId || a.structure?.storyId;
            const storyData = sid ? STORY_LESSONS[sid] : null;
            const saved = localStorage.getItem(`story_${sid}_${appState.user.uid}`);
            const progress = saved ? JSON.parse(saved) : [];
            const total = storyData?.chapters?.length || a.structure?.chapters || 5;
            const pct = Math.round((progress.length / total) * 100);
            return `<div class="hcard p-4" style="border-left:3px solid ${done?'var(--sg)':'var(--ac)'}">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:linear-gradient(135deg,rgba(212,98,47,.1),rgba(196,149,40,.1));color:var(--ac)">📖 story</span><h3 class="font-bold text-sm mt-1.5">${a.title}</h3></div>
                ${done ? `<div class="text-xs font-bold px-2 py-1 rounded" style="background:rgba(77,128,96,.1);color:var(--sg)">Complete ✓</div>` : progress.length > 0 ? `<div class="text-xs font-bold" style="color:var(--ac)">${pct}%</div>` : ''}
              </div>
              <p class="text-xs mb-2" style="color:var(--mu)">${a.prompt}</p>
              ${!done && progress.length > 0 ? `<div class="flex gap-1 mb-2">${Array.from({length:total},(_,i)=>`<div style="flex:1;height:3px;border-radius:2px;background:${progress.includes(i)?'var(--sg)':'var(--bd)'}"></div>`).join('')}</div>` : ''}
              <button onclick='window.app.router.go("story-lesson",{storyId:"${sid}",assignmentId:"${d.id}"})' class="btnP w-full text-xs">${done ? 'Re-read Story' : progress.length > 0 ? 'Continue Reading' : 'Begin Story'}</button>
            </div>`;
          }
          return `<div class="hcard p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${a.type}</span><h3 class="font-bold text-sm mt-1.5">${a.title}</h3></div>
              ${done ? `<div class="text-sm font-bold" style="color:var(--sg)">${sub.grading?.score||0}/${sub.grading?.maxScore||0}</div>` : ''}
            </div>
            <p class="text-xs mb-3 line-clamp-2" style="color:var(--mu)">${a.prompt}</p>
            ${done
              ? `<button onclick='window.app.router.go("results",{submission:${subPayload},assignment:${aPayload}})' class="btnG w-full text-xs">View Report</button>`
              : `<button onclick='window.app.router.go("editor",{assignment:${aPayload}})' class="btnP w-full text-xs">Start Writing</button>`
            }
          </div>`;
        }).join('');
      }
    }
    window.app.student.switchTab('assign'); lucide.createIcons();
  },

  initEditor: () => {
    const el = document.getElementById('essay-input');
    if (el) {
      const update = () => { const wc = document.getElementById('word-count'); if (wc) wc.textContent = (el.value.trim().split(/\s+/).filter(Boolean).length) + ' words'; };
      el.addEventListener('input', update); update();
    }
  },

  onEditorInput: (el) => {
    if (appState.activeAssignment) localStorage.setItem(`draft_${appState.activeAssignment.id}`, el.value);
    const wc = document.getElementById('word-count');
    if (wc) wc.textContent = (el.value.trim().split(/\s+/).filter(Boolean).length) + ' words';
  },

  joinClass: async () => {
    const code = document.getElementById('class-code')?.value.toUpperCase().trim(); if (!code) return;
    try {
      const snap = await getDocs(query(collection(db, "classes"), where("code", "==", code)));
      if (snap.empty) throw new Error("Invalid class code");
      await updateDoc(doc(db, "classes", snap.docs[0].id), { students: arrayUnion(appState.user.uid) });
      window.app.ui.closeModal('join-class'); window.app.ui.toast('Joined class!', 'success'); window.app.student.init();
    } catch (e) { window.app.ui.toast(e.message, 'error'); }
  },

  switchTab: (tab) => {
    ['assign', 'blocks', 'skills', 'arcade'].forEach(t => {
      document.getElementById(`tab-${t}`)?.classList.toggle('hidden', t !== tab);
      const btn = document.getElementById(`stab-${t}`);
      if (btn) btn.classList.toggle('on', t === tab);
    });
    if (tab === 'blocks') window.app.blocks.checkActiveSessions();
    lucide.createIcons();
  },

  submitEssay: async () => {
    const txt = document.getElementById('essay-input')?.value.trim();
    if (!txt || txt.length < 50) return window.app.ui.toast('Write at least a solid paragraph before submitting.', 'error');
    const words = txt.split(/\s+/).length;
    if (!appState.demoMode && !confirm(`Submit your essay? (${words} words)\n\nThe AI grader will evaluate your response. This cannot be undone.`)) return;
    window.app.ui.btnLoading('submit-btn', true); window.app.ui.toast('AI is grading your essay…', 'info');
    try {
      const a = appState.activeAssignment;
      const grading = await window.app.ai.grade(a.type, a.prompt, txt, a.structure);
      if (a.demo || appState.demoMode) {
        const sub = { assignmentId: a.id, studentId: 'demo', studentName: 'Demo Student', essayText: txt, grading, submittedAt: new Date() };
        window.app.ui.btnLoading('submit-btn', false);
        window.app.router.go('results', { submission: { id: 'demo', ...sub }, assignment: a });
        return;
      }
      const sub = { assignmentId: a.id, studentId: appState.user.uid, studentName: appState.userData.name, essayText: txt, grading, submittedAt: new Date() };
      const docRef = await addDoc(collection(db, 'submissions'), { ...sub, submittedAt: serverTimestamp() });
      localStorage.removeItem(`draft_${a.id}`);
      appState.userData.gamification.xp += grading.score * 15;
      window.app.game.updateSkillsFromGrading(a.type, grading);
      await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification });
      window.app.game.checkLevelUp();
      window.app.router.go('results', { submission: { id: docRef.id, ...sub }, assignment: a });
    } catch (e) { console.error(e); window.app.ui.toast('Error: ' + e.message, 'error'); window.app.ui.btnLoading('submit-btn', false); }
  }
},

// ═══ GAME SYSTEM ═══
game: {
  getDefaultStats: () => ({
    level: 1, xp: 0,
    mastery: {
      saq: { skills: { identify: 40, describe: 35, explain: 30 } },
      dbq: { skills: { contextualization: 25, thesis: 30, sourcing: 15, evidence: 20, complexity: 10 } },
      leq: { skills: { contextualization: 30, thesis: 35, evidence: 25, reasoning: 20 } }
    }
  }),

  checkLevelUp: () => {
    const g = appState.userData?.gamification; if (!g) return;
    const newLevel = Math.floor(g.xp / 200) + 1;
    if (newLevel > g.level) { g.level = newLevel; window.app.ui.toast('🎉 Level up! Now Level ' + newLevel + '!', 'success'); confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }, colors: ['#d4622f', '#c49528', '#4d8060', '#5c6db3'] }); }
  },

  updateSkillsFromGrading: (type, grading) => {
    if (!grading.annotations || !appState.userData.gamification.mastery[type]) return;
    const skills = appState.userData.gamification.mastery[type].skills;
    grading.annotations.forEach(a => { const cat = a.category?.toLowerCase(); if (skills[cat] !== undefined) { skills[cat] = Math.min(100, skills[cat] + (a.status === 'success' ? 8 : a.status === 'warning' ? 3 : 1)); } });
  },

  renderSkillGarden: (stats) => {
    const m = stats.mastery || window.app.game.getDefaultStats().mastery;
    const allSkills = [];
    Object.entries(m).forEach(([type, data]) => Object.entries(data.skills || {}).forEach(([name, val]) => allSkills.push({ type, name, val })));
    const mastered = allSkills.filter(s => s.val >= 80).length;
    const growing = allSkills.filter(s => s.val >= 40 && s.val < 80).length;
    const seeds = allSkills.filter(s => s.val < 40).length;
    const avgPct = allSkills.length ? Math.round(allSkills.reduce((a, s) => a + s.val, 0) / allSkills.length) : 0;

    const renderRing = (pct, size, color) => {
      const r = (size - 6) / 2, circ = 2 * Math.PI * r, offset = circ - (pct / 100) * circ;
      return `<svg width="${size}" height="${size}" class="progress-ring"><circle class="progress-ring-bg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="3"/><circle class="progress-ring-fill" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="3" stroke="${color}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/></svg>`;
    };

    const renderPlot = (type, label, icon, color) => {
      const skills = m[type]?.skills || {};
      const entries = Object.entries(skills);
      const typePct = entries.length ? Math.round(entries.reduce((a, [, v]) => a + v, 0) / entries.length) : 0;
      return `<div class="garden-plot">
        <div class="garden-type-header">
          <div class="relative">${renderRing(typePct, 44, color)}<span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">${icon}</span></div>
          <div><h4 class="text-sm font-bold">${label}</h4><p class="text-[10px]" style="color:var(--mu)">${typePct}% mastered · ${entries.filter(([,v]) => v >= 80).length}/${entries.length} golden</p></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(${Math.min(entries.length, 5)},1fr);gap:8px">
          ${entries.map(([name, val]) => {
            const plant = val >= 80 ? '🌳' : val >= 60 ? '🌻' : val >= 40 ? '🌿' : val >= 20 ? '🌱' : '🫘';
            const state = val >= 80 ? 'skill-gold' : val >= 40 ? 'skill-grow' : 'skill-seed';
            const pctLvl = val >= 80 ? 'high' : val >= 40 ? 'mid' : 'low';
            const sway = val >= 40 ? 'plant-sway' : '';
            return `<div class="plant-cell" data-pct="${pctLvl}" onclick="window.app.game.openPractice('${type}','${name}')">
              <div class="plant-pot ${state}" style="border-color:var(--bd)"><span class="${sway}">${plant}</span></div>
              <span class="text-[10px] font-semibold capitalize" style="color:var(--mu)">${name}</span>
              <div class="w-full rounded-full overflow-hidden" style="height:4px;background:var(--bd)"><div style="width:${val}%;height:100%;background:${color};border-radius:4px;transition:width .6s"></div></div>
              <span class="text-[9px] font-bold" style="color:${val >= 80 ? 'var(--gd)' : val >= 40 ? 'var(--sg)' : 'var(--fa)'}">${val}%</span>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    };

    return `<div>
      <div class="garden-summary">
        <div class="garden-stat"><div class="text-lg font-bold" style="color:var(--gd)">${mastered}</div><div class="text-[10px]" style="color:var(--mu)">🌳 Mastered</div></div>
        <div class="garden-stat"><div class="text-lg font-bold" style="color:var(--sg)">${growing}</div><div class="text-[10px]" style="color:var(--mu)">🌿 Growing</div></div>
        <div class="garden-stat"><div class="text-lg font-bold" style="color:var(--fa)">${seeds}</div><div class="text-[10px]" style="color:var(--mu)">🌱 Seedlings</div></div>
      </div>
      <div class="flex items-center gap-3 mb-4 p-3 rounded-xl" style="background:var(--acs)">
        <div class="relative">${renderRing(avgPct, 48, 'var(--ac)')}<span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">${avgPct}%</span></div>
        <div><p class="text-xs font-semibold">Overall Garden Health</p><p class="text-[10px]" style="color:var(--mu)">Tap any plant to practice that skill and watch it grow!</p></div>
      </div>
      <div class="space-y-4">
        ${renderPlot('saq', 'SAQ Skills', '📝', 'var(--ac)')}
        ${renderPlot('dbq', 'DBQ Skills', '📜', 'var(--ry)')}
        ${renderPlot('leq', 'LEQ Skills', '✍️', 'var(--sg)')}
      </div>
    </div>`;
  },

  openPractice: (type, skill) => {
    const bank = PRACTICE_BANK[skill] || PRACTICE_BANK.thesis;
    const drill = bank[Math.floor(Math.random() * bank.length)];
    appState.practiceContext = { type, skill, drill };

    const titleEl = document.getElementById('practice-title');
    const promptEl = document.getElementById('practice-prompt');
    const respEl = document.getElementById('practice-response');
    const btnEl = document.getElementById('submit-practice-btn');

    titleEl.textContent = 'Practice: ' + skill[0].toUpperCase() + skill.slice(1);
    const skillDescriptions = { thesis:"Write a clear, defensible thesis with a line of reasoning.", contextualization:"Set the broader historical context before your argument.", evidence:"Provide specific historical evidence with names, dates, places.", sourcing:"Analyze a source using HAPP (Historical situation, Audience, Purpose, POV).", reasoning:"Connect your evidence to your thesis — explain HOW and WHY.", complexity:"Show nuanced understanding — counterarguments, qualifications, cross-period connections.", identify:"Name ONE specific historical development.", describe:"Explain WHAT something was and HOW it worked.", explain:"Explain WHY something happened — connect cause to effect." };

    promptEl.innerHTML = `
      <div class="flex items-center gap-2 mb-3">
        <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${type.toUpperCase()}</span>
        <span class="text-[10px] font-bold uppercase" style="color:var(--mu)">→ ${skill}</span>
      </div>
      <p class="text-xs mb-3" style="color:var(--mu)">${skillDescriptions[skill] || ''}</p>
      <div class="drill-scenario">
        <p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:var(--ac)">📋 Your Task</p>
        <p class="text-sm fs leading-relaxed" style="white-space:pre-line">${drill.scenario}</p>
      </div>
      <div class="drill-hint">
        <p class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color:var(--gd)">💡 Hint</p>
        <p style="color:var(--mu)">${drill.hint}</p>
      </div>
      <div class="mt-3">
        <p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:var(--mu)">Checklist</p>
        <div class="drill-checklist" id="practice-checks">
          ${drill.checks.map(c => `<span class="drill-check">${c}</span>`).join('')}
        </div>
      </div>`;

    respEl.value = '';
    if (btnEl) { btnEl.textContent = 'Submit Response'; btnEl.disabled = false; }
    const feedbackEl = document.getElementById('practice-feedback');
    if (feedbackEl) feedbackEl.remove();
    window.app.ui.modal('practice-modal', 'open');
    lucide.createIcons();
  },

  submitPractice: async () => {
    const resp = document.getElementById('practice-response')?.value.trim();
    if (!resp || resp.length < 15) return window.app.ui.toast('Write a bit more before submitting.', 'error');
    const btn = document.getElementById('submit-practice-btn');
    btn.textContent = 'Evaluating…'; btn.disabled = true;

    setTimeout(async () => {
      const { type, skill, drill } = appState.practiceContext;
      const lo = resp.toLowerCase();
      const words = resp.split(/\s+/).length;
      const hasSpecifics = /\d{3,4}/.test(resp);
      const hasNames = /[A-Z][a-z]{2,}(?:\s[A-Z][a-z]+)?/.test(resp);
      const matchedKeywords = (drill.keywords || []).filter(k => lo.includes(k.toLowerCase()));
      const keywordScore = Math.min(matchedKeywords.length / Math.max(1, Math.min(drill.keywords?.length || 1, 5)), 1);

      // Score each check
      const checkResults = (drill.checks || []).map(check => {
        const c = check.toLowerCase();
        if (c.includes('claim') || c.includes('defensible')) return words >= 15 && matchedKeywords.length >= 2;
        if (c.includes('line of reasoning')) return /because|due to|as a result|in order to|led to/.test(lo);
        if (c.includes('addresses') || c.includes('relevant')) return matchedKeywords.length >= 1;
        if (c.includes('specific') || c.includes('names') || c.includes('dates')) return hasSpecifics || hasNames;
        if (c.includes('broader') || c.includes('before')) return words >= 20 && matchedKeywords.length >= 2;
        if (c.includes('two distinct') || c.includes('two examples')) return hasSpecifics && words >= 30;
        if (c.includes('cause-effect') || c.includes('mechanism') || c.includes('explains')) return /because|led to|caused|resulted|therefore|this meant|enabled/.test(lo);
        if (c.includes('connects') || c.includes('how/why')) return /this demonstrates|this shows|therefore|which meant|as a result|because/.test(lo);
        if (c.includes('nuance') || c.includes('counter') || c.includes('beyond')) return /although|however|while|on the other hand|not all|varied|conversely/.test(lo);
        if (c.includes('extent') || c.includes('degree')) return /extent|significant|largely|primarily|fundamentally|limited|partial/.test(lo);
        if (c.includes('happ') || c.includes('pov')) return /point of view|purpose|audience|situation|pov|bias|perspective|motivation/.test(lo);
        if (c.includes('time period') || c.includes('within')) return hasSpecifics;
        if (c.includes('historically accurate')) return words >= 10 && matchedKeywords.length >= 1;
        return words >= 15 && matchedKeywords.length >= 1;
      });

      const checksHit = checkResults.filter(Boolean).length;
      const totalChecks = checkResults.length || 1;
      const checkPct = checksHit / totalChecks;

      // Update checklist visually
      const checkEls = document.querySelectorAll('#practice-checks .drill-check');
      checkEls.forEach((el, i) => { if (checkResults[i]) el.classList.add('met'); });

      // Calculate boost
      let boost, quality;
      if (checkPct >= 0.8 && keywordScore >= 0.4 && words >= 20) { boost = 14; quality = 'great'; }
      else if (checkPct >= 0.5 && keywordScore >= 0.2 && words >= 15) { boost = 9; quality = 'good'; }
      else { boost = 5; quality = 'try'; }

      const xpGain = 25 + (boost * 2);
      const messages = {
        great: ["Excellent work! You nailed the key elements.", "That's AP-level writing right there!", "Outstanding — you clearly understand this skill!", "Impressive response! Your garden is flourishing."],
        good: ["Good effort! You hit several key points.", "Solid work — a few tweaks and you'll master this!", "You're on the right track! Keep building on this.", "Nice job! Focus on the unchecked items next time."],
        try: ["Good start! Let's work on including more specifics.", "You're building the foundation — try adding dates, names, or key terms.", "Keep at it! Check the hint for ideas on what to add.", "Don't give up — every practice makes you stronger!"]
      };
      const msg = messages[quality][Math.floor(Math.random() * messages[quality].length)];
      const tipsByQuality = {
        great: "Try an essay next to put this skill in context!",
        good: "Look at the unchecked items above — those are your next targets.",
        try: "Re-read the hint, then try again. Focus on one checklist item at a time."
      };

      // Show inline feedback
      const oldFeedback = document.getElementById('practice-feedback');
      if (oldFeedback) oldFeedback.remove();
      const fbDiv = document.createElement('div');
      fbDiv.id = 'practice-feedback';
      fbDiv.className = `drill-feedback drill-feedback-${quality}`;
      fbDiv.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-xl">${quality === 'great' ? '🌟' : quality === 'good' ? '👍' : '💪'}</span>
          <div>
            <p class="text-sm font-semibold mb-1">${checksHit}/${totalChecks} checklist items · +${boost}% · +${xpGain} XP</p>
            <p class="text-xs mb-2" style="color:var(--mu)">${msg}</p>
            <p class="text-[10px] font-medium" style="color:var(--${quality === 'great' ? 'sg' : quality === 'good' ? 'gd' : 'ac'})">${tipsByQuality[quality]}</p>
          </div>
        </div>`;
      document.getElementById('practice-response')?.parentNode?.appendChild(fbDiv);

      // Update gamification
      const gamif = appState.userData?.gamification;
      if (gamif) {
        gamif.mastery[type].skills[skill] = Math.min(100, gamif.mastery[type].skills[skill] + boost);
        gamif.xp += xpGain;
        if (appState.user) {
          try { await updateDoc(doc(db, "users", appState.user.uid), { gamification: gamif }); } catch(e) {}
        }
      }

      btn.textContent = 'Try Another'; btn.disabled = false;
      btn.onclick = () => { window.app.ui.closeModal('practice-modal'); setTimeout(() => window.app.game.openPractice(type, skill), 200); };

      if (quality === 'great') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.65 }, colors: ['#d4622f', '#c49528', '#4d8060'] });
        window.app.ui.toast(`🌟 ${skill} mastery +${boost}% | +${xpGain} XP`, 'success');
      } else {
        window.app.ui.toast(`${skill} +${boost}% | +${xpGain} XP`, quality === 'good' ? 'success' : 'info');
      }
      window.app.game.checkLevelUp();
    }, 800);
  },

  // ═══ ARCADE ═══
  chronoState: { score: 0, streak: 0, best: 0, anchor: null, challenge: null, hardMode: false },
  thesisJState: { score: 0, streak: 0, best: 0, idx: null },
  evidenceState: { score: 0, streak: 0, best: 0, idx: null },
  sourceState: { solved: 0, caseIdx: null },

  renderArcade: () => `
    <div class="arcP h-full flex flex-col">
      <div class="flex overflow-x-auto" style="border-bottom:1px solid #332f26">
        <button onclick="window.app.game.switchArcade('chrono')" class="arcTab on flex-1" id="atab-chrono"><i data-lucide="clock" class="w-3 h-3"></i><span>Timeline</span></button>
        <button onclick="window.app.game.switchArcade('blast')" class="arcTab flex-1" id="atab-blast"><i data-lucide="grid-3x3" class="w-3 h-3"></i><span>Block Blast</span></button>
        <button onclick="window.app.game.switchArcade('thesis')" class="arcTab flex-1" id="atab-thesis"><i data-lucide="scale" class="w-3 h-3"></i><span>Thesis</span></button>
        <button onclick="window.app.game.switchArcade('evidence')" class="arcTab flex-1" id="atab-evidence"><i data-lucide="check-square" class="w-3 h-3"></i><span>Evidence</span></button>
        <button onclick="window.app.game.switchArcade('source')" class="arcTab flex-1" id="atab-source"><i data-lucide="search" class="w-3 h-3"></i><span>Source</span></button>
      </div>
      <div class="flex-1 relative overflow-hidden">
        <div id="arc-chrono" class="absolute inset-0 overflow-y-auto csc">${window.app.game.renderChrono()}</div>
        <div id="arc-blast" class="absolute inset-0 overflow-y-auto csc hidden">${window.app.game.renderBlockBlast()}</div>
        <div id="arc-thesis" class="absolute inset-0 overflow-y-auto csc hidden">${window.app.game.renderThesisJudge()}</div>
        <div id="arc-evidence" class="absolute inset-0 overflow-y-auto csc hidden">${window.app.game.renderEvidenceOrNah()}</div>
        <div id="arc-source" class="absolute inset-0 overflow-y-auto csc hidden">${window.app.game.renderSourceDetective()}</div>
      </div>
    </div>`,

  switchArcade: (mode) => {
    ['chrono', 'blast', 'thesis', 'evidence', 'source'].forEach(m => { document.getElementById('arc-' + m)?.classList.toggle('hidden', m !== mode); document.getElementById('atab-' + m)?.classList.toggle('on', m === mode); });
    lucide.createIcons();
  },

  // ── CHRONO-CRISIS (expanded + hard mode) ──
  renderChrono: () => `
    <div class="h-full flex flex-col text-white">
      <div id="chrono-start" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-4" style="background:var(--ac)"><i data-lucide="clock" class="w-7 h-7 text-white"></i></div>
        <h3 class="text-xl font-bold mb-1 fs">CHRONO-CRISIS</h3>
        <p class="text-xs mb-4 max-w-xs" style="color:#9a9385">Was this event before or after the anchor? ${CHRONO_EVENTS.length} events to master!</p>
        <div class="flex gap-2 mb-3">
          <button onclick="window.app.game.chronoState.hardMode=false;document.getElementById('chrono-easy').classList.add('on');document.getElementById('chrono-hard').classList.remove('on')" id="chrono-easy" class="arcTab on text-[11px] px-3 py-1.5">Easy (eras shown)</button>
          <button onclick="window.app.game.chronoState.hardMode=true;document.getElementById('chrono-hard').classList.add('on');document.getElementById('chrono-easy').classList.remove('on')" id="chrono-hard" class="arcTab text-[11px] px-3 py-1.5">Hard (no hints)</button>
        </div>
        <div class="text-xs mb-3" style="color:#7f7868">Best streak: <span id="chrono-best" class="font-bold text-white">${window.app.game.chronoState.best}</span></div>
        <button onclick="window.app.game.startChrono()" class="btnP text-xs px-6 py-2.5">START GAME</button>
      </div>
      <div id="chrono-game" class="hidden flex-1 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2" style="background:rgba(255,255,255,.03)">
          <div class="text-xs"><span style="color:#9a9385">Score</span> <span class="font-bold text-lg text-white ml-1" id="chrono-score">0</span></div>
          <div class="text-xs"><span style="color:#9a9385">Streak</span> <span class="font-bold text-white ml-1" id="chrono-streak">0</span> 🔥</div>
          <button onclick="window.app.game.endChrono()" class="text-xs" style="color:#655f52">End</button>
        </div>
        <div id="chrono-play" class="flex-1 flex flex-col items-center justify-center p-4 gap-5">
          <div class="text-center"><p class="text-[10px] uppercase tracking-[.2em] mb-1" style="color:var(--ac)">Anchor Event</p><div class="px-4 py-3 rounded-xl" style="background:rgba(255,255,255,.05)"><h4 class="font-bold text-sm" id="chrono-anchor-text">…</h4><span class="fm text-[11px] px-2 py-0.5 rounded mt-1 inline-block" style="background:rgba(212,98,47,.15);color:var(--ac)" id="chrono-anchor-date">…</span></div></div>
          <div class="text-center"><p class="text-[10px] uppercase tracking-[.2em] mb-1" style="color:#9a9385">Before or After?</p><div class="px-4 py-3 rounded-xl" style="background:rgba(255,255,255,.05)"><h4 class="font-bold text-base" id="chrono-challenge-text">…</h4><p class="text-[10px] mt-1 fm" style="color:#655f52" id="chrono-challenge-era">…</p></div>
            <div class="flex gap-3 mt-4">
              <button onclick="window.app.game.guessChrono('before')" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(255,255,255,.05);color:#e8e6e1">⬅ BEFORE</button>
              <button onclick="window.app.game.guessChrono('after')" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(212,98,47,.15);color:var(--ac)">AFTER ➡</button>
            </div>
          </div>
        </div>
      </div>
      <div id="chrono-over" class="hidden flex-1 flex flex-col items-center justify-center p-6 text-center" style="background:rgba(0,0,0,.6)">
        <h3 class="text-xl font-bold mb-2 fs">GAME OVER</h3>
        <p class="text-sm mb-1" style="color:#9a9385">Score: <span class="text-white font-bold" id="chrono-final">0</span> | Streak: <span class="text-white font-bold" id="chrono-final-streak">0</span></p>
        <div id="chrono-feedback" class="text-xs mb-4 p-3 rounded-lg max-w-xs" style="background:rgba(212,98,47,.1);color:var(--ac)"></div>
        <button onclick="window.app.game.startChrono()" class="btnP text-xs px-6 py-2.5">PLAY AGAIN</button>
      </div>
    </div>`,

  startChrono: () => { const c = window.app.game.chronoState; c.score = 0; c.streak = 0; document.getElementById('chrono-start')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.add('hidden'); document.getElementById('chrono-game')?.classList.remove('hidden'); window.app.game.nextChrono(); lucide.createIcons(); },
  endChrono: () => { const c = window.app.game.chronoState; c.best = Math.max(c.best, c.streak); document.getElementById('chrono-game')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.remove('hidden'); document.getElementById('chrono-final').textContent = c.score; document.getElementById('chrono-final-streak').textContent = c.streak; document.getElementById('chrono-feedback').textContent = ''; document.getElementById('chrono-best').textContent = c.best; },
  nextChrono: () => {
    const c = window.app.game.chronoState;
    c.anchor = CHRONO_EVENTS[Math.floor(Math.random() * CHRONO_EVENTS.length)];
    do { c.challenge = CHRONO_EVENTS[Math.floor(Math.random() * CHRONO_EVENTS.length)]; } while (c.challenge === c.anchor || c.challenge.date === c.anchor.date);
    document.getElementById('chrono-score').textContent = c.score;
    document.getElementById('chrono-streak').textContent = c.streak;
    document.getElementById('chrono-anchor-text').textContent = c.anchor.event;
    document.getElementById('chrono-anchor-date').textContent = c.anchor.date;
    document.getElementById('chrono-challenge-text').textContent = c.challenge.event;
    const eraEl = document.getElementById('chrono-challenge-era');
    if (eraEl) eraEl.textContent = c.hardMode ? '???' : c.challenge.era;
  },
  guessChrono: async (dir) => {
    const c = window.app.game.chronoState; const correct = dir === 'before' ? c.challenge.date < c.anchor.date : c.challenge.date > c.anchor.date;
    const play = document.getElementById('chrono-play');
    if (correct) {
      c.score++; c.streak++; const bonus = (c.hardMode ? 2 : 1) * (c.streak >= 5 ? 3 : c.streak >= 3 ? 2 : 1); const xp = 5 * bonus;
      if (appState.userData?.gamification) { appState.userData.gamification.xp += xp; if (appState.user) { try { await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp }); } catch(e){} } }
      if (play) { play.classList.add('chronoCorrect'); setTimeout(() => play.classList.remove('chronoCorrect'), 400); }
      document.getElementById('chrono-score').textContent = c.score; document.getElementById('chrono-streak').textContent = c.streak;
      if (c.streak % 5 === 0) { window.app.ui.toast('🔥 ' + c.streak + ' streak! +' + xp + ' XP', 'success'); confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } }); }
      setTimeout(() => window.app.game.nextChrono(), 500);
    } else {
      c.best = Math.max(c.best, c.streak);
      if (play) { play.classList.add('chronoWrong'); setTimeout(() => play.classList.remove('chronoWrong'), 500); }
      document.getElementById('chrono-final').textContent = c.score; document.getElementById('chrono-final-streak').textContent = c.streak;
      document.getElementById('chrono-feedback').innerHTML = '<strong>' + c.challenge.event + '</strong> was in <strong>' + c.challenge.date + '</strong>, which is ' + (c.challenge.date < c.anchor.date ? 'BEFORE' : 'AFTER') + ' ' + c.anchor.date + '.';
      document.getElementById('chrono-game')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.remove('hidden'); document.getElementById('chrono-best').textContent = c.best;
    }
  },

  // ── THESIS OR TRASH (new game) ──
  renderThesisJudge: () => `
    <div class="h-full flex flex-col text-white">
      <div id="tj-start" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-4" style="background:var(--gd)"><i data-lucide="scale" class="w-7 h-7 text-white"></i></div>
        <h3 class="text-xl font-bold mb-1 fs">THESIS OR TRASH?</h3>
        <p class="text-xs mb-3 max-w-xs" style="color:#9a9385">Read each statement and judge: is it a strong thesis, a weak thesis, or not a thesis at all?</p>
        <div class="text-xs mb-3" style="color:#7f7868">Best streak: <span id="tj-best" class="font-bold text-white">${window.app.game.thesisJState.best}</span></div>
        <button onclick="window.app.game.startThesisJudge()" class="btnP text-xs px-6 py-2.5">START JUDGING</button>
      </div>
      <div id="tj-game" class="hidden flex-1 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2" style="background:rgba(255,255,255,.03)">
          <div class="text-xs"><span style="color:#9a9385">Score</span> <span class="font-bold text-lg text-white ml-1" id="tj-score">0</span></div>
          <div class="text-xs"><span style="color:#9a9385">Streak</span> <span class="font-bold text-white ml-1" id="tj-streak">0</span> 🔥</div>
        </div>
        <div class="flex-1 flex flex-col justify-between p-4">
          <div class="rounded-xl p-4" style="background:rgba(255,255,255,.05)">
            <p class="text-[10px] uppercase tracking-[.15em] mb-2" style="color:var(--gd)">Judge this statement</p>
            <p id="tj-text" class="text-sm fs leading-relaxed italic">"…"</p>
          </div>
          <div>
            <div class="grid grid-cols-3 gap-2 mb-2">
              <button onclick="window.app.game.judgeThesis('strong')" class="py-3 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(77,128,96,.2);color:var(--sg)">💪 Strong</button>
              <button onclick="window.app.game.judgeThesis('weak')" class="py-3 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(196,149,40,.2);color:var(--gd)">😬 Weak</button>
              <button onclick="window.app.game.judgeThesis('not_thesis')" class="py-3 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(212,98,47,.2);color:var(--ac)">🗑️ Not a Thesis</button>
            </div>
            <div id="tj-feedback" class="hidden rounded-xl p-3 text-xs" style="background:rgba(255,255,255,.05)">
              <p id="tj-result" class="font-bold mb-1"></p>
              <p id="tj-why" style="color:#9a9385"></p>
            </div>
          </div>
        </div>
      </div>
    </div>`,

  startThesisJudge: () => {
    const s = window.app.game.thesisJState; s.score = 0; s.streak = 0;
    document.getElementById('tj-start')?.classList.add('hidden');
    document.getElementById('tj-game')?.classList.remove('hidden');
    window.app.game.nextThesisJudge();
  },
  nextThesisJudge: () => {
    const s = window.app.game.thesisJState;
    let i; do { i = Math.floor(Math.random() * THESIS_JUDGE_BANK.length); } while (i === s.idx && THESIS_JUDGE_BANK.length > 1);
    s.idx = i;
    document.getElementById('tj-text').textContent = '"' + THESIS_JUDGE_BANK[i].text + '"';
    document.getElementById('tj-score').textContent = s.score;
    document.getElementById('tj-streak').textContent = s.streak;
    document.getElementById('tj-feedback')?.classList.add('hidden');
    document.querySelectorAll('#tj-game button[onclick*="judgeThesis"]').forEach(b => b.disabled = false);
  },
  judgeThesis: async (guess) => {
    const s = window.app.game.thesisJState;
    const item = THESIS_JUDGE_BANK[s.idx];
    const correct = guess === item.verdict;
    const fbEl = document.getElementById('tj-feedback');
    const resultEl = document.getElementById('tj-result');
    const whyEl = document.getElementById('tj-why');
    document.querySelectorAll('#tj-game button[onclick*="judgeThesis"]').forEach(b => b.disabled = true);
    fbEl?.classList.remove('hidden');
    if (correct) {
      s.score++; s.streak++; s.best = Math.max(s.best, s.streak);
      const xp = s.streak >= 5 ? 15 : s.streak >= 3 ? 10 : 8;
      if (appState.userData?.gamification) { appState.userData.gamification.xp += xp; if (appState.user) { try { await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp }); } catch(e){} } }
      resultEl.textContent = '✅ Correct! +' + xp + ' XP';
      resultEl.style.color = 'var(--sg)';
      if (s.streak % 5 === 0) confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } });
    } else {
      s.streak = 0;
      const labels = { strong: 'Strong Thesis', weak: 'Weak Thesis', not_thesis: 'Not a Thesis' };
      resultEl.textContent = '❌ It was: ' + labels[item.verdict];
      resultEl.style.color = 'var(--ac)';
    }
    whyEl.textContent = item.why;
    document.getElementById('tj-score').textContent = s.score;
    document.getElementById('tj-streak').textContent = s.streak;
    document.getElementById('tj-best').textContent = s.best;
    setTimeout(() => window.app.game.nextThesisJudge(), correct ? 1800 : 3000);
  },

  // ── EVIDENCE OR NAH (new game) ──
  renderEvidenceOrNah: () => `
    <div class="h-full flex flex-col text-white">
      <div id="ev-start" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-4" style="background:var(--sg)"><i data-lucide="check-square" class="w-7 h-7 text-white"></i></div>
        <h3 class="text-xl font-bold mb-1 fs">EVIDENCE OR NAH?</h3>
        <p class="text-xs mb-3 max-w-xs" style="color:#9a9385">Is this evidence specific enough for AP credit, or too vague? Train your evidence radar!</p>
        <div class="text-xs mb-3" style="color:#7f7868">Best streak: <span id="ev-best" class="font-bold text-white">${window.app.game.evidenceState.best}</span></div>
        <button onclick="window.app.game.startEvidence()" class="btnP text-xs px-6 py-2.5">START</button>
      </div>
      <div id="ev-game" class="hidden flex-1 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2" style="background:rgba(255,255,255,.03)">
          <div class="text-xs"><span style="color:#9a9385">Score</span> <span class="font-bold text-lg text-white ml-1" id="ev-score">0</span></div>
          <div class="text-xs"><span style="color:#9a9385">Streak</span> <span class="font-bold text-white ml-1" id="ev-streak">0</span> 🔥</div>
        </div>
        <div class="flex-1 flex flex-col justify-between p-4">
          <div>
            <div class="rounded-xl p-3 mb-3" style="background:rgba(255,255,255,.03)">
              <p class="text-[10px] uppercase tracking-[.15em] mb-1" style="color:#9a9385">The claim</p>
              <p id="ev-claim" class="text-xs font-semibold">…</p>
            </div>
            <div class="rounded-xl p-4" style="background:rgba(255,255,255,.05)">
              <p class="text-[10px] uppercase tracking-[.15em] mb-2" style="color:var(--sg)">The evidence</p>
              <p id="ev-text" class="text-sm fs leading-relaxed">"…"</p>
            </div>
          </div>
          <div>
            <div class="grid grid-cols-2 gap-3 mb-2">
              <button onclick="window.app.game.judgeEvidence('strong')" class="py-3 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(77,128,96,.2);color:var(--sg)">✅ Strong Evidence</button>
              <button onclick="window.app.game.judgeEvidence('weak')" class="py-3 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(212,98,47,.2);color:var(--ac)">❌ Too Vague</button>
            </div>
            <div id="ev-feedback" class="hidden rounded-xl p-3 text-xs" style="background:rgba(255,255,255,.05)">
              <p id="ev-result" class="font-bold mb-1"></p>
              <p id="ev-why" style="color:#9a9385"></p>
            </div>
          </div>
        </div>
      </div>
    </div>`,

  startEvidence: () => {
    const s = window.app.game.evidenceState; s.score = 0; s.streak = 0;
    document.getElementById('ev-start')?.classList.add('hidden');
    document.getElementById('ev-game')?.classList.remove('hidden');
    window.app.game.nextEvidence();
  },
  nextEvidence: () => {
    const s = window.app.game.evidenceState;
    let i; do { i = Math.floor(Math.random() * EVIDENCE_BANK.length); } while (i === s.idx && EVIDENCE_BANK.length > 1);
    s.idx = i;
    document.getElementById('ev-claim').textContent = EVIDENCE_BANK[i].claim;
    document.getElementById('ev-text').textContent = '"' + EVIDENCE_BANK[i].evidence + '"';
    document.getElementById('ev-score').textContent = s.score;
    document.getElementById('ev-streak').textContent = s.streak;
    document.getElementById('ev-feedback')?.classList.add('hidden');
    document.querySelectorAll('#ev-game button[onclick*="judgeEvidence"]').forEach(b => b.disabled = false);
  },
  judgeEvidence: async (guess) => {
    const s = window.app.game.evidenceState;
    const item = EVIDENCE_BANK[s.idx];
    const correct = guess === item.verdict;
    document.querySelectorAll('#ev-game button[onclick*="judgeEvidence"]').forEach(b => b.disabled = true);
    const fbEl = document.getElementById('ev-feedback');
    const resultEl = document.getElementById('ev-result');
    const whyEl = document.getElementById('ev-why');
    fbEl?.classList.remove('hidden');
    if (correct) {
      s.score++; s.streak++; s.best = Math.max(s.best, s.streak);
      const xp = s.streak >= 5 ? 15 : s.streak >= 3 ? 10 : 8;
      if (appState.userData?.gamification) { appState.userData.gamification.xp += xp; if (appState.user) { try { await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp }); } catch(e){} } }
      resultEl.textContent = '✅ Correct! +' + xp + ' XP';
      resultEl.style.color = 'var(--sg)';
      if (s.streak % 5 === 0) confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } });
    } else {
      s.streak = 0;
      resultEl.textContent = '❌ Actually: ' + (item.verdict === 'strong' ? 'This IS strong evidence' : 'This is too vague');
      resultEl.style.color = 'var(--ac)';
    }
    whyEl.textContent = item.why;
    document.getElementById('ev-score').textContent = s.score;
    document.getElementById('ev-streak').textContent = s.streak;
    document.getElementById('ev-best').textContent = s.best;
    setTimeout(() => window.app.game.nextEvidence(), correct ? 1800 : 3000);
  },

  // ── SOURCE DETECTIVE (expanded) ──
  renderSourceDetective: () => `
    <div class="h-full flex flex-col text-white">
      <div class="flex-1 flex flex-col justify-between p-4 gap-2">
        <div>
          <div class="flex items-center justify-between mb-2">
            <div><h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="search" class="w-4 h-4 text-sky-400"></i>Source Detective</h3><p class="text-[11px]" style="color:#9a9385">${SOURCE_CASES.length} cases · ID the POV, audience, and purpose.</p></div>
            <div class="text-right text-[10px]">Solved: <span id="source-solved" class="font-bold text-white">0</span></div>
          </div>
          <div class="mt-2 rounded-lg p-3 max-h-28 overflow-y-auto csc" style="background:rgba(255,255,255,.05)">
            <p class="text-[10px] uppercase tracking-[.15em] mb-1" style="color:#7b8ac4">📄 Document</p>
            <p id="source-doc" class="text-xs leading-snug italic">Click New Case to begin.</p>
            <p id="source-attr" class="text-[10px] mt-2 font-semibold" style="color:var(--gd)"></p>
          </div>
          <div id="source-context-box" class="hidden mt-2 rounded-lg p-2 text-[10px]" style="background:rgba(92,109,179,.1);color:#7b8ac4">
            <span class="font-bold">Context:</span> <span id="source-context-text"></span>
          </div>
        </div>
        <div class="space-y-2">
          <div><label class="text-[10px] font-semibold" style="color:#9a9385">👤 Point of View</label><select id="source-pov" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="text-[10px] font-semibold" style="color:#9a9385">🎯 Audience</label><select id="source-aud" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
            <div><label class="text-[10px] font-semibold" style="color:#9a9385">📌 Purpose</label><select id="source-pur" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
          </div>
        </div>
      </div>
      <div class="p-3 flex items-center justify-between gap-2" style="border-top:1px solid #332f26">
        <button onclick="window.app.game.newSourceCase()" class="text-[11px] flex items-center gap-1 px-3 py-2 rounded-lg" style="background:rgba(255,255,255,.05);color:#e8e6e1"><i data-lucide="file-plus" class="w-3 h-3"></i>New Case</button>
        <button onclick="window.app.game.solveSource()" class="text-[11px] font-semibold flex items-center gap-1 px-4 py-2 rounded-lg" style="background:#5c6db3;color:#fff"><i data-lucide="check-circle-2" class="w-3 h-3"></i>Solve</button>
      </div>
    </div>`,

  newSourceCase: () => {
    const s = window.app.game.sourceState;
    let i; do { i = Math.floor(Math.random() * SOURCE_CASES.length); } while (i === s.caseIdx && SOURCE_CASES.length > 1);
    s.caseIdx = i; const c = SOURCE_CASES[i];
    document.getElementById('source-doc').textContent = c.excerpt;
    const attrEl = document.getElementById('source-attr'); if (attrEl) attrEl.textContent = '— ' + c.attribution;
    document.getElementById('source-context-box')?.classList.add('hidden');
    // Shuffle options with correct answer always included + 4-5 distractors
    const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
    const makeOptions = (correct, allOptions) => {
      const others = allOptions.filter(o => o !== correct);
      const picks = shuffle(others).slice(0, 4);
      picks.push(correct);
      return shuffle(picks);
    };
    const fillSelect = (id, options) => {
      const el = document.getElementById(id); if (!el) return;
      el.innerHTML = '<option value="">Select...</option>';
      options.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; el.appendChild(opt); });
      el.value = '';
    };
    fillSelect('source-pov', makeOptions(c.pov, POV_OPTIONS));
    fillSelect('source-aud', makeOptions(c.audience, AUD_OPTIONS));
    fillSelect('source-pur', makeOptions(c.purpose, PURP_OPTIONS));
  },

  solveSource: async () => {
    const s = window.app.game.sourceState;
    if (s.caseIdx == null) return window.app.ui.toast('Click New Case first.', 'info');
    const c = SOURCE_CASES[s.caseIdx];
    const pov = document.getElementById('source-pov')?.value;
    const aud = document.getElementById('source-aud')?.value;
    const pur = document.getElementById('source-pur')?.value;
    if (!pov || !aud || !pur) return window.app.ui.toast('Fill all three fields.', 'error');
    let score = 0;
    if (pov === c.pov) score++;
    if (aud === c.audience) score++;
    if (pur === c.purpose) score++;
    // Show context reveal
    const ctxBox = document.getElementById('source-context-box');
    const ctxText = document.getElementById('source-context-text');
    if (ctxBox && ctxText) { ctxText.textContent = c.context; ctxBox.classList.remove('hidden'); }
    if (score === 3) {
      s.solved++;
      const xp = 20;
      if (appState.userData?.gamification) { appState.userData.gamification.xp += xp; if (appState.user) { try { await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp }); } catch(e){} } }
      document.getElementById('source-solved').textContent = s.solved;
      window.app.ui.toast('🔍 Case cracked! 3/3 · +' + xp + ' XP', 'success');
      confetti({ particleCount: 70, spread: 60, origin: { y: 0.75 } });
      setTimeout(() => window.app.game.newSourceCase(), 1500);
    } else if (score >= 2) {
      window.app.ui.toast('Close! ' + score + '/3 — ' + (pov !== c.pov ? 'POV' : aud !== c.audience ? 'Audience' : 'Purpose') + ' was wrong. Try again!', 'info');
    } else {
      let wrong = [];
      if (pov !== c.pov) wrong.push('POV');
      if (aud !== c.audience) wrong.push('Audience');
      if (pur !== c.purpose) wrong.push('Purpose');
      window.app.ui.toast(score + '/3 — Check: ' + wrong.join(', ') + '. Read the attribution carefully!', 'error');
    }
  },

  // ── BLOCK BLAST (Real mechanics: place shapes, clear rows/cols) ──
  _BB_SHAPES: [
    [[0,0]],
    [[0,0],[0,1]],[[0,0],[1,0]],
    [[0,0],[0,1],[0,2]],[[0,0],[1,0],[2,0]],
    [[0,0],[0,1],[0,2],[0,3]],[[0,0],[1,0],[2,0],[3,0]],
    [[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0],[3,0],[4,0]],
    [[0,0],[0,1],[1,0],[1,1]],
    [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]],
    [[0,0],[1,0],[2,0],[2,1]],[[0,1],[1,1],[2,0],[2,1]],
    [[0,0],[0,1],[1,0]],[[0,0],[0,1],[1,1]],[[0,0],[1,0],[1,1]],[[0,1],[1,0],[1,1]],
    [[0,0],[0,1],[0,2],[1,0]],[[0,0],[0,1],[0,2],[1,2]],
    [[0,0],[1,0],[1,1],[1,2]],[[0,2],[1,0],[1,1],[1,2]],
    [[0,0],[0,1],[1,1],[1,2]],[[0,1],[0,2],[1,0],[1,1]],
    [[0,0],[0,1],[0,2],[1,1]],
  ],
  bbState: { grid:null, score:0, best:0, active:false, pieces:[], selPiece:null, clears:0, usedQ:[], hoverR:-1, hoverC:-1 },

  renderBlockBlast: () => `
    <div class="h-full flex flex-col text-white">
      <div id="bb-start" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-4" style="background:linear-gradient(135deg,#4A90D9,#9B6FC3)"><i data-lucide="grid-3x3" class="w-7 h-7 text-white"></i></div>
        <h3 class="text-xl font-bold mb-1 fs">BLOCK BLAST</h3>
        <p class="text-xs mb-2 max-w-xs" style="color:#9a9385">Place shapes on the 8×8 grid. Fill rows or columns to clear them. Answer AP questions for bonus points!</p>
        <div class="flex gap-3 mb-3 text-[10px]" style="color:#7f7868">
          <span><span class="inline-block w-3 h-3 rounded" style="background:#4A90D9"></span> Political</span>
          <span><span class="inline-block w-3 h-3 rounded" style="background:#D4A843"></span> Economic</span>
          <span><span class="inline-block w-3 h-3 rounded" style="background:#5AAF6E"></span> Social</span>
          <span><span class="inline-block w-3 h-3 rounded" style="background:#9B6FC3"></span> Cultural</span>
        </div>
        <div class="text-xs mb-3" style="color:#7f7868">Best: <span class="font-bold text-white">${window.app.game.bbState.best}</span></div>
        <button onclick="window.app.game.startBlockBlast()" class="btnP text-xs px-6 py-2.5">START GAME</button>
      </div>
      <div id="bb-game" class="hidden flex-1 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2" style="background:rgba(255,255,255,.03)">
          <div class="text-xs"><span style="color:#9a9385">Score</span> <span class="font-bold text-lg text-white ml-1" id="bb-score">0</span></div>
          <div class="text-xs"><span style="color:#9a9385">Lines</span> <span class="font-bold text-white ml-1" id="bb-lines">0</span></div>
          <button onclick="window.app.game.endBlockBlast()" class="text-xs" style="color:#655f52">End</button>
        </div>
        <div class="flex-1 flex items-center justify-center p-4">
          <div class="bb-board" id="bb-grid"></div>
        </div>
        <div class="bb-tray" id="bb-tray"></div>
      </div>
      <div id="bb-over" class="hidden flex-1 flex flex-col items-center justify-center p-6 text-center" style="background:rgba(0,0,0,.6)">
        <h3 class="text-xl font-bold mb-2 fs">GAME OVER</h3>
        <p class="text-sm mb-1" style="color:#9a9385">Score: <span class="text-white font-bold" id="bb-final">0</span></p>
        <p class="text-xs mb-4" style="color:#7f7868" id="bb-final-msg"></p>
        <button onclick="window.app.game.startBlockBlast()" class="btnP text-xs px-6 py-2.5">PLAY AGAIN</button>
      </div>
    </div>`,

  startBlockBlast: () => {
    const g = window.app.game, s = g.bbState;
    s.grid = Array.from({length:8}, () => Array(8).fill(null));
    s.score = 0; s.clears = 0; s.active = true; s.selPiece = null; s.usedQ = []; s.hoverR = -1; s.hoverC = -1;
    g.bbGenPieces();
    document.getElementById('bb-start')?.classList.add('hidden');
    document.getElementById('bb-over')?.classList.add('hidden');
    document.getElementById('bb-game')?.classList.remove('hidden');
    g.bbRender();
  },

  endBlockBlast: () => {
    const s = window.app.game.bbState;
    s.active = false;
    s.best = Math.max(s.best, s.score);
    document.getElementById('bb-game')?.classList.add('hidden');
    document.getElementById('bb-over')?.classList.remove('hidden');
    document.getElementById('bb-final').textContent = s.score;
    document.getElementById('bb-final-msg').textContent = s.score >= 1000 ? 'AP Scholar with Distinction!' : s.score >= 500 ? 'AP Scholar! Great work!' : s.score >= 200 ? 'Solid knowledge — keep it up!' : 'History takes time — play again!';
    if (s.score > 0 && appState.userData?.gamification) {
      const xp = Math.round(s.score / 10) * 2;
      appState.userData.gamification.xp += xp;
      if (appState.user) { try { updateDoc(doc(db,"users",appState.user.uid),{"gamification.xp":appState.userData.gamification.xp}); } catch(e){} }
      window.app.ui.toast(`+${xp} XP earned!`, 'success');
    }
  },

  bbGenPieces: () => {
    const g = window.app.game, s = g.bbState, cats = Object.keys(BB_CAT_COLORS), shapes = g._BB_SHAPES;
    s.pieces = [0,1,2].map(() => ({ shape: shapes[Math.floor(Math.random()*shapes.length)], cat: cats[Math.floor(Math.random()*4)], placed: false }));
    s.selPiece = null;
  },

  bbRender: () => {
    const g = window.app.game, s = g.bbState;
    const el = document.getElementById('bb-grid'), tray = document.getElementById('bb-tray');
    if (!el) return;
    // Ghost cells
    const ghostSet = new Set();
    if (s.selPiece !== null && s.hoverR >= 0) {
      const piece = s.pieces[s.selPiece];
      if (g.bbCanPlace(piece.shape, s.hoverR, s.hoverC)) {
        piece.shape.forEach(([r,c]) => ghostSet.add((s.hoverR+r)*8+(s.hoverC+c)));
      }
    }
    const ghostCat = s.selPiece !== null ? s.pieces[s.selPiece]?.cat : null;
    // Render grid
    el.innerHTML = s.grid.map((row,r) => row.map((cat,c) => {
      const key = r*8+c;
      const isGhost = ghostSet.has(key);
      if (cat) return `<div class="bb-cell filled" style="background:${BB_CAT_COLORS[cat]}" onmouseenter="window.app.game.bbHover(${r},${c})" onclick="window.app.game.bbPlace(${r},${c})"></div>`;
      if (isGhost) return `<div class="bb-cell ghost" style="background:${BB_CAT_COLORS[ghostCat]}" onmouseenter="window.app.game.bbHover(${r},${c})" onclick="window.app.game.bbPlace(${r},${c})"></div>`;
      return `<div class="bb-cell" onmouseenter="window.app.game.bbHover(${r},${c})" onclick="window.app.game.bbPlace(${r},${c})"></div>`;
    }).join('')).join('');
    // Score
    const sc = document.getElementById('bb-score'); if(sc) sc.textContent = s.score;
    const ln = document.getElementById('bb-lines'); if(ln) ln.textContent = s.clears;
    // Render tray
    if (tray) {
      tray.innerHTML = s.pieces.map((p,i) => {
        if (p.placed) return `<div class="bb-piece used" style="grid-template-columns:repeat(1,18px)"><div class="bb-piece-cell empty"></div></div>`;
        const maxR = Math.max(...p.shape.map(c=>c[0]))+1, maxC = Math.max(...p.shape.map(c=>c[1]))+1;
        const cellSet = new Set(p.shape.map(([r,c])=>r*maxC+c));
        let cells = '';
        for(let r=0;r<maxR;r++) for(let c=0;c<maxC;c++) cells += cellSet.has(r*maxC+c) ? `<div class="bb-piece-cell" style="background:${BB_CAT_COLORS[p.cat]}"></div>` : `<div class="bb-piece-cell empty"></div>`;
        return `<div class="bb-piece ${s.selPiece===i?'selected':''}" style="grid-template-columns:repeat(${maxC},18px)" onclick="window.app.game.bbSelect(${i})">${cells}</div>`;
      }).join('');
    }
  },

  bbSelect: (idx) => {
    const s = window.app.game.bbState;
    if (!s.active || s.pieces[idx].placed) return;
    s.selPiece = s.selPiece === idx ? null : idx;
    s.hoverR = -1; s.hoverC = -1;
    window.app.game.bbRender();
  },

  bbHover: (r,c) => {
    const g = window.app.game, s = g.bbState;
    if (s.selPiece === null) return;
    if (s.hoverR === r && s.hoverC === c) return;
    s.hoverR = r; s.hoverC = c;
    g.bbRender();
  },

  bbCanPlace: (shape, row, col) => {
    const grid = window.app.game.bbState.grid;
    return shape.every(([r,c]) => { const gr=row+r, gc=col+c; return gr>=0 && gr<8 && gc>=0 && gc<8 && grid[gr][gc]===null; });
  },

  bbPlace: (r,c) => {
    const g = window.app.game, s = g.bbState;
    if (s.selPiece === null || !s.active) return;
    const piece = s.pieces[s.selPiece];
    if (!g.bbCanPlace(piece.shape, r, c)) return;
    // Place piece
    piece.shape.forEach(([dr,dc]) => { s.grid[r+dr][c+dc] = piece.cat; });
    piece.placed = true;
    s.score += piece.shape.length * 5;
    s.selPiece = null; s.hoverR = -1; s.hoverC = -1;
    // Check line clears
    const cleared = g.bbCheckLines();
    // Generate new pieces if all 3 placed
    if (s.pieces.every(p => p.placed)) g.bbGenPieces();
    // Check game over
    if (!g.bbCanPlaceAny()) { setTimeout(()=>g.endBlockBlast(), 400); g.bbRender(); return; }
    g.bbRender();
    // MCQ bonus every 3 line clears
    if (cleared > 0 && s.clears % 3 === 0) setTimeout(()=>g.bbShowQuestion(), 300);
  },

  bbCheckLines: () => {
    const s = window.app.game.bbState;
    let rows = [], cols = [];
    for(let r=0;r<8;r++) if(s.grid[r].every(c=>c!==null)) rows.push(r);
    for(let c=0;c<8;c++) if(s.grid.every(row=>row[c]!==null)) cols.push(c);
    if (!rows.length && !cols.length) return 0;
    rows.forEach(r => { for(let c=0;c<8;c++) s.grid[r][c]=null; });
    cols.forEach(c => { for(let r=0;r<8;r++) s.grid[r][c]=null; });
    const total = rows.length + cols.length;
    const pts = total * 100 + (total > 1 ? total * 80 : 0);
    s.score += pts; s.clears += total;
    window.app.ui.toast(`${total > 1 ? 'COMBO! ' : ''}${total} line${total>1?'s':''} cleared! +${pts}`, 'success');
    return total;
  },

  bbCanPlaceAny: () => {
    const g = window.app.game, s = g.bbState;
    for (const p of s.pieces) {
      if (p.placed) continue;
      for(let r=0;r<8;r++) for(let c=0;c<8;c++) if(g.bbCanPlace(p.shape,r,c)) return true;
    }
    return false;
  },

  bbShowQuestion: () => {
    const g = window.app.game, s = g.bbState;
    let pool = BB_QUESTIONS.filter((_,i) => !s.usedQ.includes(i));
    if(!pool.length) { s.usedQ = []; pool = BB_QUESTIONS; }
    const qi = BB_QUESTIONS.indexOf(pool[Math.floor(Math.random()*pool.length)]);
    const q = BB_QUESTIONS[qi]; s.usedQ.push(qi);
    const cat = q.cat, catLabel = cat.charAt(0).toUpperCase()+cat.slice(1);
    const modal = document.createElement('div');
    modal.className = 'bb-modal'; modal.id = 'bb-q-modal';
    modal.innerHTML = `<div class="bb-qcard">
      <div class="mb-2"><span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background:${BB_CAT_COLORS[cat]}30;color:${BB_CAT_COLORS[cat]}">${catLabel}</span> <span class="text-[10px]" style="color:#7f7868">Bonus Round!</span></div>
      <p class="text-sm font-semibold mb-3" style="color:#e8e6e1">${q.q}</p>
      ${q.c.map((ch,i) => `<button class="bb-choice" data-idx="${i}">${String.fromCharCode(65+i)}. ${ch}</button>`).join('')}
    </div>`;
    document.body.appendChild(modal);
    modal.querySelectorAll('.bb-choice').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.dataset.idx);
        modal.querySelectorAll('.bb-choice').forEach(b => b.style.pointerEvents='none');
        if(idx === q.a) {
          btn.classList.add('correct'); s.score += 200;
          window.app.ui.toast('+200 bonus points!','success');
          setTimeout(()=>{ modal.remove(); g.bbRender(); }, 700);
        } else {
          btn.classList.add('wrong');
          modal.querySelector(`.bb-choice[data-idx="${q.a}"]`)?.classList.add('correct');
          setTimeout(()=>modal.remove(), 900);
        }
      };
    });
  }
},

// ═══ LIVE QUIZ ═══
quiz: {
  _gameId: null, _isHost: false, _unsub: null, _unsub2: null, _timer: null, _players: [],

  hostGame: async () => {
    if (!appState.user) return;
    const code = Math.random().toString(36).substring(2,8).toUpperCase();
    // Pick 12 random questions from BB_QUESTIONS
    const shuffled = [...BB_QUESTIONS].sort(()=>Math.random()-.5).slice(0,12);
    try {
      const ref = await addDoc(collection(db,'quizGames'),{
        hostId: appState.user.uid, code, status:'lobby', currentQ:0,
        questions: shuffled.map(q=>({q:q.q,c:q.c,a:q.a,cat:q.cat})),
        numQuestions: shuffled.length, timePerQ:15,
        questionStartedAt:null, createdAt:serverTimestamp()
      });
      window.app.router.go('quiz-game',{gameId:ref.id,isHost:true});
    } catch(e) { window.app.ui.toast('Error creating quiz: '+e.message,'error'); }
  },

  joinGame: async (code) => {
    if (!appState.user || !code) return;
    try {
      const snap = await getDocs(query(collection(db,'quizGames'),where('code','==',code.toUpperCase()),where('status','==','lobby')));
      if (snap.empty) return window.app.ui.toast('No game found with that code.','error');
      const gameDoc = snap.docs[0];
      // Add player
      await setDoc(doc(db,'quizGames',gameDoc.id,'players',appState.user.uid),{
        name: appState.userData?.name||'Player', score:0, streak:0, answered:false, answer:null, answerTime:null
      });
      window.app.router.go('quiz-game',{gameId:gameDoc.id,isHost:false});
    } catch(e) { window.app.ui.toast('Error joining: '+e.message,'error'); }
  },

  init: (gameId, isHost) => {
    const qz = window.app.quiz;
    qz._gameId = gameId; qz._isHost = !!isHost; qz._players = [];
    // Listen to game doc
    qz._unsub = onSnapshot(doc(db,'quizGames',gameId), snap => {
      if (!snap.exists()) return;
      qz._gameData = snap.data();
      qz._render();
    });
    // Listen to players
    qz._unsub2 = onSnapshot(collection(db,'quizGames',gameId,'players'), snap => {
      qz._players = snap.docs.map(d=>({id:d.id,...d.data()}));
      qz._render();
    });
  },

  _render: () => {
    const qz = window.app.quiz, g = qz._gameData;
    if (!g) return;
    const status = g.status;
    document.getElementById('qz-lobby')?.classList.toggle('hidden', status!=='lobby');
    document.getElementById('qz-question')?.classList.toggle('hidden', status!=='question');
    document.getElementById('qz-leaderboard')?.classList.toggle('hidden', status!=='leaderboard');
    document.getElementById('qz-podium')?.classList.toggle('hidden', status!=='podium');

    if (status==='lobby') qz._renderLobby();
    else if (status==='question') qz._renderQuestion();
    else if (status==='leaderboard') qz._renderLeaderboard();
    else if (status==='podium') qz._renderPodium();
  },

  _renderLobby: () => {
    const qz = window.app.quiz, g = qz._gameData;
    document.getElementById('qz-code').textContent = g.code;
    document.getElementById('qz-subtitle').textContent = `${g.numQuestions} questions · ${g.timePerQ}s each · ${qz._players.length} player${qz._players.length!==1?'s':''}`;
    document.getElementById('qz-players').innerHTML = qz._players.map(p =>
      `<div class="qz-player-chip">${p.name}</div>`
    ).join('') || '<p class="text-xs" style="color:#655f52">Waiting for players to join...</p>';
    document.getElementById('qz-lobby-actions').innerHTML = qz._isHost
      ? `<button onclick="window.app.quiz.startGame()" class="btnP text-sm px-8 py-3" ${qz._players.length<1?'disabled':''}>${qz._players.length<1?'Need at least 1 player':'Start Game!'}</button>`
      : `<p class="text-xs" style="color:#9a9385">Waiting for host to start...</p>`;
  },

  startGame: async () => {
    const qz = window.app.quiz;
    // Reset all player scores
    for (const p of qz._players) {
      await updateDoc(doc(db,'quizGames',qz._gameId,'players',p.id),{score:0,streak:0,answered:false,answer:null,answerTime:null});
    }
    await updateDoc(doc(db,'quizGames',qz._gameId),{status:'question',currentQ:0,questionStartedAt:serverTimestamp()});
  },

  _renderQuestion: () => {
    const qz = window.app.quiz, g = qz._gameData;
    const qi = g.currentQ, q = g.questions[qi];
    if (!q) return;
    document.getElementById('qz-qnum').textContent = `Q${qi+1}/${g.numQuestions}`;
    document.getElementById('qz-q-text').textContent = q.q;
    const me = qz._players.find(p=>p.id===appState.user?.uid);
    if (me) document.getElementById('qz-my-score').textContent = me.score;

    // Check if already answered
    const answered = me?.answered;
    const choicesEl = document.getElementById('qz-choices');
    if (choicesEl && !answered) {
      choicesEl.innerHTML = q.c.map((c,i) =>
        `<button class="qz-choice" onclick="window.app.quiz.answer(${i})">${String.fromCharCode(65+i)}. ${c}</button>`
      ).join('');
    } else if (choicesEl && answered) {
      choicesEl.innerHTML = q.c.map((c,i) => {
        const cls = i===q.a ? 'picked right' : (i===me.answer ? 'picked wrong' : 'picked');
        return `<button class="qz-choice ${cls}" disabled>${String.fromCharCode(65+i)}. ${c}</button>`;
      }).join('');
    }
    const fb = document.getElementById('qz-answer-feedback');
    if (fb) fb.classList.toggle('hidden', !answered);
    if (fb && answered) {
      fb.innerHTML = me.answer===q.a
        ? `<span class="text-sm font-bold" style="color:#2ecc71">Correct! 🔥 Streak: ${me.streak}</span>`
        : `<span class="text-sm font-bold" style="color:#e74c3c">Wrong — answer was ${String.fromCharCode(65+q.a)}</span>`;
    }

    // Timer
    qz._startTimer();

    // Host: if all answered or time up, show leaderboard
    if (qz._isHost) {
      const allAnswered = qz._players.length > 0 && qz._players.every(p=>p.answered);
      if (allAnswered) { clearInterval(qz._timer); setTimeout(()=>qz.showLeaderboard(),1500); }
    }
  },

  _startTimer: () => {
    const qz = window.app.quiz, g = qz._gameData;
    clearInterval(qz._timer);
    const timerEl = document.getElementById('qz-timer');
    if (!timerEl || !g.questionStartedAt) return;
    const startMs = g.questionStartedAt.toMillis ? g.questionStartedAt.toMillis() : (g.questionStartedAt.seconds*1000);
    qz._timer = setInterval(() => {
      const elapsed = (Date.now()-startMs)/1000;
      const remaining = Math.max(0, g.timePerQ - elapsed);
      timerEl.textContent = Math.ceil(remaining);
      timerEl.classList.toggle('urgent', remaining <= 5);
      if (remaining <= 0) {
        clearInterval(qz._timer);
        timerEl.textContent = '0';
        if (qz._isHost) setTimeout(()=>qz.showLeaderboard(), 1000);
      }
    }, 200);
  },

  answer: async (choice) => {
    const qz = window.app.quiz, g = qz._gameData;
    if (!appState.user) return;
    const q = g.questions[g.currentQ];
    const startMs = g.questionStartedAt.toMillis ? g.questionStartedAt.toMillis() : (g.questionStartedAt.seconds*1000);
    const answerTime = (Date.now()-startMs)/1000;
    const correct = choice === q.a;
    const me = qz._players.find(p=>p.id===appState.user.uid);
    const streak = correct ? (me?.streak||0)+1 : 0;
    const multiplier = streak >= 10 ? 3 : streak >= 5 ? 2 : streak >= 3 ? 1.5 : 1;
    const speedBonus = Math.round(Math.max(0, (g.timePerQ - answerTime) / g.timePerQ * 500));
    const pts = correct ? Math.round((1000 + speedBonus) * multiplier) : 0;
    const newScore = (me?.score||0) + pts;

    await updateDoc(doc(db,'quizGames',qz._gameId,'players',appState.user.uid),{
      answered:true, answer:choice, answerTime: Math.round(answerTime*10)/10,
      score:newScore, streak
    });

    // Score popup
    if (correct) {
      const pop = document.createElement('div');
      pop.className = 'qz-score-pop';
      pop.textContent = `+${pts}`;
      document.body.appendChild(pop);
      setTimeout(()=>pop.remove(),1000);
    }
  },

  showLeaderboard: async () => {
    const qz = window.app.quiz;
    if (!qz._isHost) return;
    await updateDoc(doc(db,'quizGames',qz._gameId),{status:'leaderboard'});
  },

  _renderLeaderboard: () => {
    const qz = window.app.quiz, g = qz._gameData;
    const sorted = [...qz._players].sort((a,b)=>b.score-a.score);
    const medals = ['🥇','🥈','🥉'];
    document.getElementById('qz-lb-list').innerHTML = sorted.map((p,i) =>
      `<div class="qz-lb-row"><span class="text-lg">${medals[i]||`<span class="text-xs fm" style="color:#655f52">${i+1}</span>`}</span><span class="flex-1 text-sm font-semibold text-left">${p.name}</span><span class="fm text-sm font-bold">${p.score.toLocaleString()}</span>${p.streak>=3?`<span class="text-xs">🔥${p.streak}</span>`:''}</div>`
    ).join('');
    document.getElementById('qz-lb-actions').innerHTML = qz._isHost
      ? (g.currentQ < g.numQuestions - 1
        ? `<button onclick="window.app.quiz.nextQuestion()" class="btnP text-sm px-8 py-3 mt-2">Next Question →</button>`
        : `<button onclick="window.app.quiz.finish()" class="btnP text-sm px-8 py-3 mt-2">Show Final Results!</button>`)
      : `<p class="text-xs mt-2" style="color:#9a9385">Host is advancing...</p>`;
  },

  nextQuestion: async () => {
    const qz = window.app.quiz, g = qz._gameData;
    // Reset answered for all players
    for (const p of qz._players) {
      await updateDoc(doc(db,'quizGames',qz._gameId,'players',p.id),{answered:false,answer:null,answerTime:null});
    }
    await updateDoc(doc(db,'quizGames',qz._gameId),{status:'question',currentQ:g.currentQ+1,questionStartedAt:serverTimestamp()});
  },

  finish: async () => {
    const qz = window.app.quiz;
    await updateDoc(doc(db,'quizGames',qz._gameId),{status:'podium'});
  },

  _renderPodium: () => {
    const qz = window.app.quiz;
    const sorted = [...qz._players].sort((a,b)=>b.score-a.score);
    const medals = ['🥇','🥈','🥉'], podCls = ['qz-pod-1','qz-pod-2','qz-pod-3'];
    // Podium (reorder: 2nd, 1st, 3rd)
    const podOrder = sorted.length>=3 ? [sorted[1],sorted[0],sorted[2]] : sorted.length===2 ? [sorted[1],sorted[0]] : sorted.slice(0,1);
    const podClsOrder = sorted.length>=3 ? [1,0,2] : sorted.length===2 ? [1,0] : [0];
    document.getElementById('qz-podium-display').innerHTML = podOrder.map((p,i) =>
      `<div class="qz-pod ${podCls[podClsOrder[i]]}"><div class="text-3xl mb-1">${medals[podClsOrder[i]]}</div><div class="text-sm font-bold mb-1">${p.name}</div><div class="fm text-xs" style="color:#9a9385">${p.score.toLocaleString()}</div></div>`
    ).join('');
    // Full list
    document.getElementById('qz-podium-full').innerHTML = sorted.slice(3).map((p,i) =>
      `<div class="flex items-center gap-3 py-2 px-4 text-xs"><span class="fm" style="color:#655f52">${i+4}</span><span class="flex-1 font-semibold">${p.name}</span><span class="fm">${p.score.toLocaleString()}</span></div>`
    ).join('');
    // Award XP to current user
    const me = sorted.find(p=>p.id===appState.user?.uid);
    if (me && me.score > 0 && appState.userData?.gamification && !qz._xpAwarded) {
      qz._xpAwarded = true;
      const xp = Math.round(me.score/20);
      appState.userData.gamification.xp += xp;
      if (appState.user) { try { updateDoc(doc(db,"users",appState.user.uid),{"gamification.xp":appState.userData.gamification.xp}); } catch(e){} }
      window.app.ui.toast(`+${xp} XP from quiz!`,'success');
    }
    // Confetti for winner
    if (sorted[0]?.id === appState.user?.uid && typeof confetti !== 'undefined') {
      confetti({particleCount:120,spread:90,origin:{y:.6}});
    }
  },

  exit: () => {
    const qz = window.app.quiz;
    clearInterval(qz._timer);
    if (qz._unsub) { qz._unsub(); qz._unsub=null; }
    if (qz._unsub2) { qz._unsub2(); qz._unsub2=null; }
    qz._xpAwarded = false;
    window.app.router.go(appState.userData?.role==='teacher'?'teacher-dash':'student-dash');
  }
},

// ═══ STORY LESSONS ═══
story: {
  _storyId: null, _chapter: 0, _assignmentId: null, _completed: [],

  init: (storyId, assignmentId) => {
    const st = window.app.story;
    st._storyId = storyId;
    st._chapter = 0;
    st._assignmentId = assignmentId || null;
    // Load progress from localStorage
    const saved = localStorage.getItem(`story_${storyId}_${appState.user?.uid||'preview'}`);
    st._completed = saved ? JSON.parse(saved) : [];
    // If they've completed some chapters, start at the first incomplete
    const story = STORY_LESSONS[storyId];
    if (story) {
      const firstIncomplete = story.chapters.findIndex((_,i) => !st._completed.includes(i));
      st._chapter = firstIncomplete >= 0 ? firstIncomplete : 0;
    }
    st.renderChapter();
    lucide.createIcons();
  },

  exit: () => {
    const role = appState.userData?.role;
    if (!appState.user || role === 'teacher') window.app.router.go('library');
    else window.app.router.go('student-dash');
  },

  renderChapter: () => {
    const st = window.app.story;
    const story = STORY_LESSONS[st._storyId]; if (!story) return;
    const ch = story.chapters[st._chapter];
    const container = document.getElementById('story-content');
    const progEl = document.getElementById('story-progress');
    if (!container) return;

    // Progress pips
    if (progEl) {
      progEl.innerHTML = story.chapters.map((_,i) =>
        `<div class="story-pip ${st._completed.includes(i)?'done':''} ${i===st._chapter?'current':''}"></div>`
      ).join('');
    }

    const isComplete = st._completed.includes(st._chapter);
    const isLastChapter = st._chapter === story.chapters.length - 1;
    const isTeacher = appState.userData?.role === 'teacher';
    // Check for custom image override
    const customKey = `story_img_${st._storyId}_${st._chapter}`;
    const imgUrl = localStorage.getItem(customKey) || ch.img;

    container.innerHTML = `
      ${imgUrl ? `<div style="position:relative" class="mb-4">
        <img src="${imgUrl}" alt="${ch.title}" class="story-img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="story-scene" style="background:${ch.bg};display:none">
          <div class="story-icon">${ch.icon}</div>
          <div class="story-chnum">Chapter ${st._chapter + 1} of ${story.chapters.length}</div>
          <div class="story-chtitle">${ch.title}</div>
          <div class="story-date">${ch.date}</div>
        </div>
        ${isTeacher ? `<button class="story-img-edit" onclick="window.app.story.editImage()">✏️ Edit Image</button>` : ''}
      </div>` : ''}
      <div class="story-scene mb-6" style="background:${ch.bg}${imgUrl ? ';min-height:auto;padding:20px 16px' : ''}">
        ${!imgUrl ? `<div class="story-icon">${ch.icon}</div>` : ''}
        <div class="story-chnum">Chapter ${st._chapter + 1} of ${story.chapters.length}</div>
        <div class="story-chtitle">${ch.title}</div>
        <div class="story-date">${ch.date}</div>
        ${isTeacher && !imgUrl ? `<button class="story-img-edit" onclick="window.app.story.editImage()" style="margin-top:8px">✏️ Add Image</button>` : ''}
      </div>
      <div class="story-body mb-6">
        ${ch.text}
        ${ch.quote ? `<blockquote class="story-quote">"${ch.quote.text}"<cite>${ch.quote.attr}</cite></blockquote>` : ''}
      </div>
      <div class="story-check" id="story-check">
        ${isComplete ? `
          <div class="text-center story-unlock">
            <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" style="background:rgba(77,128,96,.15)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--sg)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
            <p class="text-sm font-bold" style="color:var(--sg)">Chapter Complete!</p>
            <p class="text-xs mt-1 mb-4" style="color:var(--mu)">You demonstrated understanding of this section.</p>
            ${isLastChapter ? `
              <div class="p-4 rounded-xl mb-3" style="background:linear-gradient(135deg,rgba(212,98,47,.08),rgba(196,149,40,.08));border:1px solid var(--bd2)">
                <p class="text-lg font-bold fs" style="color:var(--ac)">Story Complete!</p>
                <p class="text-xs mt-1" style="color:var(--mu)">You finished all ${story.chapters.length} chapters of Unit ${story.unit}: ${story.title}</p>
              </div>
              <button onclick="window.app.story.exit()" class="btnP text-xs px-6 py-2.5">Back to Dashboard</button>
            ` : `<button onclick="window.app.story.nextChapter()" class="btnP text-xs px-6 py-2.5">Continue to Chapter ${st._chapter + 2} →</button>`}
          </div>
        ` : `
          <div class="story-narrator">
            <div class="story-narrator-avi">🧑‍🏫</div>
            <div class="story-narrator-bubble">
              <p class="text-sm font-semibold mb-1">Before you continue...</p>
              <p class="text-xs" style="color:var(--mu)">${ch.question}</p>
            </div>
          </div>
          <textarea id="story-answer" class="hinp mt-3 text-sm" rows="4" placeholder="Type your answer here... Show me you understand the key ideas from this chapter."></textarea>
          <div id="story-feedback" class="hidden mt-3"></div>
          <button id="story-submit-btn" onclick="window.app.story.checkAnswer()" class="btnP text-xs w-full mt-3">Check My Understanding</button>
        `}
      </div>
      <div class="flex justify-between mt-6">
        <button onclick="window.app.story.prevChapter()" class="btnG text-xs py-2 px-4" ${st._chapter === 0 ? 'style="visibility:hidden"' : ''}>← Previous</button>
        <span class="text-[10px] fm" style="color:var(--fa)">${st._chapter + 1} / ${story.chapters.length}</span>
        ${isComplete && !isLastChapter ? `<button onclick="window.app.story.nextChapter()" class="btnG text-xs py-2 px-4">Next →</button>` : `<div></div>`}
      </div>
    `;
    // Scroll to top
    document.getElementById('story-root')?.scrollTo(0,0);
    window.scrollTo(0,0);
    lucide.createIcons();
  },

  checkAnswer: async () => {
    const st = window.app.story;
    const story = STORY_LESSONS[st._storyId]; if (!story) return;
    const ch = story.chapters[st._chapter];
    const answer = document.getElementById('story-answer')?.value?.trim();
    if (!answer || answer.length < 15) return window.app.ui.toast('Write a more complete answer — at least a sentence or two.', 'info');

    const btn = document.getElementById('story-submit-btn');
    const fb = document.getElementById('story-feedback');
    if (btn) { btn.disabled = true; btn.textContent = 'Checking...'; }

    // Resolve API key
    let key = appState._cachedGlobalKey || appState.apiKey;
    if (!key && appState.userData?.classIds?.length) {
      try {
        const cSnap = await getDocs(query(collection(db,"classes"),where("students","array-contains",appState.user.uid)));
        for (const d of cSnap.docs) { const cd = d.data(); if (cd.teacherId) { const tDoc = await getDoc(doc(db,"users",cd.teacherId)); if (tDoc.exists() && tDoc.data().apiKey) { key = tDoc.data().apiKey; break; } } }
      } catch(e){}
    }
    if (!key) {
      try { const cfgDoc = await getDoc(doc(db,"config","api")); if (cfgDoc.exists()) key = cfgDoc.data().key; } catch(e){}
    }

    if (!key) {
      // Fallback: simple keyword matching
      const concepts = ch.keyConcept.toLowerCase().split(/[,.]/).map(s=>s.trim()).filter(s=>s.length>3);
      const ansLower = answer.toLowerCase();
      const matches = concepts.filter(c => { const words = c.split(/\s+/).filter(w=>w.length>4); return words.some(w => ansLower.includes(w)); });
      if (matches.length >= 2) {
        st._markComplete();
        if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(77,128,96,.08);border:1px solid rgba(77,128,96,.2)"><p class="text-xs font-bold" style="color:var(--sg)">✓ Good understanding!</p><p class="text-xs mt-1" style="color:var(--mu)">You've shown you grasp the key ideas. Moving on!</p></div>`; }
        setTimeout(() => st.renderChapter(), 1200);
      } else {
        if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(212,98,47,.08);border:1px solid rgba(212,98,47,.2)"><p class="text-xs font-bold" style="color:var(--ac)">Not quite yet</p><p class="text-xs mt-1" style="color:var(--mu)">Re-read the chapter and try to address: ${ch.question}</p><p class="text-[10px] mt-1" style="color:var(--fa)">Hint: Think about ${concepts.slice(0,2).join(' and ')}.</p></div>`; }
        if(btn) { btn.disabled = false; btn.textContent = 'Try Again'; }
      }
      return;
    }

    // AI evaluation
    try {
      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({
          model:'claude-sonnet-4-5-20250929', max_tokens:300,
          system:'You are a friendly AP World History teacher evaluating student understanding. Be encouraging but accurate. Respond in JSON: {"pass":true/false,"feedback":"1-2 sentences of feedback","hint":"if not passing, a helpful hint"}',
          messages:[{role:'user',content:`Chapter: "${ch.title}"\nKey concept the student should demonstrate understanding of: ${ch.keyConcept}\n\nRetention question: ${ch.question}\n\nStudent's answer: "${answer}"\n\nDoes this answer show basic understanding of the key concept? They don't need to be perfect — just show they grasped the main ideas. Be encouraging.`}]
        })
      });
      const data = await resp.json();
      const text = data.content?.[0]?.text || '';
      let result;
      try { result = JSON.parse(text); } catch { result = text.toLowerCase().includes('"pass":true') || text.toLowerCase().includes('"pass": true') ? {pass:true,feedback:'Great understanding!'} : {pass:false,feedback:'Try reading the chapter again.',hint:'Focus on the key terms.'}; }

      if (result.pass) {
        st._markComplete();
        if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(77,128,96,.08);border:1px solid rgba(77,128,96,.2)"><p class="text-xs font-bold" style="color:var(--sg)">✓ ${result.feedback || 'Great understanding!'}</p></div>`; }
        setTimeout(() => st.renderChapter(), 1500);
      } else {
        if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(212,98,47,.08);border:1px solid rgba(212,98,47,.2)"><p class="text-xs font-bold" style="color:var(--ac)">Almost there!</p><p class="text-xs mt-1" style="color:var(--mu)">${result.feedback || 'Review the chapter and try again.'}</p>${result.hint ? `<p class="text-[10px] mt-1" style="color:var(--fa)">💡 ${result.hint}</p>` : ''}</div>`; }
        if(btn) { btn.disabled = false; btn.textContent = 'Try Again'; }
      }
    } catch(e) {
      console.error('Story AI check error:', e);
      // Fallback to keyword matching on API error
      if(btn) { btn.disabled = false; btn.textContent = 'Try Again'; }
      window.app.ui.toast('AI check unavailable — trying local check.', 'info');
      const concepts = ch.keyConcept.toLowerCase().split(/[,.]/).map(s=>s.trim()).filter(s=>s.length>3);
      const ansLower = answer.toLowerCase();
      const matches = concepts.filter(c => { const words = c.split(/\s+/).filter(w=>w.length>4); return words.some(w => ansLower.includes(w)); });
      if (matches.length >= 2) { st._markComplete(); if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(77,128,96,.08);border:1px solid rgba(77,128,96,.2)"><p class="text-xs font-bold" style="color:var(--sg)">✓ Good understanding!</p></div>`; } setTimeout(()=>st.renderChapter(),1200); }
      else { if(fb) { fb.classList.remove('hidden'); fb.innerHTML = `<div class="p-3 rounded-xl" style="background:rgba(212,98,47,.08);border:1px solid rgba(212,98,47,.2)"><p class="text-xs font-bold" style="color:var(--ac)">Not quite</p><p class="text-xs mt-1" style="color:var(--mu)">Re-read the chapter and try to address the question more specifically.</p></div>`; } if(btn){btn.disabled=false;btn.textContent='Try Again';} }
    }
  },

  _markComplete: () => {
    const st = window.app.story;
    if (!st._completed.includes(st._chapter)) {
      st._completed.push(st._chapter);
      localStorage.setItem(`story_${st._storyId}_${appState.user?.uid||'preview'}`, JSON.stringify(st._completed));
      // XP reward
      if (appState.userData?.gamification) {
        appState.userData.gamification.xp += 25;
        if (appState.user) { try { updateDoc(doc(db,"users",appState.user.uid),{"gamification.xp":appState.userData.gamification.xp}); } catch(e){} }
        window.app.ui.toast('+25 XP for mastering this chapter!', 'success');
        window.app.game.checkLevelUp();
      }
      // If all chapters complete and there's an assignment, mark it
      const story = STORY_LESSONS[st._storyId];
      if (story && st._completed.length >= story.chapters.length && st._assignmentId && appState.user) {
        try {
          addDoc(collection(db,'submissions'), {
            assignmentId: st._assignmentId, studentId: appState.user.uid,
            studentName: appState.userData?.name || 'Student',
            completedAt: serverTimestamp(), type: 'story',
            grading: { score: story.chapters.length, maxScore: story.chapters.length, label:'Complete' }
          });
        } catch(e) { console.error(e); }
      }
    }
  },

  nextChapter: () => {
    const st = window.app.story;
    const story = STORY_LESSONS[st._storyId];
    if (story && st._chapter < story.chapters.length - 1) {
      st._chapter++;
      st.renderChapter();
    }
  },

  prevChapter: () => {
    const st = window.app.story;
    if (st._chapter > 0) { st._chapter--; st.renderChapter(); }
  },

  editImage: () => {
    const st = window.app.story;
    const customKey = `story_img_${st._storyId}_${st._chapter}`;
    const current = localStorage.getItem(customKey) || STORY_LESSONS[st._storyId]?.chapters[st._chapter]?.img || '';
    const url = prompt('Paste a public image URL for this chapter:', current);
    if (url !== null) {
      if (url.trim()) localStorage.setItem(customKey, url.trim());
      else localStorage.removeItem(customKey);
      st.renderChapter();
    }
  }
},

// ═══ AI GRADING ═══
ai: {
  grade: async (type, prompt, essay, structure) => {
    appState._usedMockGrading = false;
    // Resolve API key: cached global → local override → teacher's key → Firestore config
    let key = appState._cachedGlobalKey || appState.apiKey;
    if (!key) {
      try {
        // Check shared config doc first
        const cfgDoc = await getDoc(doc(db, "config", "apiKey"));
        if (cfgDoc.exists() && cfgDoc.data().key) {
          key = cfgDoc.data().key;
          appState._cachedGlobalKey = key; // cache so we don't re-fetch every submission
        }
      } catch(e) { console.warn('Could not fetch global API key', e); }
    }
    if (!key && appState.activeAssignment?.teacherId) {
      try {
        const teacherDoc = await getDoc(doc(db, "users", appState.activeAssignment.teacherId));
        if (teacherDoc.exists() && teacherDoc.data().claudeKey) {
          key = teacherDoc.data().claudeKey;
        }
      } catch(e) { console.warn('Could not fetch teacher API key', e); }
    }
    if (!key) { appState._usedMockGrading = true; return window.app.ai.mockGrade(type, essay); }
    const rubrics = { saq: { maxScore: 3 }, leq: { maxScore: 6 }, dbq: { maxScore: 7 } };
    const r = rubrics[type];
    try {
      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514', max_tokens: 2000,
          messages: [{ role: 'user', content: 'You are an encouraging AP World History essay grader. Grade this ' + type.toUpperCase() + ' using the 2025 College Board rubric.\n\nPrompt:\n' + prompt + '\n\nEssay:\n' + essay + (structure?.sources ? '\n\nDocuments provided:\n' + structure.sources.map((s,i) => 'Doc ' + (i+1) + ' (' + s.type + '): ' + (s.label||s.title) + (s.type === 'image' || s.type === 'map' ? ' [Image: ' + s.content + ']' : ' - ' + s.content)).join('\n') : '') + '\n\nGrade using the official AP rubric. For EACH rubric category, find the EXACT quote from the essay that demonstrates that skill (or the best attempt). Be encouraging and specific.\n\nReturn ONLY valid JSON with no extra text:\n{"score":NUMBER,"maxScore":' + r.maxScore + ',"generalFeedback":"2-3 sentence encouraging overview highlighting strengths first, then areas to grow","annotations":[{"quote":"EXACT phrase or sentence copied from the essay (required, 5-80 chars)","category":"Thesis|Contextualization|Evidence|Sourcing|Reasoning|Complexity","status":"success if point earned|warning if close but not quite|error if missing or needs significant work","feedback":"specific encouraging feedback explaining why this earned or missed the point","improvementTip":"for warning/error only: one specific actionable step the student can take to earn this point next time, e.g. Add a date range and name a specific trade route. Empty string for success."}]}' }]
        })
      });
      const data = await resp.json();
      const text = data?.content?.[0]?.text || '';
      const match = text.match(/\{[\s\S]*\}/);
      if (match) return JSON.parse(match[0]);
      return window.app.ai.mockGrade(type, essay);
    } catch (e) { console.error('AI grading error:', e); return window.app.ai.mockGrade(type, essay); }
  },
  mockGrade: (type, essay) => {
    const scores = { saq: 2, leq: 4, dbq: 5 };
    const maxScores = { saq: 3, leq: 6, dbq: 7 };
    // Extract sentences from the essay for realistic quote highlights
    const sentences = essay ? essay.replace(/\n+/g, ' ').replace(/([.!?])\s+/g, '$1|||').split('|||').map(s => s.trim()).filter(s => s.length > 20 && s.length < 300) : [];
    const pick = (idx) => {
      if (!sentences.length) return '';
      const s = sentences[Math.min(idx, sentences.length - 1)];
      if (s.length <= 80) return s;
      const cut = s.lastIndexOf(' ', 78);
      return s.substring(0, cut > 30 ? cut : 78);
    };
    const mockAnnotations = {
      saq: [
        { quote: pick(0), category: "Identification", status: "success", feedback: "You correctly identified a relevant historical development — nice work recognizing the key factor here!", improvementTip: "" },
        { quote: pick(1), category: "Description", status: "success", feedback: "Your description is clear and shows strong understanding of the historical context.", improvementTip: "" },
        { quote: pick(2), category: "Explanation", status: "warning", feedback: "Your explanation is on the right track, but needs a stronger cause-and-effect connection.", improvementTip: "Add a sentence explaining WHY this development occurred — connect the cause directly to the effect using words like 'because' or 'as a result of'." }
      ],
      leq: [
        { quote: pick(0), category: "Thesis", status: "success", feedback: "Strong thesis! You made a clear, defensible claim that addresses the prompt with a logical line of reasoning.", improvementTip: "" },
        { quote: pick(1), category: "Contextualization", status: "warning", feedback: "You set up some historical context, but it needs to be more specific — mention broader global trends or developments beyond the prompt's focus.", improvementTip: "Add 2-3 sentences of broader context before your argument. Mention a specific global development happening at the same time, like expanding maritime trade or the decline of feudalism." },
        { quote: pick(2), category: "Evidence (1)", status: "success", feedback: "Great specific evidence! You included dates, names, and concrete details that strengthen your argument.", improvementTip: "" },
        { quote: pick(3), category: "Evidence (2)", status: "success", feedback: "Excellent use of a second body of evidence with specific historical details. This demonstrates strong content knowledge.", improvementTip: "" },
        { quote: pick(4), category: "Reasoning", status: "warning", feedback: "You present evidence well, but the analytical reasoning connecting it to your thesis could be more explicit.", improvementTip: "After each evidence paragraph, add a sentence that directly explains HOW this evidence proves your thesis. Use phrases like 'This demonstrates that...' or 'This directly supports the argument that...'." },
        { quote: pick(sentences.length - 1), category: "Complexity", status: "error", feedback: "Your conclusion restates the argument but doesn't demonstrate complex understanding. The complexity point requires nuance — counterarguments, qualifications, or cross-period connections.", improvementTip: "Replace your conclusion with analysis that complicates your argument. Try: 'Although the Columbian Exchange transformed economies, its effects were uneven — while European powers profited, indigenous and African populations bore devastating costs, suggesting that transformation and exploitation were inseparable.'" }
      ],
      dbq: [
        { quote: pick(0), category: "Thesis", status: "success", feedback: "Your thesis presents a clear, defensible argument that directly addresses the prompt. Well done!", improvementTip: "" },
        { quote: pick(1), category: "Contextualization", status: "success", feedback: "Great historical context! You connected the topic to broader trends effectively.", improvementTip: "" },
        { quote: pick(2), category: "Evidence (Docs)", status: "success", feedback: "Strong use of document evidence to support your argument.", improvementTip: "" },
        { quote: pick(3), category: "Evidence (Outside)", status: "success", feedback: "Good use of outside evidence beyond the documents. Nice work integrating additional knowledge!", improvementTip: "" },
        { quote: pick(4), category: "Sourcing", status: "warning", feedback: "You referenced a source's origin, but need to analyze HOW the author's POV, purpose, or audience shapes the document's meaning.", improvementTip: "Pick one document and explain how the author's point of view or purpose affects what they wrote. Example: 'As a Spanish official writing to the king, the author would emphasize economic success to justify continued colonial policies.'" },
        { quote: pick(5) || pick(3), category: "Reasoning", status: "warning", feedback: "Your argument groups documents together, but the reasoning connecting them to your thesis could be stronger.", improvementTip: "After discussing a group of documents, add a sentence that explicitly states how they collectively prove your thesis point." },
        { quote: pick(sentences.length - 1), category: "Complexity", status: "error", feedback: "To earn the complexity point, demonstrate nuanced understanding — address counterevidence, qualify your argument, or make connections across periods.", improvementTip: "Try adding: 'However, not all evidence supports this view...' and discuss a document that complicates your argument, then explain why your thesis still holds." }
      ]
    };
    return {
      score: scores[type] || 3, maxScore: maxScores[type] || 6,
      generalFeedback: "Nice work on this essay! You're showing solid understanding of the historical content and your writing is well-organized. Your evidence is a real strength — focus on strengthening your analytical reasoning and adding nuance for the complexity point. You're close to leveling up!",
      annotations: mockAnnotations[type] || mockAnnotations.leq
    };
  }
},

// ═══ UI UTILITIES ═══
ui: {
  resultsBack: () => {
    if (appState.demoMode && !appState.user) return window.app.router.go('home');
    if (appState.userData?.role === 'teacher' && appState._lastViewedAssignment) {
      return window.app.router.go('assignment-detail', { assignment: appState._lastViewedAssignment, classData: window.app.teacher._classDataCache });
    }
    window.app.router.go('student-dash');
  },
  setGlobalKey: async () => {
    const key = document.getElementById('api-key-input')?.value.trim();
    if (!key) return window.app.ui.toast('Enter an API key first.', 'error');
    if (!key.startsWith('sk-ant-')) return window.app.ui.toast('That doesn\'t look like an Anthropic API key.', 'error');
    try {
      await setDoc(doc(db, "config", "apiKey"), { key, setBy: appState.user?.uid || 'unknown', updatedAt: serverTimestamp() });
      appState._cachedGlobalKey = key;
      window.app.ui.toast('Universal API key saved! All users will now get real AI grading.', 'success');
      const status = document.getElementById('api-key-status');
      if (status) status.innerHTML = '<span style="color:var(--sg)">✓ Universal key is active — all users get AI grading.</span>';
    } catch(e) { console.error(e); window.app.ui.toast('Error saving key: ' + e.message, 'error'); }
  },
  updateNav: () => {
    const navOut = document.getElementById('nav-out');
    const navIn = document.getElementById('nav-in');
    const nameEl = document.getElementById('nav-name');
    if (appState.user) {
      navOut.classList.add('hidden'); navIn.classList.remove('hidden');
      if (nameEl) nameEl.textContent = appState.userData?.name || 'User';
    } else {
      navOut.classList.remove('hidden'); navIn.classList.add('hidden');
    }
  },
  toast: (msg, type = 'info') => {
    const container = document.getElementById('toast-container');
    const colors = { success: 'background:#4d8060', error: 'background:#b34d1e', info: 'background:var(--ac)' };
    const icons = { success: '✓', error: '✕', info: 'ℹ' };
    const el = document.createElement('div');
    el.className = 'toastAnim text-white px-5 py-3 rounded-xl shadow-lg pointer-events-auto text-sm font-medium flex items-center gap-2';
    el.style.cssText = (colors[type] || colors.info) + ';backdrop-filter:blur(8px)';
    const safe = msg.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    el.innerHTML = `<span style="font-size:16px">${icons[type]||icons.info}</span> ${safe}`;
    container.appendChild(el);
    setTimeout(() => { el.style.animation = 'toastOut .3s var(--ease-out-expo) forwards'; setTimeout(() => el.remove(), 300); }, 3200);
  },
  modal: (id, action) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (action === 'open') { el.classList.remove('hidden'); } else { el.classList.add('hidden'); }
    lucide.createIcons();
  },
  closeModal: (id) => { document.getElementById(id)?.classList.add('hidden'); },
  toggleSettings: () => {
    const modal = document.getElementById('settings-modal');
    if (modal.classList.contains('hidden')) {
      modal.classList.remove('hidden');
      document.getElementById('profile-name-input').value = appState.userData?.name || '';
      document.getElementById('api-key-input').value = appState.apiKey || '';
      // Student ID field — show for students, hide for teachers
      const sidWrap = document.getElementById('settings-student-id-wrap');
      const sidInput = document.getElementById('student-id-input');
      if (sidWrap) sidWrap.style.display = appState.userData?.role === 'teacher' ? 'none' : '';
      if (sidInput) sidInput.value = appState.userData?.studentId || '';
      // API key field — show for teachers only
      const akWrap = document.getElementById('settings-api-key-wrap');
      if (akWrap) akWrap.style.display = appState.userData?.role === 'student' ? 'none' : '';
      // Check global key status
      const status = document.getElementById('api-key-status');
      if (status && appState.userData?.role === 'teacher') {
        getDoc(doc(db, "config", "apiKey")).then(snap => {
          if (snap.exists() && snap.data().key) {
            status.innerHTML = '<span style="color:var(--sg)">✓ Universal key is active — all users get AI grading.</span>';
            if (!document.getElementById('api-key-input').value) document.getElementById('api-key-input').value = snap.data().key;
          } else {
            status.innerHTML = '<span style="color:var(--fa)">No universal key set. Paste your Anthropic key above and click the button below.</span>';
          }
        }).catch(() => {});
      }
      const theme = document.body.getAttribute('data-theme');
      document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
    } else { modal.classList.add('hidden'); }
    lucide.createIcons();
  },
  saveSettings: async () => {
    const name = document.getElementById('profile-name-input').value.trim();
    const key = document.getElementById('api-key-input').value.trim();
    const studentId = document.getElementById('student-id-input')?.value.trim() || '';
    const theme = document.querySelector('input[name="theme"]:checked')?.value || 'light';
    if (name && appState.user) {
      const updates = { name };
      if (appState.userData?.role === 'student') updates.studentId = studentId;
      await updateDoc(doc(db, "users", appState.user.uid), updates);
      appState.userData.name = name;
      if (appState.userData?.role === 'student') appState.userData.studentId = studentId;
      document.getElementById('nav-name').textContent = name;
    }
    if (key) {
      appState.apiKey = key; localStorage.setItem('anthropic_key', key);
      // Store encrypted key on teacher's user doc so students can use it
      if (appState.user && appState.userData?.role === 'teacher') {
        try { await updateDoc(doc(db, "users", appState.user.uid), { claudeKey: key }); } catch(e) { console.warn('Could not save key to profile', e); }
      }
    } else { localStorage.removeItem('anthropic_key'); appState.apiKey = ''; }
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('hw_theme', theme);
    window.app.ui.toggleSettings();
    window.app.ui.toast('Settings saved.', 'success');
  },
  btnLoading: (id, loading) => {
    const btn = document.getElementById(id); if (!btn) return;
    if (loading) { btn.disabled = true; btn.dataset.origText = btn.textContent; btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 16 16" style="animation:spin .8s linear infinite"><circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="28" stroke-dashoffset="8" stroke-linecap="round"/></svg>Loading…</span>'; }
    else { btn.disabled = false; btn.textContent = btn.dataset.origText || btn.textContent; }
  }
},

// ═══ ESSAY BLOCKS MODULE ═══
blocks: {
  _state: {},
  _unsub: null,
  _unsub2: null,

  // ─── MENU (shown in the Essay Blocks tab) ───
  renderMenu: () => {
    const practiceCards = ESSAY_BLOCKS_PROMPTS.map((p, i) => {
      const color = p.type === 'saq' ? 'var(--sg)' : p.type === 'leq' ? 'var(--ry)' : 'var(--ac)';
      const diff = p.difficulty === 'Easy' ? '🟢' : p.difficulty === 'Medium' ? '🟡' : '🔴';
      return `<div class="hcard p-5 flex flex-col justify-between">
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:${p.type === 'saq' ? 'rgba(77,128,96,.1)' : p.type === 'leq' ? 'rgba(92,109,179,.1)' : 'var(--acs)'};color:${color}">${p.type.toUpperCase()}</span>
            <span class="text-[10px]">${diff} ${p.difficulty}</span>
          </div>
          <h3 class="font-bold text-sm">${p.title}</h3>
          <p class="text-xs mt-1 line-clamp-2" style="color:var(--mu)">${p.prompt.substring(0, 120)}${p.prompt.length > 120 ? '…' : ''}</p>
        </div>
        <button onclick="window.app.blocks.startSoloByIndex(${i})" class="btnP text-xs w-full flex items-center justify-center gap-2"><i data-lucide="puzzle" class="w-3.5 h-3.5"></i>Start Blocks</button>
      </div>`;
    }).join('');

    return `<div class="px-1">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background:var(--acs)">🧩</div>
        <div><h3 class="font-bold text-sm">Essay Blocks</h3><p class="text-xs" style="color:var(--mu)">Build essays piece by piece — one fun block at a time!</p></div>
      </div>
      <div class="hcard p-4 mb-4 flex flex-col sm:flex-row items-center gap-3">
        <div class="flex-1"><h4 class="text-sm font-bold">Join a Live Session</h4><p class="text-xs" style="color:var(--mu)">Got a session code from your teacher?</p></div>
        <div class="flex gap-2">
          <input id="eb-join-code" placeholder="CODE" class="hinp fm uppercase text-center" style="width:120px">
          <button onclick="window.app.blocks.joinSessionByCode(document.getElementById('eb-join-code')?.value)" class="btnP text-xs py-2 px-4">Join</button>
        </div>
      </div>
      <div id="eb-active-sessions"></div>
      <h4 class="text-xs font-bold uppercase tracking-wider mb-3" style="color:var(--fa)">Solo Practice</h4>
      <div class="grid sm:grid-cols-2 gap-3 stagger">${practiceCards}</div>
    </div>`;
  },

  startSoloByIndex: (idx) => {
    window.app.router.go('blocks-solo', { prompt: ESSAY_BLOCKS_PROMPTS[idx] });
  },

  // ─── SOLO MODE ───
  initSolo: (prompt) => {
    const blocks = generateBlocks(prompt.type, prompt.prompt, prompt);
    window.app.blocks._state = {
      prompt,
      blocks,
      responses: blocks.map(() => ''),
      currentIdx: 0,
      hints: blocks.map(() => null),
      done: false
    };
    window.app.blocks._renderSoloBlock();
    lucide.createIcons();
  },

  _renderSoloBlock: () => {
    const st = window.app.blocks._state;
    const { blocks, currentIdx, responses, done } = st;

    // Progress pips
    const progEl = document.getElementById('eb-progress');
    if (progEl) {
      progEl.innerHTML = blocks.map((b, i) =>
        `<div class="eb-pip ${i < currentIdx ? 'done' : ''} ${i === currentIdx && !done ? 'active' : ''}"></div>`
      ).join('');
    }

    if (done) {
      window.app.blocks._renderConsolidated();
      return;
    }

    const b = blocks[currentIdx];
    const saved = responses[currentIdx] || '';
    const hint = st.hints[currentIdx];
    const blockEl = document.getElementById('eb-current-block');
    if (!blockEl) return;

    // Show thesis for DBQ
    const thesis = st.prompt?.thesis;
    const sources = st.prompt?.structure?.sources || [];
    const docForBlock = (b.docIndex >= 0 && sources[b.docIndex]) ? sources[b.docIndex] : null;

    blockEl.innerHTML = `<div class="eb-block">
      ${thesis ? '<div class="eb-thesis-bar mb-4"><span class="text-[10px] font-bold uppercase tracking-wider block mb-1" style="color:var(--ac)">Working Thesis</span><span class="text-sm">' + thesis + '</span></div>' : ''}
      <div class="eb-card">
        <span class="eb-emoji">${b.emoji}</span>
        <div class="flex items-center gap-2 mb-2">
          <span class="eb-block-label">${b.label}</span>
          <span class="text-xs" style="color:var(--fa)">Block ${currentIdx + 1} of ${blocks.length}</span>
        </div>
        ${docForBlock ? '<div class="eb-doc-inline mb-3"><span class="eb-doc-attr">' + docForBlock.attribution + '</span><p style="color:var(--tx);font-size:14px;line-height:1.7">"' + docForBlock.content + '"</p></div>' : ''}
        <h2 class="text-lg font-bold fs mb-2">${b.question}</h2>
        <textarea id="eb-input" class="eb-textarea" placeholder="Type your response here..." oninput="window.app.blocks._onInput(this)">${saved}</textarea>
        <div class="flex items-center justify-between mt-2">
          <span class="text-xs fm" style="color:var(--fa)" id="eb-wc">${saved.split(/\s+/).filter(w=>w).length} words</span>
          <button onclick="window.app.blocks.getHint()" class="eb-hint-btn"><i data-lucide="lightbulb" class="w-3.5 h-3.5"></i>Get a hint</button>
        </div>
        ${hint ? `<div class="eb-hint fadeIn"><span class="text-xs font-bold" style="color:var(--gd)">💡 Hint:</span> ${hint}</div>` : ''}
        <div class="eb-nav">
          ${currentIdx > 0 ? `<button onclick="window.app.blocks.prevBlock()" class="btnG flex-1 flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>` : '<div class="flex-1"></div>'}
          <button onclick="window.app.blocks.nextBlock()" class="btnP flex-1 flex items-center justify-center gap-2" id="eb-next-btn">
            ${currentIdx === blocks.length - 1 ? '<i data-lucide="check-circle" class="w-4 h-4"></i>Finish & Build Essay' : 'Next Block<i data-lucide="arrow-right" class="w-4 h-4"></i>'}
          </button>
        </div>
      </div>
    </div>`;
    lucide.createIcons();
    document.getElementById('eb-input')?.focus();
  },

  _onInput: (el) => {
    const st = window.app.blocks._state;
    st.responses[st.currentIdx] = el.value;
    const wc = el.value.split(/\s+/).filter(w => w).length;
    const wcEl = document.getElementById('eb-wc');
    if (wcEl) wcEl.textContent = wc + ' words';
  },

  nextBlock: () => {
    const st = window.app.blocks._state;
    const resp = st.responses[st.currentIdx].trim();
    const block = st.blocks[st.currentIdx];
    const wc = resp.split(/\s+/).filter(w => w).length;
    if (wc < (block.minWords || 10)) {
      return window.app.ui.toast(`Write at least ${block.minWords || 10} words before moving on!`, 'error');
    }
    if (st.currentIdx < st.blocks.length - 1) {
      st.currentIdx++;
      window.app.blocks._renderSoloBlock();
    } else {
      st.done = true;
      window.app.blocks._renderSoloBlock();
    }
  },

  prevBlock: () => {
    const st = window.app.blocks._state;
    if (st.currentIdx > 0) {
      st.currentIdx--;
      window.app.blocks._renderSoloBlock();
    }
  },

  getHint: async () => {
    const st = window.app.blocks._state;
    const block = st.blocks[st.currentIdx];
    const current = st.responses[st.currentIdx] || '';

    // Try AI hint, fallback to static hint
    let key = appState._cachedGlobalKey || appState.apiKey;
    if (!key) {
      try {
        const cfgDoc = await getDoc(doc(db, "config", "apiKey"));
        if (cfgDoc.exists() && cfgDoc.data().key) { key = cfgDoc.data().key; appState._cachedGlobalKey = key; }
      } catch(e) {}
    }

    if (key && current.length > 10) {
      try {
        window.app.ui.toast('Getting AI hint...', 'info');
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514', max_tokens: 200,
            messages: [{ role: 'user', content: `You are an encouraging AP World History tutor helping a student write an essay. The student is working on: "${block.question}"\n\nTheir current response: "${current}"\n\nGive ONE short, specific, encouraging hint (1-2 sentences) to help them improve or expand their response. Be specific — mention historical content they could add. Do NOT write the answer for them.` }]
          })
        });
        const data = await resp.json();
        const hint = data?.content?.[0]?.text || block.hint;
        st.hints[st.currentIdx] = hint;
        window.app.blocks._renderSoloBlock();
        return;
      } catch(e) { console.warn('AI hint failed:', e); }
    }

    st.hints[st.currentIdx] = block.hint;
    window.app.blocks._renderSoloBlock();
  },

  _esc: (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'),

  _renderConsolidated: () => {
    const st = window.app.blocks._state;
    const { blocks, responses, prompt } = st;
    const esc = window.app.blocks._esc;

    document.getElementById('eb-current-block')?.classList.add('hidden');
    const el = document.getElementById('eb-consolidated');
    if (!el) return;
    el.classList.remove('hidden');

    const fullEssay = responses.join('\n\n');
    const wordCount = fullEssay.split(/\s+/).filter(w => w).length;

    const blockBreakdown = blocks.map((b, i) =>
      `<div class="mb-3"><div class="eb-block-label">${b.emoji} ${b.label}</div><p class="text-sm fs leading-relaxed" style="color:var(--tx)">${esc(responses[i])}</p></div>`
    ).join('<hr style="border-color:var(--bd);margin:12px 0">');

    el.innerHTML = `<div class="eb-consolidated">
      <div class="text-center mb-6 relative">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" style="margin:0 auto;margin-bottom:8px"><circle cx="40" cy="40" r="36" stroke="var(--gd)" stroke-width="2" opacity=".15" stroke-dasharray="6 4"/><circle cx="40" cy="40" r="24" stroke="var(--sg)" stroke-width="1.5" opacity=".2"/><text x="40" y="46" text-anchor="middle" font-size="28">🎉</text></svg>
        <h2 class="text-2xl font-bold fs">Essay Complete!</h2>
        <p class="text-sm mt-1" style="color:var(--mu)">You just wrote a ${wordCount}-word ${prompt.type.toUpperCase()} — block by block!</p>
      </div>

      <div class="hcard p-1 mb-4">
        <div class="flex">
          <button onclick="window.app.blocks._showTab('blocks')" id="ebt-blocks" class="tabBtn on flex-1">By Blocks</button>
          <button onclick="window.app.blocks._showTab('full')" id="ebt-full" class="tabBtn flex-1">Full Essay</button>
        </div>
      </div>

      <div id="eb-tab-blocks" class="eb-final">${blockBreakdown}</div>
      <div id="eb-tab-full" class="eb-final hidden" style="white-space:pre-wrap">${esc(fullEssay)}</div>

      <div class="flex gap-3 mt-6">
        <button onclick="window.app.blocks.gradeEssay()" class="btnP flex-1 flex items-center justify-center gap-2" id="eb-grade-btn"><i data-lucide="sparkles" class="w-4 h-4"></i>Grade with AI</button>
        <button onclick="window.app.router.go('student-dash')" class="btnG flex-1">Back to Dashboard</button>
      </div>
      <div id="eb-grade-result" class="mt-4"></div>
    </div>`;
    lucide.createIcons();
    try { confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 }, colors: ['#d4622f', '#c49528', '#4d8060'] }); } catch(e){}
  },

  _showTab: (tab) => {
    document.getElementById('eb-tab-blocks')?.classList.toggle('hidden', tab !== 'blocks');
    document.getElementById('eb-tab-full')?.classList.toggle('hidden', tab !== 'full');
    document.getElementById('ebt-blocks')?.classList.toggle('on', tab === 'blocks');
    document.getElementById('ebt-full')?.classList.toggle('on', tab === 'full');
  },

  gradeEssay: async () => {
    const st = window.app.blocks._state;
    const fullEssay = st.responses.join('\n\n');
    window.app.ui.btnLoading('eb-grade-btn', true);
    window.app.ui.toast('AI is grading your essay...', 'info');
    try {
      const grading = await window.app.ai.grade(st.prompt.type, st.prompt.prompt, fullEssay, st.prompt);
      const pct = Math.round((grading.score / grading.maxScore) * 100);
      const grade = pct >= 80 ? 'Excellent' : pct >= 60 ? 'Proficient' : pct >= 40 ? 'Developing' : 'Needs Work';
      const el = document.getElementById('eb-grade-result');
      if (el) {
        el.innerHTML = `<div class="hcard p-6 scaleIn">
          <div class="text-center mb-4">
            <div class="text-4xl font-bold fs score-reveal" style="color:var(--ac)">${grading.score}<span class="text-lg" style="color:var(--fa)">/${grading.maxScore}</span></div>
            <div class="text-xs font-semibold" style="color:var(--mu)">${grade}</div>
          </div>
          ${grading.generalFeedback ? `<p class="text-sm mb-3 leading-relaxed" style="color:var(--mu)">${grading.generalFeedback}</p>` : ''}
          <div class="space-y-2 stagger">
            ${(grading.annotations || []).map(ann => {
              const dot = ann.status === 'success' ? 'var(--sg)' : ann.status === 'warning' ? 'var(--gd)' : 'var(--ac)';
              return `<div class="ann-card ann-card-${ann.status}"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold uppercase" style="color:${dot}">${ann.category}</span></div><p class="text-xs" style="color:var(--mu)">${ann.feedback}</p>${ann.improvementTip ? `<div class="tip-box ${ann.status === 'error' ? 'tip-box-error' : ''}" style="margin-top:6px"><p class="text-xs" style="color:var(--mu)">💡 ${ann.improvementTip}</p></div>` : ''}</div>`;
            }).join('')}
          </div>
        </div>`;
        lucide.createIcons();
        // Save XP and update skill mastery
        if (appState.userData?.gamification) {
          const xp = Math.round(pct / 10) * 5;
          appState.userData.gamification.xp = (appState.userData.gamification.xp || 0) + xp;
          window.app.game.updateSkillsFromGrading(st.prompt.type, grading);
          if (appState.user) try { await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification }); } catch(e){}
          window.app.game.checkLevelUp();
          window.app.ui.toast(`+${xp} XP earned!`, 'success');
        }
      }
    } catch(e) { console.error(e); window.app.ui.toast('Grading failed: ' + e.message, 'error'); }
    window.app.ui.btnLoading('eb-grade-btn', false);
  },

  // ─── TEACHER: CREATE SESSION ───
  createSession: async (classId, assignmentOrPrompt) => {
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    const sessionData = {
      classId,
      code,
      title: assignmentOrPrompt.title,
      type: assignmentOrPrompt.type,
      prompt: assignmentOrPrompt.prompt,
      structure: assignmentOrPrompt.structure || {},
      teacherId: appState.user.uid,
      status: 'lobby',
      timerSeconds: 300,
      groups: {},
      createdAt: serverTimestamp()
    };
    try {
      const ref = await addDoc(collection(db, 'blockSessions'), sessionData);
      window.app.ui.toast('Session created!', 'success');
      window.app.router.go('blocks-lobby', { sessionId: ref.id });
    } catch(e) { window.app.ui.toast('Error: ' + e.message, 'error'); }
  },

  // ─── LOBBY ───
  initLobby: (sessionId) => {
    const st = window.app.blocks;
    if (st._unsub) { st._unsub(); st._unsub = null; }
    if (st._unsub2) { st._unsub2(); st._unsub2 = null; }

    // Fetch session doc once and listen for status changes
    const unsubSession = onSnapshot(doc(db, 'blockSessions', sessionId), (snap) => {
      if (!snap.exists()) return;
      const session = { id: snap.id, ...snap.data() };
      st._state.session = session;

      document.getElementById('lobby-title')&&(document.getElementById('lobby-title').textContent = session.title);
      document.getElementById('lobby-prompt')&&(document.getElementById('lobby-prompt').textContent = session.prompt);
      document.getElementById('lobby-code')&&(document.getElementById('lobby-code').textContent = session.code);

      // Check for status transitions
      if (session.status === 'active') {
        if (st._unsub) { st._unsub(); st._unsub = null; }
        if (st._unsub2) { st._unsub2(); st._unsub2 = null; }
        window.app.router.go('blocks-play', { sessionId });
        return;
      }
      if (session.status === 'reviewing' || session.status === 'done') {
        if (st._unsub) { st._unsub(); st._unsub = null; }
        if (st._unsub2) { st._unsub2(); st._unsub2 = null; }
        window.app.router.go('blocks-review', { sessionId });
        return;
      }
    });

    // Listen to players subcollection in real-time
    const unsubPlayers = onSnapshot(collection(db, 'blockSessions', sessionId, 'players'), (snap) => {
      const players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      st._state.players = players;

      const isTeacher = appState.userData?.role === 'teacher';
      const me = players.find(p => p.id === appState.user?.uid);

      const playersEl = document.getElementById('lobby-players');
      if (playersEl) {
        playersEl.innerHTML = players.length === 0
          ? `<p class="text-sm" style="color:var(--fa)">No players yet. Share the session code!</p>`
          : players.map(p => `<div class="eb-player ${p.ready ? 'ready' : ''}">
              <div class="dot"></div>
              <span class="text-sm font-semibold flex-1 text-left">${p.name}</span>
              <span class="text-xs fm" style="color:${p.ready ? 'var(--sg)' : 'var(--fa)'}">${p.ready ? 'Ready!' : 'Waiting...'}</span>
            </div>`).join('');
      }

      const actionsEl = document.getElementById('lobby-actions');
      if (actionsEl) {
        if (isTeacher) {
          const readyCount = players.filter(p => p.ready).length;
          const canStart = players.length >= 2;
          actionsEl.innerHTML = `<div class="flex flex-col gap-2">
            <p class="text-xs" style="color:var(--fa)">${readyCount}/${players.length} ready${!canStart ? ' — need at least 2 players' : ''}</p>
            <button onclick="window.app.blocks.startGame('${sessionId}')" class="btnP py-3 px-8 ${canStart ? 'pulse-cta' : ''}" ${canStart ? '' : 'disabled'}>Start Game</button>
          </div>`;
        } else {
          if (!me) {
            actionsEl.innerHTML = `<button onclick="window.app.blocks.joinSession('${sessionId}')" class="btnP py-3 px-8">Join Session</button>`;
          } else if (!me.ready) {
            actionsEl.innerHTML = `<button onclick="window.app.blocks.readyUp('${sessionId}')" class="btnP py-3 px-8 pulse-cta">I'm Ready!</button>`;
          } else {
            actionsEl.innerHTML = `<p class="text-sm font-semibold" style="color:var(--sg)">✓ You're ready! Waiting for the teacher to start...</p>`;
          }
        }
      }
      lucide.createIcons();
    });

    // Store both unsubscribe functions
    st._unsub = unsubSession;
    st._unsub2 = unsubPlayers;
  },

  joinSession: async (sessionId) => {
    if (!appState.user) return window.app.ui.toast('Please log in first.', 'error');
    try {
      await setDoc(doc(db, 'blockSessions', sessionId, 'players', appState.user.uid), {
        name: appState.userData?.name || 'Student',
        ready: false,
        groupIndex: -1,
        blockIndex: -1,
        response: ''
      });
    } catch(e) { window.app.ui.toast('Error joining: ' + e.message, 'error'); }
  },

  joinSessionByCode: async (code) => {
    if (!code) return window.app.ui.toast('Enter a session code.', 'error');
    if (!appState.user) return window.app.ui.toast('Please log in first.', 'error');
    window.app.ui.toast('Looking for session...', 'info');
    try {
      const snap = await getDocs(query(collection(db, 'blockSessions'), where('code', '==', code.toUpperCase())));
      if (snap.empty) return window.app.ui.toast('No session found with that code.', 'error');
      // Find one that's still joinable (lobby or active)
      const session = snap.docs.find(d => ['lobby','active'].includes(d.data().status));
      if (!session) return window.app.ui.toast('That session has already ended.', 'error');
      const sessionId = session.id;
      await window.app.blocks.joinSession(sessionId);
      window.app.router.go('blocks-lobby', { sessionId });
    } catch(e) { console.error(e); window.app.ui.toast('Error: ' + e.message, 'error'); }
  },

  readyUp: async (sessionId) => {
    try {
      await updateDoc(doc(db, 'blockSessions', sessionId, 'players', appState.user.uid), { ready: true });
    } catch(e) { window.app.ui.toast('Error: ' + e.message, 'error'); }
  },

  startGame: async (sessionId) => {
    const session = window.app.blocks._state.session;
    const players = window.app.blocks._state.players || [];
    if (players.length < 2) return window.app.ui.toast('Need at least 2 players!', 'error');

    // Generate blocks for this essay type
    const blocks = generateBlocks(session.type, session.prompt, session.structure);
    const groupSize = Math.min(blocks.length, players.length);

    // Shuffle players
    const shuffled = [...players].sort(() => Math.random() - 0.5);

    // Create groups
    const groups = [];
    for (let i = 0; i < shuffled.length; i += groupSize) {
      const group = shuffled.slice(i, i + groupSize);
      if (group.length < 2 && groups.length > 0) {
        // Merge tiny leftover group into previous
        groups[groups.length - 1].push(...group);
      } else {
        groups.push(group);
      }
    }

    // Assign blocks to each player
    const batch = [];
    groups.forEach((group, gi) => {
      group.forEach((player, bi) => {
        const blockIdx = bi % blocks.length;
        batch.push(updateDoc(doc(db, 'blockSessions', sessionId, 'players', player.id), {
          groupIndex: gi,
          blockIndex: blockIdx,
          response: ''
        }));
      });
    });

    try {
      await Promise.all(batch);
      await updateDoc(doc(db, 'blockSessions', sessionId), {
        status: 'active',
        groups: Object.fromEntries(groups.map((g, i) => [String(i), g.map(p => p.id)])),
        blocks: blocks.map(b => ({ id: b.id, label: b.label, emoji: b.emoji, question: b.question, hint: b.hint || '', docIndex: b.docIndex ?? -1 })),
        startedAt: serverTimestamp(),
        thesis: session.thesis || ''
      });
    } catch(e) { window.app.ui.toast('Error starting: ' + e.message, 'error'); }
  },

  // ─── MULTIPLAYER PLAY ───
  initMultiPlay: (sessionId) => {
    const st = window.app.blocks;
    if (st._unsub) { st._unsub(); st._unsub = null; }
    if (st._unsub2) { st._unsub2(); st._unsub2 = null; }
    st._state.timerInterval = null;
    const isTeacher = appState.userData?.role === 'teacher';

    // Helper: start timer on a given element ID
    const setupTimer = (elId, session, onEnd) => {
      if (st._state.timerInterval || !session.startedAt) return;
      const startTime = session.startedAt.toDate ? session.startedAt.toDate().getTime() : Date.now();
      const duration = (session.timerSeconds || 300) * 1000;
      st._state.timerInterval = setInterval(() => {
        const remaining = Math.max(0, duration - (Date.now() - startTime));
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        const timerEl = document.getElementById(elId);
        if (timerEl) {
          timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          timerEl.classList.toggle('urgent', remaining < 60000);
        }
        if (remaining <= 0) { clearInterval(st._state.timerInterval); if (onEnd) onEnd(); }
      }, 1000);
    };

    st._unsub = onSnapshot(doc(db, 'blockSessions', sessionId), async (snap) => {
      if (!snap.exists()) return;
      const session = { id: snap.id, ...snap.data() };
      st._state.session = session;

      if (session.status === 'reviewing' || session.status === 'done') {
        if (st._state.timerInterval) clearInterval(st._state.timerInterval);
        if (st._unsub) { st._unsub(); st._unsub = null; }
        window.app.router.go('blocks-review', { sessionId });
        return;
      }

      // ─── TEACHER BOARD VIEW ───
      if (isTeacher) {
        const tv = document.getElementById('mp-teacher-view');
        if (tv) tv.classList.remove('hidden');
        const sv = document.getElementById('mp-student-view');
        if (sv) sv.classList.add('hidden');

        const titleEl = document.getElementById('mp-t-title');
        if (titleEl) titleEl.textContent = session.title || 'Essay Blocks';
        const promptEl = document.getElementById('mp-t-prompt');
        if (promptEl) promptEl.innerHTML = `<span class="font-bold" style="color:var(--ac)">Prompt:</span> ${session.prompt || ''}`;
        const thesisEl = document.getElementById('mp-t-thesis');
        if (thesisEl && session.thesis) { thesisEl.classList.remove('hidden'); thesisEl.innerHTML = `<span class="text-[10px] font-bold uppercase tracking-wider block mb-1" style="color:var(--ac)">Working Thesis</span>${session.thesis}`; }

        setupTimer('mp-t-timer', session, null);

        // Show progress per group
        const groups = session.groups || {};
        const progEl = document.getElementById('mp-t-progress');
        if (progEl && Object.keys(groups).length) {
          const playersSnap = await getDocs(collection(db, 'blockSessions', sessionId, 'players'));
          const players = {};
          playersSnap.forEach(d => { players[d.id] = d.data(); });
          const groupKeys = Object.keys(groups).sort((a,b) => Number(a) - Number(b));
          progEl.innerHTML = groupKeys.map(k => {
            const ids = groups[k] || [];
            const submitted = ids.filter(id => players[id]?.response?.trim()).length;
            const total = ids.length;
            const pct = total ? (submitted / total) : 0;
            const circumference = 2 * Math.PI * 25;
            const offset = circumference * (1 - pct);
            return `<div class="eb-progress-card ${submitted === total ? 'done' : ''}">
              <div class="eb-progress-ring">
                <svg width="72" height="72" viewBox="0 0 60 60"><circle class="ring-bg" cx="30" cy="30" r="25"/><circle class="ring-fill" cx="30" cy="30" r="25" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" style="${submitted === total ? 'stroke:var(--sg)' : ''}"/></svg>
                <div class="ring-text" style="${submitted === total ? 'color:var(--sg)' : ''}">${submitted}/${total}</div>
              </div>
              <p class="text-sm font-bold fs">Group ${Number(k) + 1}</p>
              <p class="text-[10px] mt-1" style="color:${submitted === total ? 'var(--sg)' : 'var(--fa)'}">${submitted === total ? 'All done!' : submitted + ' submitted'}</p>
            </div>`;
          }).join('');
        }
        lucide.createIcons();
        return;
      }

      // ─── STUDENT VIEW ───
      const sv = document.getElementById('mp-student-view');
      if (sv) sv.classList.remove('hidden');

      const myDoc = await getDoc(doc(db, 'blockSessions', sessionId, 'players', appState.user.uid));
      if (!myDoc.exists()) return;
      const me = myDoc.data();
      st._state.me = me;

      const block = session.blocks?.[me.blockIndex] || session.blocks?.[0];
      if (!block) return;

      setupTimer('mp-timer', session, () => window.app.blocks.submitMultiBlock(sessionId));

      // Show prompt
      const promptEl = document.getElementById('mp-prompt-text');
      if (promptEl) promptEl.textContent = session.prompt || '';

      // Show thesis for DBQ sessions
      if (session.thesis && !st._state.thesisRendered) {
        st._state.thesisRendered = true;
        const thesisBar = document.getElementById('mp-thesis-bar');
        const thesisText = document.getElementById('mp-thesis-text');
        if (thesisBar && thesisText) { thesisBar.classList.remove('hidden'); thesisText.textContent = session.thesis; }
      }

      // Render block info (progress pips)
      const infoEl = document.getElementById('mp-block-info');
      if (infoEl) {
        const allBlocks = session.blocks || [];
        const pips = allBlocks.map((b, i) => `<span class="inline-flex items-center gap-1 text-[10px] px-2 py-1 rounded-lg fm" style="background:${i === me.blockIndex ? 'var(--acs)' : 'var(--elev)'};${i === me.blockIndex ? 'color:var(--ac);font-weight:700;border:1px solid var(--ac)' : 'color:var(--fa);border:1px solid var(--bd)'}">${b.emoji} ${b.label}${i === me.blockIndex ? ' ← You' : ''}</span>`).join('');
        infoEl.innerHTML = `<div class="text-center">
          <div class="flex flex-wrap justify-center gap-1.5 mb-3">${pips}</div>
          <span class="eb-block-label">${block.emoji} ${block.label}</span>
          <p class="text-xs mt-1" style="color:var(--fa)">Group ${me.groupIndex + 1} — Your piece of the puzzle</p>
        </div>`;
      }

      // Show inline document for doc-analysis blocks
      const docPanel = document.getElementById('mp-block-doc');
      if (docPanel && !st._state.docsRendered) {
        st._state.docsRendered = true;
        const sources = session.structure?.sources;
        if (sources?.length && block.docIndex >= 0 && sources[block.docIndex]) {
          const d = sources[block.docIndex];
          docPanel.classList.remove('hidden');
          docPanel.innerHTML = `<div class="eb-doc-inline">
            <span class="eb-doc-attr">${d.attribution}</span>
            <p style="color:var(--tx);font-size:14px;line-height:1.7">"${d.content}"</p>
          </div>`;
        }
      }

      // Render writing area
      const areaEl = document.getElementById('mp-block-area');
      if (areaEl && !st._state.rendered) {
        st._state.rendered = true;
        const esc = window.app.blocks._esc;
        areaEl.innerHTML = `<div class="eb-card eb-block">
          <h2 class="text-base font-bold fs mb-2">${block.question}</h2>
          <p class="text-xs mb-1" style="color:var(--fa)">Your teammates are working on other blocks right now — you can't see what they're writing!</p>
          ${block.hint ? '<p class="text-xs mb-3" style="color:var(--mu)"><strong>Tip:</strong> ' + block.hint + '</p>' : ''}
          <textarea id="mp-input" class="eb-textarea" placeholder="Write your block here..." style="min-height:160px">${esc(me.response || '')}</textarea>
          <div class="flex items-center justify-between mt-3">
            <span class="text-xs fm" style="color:var(--fa)" id="mp-wc">0 words</span>
            <button onclick="window.app.blocks.submitMultiBlock('${sessionId}')" class="btnP text-sm py-2 px-6" id="mp-submit">Submit Block</button>
          </div>
        </div>`;
        const inp = document.getElementById('mp-input');
        if (inp) {
          inp.oninput = () => {
            const wc = inp.value.split(/\s+/).filter(w => w).length;
            document.getElementById('mp-wc')&&(document.getElementById('mp-wc').textContent = wc + ' words');
          };
          inp.focus();
        }
      }
      lucide.createIcons();
    });

    // Teacher: also listen to players subcollection for live progress updates
    if (isTeacher) {
      st._unsub2 = onSnapshot(collection(db, 'blockSessions', sessionId, 'players'), async (playersSnap) => {
        const session = st._state.session;
        if (!session) return;
        const groups = session.groups || {};
        const progEl = document.getElementById('mp-t-progress');
        if (!progEl || !Object.keys(groups).length) return;
        const players = {};
        playersSnap.forEach(d => { players[d.id] = d.data(); });
        const groupKeys = Object.keys(groups).sort((a,b) => Number(a) - Number(b));
        progEl.innerHTML = groupKeys.map(k => {
          const ids = groups[k] || [];
          const submitted = ids.filter(id => players[id]?.response?.trim()).length;
          const total = ids.length;
          const pct = total ? (submitted / total) : 0;
          const circumference = 2 * Math.PI * 25;
          const offset = circumference * (1 - pct);
          return `<div class="eb-progress-card ${submitted === total ? 'done' : ''}">
            <div class="eb-progress-ring">
              <svg width="72" height="72" viewBox="0 0 60 60"><circle class="ring-bg" cx="30" cy="30" r="25"/><circle class="ring-fill" cx="30" cy="30" r="25" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" style="${submitted === total ? 'stroke:var(--sg)' : ''}"/></svg>
              <div class="ring-text" style="${submitted === total ? 'color:var(--sg)' : ''}">${submitted}/${total}</div>
            </div>
            <p class="text-sm font-bold fs">Group ${Number(k) + 1}</p>
            <p class="text-[10px] mt-1" style="color:${submitted === total ? 'var(--sg)' : 'var(--fa)'}">${submitted === total ? 'All done!' : submitted + ' submitted'}</p>
          </div>`;
        }).join('');
      });
    }
  },

  submitMultiBlock: async (sessionId) => {
    const input = document.getElementById('mp-input');
    const text = input?.value?.trim() || '';
    if (text.length < 10) return window.app.ui.toast('Write a bit more before submitting!', 'error');
    if (!appState.user) return window.app.ui.toast('Not logged in.', 'error');
    window.app.ui.btnLoading('mp-submit', true);
    try {
      await updateDoc(doc(db, 'blockSessions', sessionId, 'players', appState.user.uid), { response: text });
      window.app.ui.toast('Block submitted! Waiting for teammates...', 'success');
      if (input) input.disabled = true;

      // Check if all players in my group are done
      const session = window.app.blocks._state.session;
      const me = window.app.blocks._state.me;
      if (!session || !me) return;
      const myGroup = me.groupIndex;
      const groupPlayerIds = session.groups?.[String(myGroup)] || [];
      const allDone = await Promise.all(groupPlayerIds.map(async pid => {
        const pDoc = await getDoc(doc(db, 'blockSessions', sessionId, 'players', pid));
        return pDoc.exists() && pDoc.data().response?.trim();
      }));

      // If teacher, check ALL groups
      if (appState.userData?.role === 'teacher' || allDone.every(Boolean)) {
        // Check all groups
        const allPlayersSnap = await getDocs(collection(db, 'blockSessions', sessionId, 'players'));
        const allSubmitted = allPlayersSnap.docs.every(d => d.data().response?.trim());
        if (allSubmitted) {
          await updateDoc(doc(db, 'blockSessions', sessionId), { status: 'reviewing' });
        }
      }
    } catch(e) { window.app.ui.toast('Error: ' + e.message, 'error'); }
    window.app.ui.btnLoading('mp-submit', false);
  },

  // ─── REVIEW PHASE ───
  initReview: async (sessionId) => {
    const st = window.app.blocks;
    if (st._unsub) { st._unsub(); st._unsub = null; }

    try {
      const sessionSnap = await getDoc(doc(db, 'blockSessions', sessionId));
      if (!sessionSnap.exists()) return;
      const session = { id: sessionSnap.id, ...sessionSnap.data() };
      st._state.session = session;

      const playersSnap = await getDocs(collection(db, 'blockSessions', sessionId, 'players'));
      const players = {};
      playersSnap.forEach(d => { players[d.id] = d.data(); });

      const groupsObj = session.groups || {};
      const groups = Object.keys(groupsObj).sort((a,b) => Number(a) - Number(b)).map(k => groupsObj[k]);
      const blocks = session.blocks || [];

      const essaysEl = document.getElementById('review-essays');
      if (!essaysEl) return;

      const esc = (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const groupEssays = groups.map((groupPlayerIds, gi) => {
        // Consolidate blocks — sort by block index
        const memberData = groupPlayerIds.map(pid => players[pid]).filter(Boolean);
        memberData.sort((a, b) => a.blockIndex - b.blockIndex);

        const parts = memberData.map(m => {
          const block = blocks[m.blockIndex] || { label: 'Block', emoji: '📝' };
          return { label: block.label, emoji: block.emoji, text: esc(m.response) || '(no response)', author: esc(m.name) };
        });

        const fullText = parts.map(p => p.text).join('\n\n');
        return { groupIndex: gi, parts, fullText, members: memberData.map(m => m.name) };
      });

      essaysEl.innerHTML = groupEssays.map((g, i) => `<div class="eb-group-card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold fs text-lg">Group ${i + 1}</h3>
          <span class="text-xs" style="color:var(--fa)">${g.members.join(', ')}</span>
        </div>
        ${g.parts.map(p => `<div class="mb-2">
          <span class="eb-block-label">${p.emoji} ${p.label}</span>
          <span class="text-[10px]" style="color:var(--fa)"> — ${p.author}</span>
          <p class="text-sm fs leading-relaxed mt-1">${p.text}</p>
        </div>`).join('<hr style="border-color:var(--bd);margin:8px 0">')}
        <div class="flex items-center gap-2 mt-4 pt-3" style="border-top:1px solid var(--bd)">
          <button onclick="window.app.blocks.voteForGroup('${sessionId}',${i})" class="eb-vote-btn flex-1" id="vote-${i}">⭐ Vote for this essay</button>
          <button onclick="window.app.blocks.gradeGroupEssay('${sessionId}',${i})" class="btnG text-xs py-2 px-4" id="ai-grade-${i}"><i data-lucide="sparkles" class="w-3 h-3 inline mr-1"></i>AI Grade</button>
        </div>
        <div id="group-grade-${i}" class="mt-3"></div>
      </div>`).join('');

      // Listen for vote changes
      st._unsub = onSnapshot(doc(db, 'blockSessions', sessionId), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.status === 'done') {
          st._showResults(data, groupEssays);
        }
      });

      lucide.createIcons();
    } catch(e) { console.error(e); window.app.ui.toast('Error loading review: ' + e.message, 'error'); }
  },

  voteForGroup: async (sessionId, groupIndex) => {
    if (!appState.user) return;
    try {
      await updateDoc(doc(db, 'blockSessions', sessionId), {
        [`votes.${appState.user.uid}`]: groupIndex
      });
      // Visual update
      document.querySelectorAll('[id^="vote-"]').forEach(el => el.classList.remove('voted'));
      document.getElementById(`vote-${groupIndex}`)?.classList.add('voted');
      window.app.ui.toast('Vote cast!', 'success');
    } catch(e) { window.app.ui.toast('Error voting: ' + e.message, 'error'); }
  },

  gradeGroupEssay: async (sessionId, groupIndex) => {
    window.app.ui.btnLoading(`ai-grade-${groupIndex}`, true);
    try {
      const sessionSnap = await getDoc(doc(db, 'blockSessions', sessionId));
      const session = sessionSnap.data();
      const playersSnap = await getDocs(collection(db, 'blockSessions', sessionId, 'players'));
      const players = {};
      playersSnap.forEach(d => { players[d.id] = d.data(); });

      const groupPlayerIds = session.groups[String(groupIndex)];
      const memberData = groupPlayerIds.map(pid => players[pid]).filter(Boolean);
      memberData.sort((a, b) => a.blockIndex - b.blockIndex);
      const fullText = memberData.map(m => m.response || '').join('\n\n');

      const grading = await window.app.ai.grade(session.type, session.prompt, fullText, session.structure);
      const pct = Math.round((grading.score / grading.maxScore) * 100);
      const grade = pct >= 80 ? 'Excellent' : pct >= 60 ? 'Proficient' : pct >= 40 ? 'Developing' : 'Needs Work';

      const el = document.getElementById(`group-grade-${groupIndex}`);
      if (el) {
        el.innerHTML = `<div class="hcard p-4 scaleIn">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl font-bold fs score-reveal" style="color:var(--ac)">${grading.score}/${grading.maxScore}</span>
            <span class="text-xs font-semibold" style="color:var(--mu)">${grade}</span>
          </div>
          ${grading.generalFeedback ? `<p class="text-xs mb-2" style="color:var(--mu)">${grading.generalFeedback}</p>` : ''}
          <div class="space-y-1">${(grading.annotations || []).slice(0, 4).map(a => {
            const dot = a.status === 'success' ? 'var(--sg)' : a.status === 'warning' ? 'var(--gd)' : 'var(--ac)';
            return `<div class="text-xs flex items-start gap-2"><span style="color:${dot}">●</span><span style="color:var(--mu)">${a.feedback}</span></div>`;
          }).join('')}</div>
        </div>`;
      }
    } catch(e) { window.app.ui.toast('Grading failed: ' + e.message, 'error'); }
    window.app.ui.btnLoading(`ai-grade-${groupIndex}`, false);
  },

  _showResults: (session, groupEssays) => {
    const resultsEl = document.getElementById('review-results');
    if (!resultsEl) return;

    const votes = session.votes || {};
    const counts = {};
    Object.values(votes).forEach(gi => { counts[gi] = (counts[gi] || 0) + 1; });

    let winner = 0, max = 0;
    Object.entries(counts).forEach(([gi, c]) => { if (c > max) { max = c; winner = parseInt(gi); } });

    resultsEl.classList.remove('hidden');
    resultsEl.innerHTML = `<div class="hcard p-8 text-center scaleIn">
      <span class="text-5xl score-reveal">🏆</span>
      <h2 class="text-2xl font-bold fs mt-3">Group ${winner + 1} Wins!</h2>
      <p class="text-sm mt-1" style="color:var(--mu)">${max} vote${max !== 1 ? 's' : ''}</p>
      <button onclick="window.app.router.go('student-dash')" class="btnP mt-4">Back to Dashboard</button>
    </div>`;
    try { confetti({ particleCount: 150, spread: 90, origin: { y: 0.5 }, colors: ['#d4622f', '#c49528', '#4d8060'] }); } catch(e){}
  },

  endSession: async (sessionId) => {
    if (!confirm('End this session now?')) return;
    try {
      await updateDoc(doc(db, 'blockSessions', sessionId), { status: 'done' });
      window.app.ui.toast('Session ended.', 'success');
      window.app.router.go(appState.userData?.role === 'teacher' ? 'teacher-dash' : 'student-dash');
    } catch(e) { window.app.ui.toast('Error: ' + e.message, 'error'); }
  },

  _onPresetChange: (sel) => {
    const isCustom = sel.value === 'custom';
    document.getElementById('eb-custom-fields').classList.toggle('hidden', !isCustom);
    const docPanel = document.getElementById('eb-doc-panel');
    const docList = document.getElementById('eb-doc-list');
    if (isCustom || !docPanel || !docList) { docPanel?.classList.add('hidden'); return; }
    const preset = ESSAY_BLOCKS_PROMPTS[parseInt(sel.value)];
    const sources = preset?.structure?.sources;
    if (!sources?.length) { docPanel.classList.add('hidden'); return; }
    docPanel.classList.remove('hidden');
    docList.innerHTML = sources.map((doc, i) => `
      <div class="mb-3 p-3 rounded-xl" style="background:var(--elev);border:1px solid var(--bd)">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-xs font-bold" style="color:var(--ac)">${doc.label}</span>
          <input class="hinp text-xs flex-1" id="eb-doc-attr-${i}" value="${doc.attribution.replace(/"/g,'&quot;')}" placeholder="Attribution">
        </div>
        <textarea class="hinp text-xs w-full" id="eb-doc-content-${i}" rows="3" style="min-height:60px">${doc.content}</textarea>
      </div>`).join('');
  },

  _addCustomDoc: () => {
    const list = document.getElementById('eb-custom-docs-list');
    if (!list) return;
    const idx = list.children.length;
    if (idx >= 7) return window.app.ui.toast('Maximum 7 documents.', 'error');
    const div = document.createElement('div');
    div.className = 'mb-3 p-3 rounded-xl';
    div.style.cssText = 'background:var(--elev);border:1px solid var(--bd)';
    div.innerHTML = `<span class="text-xs font-bold mb-1 block" style="color:var(--ac)">Document ${idx + 1}</span>
      <input class="hinp text-xs mb-1 w-full" id="eb-cdoc-attr-${idx}" placeholder="Attribution (author, title, year)">
      <textarea class="hinp text-xs w-full" id="eb-cdoc-content-${idx}" rows="3" placeholder="Document text..." style="min-height:60px"></textarea>`;
    list.appendChild(div);
  },

  _createFromModal: async (classId) => {
    const sel = document.getElementById('eb-prompt-select');
    const timerMins = parseInt(document.getElementById('eb-timer')?.value || '5');
    let promptData;
    if (sel.value === 'custom') {
      const type = document.getElementById('eb-custom-type')?.value || 'leq';
      const title = document.getElementById('eb-custom-title')?.value?.trim();
      const prompt = document.getElementById('eb-custom-prompt')?.value?.trim();
      if (!title || !prompt) return window.app.ui.toast('Fill in title and prompt.', 'error');
      let sources = [];
      if (type === 'dbq') {
        const customDocList = document.getElementById('eb-custom-docs-list');
        if (customDocList) {
          for (let i = 0; i < customDocList.children.length; i++) {
            const attr = document.getElementById(`eb-cdoc-attr-${i}`)?.value?.trim();
            const content = document.getElementById(`eb-cdoc-content-${i}`)?.value?.trim();
            if (attr && content) sources.push({ label: `Document ${i + 1}`, attribution: attr, type: 'text', content });
          }
        }
      }
      promptData = { type, title, prompt, structure: sources.length ? { sources } : {} };
    } else {
      const preset = ESSAY_BLOCKS_PROMPTS[parseInt(sel.value)];
      // Collect any teacher edits to documents
      const docList = document.getElementById('eb-doc-list');
      if (docList && preset?.structure?.sources?.length) {
        const editedSources = preset.structure.sources.map((s, i) => ({
          ...s,
          attribution: document.getElementById(`eb-doc-attr-${i}`)?.value?.trim() || s.attribution,
          content: document.getElementById(`eb-doc-content-${i}`)?.value?.trim() || s.content
        }));
        promptData = { ...preset, structure: { ...preset.structure, sources: editedSources } };
      } else {
        promptData = preset;
      }
    }
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    try {
      const ref = await addDoc(collection(db, 'blockSessions'), {
        classId,
        code,
        title: promptData.title,
        type: promptData.type,
        prompt: promptData.prompt,
        thesis: promptData.thesis || '',
        structure: promptData.structure || {},
        teacherId: appState.user.uid,
        status: 'lobby',
        timerSeconds: timerMins * 60,
        groups: {},
        votes: {},
        createdAt: serverTimestamp()
      });
      window.app.ui.closeModal('eb-session-modal');
      window.app.ui.toast('Session created!', 'success');
      window.app.router.go('blocks-lobby', { sessionId: ref.id });
    } catch(e) { window.app.ui.toast('Error: ' + e.message, 'error'); }
  },

  // ─── STUDENT: Check active sessions ───
  checkActiveSessions: async () => {
    if (!appState.user) return;
    try {
      const classSnap = await getDocs(query(collection(db, 'classes'), where('students', 'array-contains', appState.user.uid)));
      const classIds = classSnap.docs.map(d => d.id);
      if (!classIds.length) return;

      const allSessions = [];
      for (let i = 0; i < classIds.length; i += 10) {
        const batch = classIds.slice(i, i + 10);
        const sessSnap = await getDocs(query(collection(db, 'blockSessions'), where('classId', 'in', batch)));
        sessSnap.docs.forEach(d => {
          const s = d.data();
          if (s.status === 'lobby' || s.status === 'active') allSessions.push({ id: d.id, ...s });
        });
      }
      const container = document.getElementById('eb-active-sessions');
      if (container && allSessions.length) {
        container.innerHTML = `<div class="mb-4 p-3 rounded-xl" style="background:rgba(212,98,47,.08);border:1px solid rgba(212,98,47,.15)">
          <p class="text-xs font-bold mb-2" style="color:var(--ac)">🎮 Active Sessions</p>
          ${allSessions.map(s => {
            return `<div class="flex items-center justify-between py-1">
              <span class="text-sm font-semibold">${s.title}</span>
              <button onclick="window.app.router.go('blocks-lobby',{sessionId:'${s.id}'})" class="btnP text-xs py-1 px-3">Join</button>
            </div>`;
          }).join('')}
          </div>`;
      }
    } catch(e) { console.warn('Session check failed:', e); }
  }
}

}; // end window.app

// ═══ FIREBASE AUTH LISTENER ═══
onAuthStateChanged(auth, async (user) => {
  if (user) {
    appState.user = user;
    const snap = await getDoc(doc(db, "users", user.uid));
    appState.userData = snap.exists() ? snap.data() : { name: user.displayName, role: 'student' };
    // Load teacher's saved API key
    if (appState.userData.claudeKey && !localStorage.getItem('anthropic_key')) {
      appState.apiKey = appState.userData.claudeKey;
    }
    window.app.ui.updateNav();
    window.app.router.go(appState.userData.role === 'teacher' ? 'teacher-dash' : 'student-dash');
  } else {
    appState.user = null; appState.userData = null;
    window.app.ui.updateNav();
    window.app.router.go('home');
  }
});

// ═══ THEME INIT ═══
const savedTheme = localStorage.getItem('hw_theme');
if (savedTheme) document.body.setAttribute('data-theme', savedTheme);

// ═══ INITIAL ICONS ═══
lucide.createIcons();

</script>
</body>
</html>
