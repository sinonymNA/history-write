<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HistoryWrite | AP World History Mastery</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{
  ember:{400:'#e8794a',500:'#d4622f',600:'#b34d1e'},
  sage:{400:'#6b9b7a',500:'#4d8060'},
  royal:{400:'#7b8ac4',500:'#5c6db3'},
  gold:{400:'#d4a843',500:'#c49528'}
}}}}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#fefdfb; --card:#fff; --elev:#fdf8f0; --tx:#1e1c17; --mu:#7f7868;
  --fa:#b5b0a3; --bd:#e8e6e1; --bd2:#f3ddb8; --ac:#d4622f; --ac2:#b34d1e;
  --acs:rgba(212,98,47,.08); --sg:#4d8060; --ry:#5c6db3; --gd:#c49528;
}
[data-theme="dark"] {
  --bg:#0f0e0b; --card:#1a1814; --elev:#242119; --tx:#e8e6e1; --mu:#9a9385;
  --fa:#655f52; --bd:#332f26; --bd2:#4a4639; --ac:#e8794a; --ac2:#d4622f;
  --acs:rgba(232,121,74,.1); --sg:#6b9b7a; --ry:#7b8ac4; --gd:#d4a843;
}
* { box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--tx); margin:0; transition:background .4s,color .4s; }
.fs { font-family:'Crimson Pro',Georgia,serif; }
.fm { font-family:'JetBrains Mono',monospace; }
.csc::-webkit-scrollbar { width:5px; }
.csc::-webkit-scrollbar-track { background:transparent; }
.csc::-webkit-scrollbar-thumb { background:var(--bd); border-radius:10px; }

/* Nav glass */
.navg { background:color-mix(in srgb,var(--card) 85%,transparent); backdrop-filter:blur(20px) saturate(1.3); border-bottom:1px solid var(--bd); }

/* Cards */
.hcard { background:var(--card); border:1px solid var(--bd); border-radius:16px; transition:all .25s cubic-bezier(.4,0,.2,1); }
.hcard:hover { border-color:var(--bd2); box-shadow:0 8px 32px rgba(0,0,0,.06); }

/* Buttons */
.btnP { background:var(--ac); color:#fff; font-weight:600; border-radius:10px; padding:10px 24px; transition:all .2s; border:none; cursor:pointer; font-size:14px; font-family:'DM Sans',sans-serif; }
.btnP:hover { background:var(--ac2); transform:translateY(-1px); box-shadow:0 4px 16px rgba(212,98,47,.3); }
.btnP:active { transform:translateY(0); }
.btnP:disabled { opacity:.5; cursor:not-allowed; transform:none; }
.btnG { background:transparent; color:var(--tx); font-weight:500; border-radius:10px; padding:10px 20px; border:1px solid var(--bd); cursor:pointer; font-size:14px; transition:all .2s; font-family:'DM Sans',sans-serif; }
.btnG:hover { background:var(--acs); border-color:var(--ac); color:var(--ac); }

/* Inputs */
.hinp { width:100%; padding:10px 16px; background:var(--elev); border:1px solid var(--bd); border-radius:10px; color:var(--tx); font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color .2s; }
.hinp:focus { border-color:var(--ac); }
.hinp::placeholder { color:var(--fa); }

/* Highlights */
.hl-success { background:rgba(77,128,96,.15); border-bottom:2px solid var(--sg); cursor:help; }
.hl-warning { background:rgba(196,149,40,.15); border-bottom:2px solid var(--gd); cursor:help; }
.hl-error { background:rgba(212,98,47,.15); border-bottom:2px solid var(--ac); cursor:help; }

/* Skill nodes */
.skill-node { transition:all .3s cubic-bezier(.4,0,.2,1); cursor:pointer; }
.skill-node:hover { transform:scale(1.12); }
.skill-gold { box-shadow:0 0 0 3px var(--gd),0 0 20px rgba(196,149,40,.4); animation:glowG 2.5s ease-in-out infinite; }
.skill-grow { border-color:var(--sg); background:rgba(77,128,96,.1); }
.skill-seed { border-color:var(--bd); background:var(--elev); }
@keyframes glowG {
  0%,100% { box-shadow:0 0 0 3px var(--gd),0 0 15px rgba(196,149,40,.3); }
  50% { box-shadow:0 0 0 3px var(--gd),0 0 25px rgba(196,149,40,.6); }
}

/* Arcade */
.arcP { background:#13120f; border-radius:16px; overflow:hidden; }
[data-theme="dark"] .arcP { background:#0a0908; }
.arcTab { font-size:12px; padding:10px 16px; border:none; border-bottom:2px solid transparent; color:#7f7868; cursor:pointer; background:none; font-family:'DM Sans',sans-serif; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s; }
.arcTab.on { color:#e8e6e1; border-bottom-color:var(--ac); }

/* Animations */
@keyframes toastIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }
.toastAnim { animation:toastIn .3s ease-out; }
@keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.pageEnter { animation:fadeUp .35s ease-out; }
.heroBg { background-image:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(212,98,47,.15),transparent),radial-gradient(circle at 80% 80%,rgba(92,109,179,.1),transparent); }
@keyframes floatAnim { 0%,100% { transform:translateY(0) rotate(0); } 50% { transform:translateY(-15px) rotate(2deg); } }
.float1 { animation:floatAnim 6s ease-in-out infinite; }
.float2 { animation:floatAnim 8s ease-in-out infinite 1s; }
.float3 { animation:floatAnim 7s ease-in-out infinite 2s; }

/* Modals */
.modalBg { position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(4px); z-index:50; display:flex; align-items:center; justify-content:center; padding:16px; }
.modalBox { background:var(--card); border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,.15); width:100%; max-width:480px; padding:32px; }
.modalLg { max-width:720px; max-height:90vh; overflow-y:auto; }

/* XP bar */
.xpBar { height:6px; background:var(--bd); border-radius:3px; overflow:hidden; }
.xpFill { height:100%; background:linear-gradient(90deg,var(--ac),var(--gd)); border-radius:3px; transition:width .6s cubic-bezier(.4,0,.2,1); }

/* Tabs */
.tabBtn { padding:8px 20px; font-size:13px; font-weight:600; border-radius:8px 8px 0 0; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; background:transparent; color:var(--mu); border-bottom:2px solid transparent; transition:all .2s; }
.tabBtn.on { color:var(--ac); border-bottom-color:var(--ac); background:var(--acs); }

/* Chrono flash */
@keyframes flashGreen { 0% { background:rgba(77,128,96,.3); } 100% { background:transparent; } }
.chronoCorrect { animation:flashGreen .4s ease-out; }
@keyframes flashRed { 0% { background:rgba(212,98,47,.3); } 100% { background:transparent; } }
.chronoWrong { animation:flashRed .5s ease-out; }
</style>
</head>
<body class="antialiased h-screen flex flex-col overflow-hidden" data-theme="light">

<!-- NAVBAR -->
<nav class="navg sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div class="flex justify-between h-14">
      <div class="flex items-center cursor-pointer gap-3" onclick="window.app.router.go('home')">
        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:var(--ac)">
          <i data-lucide="feather" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="text-base font-bold" style="letter-spacing:-.02em">HistoryWrite</h1>
          <p class="text-[10px] fm uppercase tracking-widest" style="color:var(--fa)">AP World Modern</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div id="nav-out" class="flex items-center gap-2">
          <button onclick="window.app.router.go('login')" class="btnG text-sm py-2 px-4">Log In</button>
          <button onclick="window.app.router.go('signup')" class="btnP text-sm py-2 px-5">Get Started</button>
        </div>
        <div id="nav-in" class="hidden flex items-center gap-2">
          <button onclick="window.app.ui.toggleSettings()" class="flex items-center gap-2 px-3 py-1.5 rounded-xl transition" style="border:1px solid var(--bd)">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center text-xs font-bold" style="background:var(--acs);color:var(--ac)">
              <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>
            <span id="nav-name" class="hidden md:block text-xs font-semibold">User</span>
          </button>
          <button onclick="window.app.auth.logout()" class="p-2 rounded-lg transition" style="color:var(--fa)" title="Log Out">
            <i data-lucide="log-out" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main id="app-root" class="flex-1 overflow-y-auto relative bg-canvas"></main>

<!-- TOASTS -->
<div id="toast-container" class="fixed top-16 right-4 z-[60] flex flex-col gap-2 pointer-events-none"></div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="hidden">
  <div class="modalBg" onclick="event.target===this&&window.app.ui.toggleSettings()">
    <div class="modalBox">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">Settings</h3>
        <button onclick="window.app.ui.toggleSettings()" style="color:var(--mu)"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="space-y-5">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wider" style="color:var(--mu)">Name</label>
          <input type="text" id="profile-name-input" class="hinp mt-2">
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wider" style="color:var(--mu)">Claude API Key</label>
          <input type="password" id="api-key-input" placeholder="sk-ant-..." class="hinp mt-2">
          <p class="text-[11px] mt-1" style="color:var(--fa)">Optional. Enables AI-powered essay grading.</p>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wider mb-3 block" style="color:var(--mu)">Theme</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="light" class="peer sr-only">
              <div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)">
                <i data-lucide="sun" class="w-5 h-5 mx-auto" style="color:var(--ac)"></i>
                <span class="text-xs font-semibold mt-1 block">Light</span>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="dark" class="peer sr-only">
              <div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)">
                <i data-lucide="moon" class="w-5 h-5 mx-auto" style="color:var(--ac)"></i>
                <span class="text-xs font-semibold mt-1 block">Dark</span>
              </div>
            </label>
          </div>
        </div>
      </div>
      <button onclick="window.app.ui.saveSettings()" class="btnP w-full mt-6">Save Changes</button>
    </div>
  </div>
</div>

<!-- PRACTICE MODAL -->
<div id="practice-modal" class="hidden">
  <div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('practice-modal')">
    <div class="modalBox modalLg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" id="practice-title">Practice Drill</h3>
        <button onclick="window.app.ui.closeModal('practice-modal')" style="color:var(--mu)"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="practice-prompt" class="mb-4 p-4 rounded-xl text-sm fs leading-relaxed" style="background:var(--elev);border:1px solid var(--bd)"></div>
      <textarea id="practice-response" class="hinp fs" rows="6" placeholder="Write your response..."></textarea>
      <div class="flex justify-end mt-4">
        <button id="submit-practice-btn" onclick="window.app.game.submitPractice()" class="btnP">Submit Response</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, setDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyD2K9kbT3FKq0lHvl8eetv43I8xVkOFvaI",
  authDomain: "history-f02c6.firebaseapp.com",
  projectId: "history-f02c6",
  storageBucket: "history-f02c6.firebasestorage.app",
  messagingSenderId: "676682825829",
  appId: "1:676682825829:web:911e167cb59469c58ec68c"
});
const auth = getAuth(app);
const db = getFirestore(app);

const appState = {
  user: null,
  userData: null,
  apiKey: localStorage.getItem('anthropic_key') || '',
  activeAssignment: null,
  practiceContext: null
};

const LIBRARY_TEMPLATES = [
  { title: "Dar al-Islam SAQ", type: "saq", prompt: "Identify and explain ONE way Islamic states maintained political authority 1200–1450.", maxAttempts: 3 },
  { title: "Silver Trade DBQ", type: "dbq", prompt: "Evaluate the extent to which silver affected global economies 1550–1800.", sources: [{ title: "Document 1", type: "text", content: "Spanish silver from Potosí mines..." }], maxAttempts: 2 },
  { title: "Industrial Rev LEQ", type: "leq", prompt: "Evaluate the extent to which geographic factors caused industrialization differences 1750–1900.", maxAttempts: 3 },
  { title: "Mongol Empire SAQ", type: "saq", prompt: "Identify ONE way the Mongol Empire facilitated cultural exchange across Eurasia 1200–1350.", maxAttempts: 3 },
  { title: "Atlantic Revolutions LEQ", type: "leq", prompt: "Evaluate the extent to which Enlightenment ideas influenced political revolutions 1750–1900.", maxAttempts: 3 },
  { title: "Imperialism DBQ", type: "dbq", prompt: "Evaluate the extent to which state imperialism was driven by economic motives 1750–1900.", sources: [], maxAttempts: 2 }
];

const CHRONO_EVENTS = [
  { event: "Fall of Rome", date: 476, era: "Post-Classical" },
  { event: "Rise of Islam", date: 622, era: "Post-Classical" },
  { event: "Tang Dynasty begins", date: 618, era: "Post-Classical" },
  { event: "Battle of Hastings", date: 1066, era: "Post-Classical" },
  { event: "First Crusade", date: 1096, era: "Post-Classical" },
  { event: "Magna Carta", date: 1215, era: "Post-Classical" },
  { event: "Mongols take Baghdad", date: 1258, era: "Post-Classical" },
  { event: "Black Death reaches Europe", date: 1347, era: "Post-Classical" },
  { event: "Ming Dynasty founded", date: 1368, era: "Post-Classical" },
  { event: "Fall of Constantinople", date: 1453, era: "Early Modern" },
  { event: "Columbus reaches Americas", date: 1492, era: "Early Modern" },
  { event: "Luther's 95 Theses", date: 1517, era: "Early Modern" },
  { event: "Spanish Armada defeated", date: 1588, era: "Early Modern" },
  { event: "Jamestown founded", date: 1607, era: "Early Modern" },
  { event: "Thirty Years' War begins", date: 1618, era: "Early Modern" },
  { event: "Qing Dynasty established", date: 1644, era: "Early Modern" },
  { event: "Glorious Revolution", date: 1688, era: "Early Modern" },
  { event: "American Independence", date: 1776, era: "Modern" },
  { event: "French Revolution begins", date: 1789, era: "Modern" },
  { event: "Haitian Revolution", date: 1791, era: "Modern" },
  { event: "Congress of Vienna", date: 1815, era: "Modern" },
  { event: "Communist Manifesto", date: 1848, era: "Modern" },
  { event: "Meiji Restoration", date: 1868, era: "Modern" },
  { event: "Berlin Conference", date: 1884, era: "Modern" },
  { event: "Boxer Rebellion", date: 1900, era: "Modern" }
];

const THESIS_PROMPTS = [
  "Evaluate the extent to which the Columbian Exchange transformed global economies 1450–1750.",
  "Evaluate the extent to which the Mongol Empire affected interregional trade 1200–1350.",
  "Evaluate the extent to which industrialization changed social hierarchies 1750–1900.",
  "Evaluate the extent to which maritime exploration changed global trade patterns 1450–1750.",
  "Evaluate the extent to which the Atlantic slave trade affected societies in Africa and the Americas 1500–1800.",
  "Evaluate the extent to which nationalism influenced political movements 1750–1900.",
  "Evaluate the extent to which the spread of Islam facilitated cultural exchange 600–1450.",
  "Evaluate the extent to which environmental factors shaped civilizations 1200–1450."
];

const SOURCE_CASES = [
  {
    excerpt: "I, a Spanish official at the silver mines of Potosí, write to Your Majesty: revenues increase, though Indian workers grow restless under the mita labor system…",
    attribution: "Spanish colonial administrator to Philip II, 1580",
    pov: "Spanish imperial official", audience: "The Spanish monarch",
    purpose: "Justify colonial policies and request support",
    context: "Spanish silver extraction using coerced indigenous labor"
  },
  {
    excerpt: "As a Chinese scholar-official, I lament the corruption as foreign silver floods our markets, encouraging greed among those who should uphold Confucian values…",
    attribution: "Memorial to the Ming Emperor, 1590",
    pov: "Chinese scholar-official", audience: "The Emperor and imperial court",
    purpose: "Criticize moral decline and advocate reform",
    context: "Ming China experiencing massive silver inflows"
  },
  {
    excerpt: "We have witnessed destruction of our temples by foreign missionaries. Yet trade with the Portuguese brings iron tools our village greatly needs…",
    attribution: "Kongolese elder, recorded by Jesuit missionary, 1620",
    pov: "Indigenous African leader", audience: "Community members",
    purpose: "Express tension between cultural loss and material benefit",
    context: "European-African contact in Central Africa"
  },
  {
    excerpt: "Workers in my mill produce cloth at unimaginable rates. Yet children as young as eight work fourteen-hour days, and the air is thick with cotton dust…",
    attribution: "British factory owner diary, Manchester, 1832",
    pov: "British industrial capitalist", audience: "Private diary (self-reflection)",
    purpose: "Reconcile profit motive with moral concerns about labor",
    context: "Industrial Revolution transforming labor in Britain"
  }
];

const POV_OPTIONS = ["Spanish imperial official","Chinese scholar-official","Indigenous African leader","British industrial capitalist","European merchant","Local peasant or worker"];
const AUD_OPTIONS = ["The Spanish monarch","The Emperor and imperial court","Community members","Private diary (self-reflection)","General public","Other merchants"];
const PURP_OPTIONS = ["Justify colonial policies and request support","Criticize moral decline and advocate reform","Express tension between cultural loss and material benefit","Reconcile profit motive with moral concerns about labor","Advertise goods","Express personal feelings"];

window.app = {

// ═══ ROUTER ═══
router: {
  go: (view, params = {}) => {
    const root = document.getElementById('app-root');
    root.scrollTop = 0;
    const V = window.app.views;
    const routes = {
      'home': () => { if (appState.user) return window.app.router.go(appState.userData?.role === 'teacher' ? 'teacher-dash' : 'student-dash'); root.innerHTML = V.landing(); },
      'login': () => root.innerHTML = V.login(),
      'signup': () => root.innerHTML = V.signup(),
      'teacher-dash': () => { root.innerHTML = V.teacherDash(); window.app.teacher.init(); },
      'student-dash': () => { root.innerHTML = V.studentDash(); window.app.student.init(); },
      'class-detail': () => { root.innerHTML = V.classDetail(params.classData); window.app.teacher.loadClass(params.classData.id); },
      'library': () => root.innerHTML = V.library(),
      'editor': () => { appState.activeAssignment = params.assignment; root.innerHTML = V.editor(params.assignment); window.app.student.initEditor(); },
      'results': () => root.innerHTML = V.results(params.submission, params.assignment)
    };
    if (routes[view]) routes[view]();
    lucide.createIcons();
  }
},

// ═══ VIEWS ═══
views: {
  landing: () => `
    <div class="min-h-screen heroBg flex flex-col pageEnter">
      <div class="flex-1 flex items-center justify-center px-4">
        <div class="max-w-2xl text-center">
          <div class="mb-8 flex justify-center gap-4">
            <div class="float1 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--ac)"><i data-lucide="feather" class="w-6 h-6 text-white"></i></div>
            <div class="float2 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--sg)"><i data-lucide="scroll-text" class="w-6 h-6 text-white"></i></div>
            <div class="float3 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg" style="background:var(--ry)"><i data-lucide="gamepad-2" class="w-6 h-6 text-white"></i></div>
          </div>
          <h1 class="text-4xl md:text-6xl font-bold tracking-tight mb-4 fs">Write history.<br><span style="color:var(--ac)">Make history.</span></h1>
          <p class="text-lg md:text-xl mb-10" style="color:var(--mu);max-width:480px;margin:0 auto">AI-powered essay grading, skill gardens, and arcade games for AP World History writing mastery.</p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="window.app.router.go('signup')" class="btnP text-base py-3 px-8 shadow-lg">Get Started Free</button>
            <button onclick="window.app.router.go('login')" class="btnG text-base py-3 px-8">Log In</button>
          </div>
        </div>
      </div>
      <div class="py-12 px-4"><div class="max-w-4xl mx-auto grid md:grid-cols-3 gap-6">
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="pen-tool" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">AI Grading</h3><p class="text-xs" style="color:var(--mu)">Instant rubric-aligned feedback on SAQs, LEQs, and DBQs.</p></div>
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="sprout" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">Skill Garden</h3><p class="text-xs" style="color:var(--mu)">Watch AP skills grow from seedlings to golden mastery.</p></div>
        <div class="hcard p-6 text-center"><div class="w-10 h-10 rounded-xl mx-auto mb-3 flex items-center justify-center" style="background:var(--acs)"><i data-lucide="gamepad-2" class="w-5 h-5" style="color:var(--ac)"></i></div><h3 class="font-bold text-sm mb-1">Arcade Mode</h3><p class="text-xs" style="color:var(--mu)">Timeline races, thesis forging, and source detective games.</p></div>
      </div></div>
    </div>`,

  login: () => `
    <div class="min-h-screen flex items-center justify-center p-4 pageEnter"><div class="hcard w-full max-w-sm p-8">
      <h2 class="text-2xl font-bold fs mb-6">Welcome back</h2>
      <form onsubmit="event.preventDefault();window.app.auth.login(this.email.value,this.password.value)">
        <input name="email" type="email" placeholder="Email" required class="hinp mb-3">
        <input name="password" type="password" placeholder="Password" required class="hinp mb-5">
        <button id="login-btn" class="btnP w-full">Log In</button>
      </form>
      <p class="mt-4 text-center text-xs" style="color:var(--mu)">No account? <button onclick="window.app.router.go('signup')" class="font-bold" style="color:var(--ac)">Sign up</button></p>
    </div></div>`,

  signup: () => `
    <div class="min-h-screen flex items-center justify-center p-4 pageEnter"><div class="hcard w-full max-w-sm p-8">
      <h2 class="text-2xl font-bold fs mb-6">Join HistoryWrite</h2>
      <form onsubmit="event.preventDefault();window.app.auth.signup(this.name.value,this.email.value,this.password.value,this.role.value)">
        <input name="name" placeholder="Full Name" required class="hinp mb-3">
        <input name="email" type="email" placeholder="Email" required class="hinp mb-3">
        <input name="password" type="password" placeholder="Password (min 6)" required minlength="6" class="hinp mb-4">
        <div class="mb-5"><label class="text-xs font-semibold uppercase tracking-wider mb-2 block" style="color:var(--mu)">I am a…</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer"><input type="radio" name="role" value="student" checked class="peer sr-only"><div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)"><i data-lucide="book-open" class="w-6 h-6 mx-auto mb-1" style="color:var(--ac)"></i><span class="font-semibold text-xs">Student</span></div></label>
            <label class="cursor-pointer"><input type="radio" name="role" value="teacher" class="peer sr-only"><div class="p-3 rounded-xl text-center transition peer-checked:ring-2 peer-checked:ring-[var(--ac)]" style="border:1px solid var(--bd)"><i data-lucide="graduation-cap" class="w-6 h-6 mx-auto mb-1" style="color:var(--ac)"></i><span class="font-semibold text-xs">Teacher</span></div></label>
          </div>
        </div>
        <button id="signup-btn" class="btnP w-full">Create Account</button>
      </form>
      <p class="mt-4 text-center text-xs" style="color:var(--mu)">Have an account? <button onclick="window.app.router.go('login')" class="font-bold" style="color:var(--ac)">Log in</button></p>
    </div></div>`,

  teacherDash: () => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div><h2 class="text-2xl font-bold fs">My Classes</h2><p class="text-sm mt-1" style="color:var(--mu)">Create classes and assign writing tasks.</p></div>
        <div class="flex gap-2">
          <button onclick="window.app.router.go('library')" class="btnG text-sm py-2 px-4 flex items-center gap-2"><i data-lucide="library" class="w-4 h-4"></i>Library</button>
          <button onclick="window.app.ui.modal('create-class','open')" class="btnP text-sm py-2 px-4 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i>New Class</button>
        </div>
      </div>
      <div id="classes-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
    <div id="create-class" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('create-class')"><div class="modalBox">
      <h3 class="text-lg font-bold mb-4">Create Class</h3>
      <input id="class-name" placeholder="e.g. Period 3 — AP World" class="hinp mb-4">
      <div class="flex gap-2"><button onclick="window.app.ui.closeModal('create-class')" class="btnG flex-1">Cancel</button><button onclick="window.app.teacher.createClass()" class="btnP flex-1">Create</button></div>
    </div></div></div>`,

  studentDash: () => {
    const stats = appState.userData?.gamification || window.app.game.getDefaultStats();
    const level = stats.level || 1;
    const nextXp = level * 200;
    const pct = Math.min(100, Math.round((stats.xp / nextXp) * 100));
    return `
    <div class="max-w-5xl mx-auto px-4 py-6 flex flex-col h-[calc(100vh-56px)] pageEnter">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
        <div><h2 class="text-xl md:text-2xl font-bold fs tracking-tight">Welcome back, ${appState.userData?.name || 'Scholar'}</h2><p class="text-xs mt-0.5" style="color:var(--mu)">Sharpen your AP World writing skills.</p></div>
        <div class="flex items-center gap-3">
          <div class="hcard flex items-center gap-3 px-4 py-2">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold" style="background:var(--acs);color:var(--ac)">Lv${level}</div>
            <div><div class="text-xs font-semibold">${stats.xp} XP</div><div class="xpBar w-20 mt-1"><div class="xpFill" style="width:${pct}%"></div></div></div>
          </div>
          <button onclick="window.app.ui.modal('join-class','open')" class="btnP text-xs py-2 px-4">Join Class</button>
        </div>
      </div>
      <div class="flex gap-1 mb-3" style="border-bottom:1px solid var(--bd)">
        <button id="stab-assign" onclick="window.app.student.switchTab('assign')" class="tabBtn on"><i data-lucide="book-open" class="w-3.5 h-3.5 inline mr-1"></i>Assignments</button>
        <button id="stab-skills" onclick="window.app.student.switchTab('skills')" class="tabBtn"><i data-lucide="sprout" class="w-3.5 h-3.5 inline mr-1"></i>Skill Garden</button>
        <button id="stab-arcade" onclick="window.app.student.switchTab('arcade')" class="tabBtn"><i data-lucide="gamepad-2" class="w-3.5 h-3.5 inline mr-1"></i>Arcade</button>
      </div>
      <div id="tab-assign" class="flex-1 min-h-0 overflow-y-auto csc"><div id="assignments-list" class="space-y-2"></div></div>
      <div id="tab-skills" class="hidden flex-1 min-h-0 overflow-y-auto csc py-2">${window.app.game.renderSkillGarden(stats)}</div>
      <div id="tab-arcade" class="hidden flex-1 min-h-0">${window.app.game.renderArcade()}</div>
      <div id="join-class" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('join-class')"><div class="modalBox" style="max-width:380px">
        <h3 class="text-lg font-bold mb-4">Join Class</h3>
        <input id="class-code" placeholder="Enter class code" class="hinp mb-4 uppercase fm">
        <div class="flex gap-2"><button onclick="window.app.ui.closeModal('join-class')" class="btnG flex-1">Cancel</button><button onclick="window.app.student.joinClass()" class="btnP flex-1">Join</button></div>
      </div></div></div>
    </div>`;
  },

  classDetail: (cls) => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div><h1 class="text-2xl font-bold fs">${cls.name}</h1><p class="text-sm mt-1 fm" style="color:var(--mu)">Code: <span style="color:var(--ac)" class="font-bold">${cls.code}</span></p></div>
        <button onclick="window.app.ui.modal('create-assignment','open')" class="btnP text-sm flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i>New Assignment</button>
      </div>
      <div id="assignments-list" class="space-y-3"></div>
    </div>
    <div id="create-assignment" class="hidden"><div class="modalBg" onclick="event.target===this&&window.app.ui.closeModal('create-assignment')"><div class="modalBox modalLg">
      <h3 class="text-lg font-bold mb-4">Create Assignment</h3>
      <form onsubmit="event.preventDefault();window.app.teacher.createAssignment('${cls.id}')">
        <div class="grid sm:grid-cols-2 gap-3 mb-3"><input name="title" placeholder="Title" required class="hinp"><select name="type" class="hinp" onchange="window.app.teacher.onTypeChange(this.value)"><option value="saq">SAQ</option><option value="leq">LEQ</option><option value="dbq">DBQ</option></select></div>
        <textarea name="prompt" rows="3" placeholder="Prompt" required class="hinp mb-3" style="resize:vertical"></textarea>
        <div id="saq-structure" class="mb-3"><label class="text-xs font-semibold" style="color:var(--mu)">Parts</label><input type="number" name="saqParts" min="1" max="4" value="3" class="hinp mt-1 w-24"></div>
        <div id="leq-structure" class="mb-3 hidden"><label class="text-xs font-semibold mb-2 block" style="color:var(--mu)">Focus</label><div class="grid grid-cols-2 gap-2 text-xs"><label class="flex items-center gap-2"><input type="checkbox" name="leqSkill" value="thesis" checked>Thesis</label><label class="flex items-center gap-2"><input type="checkbox" name="leqSkill" value="context">Context</label><label class="flex items-center gap-2"><input type="checkbox" name="leqSkill" value="evidence">Evidence</label><label class="flex items-center gap-2"><input type="checkbox" name="leqSkill" value="reasoning">Reasoning</label></div></div>
        <div id="dbq-structure" class="mb-3 hidden"><label class="text-xs font-semibold mb-2 block" style="color:var(--mu)">DBQ Sources</label>
          <div class="hcard p-3 mb-2"><div class="grid sm:grid-cols-3 gap-2 mb-2"><select id="dbq-source-type" class="hinp text-xs"><option value="text">Text</option><option value="image">Image</option><option value="chart">Chart</option><option value="map">Map</option></select><input id="dbq-source-label" placeholder="Label" class="hinp text-xs"><input id="dbq-source-content" placeholder="Content/URL" class="hinp text-xs"></div><button type="button" onclick="window.app.teacher.addDbqSource()" class="btnP text-xs py-1.5 px-3">Add Source</button></div>
          <div id="dbq-sources-list" class="text-xs" style="color:var(--fa)">No sources added.</div>
        </div>
        <input name="maxAttempts" type="number" value="3" class="hinp mb-4 w-full" placeholder="Max attempts">
        <div class="flex gap-2"><button type="button" onclick="window.app.ui.closeModal('create-assignment')" class="btnG flex-1">Cancel</button><button class="btnP flex-1">Create</button></div>
      </form>
    </div></div></div>`,

  library: () => `
    <div class="max-w-5xl mx-auto px-4 py-6 pageEnter">
      <button onclick="window.app.router.go('teacher-dash')" class="mb-6 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
      <h1 class="text-2xl font-bold fs mb-6">Assignment Library</h1>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        ${LIBRARY_TEMPLATES.map(t => `<div class="hcard p-5 flex flex-col justify-between"><div class="mb-4"><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${t.type}</span><h3 class="font-bold mt-2 text-sm">${t.title}</h3><p class="text-xs mt-1 line-clamp-3" style="color:var(--mu)">${t.prompt}</p></div><button onclick="window.app.ui.toast('Clone to class coming soon.','info')" class="btnG text-xs w-full">Clone to Class</button></div>`).join('')}
      </div>
    </div>`,

  editor: (a) => {
    const draft = localStorage.getItem(`draft_${a.id}`) || '';
    const srcHtml = a.structure?.sources?.length ? `<div class="mt-4"><h3 class="text-sm font-bold mb-2">Documents</h3>${a.structure.sources.map((s, i) => `<div class="p-3 rounded-lg mb-2" style="background:var(--elev);border:1px solid var(--bd)"><div class="text-xs font-bold mb-1" style="color:var(--ac)">Doc ${i + 1}: ${s.label || s.title}</div><p class="text-xs" style="color:var(--mu)">${s.content}</p></div>`).join('')}</div>` : '';
    return `
    <div class="h-[calc(100vh-56px)] flex pageEnter">
      <div class="w-full md:w-[45%] overflow-y-auto p-6 md:p-8 csc" style="background:var(--card);border-right:1px solid var(--bd)">
        <button onclick="window.app.router.go('student-dash')" class="mb-5 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Exit</button>
        <span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${a.type}</span>
        <h2 class="text-xl font-bold fs mt-3">Prompt</h2>
        <div class="mt-3 p-4 rounded-xl fs text-sm leading-relaxed" style="background:var(--elev);border:1px solid var(--bd)">${a.prompt}</div>
        ${srcHtml}
      </div>
      <div class="w-full md:w-[55%] flex flex-col relative" style="background:var(--card)">
        <div class="absolute top-4 right-4 z-10"><button id="submit-btn" onclick="window.app.student.submitEssay()" class="btnP shadow-lg text-sm py-2 px-6">Submit</button></div>
        <textarea id="essay-input" class="flex-1 p-6 md:p-10 text-base md:text-lg resize-none focus:outline-none fs leading-relaxed" style="background:transparent;color:var(--tx)" placeholder="Start writing your response…" oninput="window.app.student.onEditorInput(this)">${draft}</textarea>
        <div class="px-6 pb-3 flex justify-between text-[11px]" style="color:var(--fa)"><span id="word-count">0 words</span><span>Auto-saved</span></div>
      </div>
    </div>`;
  },

  results: (sub, a) => {
    setTimeout(() => confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 }, colors: ['#d4622f', '#c49528', '#4d8060'] }), 400);
    let html = sub.essayText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    if (sub.grading.annotations) {
      sub.grading.annotations.forEach(ann => {
        if (ann.quote) {
          const escaped = ann.quote.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const cls = ann.status === 'success' ? 'hl-success' : ann.status === 'warning' ? 'hl-warning' : 'hl-error';
          html = html.replace(escaped, `<span class="${cls}" title="${(ann.feedback || '').replace(/"/g, '&quot;')}">${escaped}</span>`);
        }
      });
    }
    const pct = Math.round((sub.grading.score / sub.grading.maxScore) * 100);
    const grade = pct >= 80 ? 'Excellent' : pct >= 60 ? 'Proficient' : pct >= 40 ? 'Developing' : 'Needs Work';
    return `
    <div class="h-[calc(100vh-56px)] flex pageEnter">
      <div class="flex-1 overflow-y-auto p-6 md:p-10 csc">
        <button onclick="window.app.router.go('student-dash')" class="mb-5 text-sm flex items-center gap-1" style="color:var(--mu)"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</button>
        <h1 class="text-2xl font-bold fs mb-1">Grading Report</h1>
        <p class="text-xs mb-6" style="color:var(--mu)">${a.title}</p>
        <div class="hcard p-6 md:p-8 fs text-base md:text-lg leading-relaxed" style="white-space:pre-wrap">${html}</div>
      </div>
      <div class="w-72 md:w-80 overflow-y-auto p-6 csc" style="background:var(--card);border-left:1px solid var(--bd)">
        <div class="text-center mb-6">
          <div class="text-5xl font-bold fs" style="color:var(--ac)">${sub.grading.score}<span class="text-xl" style="color:var(--fa)">/${sub.grading.maxScore}</span></div>
          <div class="text-xs font-semibold mt-1" style="color:var(--mu)">${grade}</div>
          <div class="xpBar w-full mt-3"><div class="xpFill" style="width:${pct}%"></div></div>
        </div>
        ${sub.grading.generalFeedback ? `<p class="text-sm mb-5" style="color:var(--mu)">${sub.grading.generalFeedback}</p>` : ''}
        <div class="space-y-3">
          ${(sub.grading.annotations || []).map(a => {
            const dot = a.status === 'success' ? 'var(--sg)' : a.status === 'warning' ? 'var(--gd)' : 'var(--ac)';
            return `<div class="p-3 rounded-xl" style="background:var(--elev);border:1px solid var(--bd)"><div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full" style="background:${dot}"></div><span class="text-[11px] font-bold uppercase" style="color:${dot}">${a.category}</span></div><p class="text-xs" style="color:var(--mu)">${a.feedback}</p></div>`;
          }).join('')}
        </div>
      </div>
    </div>`;
  }
},

// ═══ AUTH ═══
auth: {
  login: async (email, password) => {
    window.app.ui.btnLoading('login-btn', true);
    try { await signInWithEmailAndPassword(auth, email, password); }
    catch (e) { window.app.ui.toast(e.message, 'error'); window.app.ui.btnLoading('login-btn', false); }
  },
  signup: async (name, email, password, role) => {
    window.app.ui.btnLoading('signup-btn', true);
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), { name, email, role, createdAt: serverTimestamp(), gamification: role === 'student' ? window.app.game.getDefaultStats() : null });
      await updateProfile(cred.user, { displayName: name });
    } catch (e) { window.app.ui.toast(e.message, 'error'); window.app.ui.btnLoading('signup-btn', false); }
  },
  logout: async () => { await signOut(auth); appState.user = null; appState.userData = null; window.app.ui.updateNav(); window.app.router.go('home'); }
},

// ═══ TEACHER ═══
teacher: {
  dbqSources: [],
  init: () => {
    const q2 = query(collection(db, "classes"), where("teacherId", "==", appState.user.uid));
    onSnapshot(q2, snap => {
      const el = document.getElementById('classes-list'); if (!el) return;
      if (snap.empty) { el.innerHTML = `<div class="col-span-3 text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><p style="color:var(--mu)" class="text-sm mb-1">No classes yet</p><p class="text-xs" style="color:var(--fa)">Click "New Class" to get started.</p></div>`; return; }
      el.innerHTML = snap.docs.map(d => {
        const data = d.data(); const payload = JSON.stringify({ id: d.id, ...data }).replace(/'/g, "&#39;");
        return `<div class="hcard p-5 cursor-pointer" onclick='window.app.router.go("class-detail",{classData:${payload}})'><h3 class="font-bold">${data.name}</h3><p class="text-xs fm mt-1" style="color:var(--mu)">Code: <span style="color:var(--ac)" class="font-bold">${data.code}</span></p></div>`;
      }).join('');
    });
  },
  createClass: async () => {
    const name = document.getElementById('class-name').value.trim(); if (!name) return;
    const code = 'HIST-' + Math.floor(1000 + Math.random() * 9000);
    await addDoc(collection(db, 'classes'), { name, code, teacherId: appState.user.uid, students: [], createdAt: serverTimestamp() });
    window.app.ui.closeModal('create-class'); window.app.ui.toast('Class created!', 'success');
  },
  loadClass: (classId) => {
    const q2 = query(collection(db, "assignments"), where("classId", "==", classId));
    onSnapshot(q2, snap => {
      const el = document.getElementById('assignments-list'); if (!el) return;
      if (snap.empty) { el.innerHTML = `<p class="text-sm" style="color:var(--mu)">No assignments yet.</p>`; return; }
      el.innerHTML = snap.docs.map(d => {
        const data = d.data();
        return `<div class="hcard p-4 flex justify-between items-center"><div><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${data.type}</span><h4 class="font-bold text-sm mt-1">${data.title}</h4></div><div class="text-xl font-bold" style="color:var(--ac)">${data.submissionsCount || 0}</div></div>`;
      }).join('');
    });
  },
  onTypeChange: (type) => {
    ['saq-structure', 'leq-structure', 'dbq-structure'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
    const map = { saq: 'saq-structure', leq: 'leq-structure', dbq: 'dbq-structure' };
    document.getElementById(map[type])?.classList.remove('hidden');
  },
  addDbqSource: () => {
    const type = document.getElementById('dbq-source-type')?.value || 'text';
    const label = document.getElementById('dbq-source-label')?.value.trim();
    const content = document.getElementById('dbq-source-content')?.value.trim();
    if (!label || !content) return window.app.ui.toast('Need label + content.', 'error');
    window.app.teacher.dbqSources.push({ id: Date.now(), type, label, content });
    document.getElementById('dbq-source-label').value = ''; document.getElementById('dbq-source-content').value = '';
    const list = document.getElementById('dbq-sources-list');
    if (list) list.innerHTML = window.app.teacher.dbqSources.map((s, i) => `<div class="py-1" style="border-bottom:1px solid var(--bd)"><span class="font-semibold">Doc ${i + 1}:</span> ${s.label} <span class="fm" style="color:var(--fa)">(${s.type})</span></div>`).join('');
    window.app.ui.toast('Source added.', 'success');
  },
  createAssignment: async (classId) => {
    const form = document.querySelector('#create-assignment form'); if (!form) return;
    const title = form.title.value.trim(), type = form.type.value, prompt = form.prompt.value.trim(), maxAttempts = parseInt(form.maxAttempts.value) || 3;
    if (!title || !prompt) return window.app.ui.toast('Title and prompt required.', 'error');
    let structure = null;
    if (type === 'saq') structure = { kind: 'saq', parts: parseInt(form.saqParts?.value) || 3 };
    else if (type === 'leq') structure = { kind: 'leq', focusSkills: Array.from(form.querySelectorAll('input[name="leqSkill"]:checked')).map(i => i.value) };
    else if (type === 'dbq') structure = { kind: 'dbq', sources: window.app.teacher.dbqSources || [] };
    await addDoc(collection(db, 'assignments'), { classId, title, type, prompt, maxAttempts, teacherId: appState.user.uid, createdAt: serverTimestamp(), submissionsCount: 0, structure });
    window.app.ui.closeModal('create-assignment'); window.app.ui.toast('Assignment created!', 'success'); window.app.teacher.dbqSources = [];
  }
},

// ═══ STUDENT ═══
student: {
  init: async () => {
    if (!appState.userData?.gamification) {
      appState.userData = appState.userData || {};
      appState.userData.gamification = window.app.game.getDefaultStats();
      await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification });
    }
    window.app.game.checkLevelUp();
    const classSnap = await getDocs(query(collection(db, "classes"), where("students", "array-contains", appState.user.uid)));
    const classIds = classSnap.docs.map(d => d.id);
    const container = document.getElementById('assignments-list'); if (!container) return;

    if (!classIds.length) {
      container.innerHTML = `<div class="text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><i data-lucide="book-open" class="w-8 h-8 mx-auto mb-2" style="color:var(--fa)"></i><p class="text-sm" style="color:var(--mu)">Join a class to see assignments.</p><p class="text-xs" style="color:var(--fa)">Ask your teacher for the class code.</p></div>`;
    } else {
      const snap = await getDocs(query(collection(db, "assignments"), where("classId", "in", classIds.slice(0, 10))));
      const subSnap = await getDocs(query(collection(db, "submissions"), where("studentId", "==", appState.user.uid)));
      const subsMap = {}; subSnap.forEach(d => subsMap[d.data().assignmentId] = { id: d.id, ...d.data() });

      if (snap.empty) {
        container.innerHTML = `<div class="text-center py-12" style="border:2px dashed var(--bd);border-radius:16px"><p class="text-sm" style="color:var(--mu)">No assignments yet. Check back soon.</p></div>`;
      } else {
        container.innerHTML = snap.docs.map(d => {
          const a = d.data(), sub = subsMap[d.id], done = !!sub;
          const subPayload = sub ? JSON.stringify(sub).replace(/'/g, "&#39;") : '';
          const aPayload = JSON.stringify({ id: d.id, ...a }).replace(/'/g, "&#39;");
          return `<div class="hcard p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div><span class="text-[10px] font-bold fm uppercase px-2 py-1 rounded" style="background:var(--acs);color:var(--ac)">${a.type}</span><h3 class="font-bold text-sm mt-1.5">${a.title}</h3></div>
              ${done ? `<div class="text-sm font-bold" style="color:var(--sg)">${sub.grading.score}/${sub.grading.maxScore}</div>` : ''}
            </div>
            <p class="text-xs mb-3 line-clamp-2" style="color:var(--mu)">${a.prompt}</p>
            ${done
              ? `<button onclick='window.app.router.go("results",{submission:${subPayload},assignment:${aPayload}})' class="btnG w-full text-xs">View Report</button>`
              : `<button onclick='window.app.router.go("editor",{assignment:${aPayload}})' class="btnP w-full text-xs">Start Writing</button>`
            }
          </div>`;
        }).join('');
      }
    }
    window.app.student.switchTab('assign'); lucide.createIcons();
  },

  initEditor: () => {
    const el = document.getElementById('essay-input');
    if (el) {
      const update = () => { const wc = document.getElementById('word-count'); if (wc) wc.textContent = (el.value.trim().split(/\s+/).filter(Boolean).length) + ' words'; };
      el.addEventListener('input', update); update();
    }
  },

  onEditorInput: (el) => {
    if (appState.activeAssignment) localStorage.setItem(`draft_${appState.activeAssignment.id}`, el.value);
    const wc = document.getElementById('word-count');
    if (wc) wc.textContent = (el.value.trim().split(/\s+/).filter(Boolean).length) + ' words';
  },

  joinClass: async () => {
    const code = document.getElementById('class-code')?.value.toUpperCase().trim(); if (!code) return;
    try {
      const snap = await getDocs(query(collection(db, "classes"), where("code", "==", code)));
      if (snap.empty) throw new Error("Invalid class code");
      await updateDoc(doc(db, "classes", snap.docs[0].id), { students: arrayUnion(appState.user.uid) });
      window.app.ui.closeModal('join-class'); window.app.ui.toast('Joined class!', 'success'); window.app.student.init();
    } catch (e) { window.app.ui.toast(e.message, 'error'); }
  },

  switchTab: (tab) => {
    ['assign', 'skills', 'arcade'].forEach(t => {
      document.getElementById(`tab-${t}`)?.classList.toggle('hidden', t !== tab);
      const btn = document.getElementById(`stab-${t}`);
      if (btn) btn.classList.toggle('on', t === tab);
    });
    lucide.createIcons();
  },

  submitEssay: async () => {
    const txt = document.getElementById('essay-input')?.value.trim();
    if (!txt || txt.length < 50) return window.app.ui.toast('Write at least a solid paragraph before submitting.', 'error');
    window.app.ui.btnLoading('submit-btn', true); window.app.ui.toast('AI is grading your essay…', 'info');
    try {
      const grading = await window.app.ai.grade(appState.activeAssignment.type, appState.activeAssignment.prompt, txt, appState.activeAssignment.structure);
      const sub = { assignmentId: appState.activeAssignment.id, studentId: appState.user.uid, studentName: appState.userData.name, essayText: txt, grading, submittedAt: new Date() };
      const docRef = await addDoc(collection(db, 'submissions'), { ...sub, submittedAt: serverTimestamp() });
      localStorage.removeItem(`draft_${appState.activeAssignment.id}`);
      appState.userData.gamification.xp += grading.score * 15;
      window.app.game.updateSkillsFromGrading(appState.activeAssignment.type, grading);
      await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification });
      window.app.game.checkLevelUp();
      window.app.router.go('results', { submission: { id: docRef.id, ...sub }, assignment: appState.activeAssignment });
    } catch (e) { console.error(e); window.app.ui.toast('Error: ' + e.message, 'error'); window.app.ui.btnLoading('submit-btn', false); }
  }
},

// ═══ GAME SYSTEM ═══
game: {
  getDefaultStats: () => ({
    level: 1, xp: 0,
    mastery: {
      saq: { skills: { identify: 40, describe: 35, explain: 30 } },
      dbq: { skills: { contextualization: 25, thesis: 30, sourcing: 15, evidence: 20, complexity: 10 } },
      leq: { skills: { contextualization: 30, thesis: 35, evidence: 25, reasoning: 20 } }
    }
  }),

  checkLevelUp: () => {
    const g = appState.userData?.gamification; if (!g) return;
    const newLevel = Math.floor(g.xp / 200) + 1;
    if (newLevel > g.level) { g.level = newLevel; window.app.ui.toast('🎉 Level up! Now Level ' + newLevel + '!', 'success'); confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }, colors: ['#d4622f', '#c49528', '#4d8060', '#5c6db3'] }); }
  },

  updateSkillsFromGrading: (type, grading) => {
    if (!grading.annotations || !appState.userData.gamification.mastery[type]) return;
    const skills = appState.userData.gamification.mastery[type].skills;
    grading.annotations.forEach(a => { const cat = a.category?.toLowerCase(); if (skills[cat] !== undefined) { skills[cat] = Math.min(100, skills[cat] + (a.status === 'success' ? 8 : a.status === 'warning' ? 3 : 1)); } });
  },

  renderSkillGarden: (stats) => {
    const m = stats.mastery || window.app.game.getDefaultStats().mastery;
    const renderGroup = (type, label, color) => {
      const skills = m[type]?.skills || {};
      return `<div class="mb-6"><h4 class="text-xs font-bold uppercase tracking-wider mb-3" style="color:${color}">${label}</h4><div class="grid grid-cols-3 gap-4">${Object.entries(skills).map(([name, val]) => {
        const state = val >= 80 ? 'skill-gold' : val >= 40 ? 'skill-grow' : 'skill-seed';
        const icon = val >= 80 ? '🌳' : val >= 40 ? '🌿' : '🌱';
        return `<button onclick="window.app.game.openPractice('${type}','${name}')" class="skill-node flex flex-col items-center gap-2"><div class="w-16 h-16 rounded-2xl ${state} border-2 flex flex-col items-center justify-center" style="border-color:var(--bd)"><span class="text-lg">${icon}</span><span class="text-[10px] font-bold">${val}%</span></div><span class="text-[10px] font-semibold uppercase" style="color:var(--mu)">${name}</span></button>`;
      }).join('')}</div></div>`;
    };
    return `<div><p class="text-xs mb-5" style="color:var(--fa)">🌱 seedling 🌿 growing 🌳 mastered — tap to practice</p>${renderGroup('saq', 'SAQ Skills', 'var(--ac)')}${renderGroup('dbq', 'DBQ Skills', 'var(--ry)')}${renderGroup('leq', 'LEQ Skills', 'var(--sg)')}</div>`;
  },

  openPractice: (type, skill) => {
    const prompts = { thesis: "Write a thesis: clear defensible claim + line of reasoning (because/due to).", contextualization: "Provide broad historical context — a wider trend beyond the specific prompt.", evidence: "Give TWO specific historical evidence pieces (dates, people, events).", sourcing: "Analyze a source's POV, Purpose, Situation, or Audience.", identify: "Identify ONE specific historical cause, effect, or development.", describe: "Describe a historical development in 2–3 sentences.", explain: "Explain WHY a development occurred. Connect causes to effects.", reasoning: "Use comparison, causation, or CCOT to connect evidence to argument.", complexity: "Qualify an argument, address counterevidence, or connect across periods." };
    document.getElementById('practice-title').textContent = 'Practice: ' + skill[0].toUpperCase() + skill.slice(1);
    document.getElementById('practice-prompt').innerHTML = `<p class="font-semibold mb-2" style="color:var(--ac)">${type.toUpperCase()} → ${skill}</p><p>${prompts[skill] || 'Practice this skill.'}</p>`;
    document.getElementById('practice-response').value = '';
    appState.practiceContext = { type, skill }; window.app.ui.modal('practice-modal', 'open');
  },

  submitPractice: async () => {
    const resp = document.getElementById('practice-response')?.value.trim();
    if (!resp || resp.length < 15) return window.app.ui.toast('Write a bit more before submitting.', 'error');
    const btn = document.getElementById('submit-practice-btn'); btn.textContent = 'Checking…'; btn.disabled = true;
    setTimeout(async () => {
      const { type, skill } = appState.practiceContext;
      const words = resp.split(/\s+/).length;
      const hasSpecifics = /\d{3,4}|[A-Z][a-z]+ [A-Z]/.test(resp);
      const boost = words >= 25 && hasSpecifics ? 12 : words >= 15 ? 8 : 5;
      appState.userData.gamification.mastery[type].skills[skill] = Math.min(100, appState.userData.gamification.mastery[type].skills[skill] + boost);
      appState.userData.gamification.xp += 30 + boost;
      await updateDoc(doc(db, "users", appState.user.uid), { gamification: appState.userData.gamification });
      btn.textContent = 'Submit Response'; btn.disabled = false;
      window.app.ui.closeModal('practice-modal');
      window.app.ui.toast(`${skill} improved +${boost}% | +${30 + boost} XP`, 'success');
      if (boost >= 10) confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#d4622f', '#c49528', '#4d8060'] });
      window.app.game.checkLevelUp();
      if (appState.userData.role === 'student') window.app.router.go('student-dash');
    }, 1000);
  },

  // ═══ ARCADE ═══
  chronoState: { score: 0, streak: 0, best: 0, anchor: null, challenge: null },
  thesisState: { streak: 0, best: 0, promptIdx: null },
  sourceState: { solved: 0, caseIdx: null },

  renderArcade: () => `
    <div class="arcP h-full flex flex-col">
      <div class="flex" style="border-bottom:1px solid #332f26">
        <button onclick="window.app.game.switchArcade('chrono')" class="arcTab on flex-1" id="atab-chrono"><i data-lucide="clock" class="w-3 h-3"></i><span>Timeline</span></button>
        <button onclick="window.app.game.switchArcade('thesis')" class="arcTab flex-1" id="atab-thesis"><i data-lucide="flame" class="w-3 h-3"></i><span>Thesis Forge</span></button>
        <button onclick="window.app.game.switchArcade('source')" class="arcTab flex-1" id="atab-source"><i data-lucide="search" class="w-3 h-3"></i><span>Source Detective</span></button>
      </div>
      <div class="flex-1 relative">
        <div id="arc-chrono" class="absolute inset-0">${window.app.game.renderChrono()}</div>
        <div id="arc-thesis" class="absolute inset-0 hidden">${window.app.game.renderThesisForge()}</div>
        <div id="arc-source" class="absolute inset-0 hidden">${window.app.game.renderSourceDetective()}</div>
      </div>
    </div>`,

  switchArcade: (mode) => {
    ['chrono', 'thesis', 'source'].forEach(m => { document.getElementById('arc-' + m)?.classList.toggle('hidden', m !== mode); document.getElementById('atab-' + m)?.classList.toggle('on', m === mode); });
    lucide.createIcons();
  },

  // ── CHRONO-CRISIS ──
  renderChrono: () => `
    <div class="h-full flex flex-col text-white">
      <div id="chrono-start" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-4" style="background:var(--ac)"><i data-lucide="clock" class="w-7 h-7 text-white"></i></div>
        <h3 class="text-xl font-bold mb-1 fs">CHRONO-CRISIS</h3>
        <p class="text-xs mb-3 max-w-xs" style="color:#9a9385">Before or after the anchor? Build streaks for bonus XP!</p>
        <div class="text-xs mb-3" style="color:#7f7868">Best streak: <span id="chrono-best" class="font-bold text-white">${window.app.game.chronoState.best}</span></div>
        <button onclick="window.app.game.startChrono()" class="btnP text-xs px-6 py-2.5">START GAME</button>
      </div>
      <div id="chrono-game" class="hidden flex-1 flex flex-col">
        <div class="flex justify-between items-center px-4 py-2" style="background:rgba(255,255,255,.03)">
          <div class="text-xs"><span style="color:#9a9385">Score</span> <span class="font-bold text-lg text-white ml-1" id="chrono-score">0</span></div>
          <div class="text-xs"><span style="color:#9a9385">Streak</span> <span class="font-bold text-white ml-1" id="chrono-streak">0</span> 🔥</div>
          <button onclick="window.app.game.endChrono()" class="text-xs" style="color:#655f52">End</button>
        </div>
        <div id="chrono-play" class="flex-1 flex flex-col items-center justify-center p-4 gap-5">
          <div class="text-center"><p class="text-[10px] uppercase tracking-[.2em] mb-1" style="color:var(--ac)">Anchor Event</p><div class="px-4 py-3 rounded-xl" style="background:rgba(255,255,255,.05)"><h4 class="font-bold text-sm" id="chrono-anchor-text">…</h4><span class="fm text-[11px] px-2 py-0.5 rounded mt-1 inline-block" style="background:rgba(212,98,47,.15);color:var(--ac)" id="chrono-anchor-date">…</span></div></div>
          <div class="text-center"><p class="text-[10px] uppercase tracking-[.2em] mb-1" style="color:#9a9385">Before or After?</p><div class="px-4 py-3 rounded-xl" style="background:rgba(255,255,255,.05)"><h4 class="font-bold text-base" id="chrono-challenge-text">…</h4><p class="text-[10px] mt-1 fm" style="color:#655f52" id="chrono-challenge-era">…</p></div>
            <div class="flex gap-3 mt-4">
              <button onclick="window.app.game.guessChrono('before')" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(255,255,255,.05);color:#e8e6e1">⬅ BEFORE</button>
              <button onclick="window.app.game.guessChrono('after')" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition hover:opacity-80" style="background:rgba(212,98,47,.15);color:var(--ac)">AFTER ➡</button>
            </div>
          </div>
        </div>
      </div>
      <div id="chrono-over" class="hidden flex-1 flex flex-col items-center justify-center p-6 text-center" style="background:rgba(0,0,0,.6)">
        <h3 class="text-xl font-bold mb-2 fs">GAME OVER</h3>
        <p class="text-sm mb-1" style="color:#9a9385">Score: <span class="text-white font-bold" id="chrono-final">0</span> | Streak: <span class="text-white font-bold" id="chrono-final-streak">0</span></p>
        <div id="chrono-feedback" class="text-xs mb-4 p-3 rounded-lg max-w-xs" style="background:rgba(212,98,47,.1);color:var(--ac)"></div>
        <button onclick="window.app.game.startChrono()" class="btnP text-xs px-6 py-2.5">PLAY AGAIN</button>
      </div>
    </div>`,

  startChrono: () => { const c = window.app.game.chronoState; c.score = 0; c.streak = 0; document.getElementById('chrono-start')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.add('hidden'); document.getElementById('chrono-game')?.classList.remove('hidden'); window.app.game.nextChrono(); lucide.createIcons(); },
  endChrono: () => { const c = window.app.game.chronoState; c.best = Math.max(c.best, c.streak); document.getElementById('chrono-game')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.remove('hidden'); document.getElementById('chrono-final').textContent = c.score; document.getElementById('chrono-final-streak').textContent = c.streak; document.getElementById('chrono-feedback').textContent = ''; document.getElementById('chrono-best').textContent = c.best; },
  nextChrono: () => { const c = window.app.game.chronoState; c.anchor = CHRONO_EVENTS[Math.floor(Math.random() * CHRONO_EVENTS.length)]; do { c.challenge = CHRONO_EVENTS[Math.floor(Math.random() * CHRONO_EVENTS.length)]; } while (c.challenge === c.anchor); document.getElementById('chrono-score').textContent = c.score; document.getElementById('chrono-streak').textContent = c.streak; document.getElementById('chrono-anchor-text').textContent = c.anchor.event; document.getElementById('chrono-anchor-date').textContent = c.anchor.date; document.getElementById('chrono-challenge-text').textContent = c.challenge.event; document.getElementById('chrono-challenge-era').textContent = c.challenge.era; },
  guessChrono: async (dir) => {
    const c = window.app.game.chronoState; const correct = dir === 'before' ? c.challenge.date < c.anchor.date : c.challenge.date > c.anchor.date;
    const play = document.getElementById('chrono-play');
    if (correct) {
      c.score++; c.streak++; const bonus = c.streak >= 5 ? 3 : c.streak >= 3 ? 2 : 1; const xp = 5 * bonus;
      appState.userData.gamification.xp += xp; await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp });
      if (play) { play.classList.add('chronoCorrect'); setTimeout(() => play.classList.remove('chronoCorrect'), 400); }
      document.getElementById('chrono-score').textContent = c.score; document.getElementById('chrono-streak').textContent = c.streak;
      if (c.streak % 5 === 0) { window.app.ui.toast('🔥 Streak bonus! +' + xp + ' XP', 'success'); confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } }); }
      setTimeout(() => window.app.game.nextChrono(), 500);
    } else {
      c.best = Math.max(c.best, c.streak);
      if (play) { play.classList.add('chronoWrong'); setTimeout(() => play.classList.remove('chronoWrong'), 500); }
      document.getElementById('chrono-final').textContent = c.score; document.getElementById('chrono-final-streak').textContent = c.streak;
      document.getElementById('chrono-feedback').innerHTML = '<strong>' + c.challenge.event + '</strong> was in <strong>' + c.challenge.date + '</strong>, which is ' + (c.challenge.date < c.anchor.date ? 'BEFORE' : 'AFTER') + ' ' + c.anchor.date + '.';
      document.getElementById('chrono-game')?.classList.add('hidden'); document.getElementById('chrono-over')?.classList.remove('hidden'); document.getElementById('chrono-best').textContent = c.best;
    }
  },

  // ── THESIS FORGE ──
  renderThesisForge: () => `
    <div class="h-full flex flex-col text-white">
      <div class="flex-1 flex flex-col justify-between p-4 gap-3">
        <div>
          <div class="flex items-center justify-between mb-2">
            <div><h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4 text-amber-400"></i>Thesis Forge</h3><p class="text-[11px]" style="color:#9a9385">Write AP theses in 1-2 sentences.</p></div>
            <div class="text-right text-[10px]"><div>Streak: <span id="thesis-streak">0</span></div><div>Best: <span id="thesis-best">0</span></div></div>
          </div>
          <div class="mt-2 rounded-lg p-3" style="background:rgba(255,255,255,.05)"><p class="text-[10px] uppercase tracking-[.15em] mb-1" style="color:#e8794a">Prompt</p><p id="thesis-prompt" class="text-xs leading-snug">Click New Prompt to begin.</p></div>
        </div>
        <div>
          <textarea id="thesis-input" class="w-full h-20 rounded-lg p-2 text-xs resize-none focus:outline-none focus:ring-1 focus:ring-amber-400" style="background:rgba(255,255,255,.05);color:#e8e6e1" placeholder="Write your thesis here..."></textarea>
          <p class="mt-1 text-[10px]" style="color:#655f52">Tip: Claim + because/due to + dates/regions/processes.</p>
        </div>
      </div>
      <div class="p-3 flex items-center justify-between gap-2" style="border-top:1px solid #332f26">
        <button onclick="window.app.game.newThesisPrompt()" class="text-[11px] flex items-center gap-1 px-3 py-2 rounded-lg" style="background:rgba(255,255,255,.05);color:#e8e6e1"><i data-lucide="refresh-cw" class="w-3 h-3"></i>New Prompt</button>
        <button onclick="window.app.game.forgeThesis()" class="text-[11px] font-semibold flex items-center gap-1 px-4 py-2 rounded-lg" style="background:#d4a843;color:#13120f"><i data-lucide="hammer" class="w-3 h-3"></i>Forge</button>
      </div>
    </div>`,

  newThesisPrompt: () => {
    const s = window.app.game.thesisState;
    let i = Math.floor(Math.random() * THESIS_PROMPTS.length);
    if (i === s.promptIdx && THESIS_PROMPTS.length > 1) i = (i + 1) % THESIS_PROMPTS.length;
    s.promptIdx = i;
    const el = document.getElementById('thesis-prompt'); if (el) el.textContent = THESIS_PROMPTS[i];
    const inp = document.getElementById('thesis-input'); if (inp) inp.value = '';
  },

  forgeThesis: async () => {
    const inp = document.getElementById('thesis-input'); if (!inp) return;
    const txt = inp.value.trim();
    if (txt.length < 20) return window.app.ui.toast('Too short for a thesis.', 'error');
    const lo = txt.toLowerCase();
    const connectors = ['because','due to','as a result','therefore','led to','resulted in','in order to','which caused','contributing to'];
    const hasConn = connectors.some(c => lo.includes(c));
    const hasSpec = /(\d{3,4}|asia|europe|americas|africa|atlantic|silk road|mongol|ottoman|ming|qing|mughal|columbian|industrial)/i.test(txt);
    const words = txt.split(/\s+/).length;
    const hasQual = /although|while|extent|significant|primarily|largely|limited|transformed|fundamentally/i.test(txt);
    let quality = 'ok';
    if (hasConn && hasSpec && words >= 18 && hasQual) quality = 'strong';
    else if (hasConn && hasSpec && words >= 15) quality = 'good';
    else if (!hasConn) quality = 'weak';
    const s = window.app.game.thesisState;
    if (quality === 'strong') {
      s.streak++; s.best = Math.max(s.best, s.streak);
      appState.userData.gamification.xp += 20;
      await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp });
      window.app.ui.toast('Masterful thesis! +20 XP', 'success');
      confetti({ particleCount: 90, spread: 70, origin: { y: 0.75 }, colors: ['#d4a843', '#e8794a'] });
      setTimeout(() => window.app.game.newThesisPrompt(), 500);
    } else if (quality === 'good') {
      s.streak++; s.best = Math.max(s.best, s.streak);
      appState.userData.gamification.xp += 10;
      await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp });
      window.app.ui.toast('Solid thesis! +10 XP. Add a qualifier for mastery.', 'success');
    } else if (quality === 'ok') {
      s.streak = 0; window.app.ui.toast('Decent start. Add cause/effect connectors + specifics.', 'info');
    } else {
      s.streak = 0; window.app.ui.toast('Too vague. Use "because" or "due to" + dates/names.', 'error');
    }
    document.getElementById('thesis-streak').textContent = s.streak;
    document.getElementById('thesis-best').textContent = s.best;
  },

  // ── SOURCE DETECTIVE ──
  renderSourceDetective: () => `
    <div class="h-full flex flex-col text-white">
      <div class="flex-1 flex flex-col justify-between p-4 gap-3">
        <div>
          <div class="flex items-center justify-between mb-2">
            <div><h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="search" class="w-4 h-4 text-sky-400"></i>Source Detective</h3><p class="text-[11px]" style="color:#9a9385">ID the POV, audience, and purpose.</p></div>
            <div class="text-right text-[10px]">Solved: <span id="source-solved" class="font-bold text-white">0</span></div>
          </div>
          <div class="mt-2 rounded-lg p-3 max-h-24 overflow-y-auto csc" style="background:rgba(255,255,255,.05)"><p class="text-[10px] uppercase tracking-[.15em] mb-1" style="color:#7b8ac4">Document</p><p id="source-doc" class="text-xs leading-snug">Click New Case to begin.</p><p id="source-attr" class="text-[10px] mt-1 italic" style="color:#655f52"></p></div>
        </div>
        <div class="space-y-2">
          <div><label class="text-[10px]" style="color:#9a9385">Point of View</label><select id="source-pov" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="text-[10px]" style="color:#9a9385">Audience</label><select id="source-aud" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
            <div><label class="text-[10px]" style="color:#9a9385">Purpose</label><select id="source-pur" class="w-full rounded-lg px-2 py-1.5 text-[11px]" style="background:rgba(255,255,255,.05);color:#e8e6e1;border:none"><option value="">Select...</option></select></div>
          </div>
        </div>
      </div>
      <div class="p-3 flex items-center justify-between gap-2" style="border-top:1px solid #332f26">
        <button onclick="window.app.game.newSourceCase()" class="text-[11px] flex items-center gap-1 px-3 py-2 rounded-lg" style="background:rgba(255,255,255,.05);color:#e8e6e1"><i data-lucide="file-plus" class="w-3 h-3"></i>New Case</button>
        <button onclick="window.app.game.solveSource()" class="text-[11px] font-semibold flex items-center gap-1 px-4 py-2 rounded-lg" style="background:#5c6db3;color:#fff"><i data-lucide="check-circle-2" class="w-3 h-3"></i>Solve</button>
      </div>
    </div>`,

  newSourceCase: () => {
    const s = window.app.game.sourceState;
    let i = Math.floor(Math.random() * SOURCE_CASES.length);
    if (i === s.caseIdx && SOURCE_CASES.length > 1) i = (i + 1) % SOURCE_CASES.length;
    s.caseIdx = i; const c = SOURCE_CASES[i];
    const docEl = document.getElementById('source-doc'); if (docEl) docEl.textContent = c.excerpt;
    const attrEl = document.getElementById('source-attr'); if (attrEl) attrEl.textContent = '— ' + c.attribution;
    const fillSelect = (id, options) => {
      const el = document.getElementById(id); if (!el) return;
      el.innerHTML = '<option value="">Select...</option>';
      options.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; el.appendChild(opt); });
      el.value = '';
    };
    fillSelect('source-pov', POV_OPTIONS);
    fillSelect('source-aud', AUD_OPTIONS);
    fillSelect('source-pur', PURP_OPTIONS);
  },

  solveSource: async () => {
    const s = window.app.game.sourceState;
    if (s.caseIdx == null) return window.app.ui.toast('Click New Case first.', 'info');
    const c = SOURCE_CASES[s.caseIdx];
    const pov = document.getElementById('source-pov')?.value;
    const aud = document.getElementById('source-aud')?.value;
    const pur = document.getElementById('source-pur')?.value;
    if (!pov || !aud || !pur) return window.app.ui.toast('Fill all three fields.', 'error');
    let score = 0;
    if (pov === c.pov) score++;
    if (aud === c.audience) score++;
    if (pur === c.purpose) score++;
    if (score === 3) {
      s.solved++;
      appState.userData.gamification.xp += 15;
      await updateDoc(doc(db, "users", appState.user.uid), { "gamification.xp": appState.userData.gamification.xp });
      document.getElementById('source-solved').textContent = s.solved;
      window.app.ui.toast('Perfect sourcing! Case solved. +15 XP', 'success');
      confetti({ particleCount: 70, spread: 60, origin: { y: 0.75 } });
      setTimeout(() => window.app.game.newSourceCase(), 500);
    } else {
      let hints = 'Check:';
      if (pov !== c.pov) hints += ' POV';
      if (aud !== c.audience) hints += ' Audience';
      if (pur !== c.purpose) hints += ' Purpose';
      window.app.ui.toast(hints + '. ' + score + '/3 correct.', 'info');
    }
  }
},

// ═══ AI GRADING ═══
ai: {
  grade: async (type, prompt, essay, structure) => {
    if (!appState.apiKey) return window.app.ai.mockGrade(type);
    const rubrics = { saq: { maxScore: 3 }, leq: { maxScore: 6 }, dbq: { maxScore: 7 } };
    const r = rubrics[type];
    try {
      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': appState.apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514', max_tokens: 2000,
          messages: [{ role: 'user', content: 'You are an AP World History essay grader. Grade this ' + type.toUpperCase() + ' using the 2025 College Board rubric.\n\nPrompt:\n' + prompt + '\n\nEssay:\n' + essay + '\n\nReturn ONLY valid JSON with no extra text:\n{"score":NUMBER,"maxScore":' + r.maxScore + ',"generalFeedback":"2-3 sentence overview","annotations":[{"quote":"short excerpt from essay","category":"Thesis|Contextualization|Evidence|Sourcing|Reasoning|Complexity","status":"success|warning|error","feedback":"specific feedback"}]}' }]
        })
      });
      const data = await resp.json();
      const text = data?.content?.[0]?.text || '';
      const match = text.match(/\{[\s\S]*\}/);
      if (match) return JSON.parse(match[0]);
      return window.app.ai.mockGrade(type);
    } catch (e) { console.error('AI grading error:', e); return window.app.ai.mockGrade(type); }
  },
  mockGrade: (type) => {
    const scores = { saq: 2, leq: 4, dbq: 5 };
    const maxScores = { saq: 3, leq: 6, dbq: 7 };
    return {
      score: scores[type] || 3, maxScore: maxScores[type] || 6,
      generalFeedback: "Good effort! Your essay shows solid understanding of the topic. Work on including more specific historical evidence with dates and names, and strengthen your analytical reasoning to connect evidence to your argument.",
      annotations: [
        { quote: "", category: "Thesis", status: "success", feedback: "You presented a clear, defensible claim that addresses the prompt." },
        { quote: "", category: "Evidence", status: "warning", feedback: "Include more specific historical examples with dates, names, and places to strengthen your argument." },
        { quote: "", category: "Reasoning", status: "warning", feedback: "Try to more explicitly connect your evidence to your thesis using causation, comparison, or continuity/change." }
      ]
    };
  }
},

// ═══ UI UTILITIES ═══
ui: {
  updateNav: () => {
    const navOut = document.getElementById('nav-out');
    const navIn = document.getElementById('nav-in');
    const nameEl = document.getElementById('nav-name');
    if (appState.user) {
      navOut.classList.add('hidden'); navIn.classList.remove('hidden');
      if (nameEl) nameEl.textContent = appState.userData?.name || 'User';
    } else {
      navOut.classList.remove('hidden'); navIn.classList.add('hidden');
    }
  },
  toast: (msg, type = 'info') => {
    const container = document.getElementById('toast-container');
    const colors = { success: 'background:#4d8060', error: 'background:#b34d1e', info: 'background:var(--ac)' };
    const el = document.createElement('div');
    el.className = 'toastAnim text-white px-5 py-3 rounded-xl shadow-lg pointer-events-auto text-sm font-medium';
    el.style.cssText = colors[type] || colors.info;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3500);
  },
  modal: (id, action) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (action === 'open') { el.classList.remove('hidden'); } else { el.classList.add('hidden'); }
    lucide.createIcons();
  },
  closeModal: (id) => { document.getElementById(id)?.classList.add('hidden'); },
  toggleSettings: () => {
    const modal = document.getElementById('settings-modal');
    if (modal.classList.contains('hidden')) {
      modal.classList.remove('hidden');
      document.getElementById('profile-name-input').value = appState.userData?.name || '';
      document.getElementById('api-key-input').value = appState.apiKey || '';
      const theme = document.body.getAttribute('data-theme');
      document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
    } else { modal.classList.add('hidden'); }
    lucide.createIcons();
  },
  saveSettings: async () => {
    const name = document.getElementById('profile-name-input').value.trim();
    const key = document.getElementById('api-key-input').value.trim();
    const theme = document.querySelector('input[name="theme"]:checked')?.value || 'light';
    if (name && appState.user) {
      await updateDoc(doc(db, "users", appState.user.uid), { name });
      appState.userData.name = name;
      document.getElementById('nav-name').textContent = name;
    }
    appState.apiKey = key;
    if (key) localStorage.setItem('anthropic_key', key); else localStorage.removeItem('anthropic_key');
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('hw_theme', theme);
    window.app.ui.toggleSettings();
    window.app.ui.toast('Settings saved.', 'success');
  },
  btnLoading: (id, loading) => {
    const btn = document.getElementById(id); if (!btn) return;
    if (loading) { btn.disabled = true; btn.dataset.origText = btn.textContent; btn.textContent = 'Loading…'; }
    else { btn.disabled = false; btn.textContent = btn.dataset.origText || btn.textContent; }
  }
}

}; // end window.app

// ═══ FIREBASE AUTH LISTENER ═══
onAuthStateChanged(auth, async (user) => {
  if (user) {
    appState.user = user;
    const snap = await getDoc(doc(db, "users", user.uid));
    appState.userData = snap.exists() ? snap.data() : { name: user.displayName, role: 'student' };
    window.app.ui.updateNav();
    window.app.router.go(appState.userData.role === 'teacher' ? 'teacher-dash' : 'student-dash');
  } else {
    appState.user = null; appState.userData = null;
    window.app.ui.updateNav();
    window.app.router.go('home');
  }
});

// ═══ THEME INIT ═══
const savedTheme = localStorage.getItem('hw_theme');
if (savedTheme) document.body.setAttribute('data-theme', savedTheme);

// ═══ INITIAL ICONS ═══
lucide.createIcons();

</script>
</body>
</html>
